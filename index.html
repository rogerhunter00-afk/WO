<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Work Orders List – Aberdeen Laundry Services (Engineering)</title>
  <style>
    :root{
      --ink:#0b0f1a;
      --muted:#6b7280;
      --als-blue:#0b67c2;
      --als-blue-strong:#0a5cb0;
      --thead:#0b67c2;
      --thead-text:#ffffff;
      --grid:#e6e9ef;
      --zebra:#ffffff;
      --chip-cat-tx:#0b67c2;
      --chip-cat-br:#0b67c2;
      --done-tx:#059669;
      --open-tx:#0b67c2;
      --hold-tx:#b45309;
      --done-bg:#0596691a;
      --open-bg:#0b67c21a;
      --hold-bg:#f59e0b1a;
      --paper:#ffffff;
      --priority-rail:#E85A70;
      --sticky-controls-offset:0px;
    }

    @media (prefers-color-scheme: dark){
      :root{
        color-scheme: dark;
        --ink:#f3f4f6;
        --muted:#9ca3af;
        --als-blue:#3b82f6;
        --als-blue-strong:#2563eb;
        --thead:#1e3a8a;
        --thead-text:#ffffff;
        --grid:#374151;
        --zebra:#1f2937;
        --chip-cat-tx:#3b82f6;
        --chip-cat-br:#3b82f6;
        --done-tx:#10b981;
        --open-tx:#3b82f6;
        --hold-tx:#fbbf24;
        --done-bg:#10b98133;
        --open-bg:#3b82f633;
        --hold-bg:#f59e0b33;
        --paper:#111827;
      }
    }

    .dark{
      --ink:#f3f4f6;
      --muted:#9ca3af;
      --als-blue:#3b82f6;
      --als-blue-strong:#2563eb;
      --thead:#1e3a8a;
      --thead-text:#ffffff;
      --grid:#374151;
      --zebra:#1f2937;
      --chip-cat-tx:#3b82f6;
      --chip-cat-br:#3b82f6;
      --done-tx:#10b981;
      --open-tx:#3b82f6;
      --hold-tx:#fbbf24;
      --done-bg:#10b98133;
      --open-bg:#3b82f633;
      --hold-bg:#f59e0b33;
      --paper:#111827;
      color-scheme: dark;
    }

    .light{
      --ink:#0b0f1a;
      --muted:#6b7280;
      --als-blue:#0b67c2;
      --als-blue-strong:#0a5cb0;
      --thead:#0b67c2;
      --thead-text:#ffffff;
      --grid:#e6e9ef;
      --zebra:#ffffff;
      --chip-cat-tx:#0b67c2;
      --chip-cat-br:#0b67c2;
      --done-tx:#059669;
      --open-tx:#0b67c2;
      --hold-tx:#b45309;
      --done-bg:#0596691a;
      --open-bg:#0b67c21a;
      --hold-bg:#f59e0b1a;
      --paper:#ffffff;
      color-scheme: light;
    }

    /* --- collapsible sticky header --- */
.sticky-top__bar{
  display:flex; justify-content:flex-end; align-items:center; gap:8px;
}

.btn--pill{ border-radius:999px; padding:6px 12px; }

.sticky-content{ /* smooth-ish hide/show */
  transition: opacity .18s ease;
}

.sticky-top[data-collapsed="true"]{
  padding:6px 0;               /* slimmer bar when collapsed */
}
.sticky-top[data-collapsed="true"] .sticky-content{
  display:none !important;     /* fully hidden */
  opacity:0;
}

    /* Mobile cards (hidden by default) */
.mobile-cards{ display:none; }

.mobile-card{
  border:1px solid var(--grid);
  border-radius:14px;
  padding:12px;
  background:var(--paper);
  display:grid;
  grid-template-columns: 1fr auto;
  gap:8px 12px;
}
.mobile-card + .mobile-card{ margin-top:10px; }

.mobile-card__title{ font-weight:800; line-height:1.3; }
.mobile-card__id{ font-weight:900; opacity:.7; }
.mobile-card__meta{
  grid-column:1 / -1;
  display:flex; flex-wrap:wrap; gap:8px;
  font-size:12px; color:var(--muted);
}
.mobile-card__row{ grid-column:1 / -1; display:flex; gap:8px; align-items:center; }
.mobile-card .status-chip{ font-size:12px; }
.mobile-card .chip-cat{ padding:3px 8px; font-size:11px; margin:2px 4px 0 0; }

/* Swap to cards on phones */
@media (max-width: 700px){
  .dash-table .table-scroll{ display:none; } /* hide desktop table */
  .mobile-cards{ display:block; }            /* show card list */
  .page{ --page-pad-inline:16px; }
}
    /* ---- Mobile sort controls ---- */
.mobile-sort{
  display:none;
  align-items:center;
  gap:8px;
  margin:0 0 12px;
}
.mobile-sort__label{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.4px;
  font-weight:700;
  color:var(--muted);
}
.mobile-sort__select{
  flex:1 1 auto;
  font:inherit;
  font-weight:600;
  padding:8px 12px;
  border-radius:8px;
  border:1px solid var(--grid);
  background:var(--paper);
  color:var(--ink);
}
.mobile-sort__direction{
  font:inherit;
  font-weight:700;
  padding:8px 12px;
  border-radius:8px;
  border:1px solid var(--grid);
  background:color-mix(in srgb, var(--als-blue) 16%, var(--paper));
  color:var(--ink);
  cursor:pointer;
}
.mobile-sort__direction[disabled]{ opacity:.5; cursor:not-allowed; }

/* Show sort controls with cards under 700px */
@media (max-width: 700px){
  .mobile-sort{ display:flex; flex-wrap:wrap; }
}
    
    html,body{height:100%}
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink); background:var(--paper); margin:0; font-size:13px; line-height:1.32;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }

.page{
  /* existing vars + padding kept */
  --page-pad-top:40px;
  --page-pad-inline:48px;
  --page-pad-bottom:56px;
  padding:var(--page-pad-top) var(--page-pad-inline) var(--page-pad-bottom);
  box-sizing:border-box;

  /* NEW: center the page and cap width */
  max-width: clamp(960px, 96vw, 1680px);
  margin-inline: auto;
}

    /* Popover shell */
.legend-popover{ position:relative; }
.legend-popover__panel{
  position:absolute; right:0; top:calc(100% + 8px);
  width: min(320px, 86vw); max-height: 70vh; overflow:auto;
  background: var(--paper); color: var(--ink);
  border:1px solid var(--grid); border-radius:12px; padding:10px;
  box-shadow: 0 12px 30px rgba(0,0,0,.18);
  opacity:0; transform: translateY(-4px); pointer-events:none;
  transition: opacity .15s ease, transform .15s ease;
  z-index: 130;
}
/* little caret */
.legend-popover__panel::before{
  content:""; position:absolute; top:-6px; right:24px;
  width:12px; height:12px; transform: rotate(45deg);
  background: var(--paper); border-left:1px solid var(--grid); border-top:1px solid var(--grid);
}

/* Show on hover or keyboard focus */
.legend-popover:hover .legend-popover__panel,
.legend-popover:focus-within .legend-popover__panel,
.legend-popover.is-open .legend-popover__panel{
  opacity:1; transform: none; pointer-events:auto;
}

/* Compact legend tweaks */
.legend--compact{ margin:0; padding:10px; background:var(--paper); }
.legend--compact .legend__title{ margin:0 0 6px; font-size:10px; }
.legend--compact .legend__list{ gap:6px 8px; }
.legend--compact .status-chip{ font-size:11px; padding:3px 9px; }
.legend--compact .age-chip{ font-size:11.5px; padding:3px 7px; }
.legend--compact .chip-cat{ font-size:11px; padding:3px 8px; }
.legend--compact .legend__kpi{ font-size:11px; padding:3px 8px; }

/* Mobile: make it easier to use with touch */
@media (max-width:700px){
  .legend-popover__panel{
    position: fixed; left: 12px; right: 12px; top: calc(var(--sticky-controls-offset) + 8px);
    width:auto; max-height: 60vh;
  }
  .legend-popover__panel::before{ display:none; }
}

    .legend{
  border:1px solid var(--grid);
  border-radius:12px;
  background:var(--paper);
  padding:12px;
  margin:8px 0 12px;
}
.legend__title{
  margin:0 0 8px;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.4px;
  color:var(--muted);
}
.legend__list{
  list-style:none; margin:0; padding:0;
  display:grid; grid-template-columns:auto 1fr; gap:8px 10px;
}
.legend__sample{ display:contents; } /* lets samples align in first column */
.legend__list > .legend__sample > :first-child{ display:inline-flex; align-items:center; gap:6px; min-height:22px; }

.legend__rail{
  width:6px; height:16px; border-radius:999px;
  background:var(--priority-rail);
  box-shadow:0 0 0 1px color-mix(in srgb, var(--priority-rail) 28%, transparent);
}

.legend__kpi{
  display:inline-block;
  padding:4px 8px;
  border:1px solid var(--grid);
  border-radius:10px;
  font-weight:800; font-size:12px;
  background: color-mix(in srgb, var(--als-blue) 8%, var(--paper));
  color: var(--ink);
}
/* Show the big legend only when printing */
.legend--full{ display:none; }
@media print{
  .legend--full{ display:block; }
}
    
    .page-head{ display:flex; align-items:flex-start; justify-content:space-between; }
    .title{ font-size:28px; font-weight:800; color:var(--ink); margin:0 0 8px; }
    .logo{ height:50px; }

    .top-rule{ height:6px; background:var(--als-blue); border-bottom:1px solid var(--als-blue-strong); margin:8px 0 10px; }

.table-scroll{
  height: calc(100vh - var(--sticky-controls-offset) - 24px);
  overflow:auto;
  border:1px solid var(--grid);
  border-radius:12px;
}

.table-scroll thead{
  position: sticky;
  top: 0;
  z-index:112;
  background:var(--thead);
}

/* Header cell visuals (no sticky here) */
.table-scroll thead th{
  position: static;              /* reset from the old sticky-per-th */
  background:var(--thead);
  color:var(--thead-text);
  text-transform:uppercase;
  letter-spacing:.6px;
  font-weight:800;
  font-size:11px;
  padding:8px 6px;
  border-right:1px solid rgba(255,255,255,.08);
  cursor:pointer;
  box-shadow: 0 1px 0 var(--grid);
  white-space:nowrap;
  text-overflow:ellipsis;
  overflow:hidden;
}

/* ✅ Merged table + cell styles */
table{
  width:100%;
  min-width:1100px;
  border-collapse:separate;
  border-spacing:0;
  table-layout:auto;
}

table th, table td{
  overflow-wrap:anywhere;
  word-break:break-word;
  hyphens:auto;
}

    tbody td, tbody th{
      position:static;
    }
    thead th .sort-arrow{ margin-left:4px; }
    thead th[data-sort="asc"] .sort-arrow::after{ content:'\25B2'; }
    thead th[data-sort="desc"] .sort-arrow::after{ content:'\25BC'; }
    thead th:first-child{ border-top-left-radius:3px; }
    thead th:last-child{ border-top-right-radius:3px; border-right:none; }

    tbody td{
      background:var(--zebra);
      border-bottom:1px solid var(--grid);
      padding:8px 6px;
      vertical-align:top;
      overflow-wrap:anywhere;
      word-break:break-word;
      hyphens:auto;
      line-height:1.35;
    }
/* very faint ALS-blue wash across the whole row */
tr.row-priority > td{
  background: color-mix(in srgb, var(--als-blue) 6%, var(--paper));
}
.dark tr.row-priority > td{
  background: color-mix(in srgb, var(--als-blue) 10%, var(--zebra));
}

/* thin rounded rail, positioned so it DOESN'T steal padding from the ID cell */
tr.row-priority > td:first-child{
  position: relative;         /* anchor the rail */
}
tr.row-priority > td:first-child::before{
  content: "";
  position: absolute;
  left: 0;                    /* sits on the very edge of the cell */
  top: 6px;                   /* mirrors your td vertical padding */
  bottom: 6px;
  width: 3px;                 /* thin rail */
  border-radius: 999px;       /* fully rounded ends */
  background: var(--priority-rail);
  box-shadow: 0 0 0 1px color-mix(in srgb, var(--priority-rail) 28%, transparent);
  pointer-events: none;
}

    .col-id{ width:66px; }
    .col-title{ width:280px; }
    .col-status{ width:120px; }
    .col-priority{ width:92px; }
    .col-createdby{ width:140px; }
    .col-createdon{ width:110px; }
    .col-completedon{ width:110px; }
    .col-updated{ width:120px; }
    .col-location{ width:180px; }
    .col-asset{ width:220px; }
    .col-categories{ width:auto !important; }

    .id{ font-weight:700; }
    .title-cell b{ display:block; font-weight:800; }

    .chip-cat{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:4px 10px;
      border:1px solid currentColor;
      background:transparent;
      margin:2px 6px 2px 0;
      font-weight:600;
      font-size:12px;
      line-height:1;
      white-space:nowrap;
    }

/* Stack categories and let the row grow */
.table-scroll td[data-col="Categories"]{
  white-space: normal;        /* allow wrapping between chips */
  min-width: 140px;           /* your chosen min */
  width: 1%;
}

.table-scroll td[data-col="Categories"] .chip-stack{
  display: flex;
  flex-wrap: wrap;            /* key: wrap to next line */
  gap: 4px 6px;               /* controls row/column spacing between chips */
  align-items: center;
}

.table-scroll td[data-col="Categories"] .chip-cat{
  margin: 0;                  /* gap now handles spacing */
  /* keep each chip on one line */
  white-space: nowrap;
  /* optional: compact */
  font-size: 11px;
  padding: 3px 8px;
}

/* STATUS-CHIPS v2 — search anchor: STATUS-CHIPS v2 */
.status-chip{
  --ring: color-mix(in srgb, currentColor 40%, transparent);
  --bg:   color-mix(in srgb, currentColor 18%, transparent);
  display:inline-flex; align-items:center; gap:6px;
  padding:3px 10px; border-radius:999px;
  font-weight:700; font-size:12px; line-height:1;
  border:1px solid var(--ring); background:var(--bg); color:currentColor;
}

/* icon bubble (CSS mask so it tints with currentColor) */
.status-chip::before{
  content:"";
  width:14px; height:14px; display:inline-block;
  background: currentColor;
  mask: var(--icon) no-repeat center / 14px 14px;
  -webkit-mask: var(--icon) no-repeat center / 14px 14px;
}

/* Open chip — blue with hollow-circle icon */
.status-chip.open{
  --icon: url("data:image/svg+xml;utf8,\
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'>\
      <circle cx='8' cy='8' r='5.5' fill='none' stroke='black' stroke-width='2'/>\
    </svg>");
  color: var(--open-tx);
  border-color: color-mix(in srgb, var(--open-tx) 55%, transparent);
  background:   color-mix(in srgb, var(--open-tx) 12%, var(--paper));
  box-shadow: none;
  padding: 4px 12px;
}

/* keep the icon tinted blue */
.status-chip.open::before{
  background: var(--open-tx);
}

/* remove the dropdown caret if you added one earlier */
.status-chip.open::after{ content: none !important; }

.status-chip.in-progress{
  color: var(--open-tx);
  --icon: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='black' fill-rule='evenodd' d='M8 1a7 7 0 1 1 0 14A7 7 0 0 1 8 1zm0 2a5 5 0 1 0 0 10A5 5 0 0 0 8 3z'/><rect x='7.25' y='3' width='1.5' height='5' rx='0.75' fill='black'/><rect x='7.25' y='8' width='4.5' height='1.5' rx='0.75' fill='black'/></svg>");
}
.status-chip.on-hold{
  color: var(--hold-tx);
  --icon: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect x='3' y='2' width='4' height='12' rx='1' fill='black'/><rect x='9' y='2' width='4' height='12' rx='1' fill='black'/></svg>");
}
.status-chip.done{
  color: var(--done-tx);
  --icon: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='black' d='M6.6 12.2 2.9 8.5l1.4-1.4 2.3 2.3 4.9-4.9 1.4 1.4-6.3 6.3z'/></svg>");
  --bg:  color-mix(in srgb, var(--done-tx) 18%, transparent);
  --ring: color-mix(in srgb, var(--done-tx) 40%, transparent);
}

/* Fallback for browsers without mask() */
@supports not (mask: url("")) {
  .status-chip::before{ 
    mask:none; -webkit-mask:none; background:none; width:auto; margin-right:2px;
    content: var(--glyph, "•");
  }
  .status-chip.open{        --glyph: "○"; }
  .status-chip.in-progress{ --glyph: "⏳"; }
  .status-chip.on-hold{     --glyph: "⏸"; }
  .status-chip.done{        --glyph: "✓"; }
}

/* AGE-CHIPS v2 — readable pill using the bucket colours */
.age-chip{
  --ring: color-mix(in srgb, currentColor 50%, transparent);   /* stronger outline */
  --bg:   color-mix(in srgb, currentColor 26%, transparent);   /* stronger fill */
  display:inline-flex; align-items:center;
  padding:4px 9px;                   /* +1px breathing room */
  border-radius:999px;
  font-weight:800;                   /* crisper numerals */
  font-size:12.5px;
  line-height:1;
  border:1px solid var(--ring);
  background:var(--bg);
  font-variant-numeric: tabular-nums;
}
/* === AGE FREEZE (Planned Winter Project) === */
.age-chip.frozen{
  position: relative;
  padding-right: 22px;       /* room for the snowflake */
  border-style: dashed;      /* subtle visual cue */
  /* IMPORTANT: let the base chip use --bg; don't override it here */
  background: var(--bg);
  cursor: help;
}
/* snowflake badge */
.age-chip.frozen::after{
  content: "❄";
  font-size: 12px;
  line-height: 1;
  position: absolute;
  right: 6px;
  top: 50%;
  transform: translateY(-50%);
  opacity: .9;
}

/* keep bucket colours; only the bg strength varies */
.age-chip.age-fresh   { color:#10b981; }  /* < 7d  */
.age-chip.age-stale   { color:#b45309; }  /* 7–30d */
.age-chip.age-old     { color:#dc2626; --bg: color-mix(in srgb, currentColor 32%, transparent); }
.age-chip.age-ancient { color:#991b1b; --bg: color-mix(in srgb, currentColor 38%, transparent); }

/* extra pop in dark mode */
.dark .age-chip{
  text-shadow: 0 1px 0 rgba(0,0,0,.35);
  box-shadow: 0 0 0 1px color-mix(in srgb, currentColor 30%, transparent);
}

.age-chip:focus-visible{
  outline: 2px solid color-mix(in srgb, currentColor 55%, transparent);
  outline-offset: 2px;
}

/* Controls + sticky + search + filter chips (merged) */
.sticky-top{
  position: sticky;
  top: 0;
  z-index: 120;
  background: var(--paper);
  margin:0 0 12px;
  padding:10px 0 14px;
  display:flex;
  flex-direction:column;
  gap:12px;
  box-shadow:0 1px 0 var(--grid);
}

/* Scrim under sticky controls — pure overlay, no layout impact */
.sticky-top::after{
  content:"";
  position: fixed;                 /* overlay, not part of layout */
  left: 0;
  right: 0;                        /* avoids 100vw jitter */
  top: var(--sticky-controls-offset);
  height: var(--thead-height, 40px);
  background: var(--paper);
  pointer-events: none;
  z-index: 111;                    /* below sticky thead (112), below controls (120) */
}

/* keep these */
.sticky-top{ z-index:120; }

/* optional: keep vertical scrollbar width constant on all pages */
html{ overflow-y: scroll; }

.controls{
  display:flex;
  gap:12px;
  align-items:center;
  font-size:12px;
  flex-wrap:wrap;
}
.controls input[type="file"], .controls textarea{ font:inherit; }

/* Search input (works whether or not it’s inside .controls, but it is) */
.search-input{
  flex:1 1 280px;
  min-width:220px;
  max-width:460px;
  order:-1;
  padding:9px 16px;
  border-radius:999px;
  border:2px solid color-mix(in srgb, var(--als-blue) 65%, transparent);
  background:color-mix(in srgb, var(--als-blue) 12%, var(--paper));
  color:var(--ink);
  font:inherit;
  font-weight:600;
  box-shadow:0 4px 10px color-mix(in srgb, var(--als-blue) 18%, transparent);
  transition:border-color .18s ease, box-shadow .18s ease, background-color .18s ease;
  appearance:none;
}
.search-input::placeholder{ color:color-mix(in srgb, var(--ink) 45%, transparent); font-weight:500; }
.search-input:focus-visible{
  outline:none;
  border-color:var(--als-blue);
  box-shadow:0 0 0 3px color-mix(in srgb, var(--als-blue) 30%, transparent);
  background:color-mix(in srgb, var(--als-blue) 20%, var(--paper));
}

/* Filter selects */
.filter-group{ display:flex; align-items:center; gap:6px; font-weight:600; color:var(--ink); }
.filter-group select{
  font:inherit;
  padding:6px 10px;
  border:1px solid var(--grid);
  border-radius:8px;
  background:var(--paper);
  color:inherit;
  cursor:pointer;
}
.filter-group select:focus-visible{ outline:2px solid color-mix(in srgb, var(--als-blue) 65%, transparent); outline-offset:2px; }

/* Buttons */
.btn{ padding:6px 10px; border:1px solid var(--als-blue); border-radius:8px; background:var(--paper); color:var(--als-blue); font-weight:700; cursor:pointer; }

/* Active filter chips row (non-sticky) */
.active-filter-chips{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin:-4px 0 0;
  padding:0;
}
.active-filter-chips[hidden]{ display:none; }
.filter-chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  border-radius:999px;
  border:1px solid color-mix(in srgb, var(--als-blue) 32%, var(--grid));
  background:color-mix(in srgb, var(--als-blue) 14%, var(--paper));
  color:var(--ink);
  font-weight:600;
  font-size:12px;
  cursor:pointer;
  max-width:100%;
  text-align:left;
  transition:background .2s ease, border-color .2s ease, color .2s ease;
}
.filter-chip:hover{
  background:color-mix(in srgb, var(--als-blue) 22%, var(--paper));
  border-color:color-mix(in srgb, var(--als-blue) 48%, var(--grid));
}
.filter-chip:focus-visible{
  outline:2px solid color-mix(in srgb, var(--als-blue) 65%, transparent);
  outline-offset:2px;
}
.filter-chip__label{
  display:inline-block;
  max-width:min(280px, 100%);
  white-space:normal;
  word-break:break-word;
}
.filter-chip__icon{ font-size:16px; line-height:1; }

/* --- Per-site dashboards --- */
.nav{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 0; }
.nav .tab{ padding:8px 12px; border:1px solid var(--grid); border-radius:999px; cursor:pointer; background:var(--paper); color:var(--ink); font-weight:700; }
.nav .tab[aria-selected="true"]{ border-color:var(--als-blue); box-shadow:0 0 0 2px color-mix(in srgb, var(--als-blue) 25%, transparent); }
    /* === Chips & tabs tweaks (mobile-friendly) === */

/* 1) Active-filter chips: clearer spacing + label */
.active-filter-chips{
  align-items: center;
  margin-top: 4px;
  margin-bottom: 12px;  /* space above the site tabs */
}
.active-filter-chips::before{
  content: "Active filters";
  font-size: 11px;
  font-weight: 700;
  letter-spacing: .4px;
  color: var(--muted);
  margin-right: 8px;
}

/* 2) Visually separate site tabs from chips */
.nav .tab{
  background: transparent;
  border-color: var(--grid);
  box-shadow: none;
}
.nav .tab[aria-selected="true"]{
  background: color-mix(in srgb, var(--als-blue) 8%, var(--paper));
  border-color: var(--als-blue);
  box-shadow: 0 0 0 2px color-mix(in srgb, var(--als-blue) 25%, transparent);
}

/* 3) Mobile: chips scroll horizontally instead of wrapping */
@media (max-width: 700px){
  .active-filter-chips{
    gap: 6px;
    overflow-x: auto;
    flex-wrap: nowrap;
    padding-bottom: 2px;
    -webkit-overflow-scrolling: touch;
  }
  .active-filter-chips .filter-chip{ flex: 0 0 auto; }
  .nav{ margin-top: 6px; }
}

.kpi-panels{ min-height:72px; }
.dash-kpis[hidden]{ display:none !important; }
.kpis{display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin:0;}
.card{ background:var(--paper); border:1px solid var(--grid); border-radius:14px; padding:12px; }
.card h3{ margin:0 0 6px; font-size:12px; text-transform:uppercase; letter-spacing:.5px; color:var(--muted); }
.card .big{ font-size:22px; font-weight:900; }
    /* Clickable KPI state */
.kpi-clickable{
  cursor: pointer;
  user-select: none;
  transition: box-shadow .18s ease, border-color .18s ease, background-color .18s ease;
}
.kpi-clickable:hover{
  box-shadow: 0 0 0 2px color-mix(in srgb, var(--als-blue) 25%, transparent);
  border-color: var(--als-blue);
}
.kpi-clickable[aria-pressed="true"]{
  background: color-mix(in srgb, var(--als-blue) 12%, var(--paper));
  border-color: var(--als-blue);
  box-shadow: 0 0 0 2px color-mix(in srgb, var(--als-blue) 25%, transparent);
}
.dash{ display:none; }
.dash[data-active="true"]{ display:block; }

/* a11y helper */
.visually-hidden{
  position:absolute;
  width:1px;
  height:1px;
  padding:0;
  margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  white-space:nowrap;
  border:0;
}

@media (min-width: 960px){
  table{ table-layout:auto; }
}

/* responsive tweaks */
@media (max-width: 960px){
  .page{
    --page-pad-top:32px;
    --page-pad-inline:32px;
    --page-pad-bottom:44px;
  }
}

@media (max-width: 680px){
  .page{
    --page-pad-top:24px;
    --page-pad-inline:18px;
    --page-pad-bottom:32px;
  }
  .page-head{ flex-direction:column; align-items:flex-start; gap:12px; }
  .title{ font-size:24px; margin-bottom:4px; }
  .logo{ height:42px; }
  .controls{ gap:10px; }
  .controls textarea{ width:100%; min-width:0; }
  .controls .search-input{ flex-basis:100%; max-width:none; }
}

    @media print{
      @page{ size: A4 landscape; margin: 10mm; }
      body{ font-size:11.5px; }
      thead{ display:table-header-group; }
      table{ width:100% !important; table-layout:fixed; border-collapse:collapse; }
      th, td{ box-sizing:border-box; overflow-wrap:anywhere; word-break:break-word; hyphens:auto; }
      thead th { position: static; }
      .title-cell, .col-categories{ break-inside:avoid; }
      html{-webkit-print-color-adjust:exact;}
      .controls{ display:none !important; }
      .active-filter-chips{ display:none !important; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="page-head">
      <h1 class="title">Work Orders List</h1>
      <img class="logo" alt="Aberdeen Laundry Services" src="LOGOlesswhitespace.png">
    </div>
        <div class="top-rule"></div>

<div class="sticky-top" role="region" aria-label="Table controls and overview">
  <!-- NEW: tiny bar with a collapse/expand button -->
  <div class="sticky-top__bar">
    <button id="collapseBtn"
            class="btn btn--pill"
            type="button"
            aria-expanded="true"
            aria-controls="stickyContent">
      Hide controls
    </button>
  </div>

<section class="legend legend--full" role="note" aria-label="Legend">
  <h2 class="legend__title">Index</h2>
  <ul class="legend__list">
    <li class="legend__sample"><span class="status-chip open">Open</span><span>Open work order</span></li>
    <li class="legend__sample"><span class="status-chip in-progress">In&nbsp;Progress</span><span>Currently being worked</span></li>
    <li class="legend__sample"><span class="status-chip on-hold">On&nbsp;Hold</span><span>Paused</span></li>
    <li class="legend__sample"><span class="status-chip done">Done</span><span>Completed</span></li>

    <li class="legend__sample"><span class="age-chip age-stale">12d</span><span>Age (d/h/m); darker = older</span></li>
    <li class="legend__sample"><span class="age-chip age-old frozen" title="Planned Winter Project">12d</span><span>❄ Planned Winter Project (frozen)</span></li>

    <li class="legend__sample"><span class="legend__rail" aria-hidden="true"></span><span>“Priority” row (red rail + faint blue wash)</span></li>
    <li class="legend__sample"><span class="chip-cat">Category</span><span>Category tags</span></li>

    <li class="legend__sample"><span class="legend__kpi">KPI</span><span>Tiles are clickable filters</span></li>
  </ul>
</section>

  <!-- NEW: everything collapses inside this wrapper -->
  <div id="stickyContent" class="sticky-content">
    <div class="controls" role="region" aria-label="Table controls">
      <input type="search" id="globalSearch" class="search-input" placeholder="Search work orders" aria-label="Search work orders">
      <label class="btn" for="file">Upload CSV/TSV/JSON</label>
      <input id="file" type="file" accept=".csv,.tsv,.json,application/json,text/csv,text/tab-separated-values" style="display:none" />
      <button class="btn" id="themeBtn" type="button">Dark mode</button>
      <button class="btn" id="exportCsvBtn" type="button" disabled>Export CSV</button>
      <button class="btn" id="refreshBtn" type="button">Refresh</button>
      <div id="weekPicker" class="filter-group"></div>
<!-- Legend popover trigger -->
<div class="legend-popover">
  <button class="btn" id="legendBtn" type="button"
          aria-haspopup="dialog" aria-expanded="false"
          aria-controls="legendPanel">Index</button>

  <div id="legendPanel" class="legend-popover__panel" role="dialog" aria-label="Legend quick reference">
    <section class="legend legend--compact">
      <h2 class="legend__title">Index</h2>
      <ul class="legend__list">
        <li class="legend__sample"><span class="status-chip open">Open</span><span>Open work order</span></li>
        <li class="legend__sample"><span class="status-chip in-progress">In&nbsp;Progress</span><span>Currently being worked</span></li>
        <li class="legend__sample"><span class="status-chip on-hold">On&nbsp;Hold</span><span>Paused</span></li>
        <li class="legend__sample"><span class="status-chip done">Done</span><span>Completed</span></li>
        <li class="legend__sample"><span class="age-chip age-stale">12d</span><span>Age (d/h/m); darker = older</span></li>
        <li class="legend__sample"><span class="age-chip age-old frozen" title="Planned Winter Project">12d</span><span>❄ Planned Winter Project (frozen)</span></li>
        <li class="legend__sample"><span class="legend__rail" aria-hidden="true"></span><span>“Priority” row (red rail + faint blue wash)</span></li>
        <li class="legend__sample"><span class="chip-cat">Category</span><span>Category tags</span></li>
        <li class="legend__sample"><span class="legend__kpi">KPI</span><span>Tiles are clickable filters</span></li>
      </ul>
    </section>
  </div>
</div>

      <label class="filter-group">
        <span>Status</span>
        <select id="statusFilter" name="status-filter">
          <option value="">All</option>
          <option value="open">Open</option>
          <option value="in-progress">In Progress</option>
          <option value="on-hold">On Hold</option>
          <option value="done">Done</option>
          <option value="not:done">Not: Done</option>
        </select>
      </label>

      <label class="filter-group">
        <span>Priority</span>
        <select id="priorityFilter" name="priority-filter">
          <option value="">All</option>
          <option value="critical">Critical</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
      </label>
    </div>

    <div id="activeFilterChips" class="active-filter-chips" hidden aria-live="polite"></div>

    <!-- Tabs -->
    <div class="nav" role="tablist" aria-label="Site dashboards">
      <button class="tab" role="tab" id="tab-all"   aria-controls="dash-all"   aria-selected="true">All Sites</button>
      <button class="tab" role="tab" id="tab-ek"    aria-controls="dash-ek"    aria-selected="false">EK / Cathkin</button>
      <button class="tab" role="tab" id="tab-mm"    aria-controls="dash-mm"    aria-selected="false">Mugiemoss</button>
      <button class="tab" role="tab" id="tab-keith" aria-controls="dash-keith" aria-selected="false">Keith</button>
      <button class="tab" role="tab" id="tab-by"    aria-controls="dash-by"    aria-selected="false">Byron</button>
    </div>

    <div class="kpi-panels" aria-live="polite">
      <section id="kpi-all"   class="dash dash-kpis" data-kind="kpis" data-site="all"   data-active="true"  aria-labelledby="tab-all"></section>
      <section id="kpi-ek"    class="dash dash-kpis" data-kind="kpis" data-site="ek"    data-active="false" aria-labelledby="tab-ek" hidden></section>
      <section id="kpi-mm"    class="dash dash-kpis" data-kind="kpis" data-site="mm"    data-active="false" aria-labelledby="tab-mm" hidden></section>
      <section id="kpi-keith" class="dash dash-kpis" data-kind="kpis" data-site="keith" data-active="false" aria-labelledby="tab-keith" hidden></section>
      <section id="kpi-by"    class="dash dash-kpis" data-kind="kpis" data-site="by"    data-active="false" aria-labelledby="tab-by" hidden></section>
    </div>
  </div>
</div>

    <!-- Dashboards -->
    <section id="dash-all"   class="dash dash-table" data-kind="table" data-site="all"   data-active="true"  role="tabpanel" aria-labelledby="tab-all"></section>
    <section id="dash-ek"    class="dash dash-table" data-kind="table" data-site="ek"    data-active="false" role="tabpanel" aria-labelledby="tab-ek" hidden></section>
    <section id="dash-mm"    class="dash dash-table" data-kind="table" data-site="mm"    data-active="false" role="tabpanel" aria-labelledby="tab-mm" hidden></section>
    <section id="dash-keith" class="dash dash-table" data-kind="table" data-site="keith" data-active="false" role="tabpanel" aria-labelledby="tab-keith" hidden></section>
    <section id="dash-by"    class="dash dash-table" data-kind="table" data-site="by"    data-active="false" role="tabpanel" aria-labelledby="tab-by" hidden></section>
  </div>

<script>

  let __loadController = null;

  const $loading = document.getElementById('loadingOverlay');
const showLoading = () => { if ($loading) $loading.style.display = 'grid'; };
const hideLoading = () => { if ($loading) $loading.style.display = 'none'; };

async function loadChosenGid(meta){
  if (__loadController) __loadController.abort();
  __loadController = new AbortController();

  try{
    if (!meta || !meta.gid) {
      throw new Error('Selected week is missing a valid gid');
    }

    const url = meta.url ? meta.url : csvUrlForGid(meta.gid);
    console.log('[loadChosenGid] gid:', meta.gid, 'url:', url);

    const res = await fetch(url, { signal: __loadController.signal });
    if(!res.ok) {
      // show status code/message if Google returns an error
      throw new Error(`Fetch failed (${res.status} ${res.statusText})`);
    }

    const text = await res.text();
    if (!text || !text.trim()) {
      throw new Error('Fetched CSV is empty');
    }
    console.log('[loadChosenGid] first 200 chars of CSV:', text.slice(0,200));

    let headers, rows;
    try {
      ({ headers, rows } = parseDelimited(text));
    } catch (pErr) {
      console.error('[parseDelimited] failed:', pErr);
      throw new Error('Could not parse CSV – check delimiters/quotes');
    }

    try {
      rows = dedupeRows(rows);
    } catch (dErr) {
      console.error('[dedupeRows] failed:', dErr);
      throw new Error('Row dedupe failed – check required columns like ID/Title/Created on');
    }

    LAST_HEADERS = headers;
    ALL_ROWS     = rows;
    setWeekBadge(meta.label || meta.weekEnd);

    try {
      ingestToDashboards(LAST_HEADERS, ALL_ROWS);
    } catch (rErr) {
      console.error('[ingest/render] failed:', rErr);
      throw new Error('Rendering failed – see console for details');
    }
  } catch (e){
    if (e.name !== 'AbortError') {
      console.error('[loadChosenGid] error:', e);
      alert('Could not load the selected week. ' + (e?.message || ''));
    }
  } finally {
    __loadController = null;
  }
}
  
// Published CSV of the *Index* tab
const SHEET_INDEX_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRJocigDhxneJtrUmezFU7FcWpzSSah8-Wb6Rce8NA1f7jKcINgYU29iYRqt5QQymWATX5zs5k8_rK0/pub?single=true&output=csv&gid=105348743';
  
// --- Layout helpers ---
const $stickyTop = document.querySelector('.sticky-top');
const rootStyle = document.documentElement.style;
function updateStickyControlsOffset(){
  if(!$stickyTop || !rootStyle) return;
  const styles = getComputedStyle($stickyTop);
  const marginBottom = parseFloat(styles.marginBottom) || 0;
  const offset = $stickyTop.getBoundingClientRect().height + marginBottom;
  rootStyle.setProperty('--sticky-controls-offset', `${offset}px`);
}
updateStickyControlsOffset();
window.addEventListener('resize', updateStickyControlsOffset);
window.addEventListener('load', updateStickyControlsOffset);
if('ResizeObserver' in window && $stickyTop){
  const observer = new ResizeObserver(updateStickyControlsOffset);
  observer.observe($stickyTop);
}

  const MS = { min:6e4, hour:36e5, day:864e5 };
  const MIN_AGE_MINUTES = 30;

function parseCreated(r){ return parseDateLoose(r['Created on']); }
function parseCompleted(r){ return parseDateLoose(r['Completed on']); }

function ageMs(row){
  const created = parseCreated(row); if(!created) return null;
  const done = /^done$/i.test(row['Status']);
  const end = done ? (parseCompleted(row) || new Date()) : new Date();
  const diff = end - created;
  return Number.isFinite(diff) && diff >= 0 ? diff : null;
}

function ageBucket(ms){
  if(ms==null) return 'fresh';
  const d = ms / MS.day;
  if(d < 7) return 'fresh';
  if(d < 30) return 'stale';
  if(d < 90) return 'old';
  return 'ancient';
}

function fmtAge(ms){
  if(ms == null) return '—';
  if(ms < MS.hour){
    const minutes = Math.floor(ms / MS.min);
    const clamped = Math.max(MIN_AGE_MINUTES, minutes);
    return `${clamped}m`;
  }
  if(ms < MS.day){
    return `${Math.floor(ms / MS.hour)}h`; // under 24h: hours only
  }
  // ≥ 24h: days only (no hours)
  const d = Math.floor(ms / MS.day);
  return `${d}d`;
}

function normalizeAgeLabel(raw){
  if(raw == null) return raw;
  const trimmed = String(raw).trim();
  const match = trimmed.match(/^(\d+)\s*m(?:in(?:s)?)?$/i);
  if(match){
    const minutes = parseInt(match[1], 10);
    const clamped = Math.max(MIN_AGE_MINUTES, minutes);
    return `${clamped}m`;
  }
  return trimmed;
}

function getAgeLabel(row){
  if(!row) return '—';
  const ms = row.__ageMs;
  if(ms != null){
    return fmtAge(ms);
  }
  const normalized = normalizeAgeLabel(row['Age']);
  return normalized || '—';
}

// --- State cache for rendering ---
let LAST_HEADERS = null;
let ALL_ROWS = null;
let __LAST_FILTERS_JSON = null;

const $exportCsvBtn = document.getElementById('exportCsvBtn');

function hasSheetData(){
  return Array.isArray(LAST_HEADERS) && LAST_HEADERS.length > 0;
}

function updateExportButtonsState(){
  const hasData = hasSheetData();
  [$exportCsvBtn].forEach(btn => {
    if(!btn) return;
    btn.disabled = !hasData;
    if(!hasData){
      btn.title = 'Sheet data is still loading';
    }else{
      btn.removeAttribute('title');
    }
  });
}
updateExportButtonsState();

function csvEscape(value){
  const str = String(value ?? '');
  return /[",\n\r]/.test(str) ? `"${str.replace(/"/g,'""')}"` : str;
}

  /* ========= Week arrows hookup ========= */

/* cache the weeks list + current selection so external arrows can work */
let __WEEKS = [];          // [{label, weekEnd, gid}, ...]
let __WEEK_SELECTED = null; // string weekEnd

function setSelectedWeek(weekObj){
  // remember selection for external arrows
  __WEEK_SELECTED = weekObj?.weekEnd || null;
  rememberWeek(weekObj);

  // update URL (?week=...)
  const url = new URL(location.href);
  url.searchParams.set('week', weekObj.weekEnd);
  url.searchParams.delete('gid');
  history.replaceState({}, '', url);

  // load that gid
  loadChosenGid(weekObj);
}

/* Move by an offset relative to the current option (list is newest-first) */
function gotoWeekByOffset(offset){
  if (!__WEEKS.length) return;
  const idx = __WEEKS.findIndex(w => w.weekEnd === __WEEK_SELECTED);
  const next = idx + offset;
  if (next < 0 || next >= __WEEKS.length) return;
  setSelectedWeek(__WEEKS[next]);
  // also refresh enable/disable state on any arrows we can see
  refreshWeekArrowDisabled();
}

/* Enable/disable whichever arrow buttons exist */
function refreshWeekArrowDisabled(){
  const idx = __WEEKS.findIndex(w => w.weekEnd === __WEEK_SELECTED);
  const prevs = document.querySelectorAll('#weekPrev,[data-week-nav="prev"]');
  const nexts = document.querySelectorAll('#weekNext,[data-week-nav="next"]');
  prevs.forEach(btn => btn.disabled = (idx === __WEEKS.length - 1));
  nexts.forEach(btn => btn.disabled = (idx <= 0));
}

/* Bind any external arrow buttons (call after weeks are known) */
function wireExternalWeekArrows(){
  const prevs = document.querySelectorAll('#weekPrev,[data-week-nav="prev"]');
  const nexts = document.querySelectorAll('#weekNext,[data-week-nav="next"]');
  prevs.forEach(btn => {
    btn.type = btn.type || 'button';
    btn.addEventListener('click', () => gotoWeekByOffset(+1)); // newer-first list → +1 is “previous” (older)
  });
  nexts.forEach(btn => {
    btn.type = btn.type || 'button';
    btn.addEventListener('click', () => gotoWeekByOffset(-1)); // move towards newer
  });
  refreshWeekArrowDisabled();
}

  function debounce(fn, ms=160){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

/* ========= integrate with your existing functions ========= */

/* 1) After we fetch the index and choose the week, remember it globally */
async function loadLatestOrChosenWeek(forceBust=false){
  try{
    let weeks;
    if (forceBust){
      const bustUrl = new URL(SHEET_INDEX_CSV_URL);
      bustUrl.searchParams.set('_ts', Date.now());
      weeks = await loadWeeksIndexFrom(bustUrl.toString());
    } else {
      weeks = await loadWeeksIndex();
    }
    if (!weeks.length) throw new Error('Index is empty');

    __WEEKS = weeks.slice();                                // <—
    const chosen = chooseInitialWeek(__WEEKS);
    __WEEK_SELECTED = chosen.weekEnd;                       // <—

    renderWeekControls(__WEEKS, chosen);
    rememberWeek(chosen);
    await loadChosenGid(chosen);

    wireExternalWeekArrows();                               // <— bind external arrows
    refreshWeekArrowDisabled();
  }catch(err){
    console.error(err);
    alert('Could not load the latest dashboard. Check the Index publish URL and columns (label, week_end, gid).');
  }
}
  
document.addEventListener('DOMContentLoaded', () => {
  PREFERRED_ACTIVE_DASH = 'dash-all';
  loadLatestOrChosenWeek();  // this will call ingest → setActiveDash(...) for you
});
  
function renderWeekControls(weeks, chosen){
  const wrap = document.getElementById('weekPicker');
  if(!wrap) return;
  wrap.innerHTML = '';

  const label = document.createElement('span');
  label.textContent = 'Week';

  const sel = document.createElement('select');

  sel.innerHTML = weeks.map((w, i) => {
    const isSelected = (w.weekEnd === chosen.weekEnd);
    return `<option value="${i}"${isSelected ? ' selected' : ''}>
              ${esc(w.label || w.weekEnd)}
            </option>`;
  }).join('');

  sel.addEventListener('change', () => {
    const idx = Number(sel.value);
    const wk = weeks[idx];
    if (wk){
      setSelectedWeek(wk);
      refreshWeekArrowDisabled();
    }
  });

  wrap.append(label, sel);
  refreshWeekArrowDisabled();
}

  function setSelectedWeek(weekObj){
  __WEEK_SELECTED = weekObj?.weekEnd || null;
  rememberWeek(weekObj);

  const url = new URL(location.href);
  url.searchParams.set('week', weekObj.weekEnd);
  url.searchParams.delete('gid');
  history.replaceState({}, '', url);

  // keep the <select> showing the current choice
  const sel = document.querySelector('#weekPicker select');
  if (sel){
    const i = __WEEKS.findIndex(w => w.weekEnd === weekObj.weekEnd);
    if (i >= 0) sel.value = String(i);
  }

  loadChosenGid(weekObj);
}
  
function renderRowsSmart(tbodyEl, headers, rows, container){
  if (isMobileView() || (rows?.length ?? 0) < 600) {
    return renderRowsScoped(tbodyEl, headers, rows, container);
  }
  return renderRowsScopedChunked(tbodyEl, headers, rows, container);
}

function renderRowsScoped(tbodyEl, headers, rows, container){
  const mobile = isMobileView();
  const safeRows = Array.isArray(rows) ? rows : [];
  if (!tbodyEl) return;

  if (!mobile){
    tbodyEl.innerHTML = safeRows.map(row => {
      const rowCls = hasPriorityCategory(row) ? 'row-priority' : '';
      return `<tr class="${rowCls}">` + headers.map(h => {
        const key = String(h||'').trim().toLowerCase();
        const v = row[h];

        if (key === 'categories'){
          return `<td data-col="Categories"><div class="chip-stack">${buildCategoryChips(v)}</div></td>`;
        }
        if (key === 'status'){
          return `<td data-col="Status"><span class="status-chip ${statusClass(v)}">${esc(v)}</span></td>`;
        }
        if (key === 'age'){
          const ms      = row.__ageMs;
          const bucket  = row.__ageBucket || ageBucket(ms);
          const label   = esc(getAgeLabel(row));
          const baseT   = ms != null ? `${(ms/86400000).toFixed(1)} days` : 'Unknown';
          const frozen  = isWinterPlanned(row);
          const pwp     = categoryColors['planned-winter-project'] || { background:'#E7F3FE', foreground:'#1887FC' };
          const style   = frozen ? ` style="--bg:${pwp.background}; --ring: color-mix(in srgb, ${pwp.foreground} 50%, transparent); color:${pwp.foreground}"` : '';
          const cls     = `age-chip age-${bucket}` + (frozen ? ' frozen' : '');
const title   = frozen ? `Planned for Winter • ${baseT}` : baseT;
          const aria    = frozen ? ' aria-label="Planned for Winter"' : '';
          return `<td data-col="Age"><span class="${cls}"${style} title="${esc(title)}"${aria}>${label}</span></td>`;
        }
        return `<td data-col="${esc(h)}">${esc(v)}</td>`;
      }).join('') + `</tr>`;
    }).join('\n');

    const hasRows = safeRows.length > 0;
    container?.__tableWrap && (container.__tableWrap.hidden = mobile || !hasRows);
    container?.__mobileSortWrap && (container.__mobileSortWrap.hidden = !mobile || !hasRows);
    container?.__mobileCards && (container.__mobileCards.hidden = true);
    container?.__emptyState && (container.__emptyState.hidden = hasRows);
    updateTheadHeight();
    return;
  }

  tbodyEl.innerHTML = '';
  if (container?.__mobileCards){
    container.__mobileCards.innerHTML = (Array.isArray(rows) ? rows : []).map(cardHTML).join('');
    const hasRows = (rows?.length ?? 0) > 0;
    container.__tableWrap && (container.__tableWrap.hidden = true);
    container.__mobileSortWrap && (container.__mobileSortWrap.hidden = !hasRows);
    container.__mobileCards.hidden = !hasRows;
    container.__emptyState && (container.__emptyState.hidden = hasRows);
  }
}

function renderRowsScopedChunked(tbodyEl, headers, rows, container){
  if (isMobileView() || !tbodyEl) {
    return renderRowsScoped(tbodyEl, headers, rows, container);
  }

  const safe = Array.isArray(rows) ? rows : [];
  tbodyEl.innerHTML = '';
  const CHUNK = 400;
  let i = 0;

  function paintChunk(){
    let html = '';
    for (let c = 0; c < CHUNK && i < safe.length; c++, i++){
      const row = safe[i];
      const rowCls = hasPriorityCategory(row) ? 'row-priority' : '';
      html += `<tr class="${rowCls}">` + headers.map(h => {
        const key = String(h||'').trim().toLowerCase();
        const v = row[h];

        if (key === 'categories'){
          return `<td data-col="Categories"><div class="chip-stack">${buildCategoryChips(v)}</div></td>`;
        }
        if (key === 'status'){
          return `<td data-col="Status"><span class="status-chip ${statusClass(v)}">${esc(v)}</span></td>`;
        }
        if (key === 'age'){
          const ms      = row.__ageMs;
          const bucket  = row.__ageBucket || ageBucket(ms);
          const label   = esc(getAgeLabel(row));
          const baseT   = ms != null ? `${(ms/86400000).toFixed(1)} days` : 'Unknown';
          const frozen  = isWinterPlanned(row);
          const pwp     = categoryColors['planned-winter-project'] || { background:'#E7F3FE', foreground:'#1887FC' };
          const style   = frozen ? ` style="--bg:${pwp.background}; --ring: color-mix(in srgb, ${pwp.foreground} 50%, transparent); color:${pwp.foreground}"` : '';
          const cls     = `age-chip age-${bucket}` + (frozen ? ' frozen' : '');
          const title   = frozen ? `Planned for Winter • ${baseT}` : baseT;
          const aria    = frozen ? ' aria-label="Planned for Winter"' : '';
          return `<td data-col="Age"><span class="${cls}"${style} title="${esc(title)}"${aria}>${label}</span></td>`;
        }
        return `<td data-col="${esc(h)}">${esc(v)}</td>`;
      }).join('') + `</tr>`;
    }

    if (html){
      const tmp = document.createElement('tbody');
      tmp.innerHTML = html;
      while (tmp.firstChild){
        tbodyEl.appendChild(tmp.firstChild);
      }
    }

    if (i < safe.length){
      requestAnimationFrame(paintChunk);
    } else {
      const hasRows = safe.length > 0;
      container?.__tableWrap && (container.__tableWrap.hidden = isMobileView() || !hasRows);
      container?.__mobileSortWrap && (container.__mobileSortWrap.hidden = !isMobileView() || !hasRows);
      container?.__mobileCards && (container.__mobileCards.hidden = true);
      container?.__emptyState && (container.__emptyState.hidden = hasRows);
      updateTheadHeight();
    }
  }

  requestAnimationFrame(paintChunk);
}

function buildCsv(headers, rows){
  const safeHeaders = Array.isArray(headers) ? headers : [];
  const safeRows = Array.isArray(rows) ? rows : [];
  const headerLine = safeHeaders.map(csvEscape).join(',');
  const lines = safeRows.map(row => safeHeaders.map(h => csvEscape(row?.[h])).join(','));
  return '\ufeff' + [headerLine, ...lines].join('\r\n');
}

function escapeForExcel(value){
  return esc(String(value ?? '')).replace(/\r?\n/g, '<br>');
}

function buildExcelHTML(headers, rows){
  const safeHeaders = Array.isArray(headers) ? headers : [];
  const head = `<tr>${safeHeaders.map(h => `<th>${escapeForExcel(h)}</th>`).join('')}</tr>`;
  const body = (Array.isArray(rows) ? rows : []).map(row => {
    const cells = safeHeaders.map(h => `<td>${escapeForExcel(row?.[h])}</td>`).join('');
    return `<tr>${cells}</tr>`;
  }).join('');
  return `<!DOCTYPE html><html><head><meta charset="utf-8" /></head><body><table><thead>${head}</thead><tbody>${body}</tbody></table></body></html>`;
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.style.display = 'none';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  setTimeout(()=>URL.revokeObjectURL(url), 0);
}

function exportTimestamp(){
  return new Date().toISOString().replace(/[:.]/g,'-');
}

function exportSheetAsCsv(){
  if(!hasSheetData()){ alert('Sheet data is still loading.'); return; }
  const csv = buildCsv(LAST_HEADERS, ALL_ROWS);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  downloadBlob(blob, `work-orders-${exportTimestamp()}.csv`);
}

$exportCsvBtn?.addEventListener('click', ()=>{ if(!$exportCsvBtn.disabled) exportSheetAsCsv(); });

// ---------- Utility + theming (unchanged bits you already had) ----------
const ESC_MAP = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}; const ESC_RE=/[&<>"']/g;
function esc(s){ return String(s==null?'':s).replace(ESC_RE, c => ESC_MAP[c]); }
function slugify(str){ return str.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,''); }

function applyColumnWidths(table, headers){
  const widthMap = {
    'ID':'66px',
    'Title':'200px',
    'Status':'120px',
    'Priority':'92px',
    'Assigned to':'160px',
    'Created on':'110px',
    'Completed on':'110px',
    'Last updated':'120px',
    'Age':'96px',
    'Location':'160px',
    'Asset':'150px',
    'Categories':'140px'
  };
  const colgroup = document.createElement('colgroup');
  headers.forEach(h=>{
    const col = document.createElement('col');
    if(widthMap[h]) col.style.minWidth = widthMap[h];
    colgroup.appendChild(col);
  });
  table.prepend(colgroup);
}

// Category presets + fallback coloring
const CATEGORY_COLOR_PRESETS=[['Search','#E7F3FE','#1887FC'],['Cleaning','#FCEBFF','#EA7BFF'],['Commission','#E7DFFD','#855EF4'],['Contractor','#FFE6CC','#A24900'],['Daily Procedures','#FFE5DF','#FF7C60'],['Damage','#FFF5CC','#CC9900'],['Electrical','#FFE4D0','#FF7439'],['Eng Weekly Meeting','#FFE5DF','#FF7C60'],['Error Codes','#FFDBE6','#FF4A80'],['Fire Safety','#FFDBE6','#FF4A80'],['First Time Fix','#E7F3FE','#1887FC'],['General improvements','#E7DFFD','#855EF4'],['Inspection','#E7F3FE','#1887FC'],['James Indust Cleaner','#D9F5F1','#3FCBBB'],['Leak','#DDF9FC','#1887FC'],['Manufacturers Machine Service Procedure','#FCEBFF','#EA7BFF'],['Mechanical','#E7F3FE','#1A66CC'],['meters','#E7F3FE','#1570B8'],['Monthly Procedures','#FFE4D0','#FF7439'],['Ordering/Purchasing','#DDF9FC','#54DFF2'],['Planned Winter Project','#E7F3FE','#1887FC'],['Plumbing','#FCEBFF','#B24BEA'],['PPM','#E4F9E8','#2FB95A'],['Preventive','#E4F9E8','#2FB95A'],['Product Quality improvements','#E7F3FE','#1887FC'],['Programming','#FFE4D0','#D85E2E'],['Project','#E7F3FE','#2A7BEF'],['Reactive Maintenance','#DDF9FC','#2CCFE3'],['Refrigeration','#D9F5F1','#3FCBBB'],['Safety','#E7F3FE','#1870DA'],['Site maintenance responsabilities','#E7F3FE','#1868C0'],['Smart Check','#FFDBE6','#E43C75'],['Standard Operating Procedure','#FFDBE6','#E43C75'],['Top 5','#E7DFFD','#6D4CE6'],['Training','#E7F3FE','#1870DA'],['Weekly Procedures','#E7F3FE','#1870DA'],['Yearly Procedures','#FFF5CC','#8A6E00'],['Priority', '#FFE2E2', '#E11D48'],['Zero Emissions','#D9F5F1','#2AAE9E']];
const categoryColors = CATEGORY_COLOR_PRESETS.reduce((a,[label,bg,fg]) => (a[slugify(label)]={background:bg,foreground:fg}, a),{});
(function injectCategoryCSS(){
  const styleEl=document.createElement('style');
  styleEl.textContent = Object.entries(categoryColors).map(([slug,c]) => `.chip-cat.cat-${slug}{background:${c.background};color:${c.foreground};border-color:${c.foreground};}`).join('');
  document.head.appendChild(styleEl);
})();
function hashCategory(label){ let h=0, s=String(label||''); for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return Math.abs(h); }
function hslToRgb(h,s,l){ const hue=((h%360)+360)%360, S=Math.max(0,Math.min(100,s))/100, L=Math.max(0,Math.min(100,l))/100; const c=(1-Math.abs(2*L-1))*S, x=c*(1-Math.abs(((hue/60)%2)-1)), m=L-c/2; let r1=0,g1=0,b1=0; if(hue<60){r1=c;g1=x;} else if(hue<120){r1=x;g1=c;} else if(hue<180){g1=c;b1=x;} else if(hue<240){g1=x;b1=c;} else if(hue<300){r1=x;b1=c;} else {r1=c;b1=x;} return [r1+m,g1+m,b1+m]; }
function srgbToLinear(c){ return c<=0.04045?c/12.92:Math.pow((c+0.055)/1.055,2.4); }
function relativeLuminance(rgb){ const [r,g,b]=rgb.map(v=>srgbToLinear(Math.max(0,Math.min(1,v)))); return 0.2126*r+0.7152*g+0.0722*b; }
function contrastRatio(bgH,fgH){ const lBg=relativeLuminance(hslToRgb(bgH.h,bgH.s,bgH.l)), lFg=relativeLuminance(hslToRgb(fgH.h,fgH.s,fgH.l)); const light=Math.max(lBg,lFg), dark=Math.min(lBg,lFg); return (light+0.05)/(dark+0.05); }
function fallbackColors(label){ const hue=hashCategory(label)%360, bg={h:hue,s:45,l:92}, fg0={h:hue,s:60,l:32}; let fg={...fg0}; while(contrastRatio(bg,fg)<4.5 && fg.l>0){ fg={...fg,l:Math.max(0,fg.l-10)}; } return {background:`hsl(${bg.h}, ${bg.s}%, ${bg.l}%)`, foreground:`hsl(${fg.h}, ${fg.s}%, ${fg.l}%)`}; }
function chipStyle(label, slugOverride){ const slug=slugOverride||slugify(label), preset=categoryColors[slug]; if(preset) return {className:`cat-${slug}`, style:''}; const c=fallbackColors(label); return {className:`cat-${slug}`, style:`background:${c.background};border-color:${c.foreground};color:${c.foreground}`}; }
  function hasPriorityCategory(row){
  const cats = String(row['Categories'] || '')
    .split(/[,;]+/)
    .map(s => slugify(s.trim()))
    .filter(Boolean);
  return cats.includes(slugify('Priority'));
}
// --- Name aliases / shortening ---
const NAME_ALIASES = new Map([
  ['callum keith engineering team', 'Callum'],
  ['east kilbride engineering team', 'Jim and Ciaren'],
  // add more here...
]);

function shortenName(s){
  const raw = String(s || '').trim();
  if (!raw) return '';
  const parts = raw.split(/[,;/]+/).map(p => p.trim()).filter(Boolean);
  const alias = (x) => NAME_ALIASES.get(x.toLowerCase().replace(/\s+/g,' '));
  const first = (x) => x.split(/\s+/)[0];

  if (parts.length > 1){
    const uniq = [...new Set(parts.map(p => alias(p) || first(p)))];
    return uniq.join(', ');
  }
  return alias(raw) || first(raw);
}

  // Always pass `search`, not `searchTerm`, to the chips UI
function updateChipsFromFilters(f){
  updateActiveFilterChips({
    status: f.status,
    excludeStatus: f.excludeStatus,
    priority: f.priority,
    search: f.searchTerm,   // <- the important mapping
  });
}

// CSV / JSON ingest helpers
function parseDelimited(text){
  const sep = text.includes('\t') ? '\t' : ',';
  const rows = text.trim().split(/\r?\n/).map(r =>
    r.split(new RegExp(`${sep}(?=(?:[^"]*"[^"]*")*[^"]*$)`)).map(c => c.replace(/^"|"$/g,''))
  );
  const rawHeaders = rows.shift() || [];
  const headers = rawHeaders.map((h,i)=>String(h??'').replace(/^\uFEFF/,'').trim()||`col${i}`);
  const data = rows.map(r => Object.fromEntries(r.map((v,i)=>[headers[i]||`col${i}`, v])));
  return { headers, rows: data };
}
function handleJSON(text){
  const data = JSON.parse(text);
  const rows = Array.isArray(data) ? data : (Array.isArray(data.rows) ? data.rows : []);
  const headers = rows.length ? Object.keys(rows[0]) : [];
  return { headers, rows };
}

// Site helpers / sorting / status
function toSiteKey(loc){ const s=String(loc||'').toLowerCase(); if(s.includes('byron'))return'by'; if(s.includes('mugiemoss')||s.includes('bucksburn'))return'mm'; if(s.includes('keith'))return'keith'; if(s.includes('cathkin')||s.includes('east kilbride')||s.includes('ek'))return'ek'; return'other'; }
function kpiCard(label,val){ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<h3>${esc(label)}</h3><div class="big">${esc(val)}</div>`; return el; }
const PRIORITY_ORDER=['critical','high','medium','low','']; const STATUS_ORDER=['open','in-progress','on-hold','done',''];
function parseDateLoose(v){
  if(!v) return null;
  const m=String(v).trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2}))?$/);
  if(!m) return null;
  let [,d,M,y,hh='00',mm='00']=m;
  d=d.padStart(2,'0');
  M=M.padStart(2,'0');
  hh=hh.padStart(2,'0');
  const dt=new Date(`${y}-${M}-${d}T${hh}:${mm}:00`);
  return isNaN(dt.getTime())?null:dt;
}
  // === DEDUPE HELPERS ===
function bestTimestamp(r){
  return (parseDateLoose(r['Last updated'])?.getTime())
      || (parseDateLoose(r['Completed on'])?.getTime())
      || (parseDateLoose(r['Created on'])?.getTime())
      || 0;
}
function normalizeId(v){
  return String(v ?? '')
    .trim()
    .replace(/^WO-?/i,'')        // optional: strip "WO-" prefixes
    .replace(/[^\w]/g,'')        // drop punctuation/spaces
    .toLowerCase();
}
function dedupeRows(rows){
  const map = new Map();
  for(const r of (rows||[])){
    const id = normalizeId(r['ID']);
    // fallback key if ID is empty
    const fallback = String(r['Title']||'').trim().toLowerCase()
                   + '|' + (parseDateLoose(r['Created on'])?.toISOString()?.slice(0,10) || '');
    const key = id || fallback;

    const prev = map.get(key);
    if(!prev){ map.set(key, r); continue; }

    // keep the most recently updated copy
    if(bestTimestamp(r) > bestTimestamp(prev)) map.set(key, r);
  }
  return [...map.values()];
}

  function makeStatusKpi(label, statusValue, count, container){
  const el = kpiCard(label, count);
  el.classList.add('kpi-clickable');
  el.setAttribute('role','button');
  el.setAttribute('tabindex','0');
  el.setAttribute('title', `Toggle status filter: ${label}`);
  el.setAttribute('aria-label', `Toggle status filter: ${label}`);

  // pressed when this status filter is active (and not negated)
  const f = getFilters();
  const pressed = f.status === statusClass(statusValue) && !f.excludeStatus;
  el.setAttribute('aria-pressed', pressed ? 'true' : 'false');

  const toggle = () => {
    const curr = getFilters();
    const isOn = curr.status === statusClass(statusValue) && !curr.excludeStatus;

    // clear any "Oldest only" focus when switching to a status filter
    if (container) { container.__focusOldest = false; updateOldestOnlyChip(container); }

    // toggle the <select> so chips/UI stay in sync
    $statusFilter.value = isOn ? '' : statusValue;
    $statusFilter.dispatchEvent(new Event('change', { bubbles:true }));
  };

  el.addEventListener('click', toggle);
  el.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); }
  });

  return el;
}

// Build per-tab CSV links by swapping the gid on the SAME published doc:
const BASE_PUBLISH_URL = (() => {
  const u = new URL(SHEET_INDEX_CSV_URL);
  // strip any gid from the index link and keep everything else
  u.searchParams.delete('gid');
  return u.toString(); // .../pub?single=true&output=csv
})();

function csvUrlForGid(gid){
  const u = new URL(BASE_PUBLISH_URL);
  u.searchParams.set('gid', String(gid));
  // ensure single/output stay correct
  u.searchParams.set('single','true');
  u.searchParams.set('output','csv');
  return u.toString();
}

/* --- Parse the Index (label, week_end, gid) with aliases + diagnostics --- */
async function loadWeeksIndex(){
  return loadWeeksIndexFrom(SHEET_INDEX_CSV_URL);
}

async function loadWeeksIndexFrom(url){
    console.log('Index CSV URL:', url);   // 👈 add here
  const res = await fetch(url);
  if(!res.ok) throw new Error('Index load failed: ' + res.status);

  const text = await res.text();
  const { headers, rows } = parseDelimited(text);

  // Normalize headers once
  const normHeaders = headers.map(h => String(h || '').trim());
  const findHeader = (...candidates) => {
    const wanted = candidates.map(c => String(c).trim().toLowerCase());
    const idx = normHeaders.findIndex(h => wanted.includes(h.toLowerCase()));
    return idx >= 0 ? headers[idx] : null;
  };

  // Accept common aliases
  const H_LABEL   = findHeader('label', 'week label', 'title', 'name');
  const H_WEEKEND = findHeader('week_end', 'week end', 'week', 'weekending', 'week-ending', 'week_end_date', 'date', 'week ending (iso)');
  const H_GID     = findHeader('gid', 'sheet_gid', 'tab_gid', 'tab id', 'sheet id', 'sheetid', 'tabid', 'sheet');

  // Optional URL column (we can extract gid=12345 from it)
  const H_URL     = findHeader('url', 'sheet url', 'link');

  if (!H_GID && !H_URL){
    console.error('[Index] Headers present:', headers);
    throw new Error('Index is missing a "gid" or "url" column');
  }
  if (!H_LABEL || !H_WEEKEND){
    console.warn('[Index] Using partial headers. Found:', { H_LABEL, H_WEEKEND, H_GID, H_URL, headers });
  }

  const gidFromUrl = (u) => {
    if (!u) return null;
    // Handles ...edit#gid=123, ...pub?gid=123, etc.
    const m = String(u).match(/[?#&]gid=(\d+)/);
    return m ? m[1] : null;
  };

const out = rows.map(r => {
  const label   = H_LABEL   ? r[H_LABEL]   : (r[H_WEEKEND] || '').trim();
  const weekEnd = H_WEEKEND ? r[H_WEEKEND] : '';
  const urlRaw  = H_URL ? String(r[H_URL] || '').trim() : '';
  let gid       = H_GID ? r[H_GID] : null;
  if (!gid && urlRaw) gid = gidFromUrl(urlRaw);
  const url     = urlRaw || null;     // keep the URL if provided
  return { label, weekEnd, gid, url };
}).filter(x => x && (x.gid || x.url));

  if (!out.length){
    console.error('[Index] No usable rows. Headers:', headers, 'Sample row:', rows[0]);
    throw new Error('Index has no rows with a gid');
  }

  // newest first by week_end (string compare ok if YYYY-MM-DD)
  out.sort((a,b) => String(b.weekEnd).localeCompare(String(a.weekEnd)));
  return out;
}

/* --- Selection + persistence --- */
const LS_LAST_WEEK = 'alsLastWeekEnd';
function getUrlParam(n){ return new URLSearchParams(location.search).get(n); }
function rememberWeek(w){ try{ localStorage.setItem(LS_LAST_WEEK, w.weekEnd); }catch{} }

function chooseInitialWeek(weeks){
  const q = new URLSearchParams(location.search);
  const byGid  = q.get('gid');
  const byDate = q.get('week');
  const forceLatest = q.get('latest') === '1';

  let chosen = null;
  if (byGid)   chosen = weeks.find(w => String(w.gid) === String(byGid));
  if (!chosen && byDate) chosen = weeks.find(w => String(w.weekEnd) === String(byDate));
  if (!chosen && !forceLatest){
    const last = localStorage.getItem(LS_LAST_WEEK);
    if (last) chosen = weeks.find(w => String(w.weekEnd) === last);
  }
  return chosen || weeks[0]; // newest
}

function setWeekBadge(text){
  const titleEl = document.querySelector('.title'); 
  if(!titleEl) return;

  let badge = document.getElementById('week-badge');
  if(!badge){
    badge = document.createElement('span');
    badge.id = 'week-badge';
    badge.style.marginLeft   = '10px';
    badge.style.fontSize     = '12px';
    badge.style.fontWeight   = '800';
    badge.style.padding      = '4px 8px';
    badge.style.border       = '1px solid var(--grid)';
    badge.style.borderRadius = '999px';
    badge.style.background   = 'color-mix(in srgb, var(--als-blue) 10%, var(--paper))';
    titleEl.appendChild(badge);
  }
  badge.textContent = `Week: ${text || 'Latest'}`;
}

function normalizePriority(v){ if(v==null) return ''; let slug=slugify(String(v).trim()); if(!slug) return''; if(slug.endsWith('-priority')) slug=slug.replace(/-priority$/,''); if(slug==='med'||slug==='normal') slug='medium'; if(slug==='urgent'||slug==='emergency') slug='critical'; return slug; }
function cmpPriority(a,b){ const ia=PRIORITY_ORDER.indexOf(normalizePriority(a)), ib=PRIORITY_ORDER.indexOf(normalizePriority(b)); const safe=i=>(i===-1?PRIORITY_ORDER.length:i); const diff=safe(ia)-safe(ib); return diff||String(a??'').localeCompare(String(b??''),undefined,{numeric:true,sensitivity:'base'}); }
function statusClass(v){ const map=new Map([['done','done'],['complete','done'],['completed','done'],['open','open'],['in-progress','in-progress'],['in progress','in-progress'],['progress','in-progress'],['inprogress','in-progress'],['on-hold','on-hold'],['on hold','on-hold'],['hold','on-hold'],['onhold','on-hold']]); const s=slugify(String(v||'')); return map.get(s)||s; }
function cmpStatus(a,b){ const ia=STATUS_ORDER.indexOf(statusClass(a)), ib=STATUS_ORDER.indexOf(statusClass(b)); const safe=i=>(i===-1?STATUS_ORDER.length:i); const diff=safe(ia)-safe(ib); return diff||String(a??'').localeCompare(String(b??''),undefined,{numeric:true,sensitivity:'base'}); }
function cmpId(a,b){ const na=parseInt(String(a).replace(/\D+/g,''),10)||0; const nb=parseInt(String(b).replace(/\D+/g,''),10)||0; return na-nb; }
function detectType(col, rows){
  const n = String(col || '').trim().toLowerCase();

  // 👇 early exit for our virtual Age column
  if (n === 'age' || n === 'age (days)') return 'number';

  const sample = rows.slice(0, 10).map(r => r[col]);
  const allDates = sample.length && sample.every(v => parseDateLoose(v) !== null);
  const allNums  = sample.length && sample.every(v =>
    typeof v === 'number' || /^\s*[-+]?\d+(\.\d+)?\s*$/.test(String(v))
  );

  if (allDates)  return 'date';
  if (allNums)   return 'number';
  if (n === 'id')       return 'id';
  if (n === 'priority') return 'priority';
  if (n === 'status')   return 'status';
  return 'string';
}

// ---------- Shared sort + UI helpers ----------
function applySort(rows, column, direction){
  const list = Array.isArray(rows) ? rows : [];
  if (!column) return list.slice();

  const dir = direction === 'asc' ? 'asc' : 'desc';
  const f   = dir === 'asc' ? 1 : -1;

  // --- Special-case: Age column
  if (String(column).toLowerCase().startsWith('age')) {
    const MIN = -1; // pushes unknowns to the top/bottom depending on dir
    const toMs = (row) => {
      // 1) preferred: precomputed raw ms
      if (row.__ageMs != null) return row.__ageMs;

      const v = row[column];

      // 2) numeric age (e.g. "Age (days)" as number)
      if (typeof v === 'number' && Number.isFinite(v)) {
        return v * 24 * 60 * 60 * 1000;
      }
      // 3) human string like "14d 6h 3m"
      if (typeof v === 'string' && v.trim()){
        const m = v.match(/^\s*(?:(\d+)\s*d)?\s*(?:(\d+)\s*h)?\s*(?:(\d+)\s*m)?\s*$/i);
        if (m && (m[1] || m[2] || m[3])) {
          const d  = +m[1] || 0;
          const h  = +m[2] || 0;
          const mm = +m[3] || 0;
          return (((d * 24) + h) * 60 + mm) * 60 * 1000;
        }
        // also accept plain numeric strings as days
        if (/^\s*[-+]?\d+(\.\d+)?\s*$/.test(v)) {
          return parseFloat(v) * 24 * 60 * 60 * 1000;
        }
      }
      // 4) fallback: compute from "Created on"
      const created = parseDateLoose(row['Created on']);
      return created ? (Date.now() - created.getTime()) : MIN;
    };

    return [...list].sort((a,b) => f * (toMs(a) - toMs(b)));
  }

  // --- normal types
  const type = detectType(column, list);
  return [...list].sort((a,b)=>{
    const va = a[column], vb = b[column];
    if (type === 'date'){
      const da = parseDateLoose(va), db = parseDateLoose(vb);
      return f * ((da?.getTime() || 0) - (db?.getTime() || 0));
    }
    if (type === 'number'){
      return f * ((parseFloat(va) || 0) - (parseFloat(vb) || 0));
    }
    if (type === 'priority'){ return f * cmpPriority(va, vb); }
    if (type === 'status'){   return f * cmpStatus(va, vb); }
    if (type === 'id'){       return f * cmpId(va, vb); }
    return f * String(va ?? '').localeCompare(String(vb ?? ''), undefined, { numeric:true, sensitivity:'base' });
  });
}

function clearDesktopSortIndicators(container){
  container?.__thead?.querySelectorAll('th').forEach(th=>{
    th.removeAttribute('data-sort');
    th.setAttribute('aria-sort','none');
  });
}
function syncDesktopSortIndicators(container, column, direction){
  container?.__thead?.querySelectorAll('th').forEach(th=>{
    const col = th.getAttribute('data-col');
    if(col===column){
      th.setAttribute('data-sort', direction);
      th.setAttribute('aria-sort', direction==='asc'?'ascending':'descending');
    }else{
      th.removeAttribute('data-sort');
      th.setAttribute('aria-sort','none');
    }
  });
}
function updateMobileSortDirectionButton(container){
  const btn = container?.__mobileSortDirectionBtn;
  if(!btn) return;
  const dir = container.__mobileSortDirection==='asc'?'asc':'desc';
  btn.dataset.direction = dir;
  btn.textContent = dir==='asc' ? 'Ascending' : 'Descending';
  btn.setAttribute('aria-label', `Toggle sort direction (currently ${btn.textContent.toLowerCase()})`);
}
function setSortState(container, column, direction){
  if(!container) return;
  const dir = direction==='asc'?'asc':'desc';
  container.__currentSort = column ? { column, direction: dir } : null;
  container.__mobileSortDirection = dir;

  if(container.__mobileSortSelect){
    container.__mobileSortSelect.value = column || '';
    container.__mobileSortDirectionBtn.disabled = !column || !isMobileView() || !(container.__rows?.length);
  }
  if(column) syncDesktopSortIndicators(container, column, dir);
  else clearDesktopSortIndicators(container);

  updateMobileSortDirectionButton(container);
}

  function handleMobileSort(container){
  if(!container) return;
  const select = container.__mobileSortSelect;
  const tbodyEl = container.__tbody;
  const headers = container.__headers;
  if(!select || !tbodyEl || !headers) return;

  const column = select.value;
  const base = container.__rawRows ? container.__rawRows.slice() : [];

  if(!column){
    container.__rows = base.slice();
    setSortState(container, null, 'desc');
    renderRowsScoped(tbodyEl, headers, base, container);
    return;
  }

  const dir = container.__mobileSortDirection || 'desc';
  const sorted = applySort(base, column, dir);
  container.__rows = sorted.slice();
  setSortState(container, column, dir);
  renderRowsScoped(tbodyEl, headers, sorted, container);
}

function toggleMobileSortDirection(container){
  if(!container) return;
  const select = container.__mobileSortSelect;
  const tbodyEl = container.__tbody;
  const headers = container.__headers;
  if(!select || !select.value || !tbodyEl || !headers) return;

  const next = (container.__mobileSortDirection === 'asc') ? 'desc' : 'asc';
  const base = (container.__rows && container.__rows.length)
    ? container.__rows
    : (container.__rawRows || []);

  const sorted = applySort(base, select.value, next);
  container.__rows = sorted.slice();
  setSortState(container, select.value, next);
  renderRowsScoped(tbodyEl, headers, sorted, container);
}

// small helper so we can reuse category chip markup
  // === Freeze rule: red age + "Planned Winter Project" category ===
function isWinterPlanned(row){
  const cats = String(row['Categories'] || '');
  const hasPWP = /\bplanned\s*winter\s*project\b/i.test(cats);
  const bucket = row.__ageBucket || ageBucket(row.__ageMs);
  return hasPWP && (bucket === 'old' || bucket === 'ancient'); // only “red” ages
}

function buildCategoryChips(value){
  const seen=new Set();
  return String(value||'')
    .split(/[,;]+/)
    .map(c=>c.trim()).filter(Boolean)
    .map(cat=>{
      const slug=slugify(cat);
      if(seen.has(slug)) return '';
      seen.add(slug);
      const { className, style } = chipStyle(cat, slug);
      const styleAttr = style ? ` style="${style}"` : '';
      const classAttr = className ? ` ${className}` : '';
      return `<span class="chip-cat${classAttr}"${styleAttr}>${esc(cat)}</span>`;
    }).filter(Boolean).join('');
}

// Filters
const $searchInput = document.getElementById('globalSearch');
const $statusFilter = document.getElementById('statusFilter');
const $priorityFilter = document.getElementById('priorityFilter');
const $activeFilterChips = document.getElementById('activeFilterChips');
  let PREFERRED_ACTIVE_DASH = null;

function getActiveDashId(){
  // Prefer the active TABLE panel, fall back to any .dash, then dash-all
  return document.querySelector('.dash-table[data-active="true"]:not([hidden])')?.id
      || document.querySelector('.dash[data-active="true"]:not([hidden])')?.id
      || 'dash-all';
}

function humanizeFilterValue(value){
  return String(value || '')
    .split(/[-_\s]+/)
    .filter(Boolean)
    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
    .join(' ');
}

function updateActiveFilterChips(filters){
  if(!$activeFilterChips) return;

  const chips=[];

  if(filters.status){
    const label=humanizeFilterValue(filters.status);
    const text=filters.excludeStatus?`Status ≠ ${label}`:`Status: ${label}`;
    const aria=filters.excludeStatus?`Clear status filter (not ${label})`:`Clear status filter: ${label}`;
   chips.push({
  key:'status',
  text,
  aria,
  onRemove:()=>{
    if($statusFilter){
      $statusFilter.value='';
      $statusFilter.dispatchEvent(new Event('change',{bubbles:true}));
    }
  }
});
  }

  if(filters.priority){
    const label=humanizeFilterValue(filters.priority);
    const text=`Priority: ${label}`;
    const aria=`Clear priority filter: ${label}`;
    chips.push({
      key:'priority',
      text,
      aria,
      onRemove:()=>{
        if($priorityFilter){
          $priorityFilter.value='';
          $priorityFilter.dispatchEvent(new Event('change',{bubbles:true}));
        }
      }
    });
  }

  if(filters.search){
    const text=`Search: ${filters.search}`;
    const aria=`Clear search filter: ${filters.search}`;
    chips.push({
  key:'search',
  text,
  aria,
  onRemove:()=>{
    if($searchInput){
      $searchInput.value='';
      // fire input so filtering runs immediately
      $searchInput.dispatchEvent(new Event('input',{bubbles:true}));
      $searchInput.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }
});
  }

  if(!chips.length){
    $activeFilterChips.innerHTML='';
    $activeFilterChips.setAttribute('hidden','');
    return;
  }

  const frag=document.createDocumentFragment();
  chips.forEach(chip=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='filter-chip';
    btn.dataset.filter=chip.key;
    btn.setAttribute('aria-label', chip.aria);
    btn.title=chip.aria;

    const label=document.createElement('span');
    label.className='filter-chip__label';
    label.textContent=chip.text;

    const icon=document.createElement('span');
    icon.className='filter-chip__icon';
    icon.setAttribute('aria-hidden','true');
    icon.textContent='×';

    btn.append(label, icon);
    btn.addEventListener('click', chip.onRemove);
    frag.appendChild(btn);
  });

  $activeFilterChips.innerHTML='';
  $activeFilterChips.removeAttribute('hidden');
  $activeFilterChips.appendChild(frag);
}

function getFilters(){
  const rawStatus = ($statusFilter?.value || '').trim().toLowerCase();
  let status = '';
  let excludeStatus = false;

  // use the real input you have in the HTML
  const searchTerm = ($searchInput?.value || '').trim();

  if(rawStatus){
    const negMatch = rawStatus.match(/^(?:not[:\s]+|!)(.+)$/);
    if(negMatch){
      status = negMatch[1].trim();
      excludeStatus = true;
    }else{
      status = rawStatus;
    }
  }

  status = status ? statusClass(status) : '';
  if(!status){
    excludeStatus = false;
  }

  return {
    status,
    excludeStatus,
    priority: normalizePriority($priorityFilter?.value || ''),
    searchTerm
  };
}

const SEARCH_KEYS = ['ID','Title','Status','Priority','Assigned to','Created by','Created on','Completed on','Last updated','Location','Asset','Categories','Age'];

function buildHaystack(row){
  if(!row) return '';
  return SEARCH_KEYS
    .map(key => String(row[key] ?? ''))
    .join(' ')
    .toLowerCase();
}

function applyFilters(rows){
  const filters = getFilters();

  // Keep the chips UI updated (mapped to `search`)
  updateChipsFromFilters(filters);

  const { status, excludeStatus, priority, searchTerm } = filters;
  const tokens = searchTerm ? searchTerm.toLowerCase().split(/\s+/).filter(Boolean) : [];

  return rows.filter(r => {
    const rowStatus = statusClass(r['Status']);
    const okStatus = !status ? true : (excludeStatus ? rowStatus !== status : rowStatus === status);
    const okPrio   = !priority || normalizePriority(r['Priority']) === priority;

    let okSearch = true;
    if(tokens.length){
      const hay = r.__haystack || '';
      okSearch = tokens.every(t => hay.includes(t));
    }

    return okStatus && okPrio && okSearch;
  });
}
  function updatePriorityOnlyChip(container){
  if(!$activeFilterChips || !container) return;
  const existing = $activeFilterChips.querySelector('[data-filter="priority-tag"]');

  if(!container.__priorityOnly){
    existing?.remove();
    if(!$activeFilterChips.querySelector('.filter-chip')) $activeFilterChips.setAttribute('hidden','');
    return;
  }

  $activeFilterChips.removeAttribute('hidden');
  const btn = existing || document.createElement('button');
  btn.type='button';
  btn.className='filter-chip';
  btn.dataset.filter='priority-tag';
  btn.setAttribute('aria-label','Clear “Priority” category filter');
  btn.title='Clear “Priority” category filter';
  btn.innerHTML = `<span class="filter-chip__label">Category: Priority</span><span class="filter-chip__icon" aria-hidden="true">×</span>`;
  btn.onclick = ()=>{
    container.__priorityOnly = false;

    let working = (container.__rawRows || []).slice();

    // keep “Oldest only” behavior if it’s on
if (container.__focusOldest){
  const pick = working
    .filter(r => !isWinterPlanned(r))     // ← add this
    .reduce((acc, r) => {
      const ms = r.__ageMs ?? ageMs(r);
      if (ms == null) return acc;
      return (!acc || ms > (acc.__ageMs ?? ageMs(acc))) ? r : acc;
    }, null);
  working = pick ? [pick] : [];
}

    const s = container.__currentSort;
    if (s && s.column) working = applySort(working, s.column, s.direction);

    container.__rows = working.slice();
renderRowsSmart(container.__tbody, container.__headers, working, container);

    // un-press the KPI card if present
    container.__prioKpiCard?.setAttribute('aria-pressed','false');

    updatePriorityOnlyChip(container);
    updateTheadHeight();
  };

  if(!existing) $activeFilterChips.appendChild(btn);
}

function updateOldestOnlyChip(container){
  if(!$activeFilterChips || !container) return;
  const existing = $activeFilterChips.querySelector('[data-filter="oldest-only"]');

  if(!container.__focusOldest){
    existing?.remove();
    if(!$activeFilterChips.querySelector('.filter-chip')) $activeFilterChips.setAttribute('hidden','');
    return;
  }

  $activeFilterChips.removeAttribute('hidden');
  const btn = existing || document.createElement('button');
  btn.type='button';
  btn.className='filter-chip';
  btn.dataset.filter='oldest-only';
  btn.setAttribute('aria-label','Clear oldest-only filter');
  btn.title='Clear oldest-only filter';
  btn.innerHTML = `<span class="filter-chip__label">Oldest only</span><span class="filter-chip__icon" aria-hidden="true">×</span>`;
  btn.onclick = ()=>{
    container.__focusOldest = false;

    let working = (container.__rawRows || []).slice();
    const s = container.__currentSort;
    if (s && s.column) working = applySort(working, s.column, s.direction);

    container.__rows = working.slice();
renderRowsSmart(container.__tbody, container.__headers, working, container);

    // only update the KPI in this site's panel
    const site = container.dataset.site || container.id.replace(/^dash-/, '');
    const kpiCardBtn = document.querySelector(`.dash-kpis[data-site="${site}"] .kpi-clickable`);
    kpiCardBtn?.setAttribute('aria-pressed','false');

    updateOldestOnlyChip(container);
    updateTheadHeight();
  };
  
  // ⬇️ these two lines were missing
  if(!existing) $activeFilterChips.appendChild(btn);
}
  
// Rendering
function renderDashboard(container, headers, rows){
  // keep previous sort direction if we re-render this dash
  const prevSort = container.__currentSort;
  const prevDir  = container.__mobileSortDirection || (prevSort?.direction ?? 'desc');

  container.innerHTML='';

  const siteKey = container.dataset.site || container.id.replace(/^dash-/, '');
  const kpiContainer = siteKey ? document.querySelector(`.dash-kpis[data-site="${siteKey}"]`) : null;

  // KPIs
  const kpiWrap=document.createElement('div'); kpiWrap.className='kpis';
  const open =rows.filter(r=>/^open$/i.test(r.Status)).length;
  const prog =rows.filter(r=>/^in\s*progress$/i.test(r.Status)).length;
  const hold =rows.filter(r=>/^on\s*hold$/i.test(r.Status)).length;
  const done =rows.filter(r=>/^done$/i.test(r.Status)).length;
// Counts (clickable toggles)
kpiWrap.appendChild(makeStatusKpi('Open',        'open',        open, container));
kpiWrap.appendChild(makeStatusKpi('In Progress', 'in-progress', prog, container));
kpiWrap.appendChild(makeStatusKpi('On Hold',     'on-hold',     hold, container));
kpiWrap.appendChild(makeStatusKpi('Done',        'done',        done, container));

// --- Oldest Age – clickable filter
const oldestEntry = rows
  .filter(r => !isWinterPlanned(r)) // ignore frozen
  .reduce((acc, r) => {
    const ms = r.__ageMs ?? ageMs(r);
    if (ms == null) return acc;
    return (!acc || ms > acc.ms) ? { row:r, ms } : acc;
  }, null);

if (oldestEntry) {
  const oldestCard = kpiCard('Oldest Age', fmtAge(oldestEntry.ms));
  oldestCard.classList.add('kpi-clickable');
  oldestCard.setAttribute('role','button');
  oldestCard.setAttribute('tabindex','0');
  oldestCard.setAttribute('aria-pressed', container.__focusOldest ? 'true' : 'false');
  oldestCard.setAttribute('title','Show only the oldest work order (toggle)');
  oldestCard.setAttribute('aria-label','Toggle oldest work order filter');

const applyFocusOldest = () => {
  container.__focusOldest = !container.__focusOldest;
  oldestCard.setAttribute('aria-pressed', container.__focusOldest ? 'true' : 'false');

  // start from this site's filtered rows
  let working = (container.__rawRows || []).slice();

  // keep Priority toggle if it’s on
  if (container.__priorityOnly) {
    working = working.filter(hasPriorityCategory);
  }

if (container.__focusOldest) {
  const pick = working
    .filter(r => !isWinterPlanned(r))
    .reduce((acc, r) => {
      const ms = r.__ageMs ?? ageMs(r);
      if (ms == null) return acc;
      return (!acc || ms > (acc.__ageMs ?? ageMs(acc))) ? r : acc;
    }, null);
  working = pick ? [pick] : [];
}

  // honor current sort
  const s = container.__currentSort;
  if (s && s.column) working = applySort(working, s.column, s.direction);

  container.__rows = working.slice();
renderRowsSmart(container.__tbody, container.__headers, working, container);
  updateOldestOnlyChip(container);
  updateTheadHeight();
};

  oldestCard.addEventListener('click', applyFocusOldest);
  oldestCard.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); applyFocusOldest(); }
  });

  kpiWrap.appendChild(oldestCard);
}

// --- Priority WOs – always show
const prioTagCount = rows.filter(hasPriorityCategory).length;
const prioCard = kpiCard('Priority WOs', prioTagCount);
prioCard.classList.add('kpi-clickable');
prioCard.setAttribute('role','button');
prioCard.setAttribute('tabindex','0');
prioCard.setAttribute('aria-pressed', container.__priorityOnly ? 'true' : 'false');
prioCard.setAttribute('title','Show only rows that include the “Priority” category (toggle)');
prioCard.setAttribute('aria-label','Toggle Priority category filter');
container.__prioKpiCard = prioCard;

const togglePrio = () => {
  container.__priorityOnly = !container.__priorityOnly;
  prioCard.setAttribute('aria-pressed', container.__priorityOnly ? 'true' : 'false');

  let working = (container.__rawRows || []).slice();
  if (container.__priorityOnly) {
    working = working.filter(hasPriorityCategory);
  }
if (container.__focusOldest) {
  const pick = working
    .filter(r => !isWinterPlanned(r))     // ← ignore frozen PWPs
    .reduce((acc, r) => {
      const ms = r.__ageMs ?? ageMs(r);
      if (ms == null) return acc;
      return (!acc || ms > (acc.__ageMs ?? ageMs(acc))) ? r : acc;
    }, null);
  working = pick ? [pick] : [];
}

  const s = container.__currentSort;
  if (s && s.column) working = applySort(working, s.column, s.direction);

  container.__rows = working.slice();
renderRowsSmart(container.__tbody, container.__headers, working, container);
  updatePriorityOnlyChip(container);
  updateTheadHeight();
};

prioCard.addEventListener('click', togglePrio);
prioCard.addEventListener('keydown', e => {
  if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); togglePrio(); }
});

kpiWrap.appendChild(prioCard);

  if(kpiContainer){ kpiContainer.innerHTML=''; kpiContainer.appendChild(kpiWrap); }

  // --- shell: table + mobile containers (both exist; CSS decides visibility) ---
  const tableWrap=document.createElement('div'); tableWrap.className='table-scroll';
  const table=document.createElement('table');
  const thead=document.createElement('thead');
  const tbody=document.createElement('tbody');
  applyColumnWidths(table, headers); // ✅ add this line
  table.append(thead, tbody); tableWrap.appendChild(table);

  const mobileSortWrap=document.createElement('div'); mobileSortWrap.className='mobile-sort';
  const selectId=`${container.id || siteKey || 'dash'}-mobile-sort`;
  const mobileSortLabel=document.createElement('label');
  mobileSortLabel.className='mobile-sort__label';
  mobileSortLabel.setAttribute('for', selectId);
  mobileSortLabel.textContent='Sort by';
  const mobileSortSelect=document.createElement('select');
  mobileSortSelect.id=selectId; mobileSortSelect.className='mobile-sort__select';
  const defOpt=document.createElement('option'); defOpt.value=''; defOpt.textContent='Default order';
  mobileSortSelect.appendChild(defOpt);
  headers.forEach(h=>{ const o=document.createElement('option'); o.value=h; o.textContent=h; mobileSortSelect.appendChild(o); });
  const mobileSortDirBtn=document.createElement('button');
  mobileSortDirBtn.type='button'; mobileSortDirBtn.className='mobile-sort__direction';
  mobileSortDirBtn.setAttribute('aria-label','Toggle sort direction');
  mobileSortWrap.append(mobileSortLabel, mobileSortSelect, mobileSortDirBtn);

  const mobileCards=document.createElement('div'); mobileCards.className='mobile-cards';
  const emptyState=document.createElement('div'); emptyState.className='dash-empty'; emptyState.textContent='No work orders match the current filters.'; emptyState.hidden=true;

  container.append(tableWrap, mobileSortWrap, mobileCards, emptyState);

  // cache refs on the dashboard section element
  container.__headers = headers.slice();
  container.__tableWrap = tableWrap;
  container.__thead = thead;
  container.__tbody = tbody;
  container.__mobileCards = mobileCards;
  container.__mobileSortWrap = mobileSortWrap;
  container.__mobileSortSelect = mobileSortSelect;
  container.__mobileSortDirectionBtn = mobileSortDirBtn;
  container.__emptyState = emptyState;

  // table header + sorting (desktop)
  thead.innerHTML = `<tr>${headers.map(h=>`<th scope="col" data-col="${esc(h)}" tabindex="0"><span>${esc(h)}</span><span class="sort-arrow" aria-hidden="true"></span></th>`).join('')}</tr>`;
  thead.querySelectorAll('th').forEach(th=>{
    th.setAttribute('aria-sort','none');
    th.addEventListener('click', ()=> sortScoped(th, container));
    th.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); sortScoped(th, container); } });
  });

  // mobile sort UI
  mobileSortSelect.addEventListener('change', ()=> handleMobileSort(container));
  mobileSortDirBtn.addEventListener('click', ()=>{ if(!mobileSortDirBtn.disabled) toggleMobileSortDirection(container); });

  // initial data & sort
  const baseRows = rows.slice();
  container.__rawRows = baseRows.slice();
  let working = baseRows;
  if(prevSort && headers.includes(prevSort.column)){
    working = applySort(baseRows, prevSort.column, prevDir);
  }
// If "Oldest Age" toggle is active, reduce to just that one row (ignore frozen PWP)
if (container.__focusOldest) {
  const pick = working
    .filter(r => !isWinterPlanned(r))
    .reduce((acc, r) => {
      const ms = r.__ageMs ?? ageMs(r);
      if (ms == null) return acc;
      return (!acc || ms > (acc.__ageMs ?? ageMs(acc))) ? r : acc;
    }, null);
  working = pick ? [pick] : [];
}

  // apply the priority-tag filter when enabled
  if (container.__priorityOnly) {
    working = working.filter(hasPriorityCategory);
  }
  container.__rows = working.slice();
  setSortState(container, prevSort?.column || null, prevDir);

  // draw once for current viewport, then measure sticky
renderRowsSmart(tbody, headers, working, container);
  updateOldestOnlyChip(container);   // <-- add this
  updatePriorityOnlyChip(container);
  updateTheadHeight();
}

function sortScoped(th, container){
  if(!container) return;
  const tbodyEl = container.__tbody;
  const headers = container.__headers;
  if(!tbodyEl || !headers) return;

  const col = th.getAttribute('data-col');
  if(!col) return;

  // toggle direction (if same col -> flip; else default to asc)
  const current = container.__currentSort;
  const nextDir =
    current && current.column === col && current.direction === 'asc'
      ? 'desc'
      : 'asc';

  const base = (container.__rows && container.__rows.length)
    ? container.__rows
    : (container.__rawRows || []);

  const sorted = applySort(base, col, nextDir);
  container.__rows = sorted.slice();

  setSortState(container, col, nextDir);               // updates desktop + mobile UI
  renderRowsScoped(tbodyEl, headers, sorted, container);
}
  
function updateTheadHeight(){
  const activeDash = document.querySelector('.dash[data-active="true"]:not([hidden])');
  const tableWrap = activeDash?.querySelector('.table-scroll');
  let h = 0;
  if(tableWrap && tableWrap.offsetParent !== null && !tableWrap.hidden){
    const thead = tableWrap.querySelector('thead');
    h = thead ? thead.getBoundingClientRect().height : 0;
  }
  document.documentElement.style.setProperty('--thead-height', `${h}px`);
}

// Run on load
document.addEventListener('DOMContentLoaded', updateTheadHeight);

// Run on resize
window.addEventListener('resize', updateTheadHeight);

  document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && legendWrap?.classList.contains('is-open')){
    legendWrap.classList.remove('is-open');
    legendBtn?.setAttribute('aria-expanded','false');
    legendBtn?.focus();
  }
});

function ingestToDashboards(headers, rows){
  // Always reset cached data so future loads start fresh
  window.__ALS_GROUPS = undefined;
  window.__ALS_HEADERS = undefined;
  window.__ALS_GROUP_MAP = undefined;

  // 1) Remember which dashboard is currently active
  const prevActiveId =
    document.querySelector('.dash[data-active="true"]:not([hidden])')?.id || null;
  const expected=['ID','Title','Status','Priority','Assigned to','Created by','Created on','Completed on','Last updated','Location','Asset','Categories'];
  const present = expected.filter(h => headers.includes(h));
  const baseHeaders = present.length ? present : expected;

  updateExportButtonsState();

  // normalize + derive age
  const normalized = rows.map(r => {
    const o={}; expected.forEach(h => { o[h] = r[h] ?? ''; });
      // shorten people/team fields
  o['Assigned to'] = shortenName(o['Assigned to']);
  o['Created by']  = shortenName(o['Created by']);

    const ms = ageMs(o);
    o.__ageMs      = ms;                // raw milliseconds
    o.Age          = fmtAge(ms);        // human label like "12d 3h"
    o.__ageBucket  = ageBucket(ms);     // fresh | stale | old | ancient
    o.__haystack   = buildHaystack(o);  // cached lower-case search text
    return o;
  });

  const filtered = applyFilters(normalized);

 // --- place this inside ingestToDashboards(), replacing the old "inject Age" block ---
const displayHeaders = (() => {
  const out = baseHeaders.slice();

  // 1) Make sure these three are in the order: Created on → Last updated → Completed on
  const trio = ['Created on', 'Last updated', 'Completed on'];
  const presentTrio = trio.filter(h => out.includes(h));
  if (presentTrio.length) {
    const firstIdx = Math.min(...presentTrio.map(h => out.indexOf(h)));
    // remove any of the trio currently present
    trio.forEach(h => {
      const i = out.indexOf(h);
      if (i > -1) out.splice(i, 1);
    });
    // insert back in desired order (only those that exist)
    out.splice(firstIdx, 0, ...presentTrio);
  }

  // 2) Put Age immediately AFTER "Completed on"
  const afterIdx = out.indexOf('Completed on');
  const targetIdx = afterIdx >= 0 ? afterIdx + 1 : out.length;

  if (!out.includes('Age')) {
    out.splice(targetIdx, 0, 'Age');
  } else {
    const ageIdx = out.indexOf('Age');
    if (ageIdx !== targetIdx && ageIdx !== -1) {
      out.splice(ageIdx, 1);
      out.splice(Math.min(targetIdx, out.length), 0, 'Age');
    }
  }

  return out;
})();

  const groups={
    all  : filtered,
    ek   : filtered.filter(r=>toSiteKey(r.Location)==='ek'),
    mm   : filtered.filter(r=>toSiteKey(r.Location)==='mm'),
    keith: filtered.filter(r=>toSiteKey(r.Location)==='keith'),
    by   : filtered.filter(r=>toSiteKey(r.Location)==='by'),
  };

  const dashEntries = [
    ['dash-all','all'],
    ['dash-ek','ek'],
    ['dash-mm','mm'],
    ['dash-keith','keith'],
    ['dash-by','by']
  ];

  window.__ALS_GROUPS = groups;
  window.__ALS_HEADERS = displayHeaders.slice();
  window.__ALS_GROUP_MAP = dashEntries.reduce((acc, [id, key]) => {
    acc[id] = key;
    return acc;
  }, {});

  const currentActiveId = getActiveDashId();

  dashEntries.forEach(([id, key]) => {
    const el = document.getElementById(id);
    if (!el){ console.warn?.(`Skipping dashboard "${id}" – element not found.`); return; }
    el.__needsRender = true;

    if (id === currentActiveId){
      renderDashboard(el, displayHeaders, groups[key] || []);
      el.__needsRender = false;
    }
  });

// restore preferred/previous site
const targetId =
  PREFERRED_ACTIVE_DASH
  || prevActiveId
  || (document.getElementById('dash-all') ? 'dash-all' : document.querySelector('.dash')?.id);

PREFERRED_ACTIVE_DASH = null;
if (targetId) setActiveDash(targetId);
} // closes function ingestToDashboards


// Tabs
const tabs = Array.from(document.querySelectorAll('.nav .tab'));
tabs.forEach(btn => btn.addEventListener('click', ()=> setActiveDash(btn.getAttribute('aria-controls'))));
function setActiveDash(id){
  const active = document.getElementById(id);
  if(!active) return;  // guard

  const site = active.dataset.site || active.id.replace(/^dash-/, '');
  document.querySelectorAll('.dash').forEach(sec => {
    const isMatch = sec.dataset.site === site;
    sec.setAttribute('data-active', String(isMatch));
    sec.hidden = !isMatch;
  });

  // sync tabs safely
  document.querySelectorAll('.nav .tab').forEach(t => {
    const controls = t.getAttribute('aria-controls');
    t.setAttribute('aria-selected', String(controls === id));
  });

  if (active.__needsRender && window.__ALS_HEADERS && window.__ALS_GROUPS){
    const map = window.__ALS_GROUP_MAP || {};
    const key = map[id] || site;
    const rows = window.__ALS_GROUPS[key] || [];
    renderDashboard(active, window.__ALS_HEADERS, rows);
    active.__needsRender = false;
  }

  updateStickyControlsOffset();
  updateTheadHeight();
}

  // --- collapsible sticky header ---
const $sticky = document.querySelector('.sticky-top');
const $collapseBtn = document.getElementById('collapseBtn');

function setCollapsed(isCollapsed){
  if(!$sticky || !$collapseBtn) return;
  $sticky.dataset.collapsed = isCollapsed ? 'true' : 'false';
  $collapseBtn.setAttribute('aria-expanded', String(!isCollapsed));
  $collapseBtn.textContent = isCollapsed ? 'Show controls' : 'Hide controls';

  // keep layout/overlays correct
  updateStickyControlsOffset();
  updateTheadHeight();
}

// restore saved state (default: expanded)
const saved = localStorage.getItem('alsStickyCollapsed');
setCollapsed(saved === '1');

// optional: start collapsed on phones — uncomment to enable
// if (isMobileView() && saved === null) setCollapsed(true);

$collapseBtn?.addEventListener('click', ()=>{
  const now = $sticky?.dataset.collapsed === 'true';
  setCollapsed(!now);
  localStorage.setItem('alsStickyCollapsed', !now ? '1' : '0');
});

// File ingest (unchanged, but now reuses the same ingest/render)
document.getElementById('file').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    const text=reader.result; let headers=[], rows=[];
    try{
      const result=(/json$/i.test(f.name) || text.trim().startsWith('[') || text.trim().startsWith('{')) ? handleJSON(text) : parseDelimited(text);
      headers=result.headers; rows=result.rows; rows = dedupeRows(rows);
    }catch(err){ alert('Could not parse file: '+err.message); }
    LAST_HEADERS=headers; ALL_ROWS=rows; ingestToDashboards(LAST_HEADERS, ALL_ROWS);
  };
  reader.readAsText(f);
});

// Refresh index + dashboards
const refreshBtn=document.getElementById('refreshBtn');
refreshBtn?.addEventListener('click', ()=>{
  loadLatestOrChosenWeek(true);
});

// Theme toggle (unchanged)
const themeBtn=document.getElementById('themeBtn');
function applyTheme(theme){
  const isDark=theme==='dark';
  document.body.classList.toggle('dark', isDark);
  document.body.classList.toggle('light', !isDark);
  themeBtn.textContent=isDark?'Light mode':'Dark mode';
  themeBtn.setAttribute('aria-pressed', isDark?'true':'false');
  themeBtn.setAttribute('aria-label', isDark?'Switch to light mode':'Switch to dark mode');
}
const savedTheme=localStorage.getItem('theme');
const prefersDark=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
themeBtn.addEventListener('click', ()=>{
  const newTheme=document.body.classList.contains('dark')?'light':'dark';
  applyTheme(newTheme); localStorage.setItem('theme', newTheme);
});

  // Detect mobile (also allow ?mobile=1 for desktop testing, or <body class="force-mobile">)
function isMobileView(){
  if (document.body.classList.contains('force-mobile')) return true;
  if (new URLSearchParams(location.search).has('mobile')) return true;
  return window.matchMedia('(max-width: 700px)').matches;
}

function cardHTML(row){
  const allCats = String(row['Categories']||'')
    .split(/[,;]+/).map(s=>s.trim()).filter(Boolean);
  const seen = new Set(); const unique = [];
  for (const c of allCats){ const s=slugify(c); if(!seen.has(s)){ seen.add(s); unique.push(c); } }
  const shown = unique.slice(0,4).map(cat=>{
    const { className, style } = chipStyle(cat);
    const styleAttr = style ? ` style="${style}"` : '';
    const classAttr = className ? ` ${className}` : '';
    return `<span class="chip-cat${classAttr}"${styleAttr}>${esc(cat)}</span>`;
  }).join('');
  const more = unique.length>4 ? `<span class="chip-cat" style="opacity:.85;border-style:dashed">+${unique.length-4}</span>` : '';

  const statusCls = statusClass(row['Status']);
  const ms     = row.__ageMs;
  const bucket = row.__ageBucket || ageBucket(ms);
  const ageLbl = getAgeLabel(row);

  // ✅ compute these BEFORE returning the template
  const frozen  = isWinterPlanned(row);
  const ageCls  = `age-chip age-${bucket}` + (frozen ? ' frozen' : '');
  const baseT   = ms != null ? `${(ms/86400000).toFixed(1)} days` : 'Unknown';
  const ageTtl  = frozen ? `Planned for Winter • ${baseT}` : undefined;

  // 🎨 match the Planned Winter Project chip colours when frozen
  const pwp     = categoryColors['planned-winter-project'] || { background:'#E7F3FE', foreground:'#1887FC' };
  const ageStyle = frozen
    ? ` style="--bg:${pwp.background}; --ring: color-mix(in srgb, ${pwp.foreground} 50%, transparent); color:${pwp.foreground}"`
    : '';

  return `
  <article class="mobile-card" role="listitem" aria-label="WO ${esc(row['ID'])}">
    <div class="mobile-card__title">
      <span class="mobile-card__id">#${esc(row['ID'])}</span>
      &nbsp;${esc(row['Title'])}
    </div>
    <div class="mobile-card__badge">
      <span class="status-chip ${statusCls}">${esc(row['Status'])}</span>
    </div>

    <div class="mobile-card__row"><strong>Priority:</strong> ${esc(row['Priority']||'—')}</div>
    <div class="mobile-card__row">
      <strong>Age:</strong>
      <span class="${ageCls}"${ageStyle}${ageTtl ? ` title="${esc(ageTtl)}" aria-label="Planned for Winter"` : ''}>
        ${esc(ageLbl)}
      </span>
    </div>

    ${shown || more ? `<div class="mobile-card__row">${shown}${more}</div>` : ''}
  </article>`;
}

  let __wasMobile = isMobileView();
window.addEventListener('resize', ()=>{
  const now = isMobileView();
  if (now !== __wasMobile){
    __wasMobile = now;
    if (LAST_HEADERS && ALL_ROWS) ingestToDashboards(LAST_HEADERS, ALL_ROWS);
  }
});

// Re-render on filter change
function handleFilterChange(){
  const filters = getFilters();
  const nextJson = JSON.stringify(filters);
  const same = __LAST_FILTERS_JSON === nextJson;

  if (same){
    if (!LAST_HEADERS || !ALL_ROWS){
      updateChipsFromFilters(filters);   // <- mapped to `search`
    }
    return;
  }

  __LAST_FILTERS_JSON = nextJson;

  if (LAST_HEADERS && ALL_ROWS){
    ingestToDashboards(LAST_HEADERS, ALL_ROWS);
  } else {
    updateChipsFromFilters(filters);   // <- mapped to `search`
  }
}
$statusFilter?.addEventListener('change', handleFilterChange);
$priorityFilter?.addEventListener('change', handleFilterChange);
$searchInput?.addEventListener('input', debounce(handleFilterChange, 300));
$searchInput?.addEventListener('change', handleFilterChange);

/* Legend popover JS */
const legendWrap = document.querySelector('.legend-popover');
const legendBtn  = document.getElementById('legendBtn');
legendBtn?.addEventListener('click', (e)=>{
  const open = legendWrap.classList.toggle('is-open');
  legendBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
});
document.addEventListener('click', (e)=>{
  if (legendWrap && !legendWrap.contains(e.target)){
    legendWrap.classList.remove('is-open');
    legendBtn?.setAttribute('aria-expanded','false');
  }
});
  document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && legendWrap?.classList.contains('is-open')){
    legendWrap.classList.remove('is-open');
    legendBtn?.setAttribute('aria-expanded','false');
    legendBtn?.focus();
  }
});
</script> <!-- ← keep this closing tag -->
  <div id="loadingOverlay" style="
 position:fixed; inset:0; display:none; place-items:center;
 background:color-mix(in srgb, var(--paper) 70%, transparent); z-index:9999;">
  <div style="padding:10px 14px;border:1px solid var(--grid);border-radius:10px;background:var(--paper);font-weight:800">
    Loading…
  </div>
</div>
</body>
</html>
