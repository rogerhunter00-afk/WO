<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Work Orders List – Aberdeen Laundry Services (Engineering)</title>
  <style>
    :root{
      --ink:#0b0f1a;
      --muted:#6b7280;
      --als-blue:#0b67c2;
      --als-blue-strong:#0a5cb0;
      --thead:#0b67c2;
      --thead-text:#ffffff;
      --grid:#e6e9ef;
      --zebra:#ffffff;
      --chip-cat-tx:#0b67c2;
      --chip-cat-br:#0b67c2;
      --done-tx:#059669;
      --open-tx:#0b67c2;
      --hold-tx:#b45309;
      --done-bg:#0596691a;
      --open-bg:#0b67c21a;
      --hold-bg:#f59e0b1a;
      --paper:#ffffff;
    }

    @media (prefers-color-scheme: dark){
      :root{
        color-scheme: dark;
        --ink:#f3f4f6;
        --muted:#9ca3af;
        --als-blue:#3b82f6;
        --als-blue-strong:#2563eb;
        --thead:#1e3a8a;
        --thead-text:#ffffff;
        --grid:#374151;
        --zebra:#1f2937;
        --chip-cat-tx:#3b82f6;
        --chip-cat-br:#3b82f6;
        --done-tx:#10b981;
        --open-tx:#3b82f6;
        --hold-tx:#fbbf24;
        --done-bg:#10b98133;
        --open-bg:#3b82f633;
        --hold-bg:#f59e0b33;
        --paper:#111827;
      }
    }

    .dark{
      --ink:#f3f4f6;
      --muted:#9ca3af;
      --als-blue:#3b82f6;
      --als-blue-strong:#2563eb;
      --thead:#1e3a8a;
      --thead-text:#ffffff;
      --grid:#374151;
      --zebra:#1f2937;
      --chip-cat-tx:#3b82f6;
      --chip-cat-br:#3b82f6;
      --done-tx:#10b981;
      --open-tx:#3b82f6;
      --hold-tx:#fbbf24;
      --done-bg:#10b98133;
      --open-bg:#3b82f633;
      --hold-bg:#f59e0b33;
      --paper:#111827;
      color-scheme: dark;
    }

    .light{
      --ink:#0b0f1a;
      --muted:#6b7280;
      --als-blue:#0b67c2;
      --als-blue-strong:#0a5cb0;
      --thead:#0b67c2;
      --thead-text:#ffffff;
      --grid:#e6e9ef;
      --zebra:#ffffff;
      --chip-cat-tx:#0b67c2;
      --chip-cat-br:#0b67c2;
      --done-tx:#059669;
      --open-tx:#0b67c2;
      --hold-tx:#b45309;
      --done-bg:#0596691a;
      --open-bg:#0b67c21a;
      --hold-bg:#f59e0b1a;
      --paper:#ffffff;
      color-scheme: light;
    }

    html,body{height:100%}
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink); background:var(--paper); margin:0; font-size:13px; line-height:1.32;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }

    .page{
      --page-pad-top:40px;
      --page-pad-inline:48px;
      --page-pad-bottom:56px;
      padding:var(--page-pad-top) var(--page-pad-inline) var(--page-pad-bottom);
      box-sizing:border-box;
    }

    .page-head{ display:flex; align-items:flex-start; justify-content:space-between; }
    .title{ font-size:28px; font-weight:800; color:var(--ink); margin:0 0 8px; }
    .logo{ height:50px; }

    .top-rule{ height:6px; background:var(--als-blue); border-bottom:1px solid var(--als-blue-strong); margin:8px 0 10px; }

    table{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    table th, table td{ overflow-wrap:anywhere; word-break:break-word; }
    thead th { position: sticky; top: 0; z-index: 3; }
    thead th{
      background:var(--thead); color:var(--thead-text); text-transform:uppercase; letter-spacing:.6px;
      font-weight:800; font-size:11px; padding:10px 8px; border-right:1px solid rgba(255,255,255,.08);
      cursor:pointer;
    }
    thead th .sort-arrow{ margin-left:4px; }
    thead th[data-sort="asc"] .sort-arrow::after{ content:'\25B2'; }
    thead th[data-sort="desc"] .sort-arrow::after{ content:'\25BC'; }
    thead th:first-child{ border-top-left-radius:3px; }
    thead th:last-child{ border-top-right-radius:3px; border-right:none; }

    tbody td{ background:var(--zebra); border-bottom:1px solid var(--grid); padding:10px 8px; vertical-align:top; }

    .col-id{ width:66px; }
    .col-title{ width:240px; }
    .col-status{ width:120px; }
    .col-priority{ width:92px; }
    .col-createdby{ width:140px; }
    .col-createdon{ width:110px; }
    .col-completedon{ width:110px; }
    .col-updated{ width:120px; }
    .col-location{ width:180px; }
    .col-asset{ width:200px; }
    .col-categories{ width:200px; }

    .id{ font-weight:700; }
    .title-cell b{ display:block; font-weight:800; }

    .chip-cat{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:4px 10px;
      border:1px solid currentColor;
      background:transparent;
      margin:2px 6px 2px 0;
      font-weight:600;
      font-size:12px;
      line-height:1;
      white-space:nowrap;
    }

    .status-chip{ display:inline-flex; align-items:center; padding:2px 8px; border-radius:6px; font-weight:700; }
    .status-chip::before{ margin-right:4px; }
    .status-chip.done{ color:var(--done-tx); background:var(--done-bg); }
    .status-chip.done::before{ content:'\2713'; }
    .status-chip.open{ color:var(--open-tx); background:var(--open-bg); }
    .status-chip.open::before{ content:'\26AA'; }
    .status-chip.in-progress{ color:var(--open-tx); background:var(--open-bg); }
    .status-chip.in-progress::before{ content:'\23F3'; }
    .status-chip.on-hold{ color:var(--hold-tx); background:var(--hold-bg); }
    .status-chip.on-hold::before{ content:'\23F8'; }

    .ico{ width:16px; height:16px; vertical-align:-3px; margin-right:6px; }
    .done{ color:var(--done-tx); font-weight:800; }
    .open{ color:var(--open-tx); font-weight:800; }

    footer{ margin-top:8px; color:var(--muted); font-size:11px; display:flex; justify-content:space-between; }

    .controls{ display:flex; gap:12px; align-items:center; margin:8px 0 12px; font-size:12px; flex-wrap:wrap; }
    .controls input[type="file"], .controls textarea{ font:inherit; }
    .controls textarea{ width:min(100%, 520px); height:100px; padding:8px; border:1px solid var(--grid); border-radius:6px; }
    .btn{ padding:6px 10px; border:1px solid var(--als-blue); border-radius:8px; background:var(--paper); color:var(--als-blue); font-weight:700; cursor:pointer; }

/* --- Per-site dashboards --- */
.nav{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 10px; }
.nav .tab{ padding:8px 12px; border:1px solid var(--grid); border-radius:999px; cursor:pointer; background:var(--paper); color:var(--ink); font-weight:700; }
.nav .tab[aria-selected="true"]{ border-color:var(--als-blue); box-shadow:0 0 0 2px color-mix(in srgb, var(--als-blue) 25%, transparent); }
.kpis{ display:grid; grid-template-columns: repeat(5, minmax(140px,1fr)); gap:10px; margin:12px 0; }
.card{ background:var(--paper); border:1px solid var(--grid); border-radius:14px; padding:12px; }
.card h3{ margin:0 0 6px; font-size:12px; text-transform:uppercase; letter-spacing:.5px; color:var(--muted); }
.card .big{ font-size:22px; font-weight:900; }
.dash{ display:none; }
.dash[data-active="true"]{ display:block; }

/* keep table look consistent in the new dashboards */
tbody td{ overflow-wrap:anywhere; }

/* a11y helper */
.visually-hidden{
  position:absolute;
  width:1px;
  height:1px;
  padding:0;
  margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  white-space:nowrap;
  border:0;
}

/* responsive tweaks */
@media (max-width: 960px){
  .page{
    --page-pad-top:32px;
    --page-pad-inline:32px;
    --page-pad-bottom:44px;
  }
}

@media (max-width: 680px){
  .page{
    --page-pad-top:24px;
    --page-pad-inline:18px;
    --page-pad-bottom:32px;
  }
  .page-head{ flex-direction:column; align-items:flex-start; gap:12px; }
  .title{ font-size:24px; margin-bottom:4px; }
  .logo{ height:42px; }
  .controls{ gap:10px; }
  .controls textarea{ width:100%; min-width:0; }
}

    @media print{
      @page{ size: A4 landscape; margin: 10mm; }
      body{ font-size:11.5px; }
      thead{ display:table-header-group; }
      table{ width:100% !important; table-layout:fixed; border-collapse:collapse; }
      th, td{ box-sizing:border-box; overflow-wrap:anywhere; word-break:break-word; hyphens:auto; }
      thead th { position: static; }
      .title-cell, .col-categories{ break-inside:avoid; }
      html{-webkit-print-color-adjust:exact;}
      .controls{ display:none !important; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="page-head">
      <h1 class="title">Work Orders List</h1>
      <img class="logo" alt="Aberdeen Laundry Services" src="LOGOlesswhitespace.png">
    </div>
    <div class="top-rule"></div>

    <div class="controls" aria-hidden="false">
      <label class="btn" for="file">Upload CSV/TSV/JSON</label>
      <input id="file" type="file" accept=".csv,.tsv,.json,application/json,text/csv,text/tab-separated-values" style="display:none" />
      <button class="btn" id="pasteBtn" type="button">Paste data → render</button>
      <button class="btn" id="themeBtn" type="button">Dark mode</button>
      <textarea id="pasteBox" placeholder="Paste CSV (headers required) or JSON array here..."></textarea>
    </div>

    <!-- Tabs -->
    <div class="nav" role="tablist" aria-label="Site dashboards">
      <button class="tab" role="tab" id="tab-all"   aria-controls="dash-all"   aria-selected="true">All Sites</button>
      <button class="tab" role="tab" id="tab-ek"    aria-controls="dash-ek"    aria-selected="false">EK / Cathkin</button>
      <button class="tab" role="tab" id="tab-mm"    aria-controls="dash-mm"    aria-selected="false">Mugiemoss</button>
      <button class="tab" role="tab" id="tab-keith" aria-controls="dash-keith" aria-selected="false">Keith</button>
      <button class="tab" role="tab" id="tab-by"    aria-controls="dash-by"    aria-selected="false">Byron</button>
    </div>

    <!-- Dashboards -->
    <section id="dash-all"   class="dash" data-active="true"  role="tabpanel" aria-labelledby="tab-all"></section>
    <section id="dash-ek"    class="dash" data-active="false" role="tabpanel" aria-labelledby="tab-ek"></section>
    <section id="dash-mm"    class="dash" data-active="false" role="tabpanel" aria-labelledby="tab-mm"></section>
    <section id="dash-keith" class="dash" data-active="false" role="tabpanel" aria-labelledby="tab-keith"></section>
    <section id="dash-by"    class="dash" data-active="false" role="tabpanel" aria-labelledby="tab-by"></section>

    <footer>
      <span></span>
      <span></span>
    </footer>
  </div>

<script>
  const CATEGORY_COLOR_PRESETS = [
    ['Search', '#E7F3FE', '#1887FC'],
    ['Cleaning', '#FCEBFF', '#EA7BFF'],
    ['Commission', '#E7DFFD', '#855EF4'],
    ['Contractor', '#DDF9FC', '#54DFF2'],
    ['Daily Procedures', '#FFE5DF', '#FF7C60'],
    ['Damage', '#FFF5CC', '#CC9900'],
    ['Electrical', '#FFE4D0', '#FF7439'],
    ['Eng Weekly Meeting', '#FFE5DF', '#FF7C60'],
    ['Error Codes', '#FFDBE6', '#FF4A80'],
    ['Fire Safety', '#FFDBE6', '#FF4A80'],
    ['First Time Fix', '#E7F3FE', '#1887FC'],
    ['General improvements', '#E7DFFD', '#855EF4'],
    ['Inspection', '#E7F3FE', '#1887FC'],
    ['James Indust Cleaner', '#D9F5F1', '#3FCBBB'],
    ['Leak', '#DDF9FC', '#1887FC'],
    ['Manufacturers Machine Service Procedure', '#FCEBFF', '#EA7BFF'],
    ['Mechanical', '#E7F3FE', '#1A66CC'],
    ['meters', '#E7F3FE', '#1570B8'],
    ['Monthly Procedures', '#FFE4D0', '#FF7439'],
    ['Ordering/Purchasing', '#DDF9FC', '#54DFF2'],
    ['Planned Winter Project', '#E7F3FE', '#1887FC'],
    ['Plumbing', '#FCEBFF', '#B24BEA'],
    ['PPM', '#E4F9E8', '#2FB95A'],
    ['Preventive', '#E4F9E8', '#2FB95A'],
    ['Product Quality improvements', '#E7F3FE', '#1887FC'],
    ['Programming', '#FFE4D0', '#D85E2E'],
    ['Project', '#E7F3FE', '#2A7BEF'],
    ['Reactive Maintenance', '#DDF9FC', '#2CCFE3'],
    ['Refrigeration', '#D9F5F1', '#3FCBBB'],
    ['Safety', '#E7F3FE', '#1870DA'],
    ['Site maintenance responsabilities', '#E7F3FE', '#1868C0'],
    ['Smart Check', '#FFDBE6', '#E43C75'],
    ['Standard Operating Procedure', '#FFDBE6', '#E43C75'],
    ['Top 5', '#E7DFFD', '#6D4CE6'],
    ['Training', '#E7F3FE', '#1870DA'],
    ['Weekly Procedures', '#E7F3FE', '#1870DA'],
    ['Yearly Procedures', '#FFF5CC', '#8A6E00'],
    ['Zero Emissions', '#D9F5F1', '#2AAE9E'],
  ];

  const categoryColors = CATEGORY_COLOR_PRESETS.reduce((acc, [label, background, foreground]) => {
    const slug = slugify(label);
    acc[slug] = { background, foreground };
    return acc;
  }, {});

  function hashCategory(label){
    let hash = 0;
    const input = String(label || '');
    for(let i = 0; i < input.length; i++){
      hash = ((hash << 5) - hash) + input.charCodeAt(i);
      hash |= 0;
    }
    return Math.abs(hash);
  }

  function hslToRgb(h, s, l){
    const hue = ((h % 360) + 360) % 360;
    const sat = Math.max(0, Math.min(100, s)) / 100;
    const lig = Math.max(0, Math.min(100, l)) / 100;
    const c = (1 - Math.abs(2 * lig - 1)) * sat;
    const x = c * (1 - Math.abs(((hue / 60) % 2) - 1));
    const m = lig - c / 2;
    let r1 = 0, g1 = 0, b1 = 0;
    if(hue < 60){ r1 = c; g1 = x; }
    else if(hue < 120){ r1 = x; g1 = c; }
    else if(hue < 180){ g1 = c; b1 = x; }
    else if(hue < 240){ g1 = x; b1 = c; }
    else if(hue < 300){ r1 = x; b1 = c; }
    else { r1 = c; b1 = x; }
    const r = r1 + m;
    const g = g1 + m;
    const b = b1 + m;
    return [r, g, b];
  }

  function srgbToLinear(c){
    return c <= 0.04045 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
  }

  function relativeLuminance(rgb){
    const [r, g, b] = rgb.map(v => srgbToLinear(Math.max(0, Math.min(1, v))));
    return 0.2126 * r + 0.7152 * g + 0.0722 * b;
  }

  function contrastRatio(bgHsl, fgHsl){
    const bgRgb = hslToRgb(bgHsl.h, bgHsl.s, bgHsl.l);
    const fgRgb = hslToRgb(fgHsl.h, fgHsl.s, fgHsl.l);
    const lBg = relativeLuminance(bgRgb);
    const lFg = relativeLuminance(fgRgb);
    const light = Math.max(lBg, lFg);
    const dark = Math.min(lBg, lFg);
    return (light + 0.05) / (dark + 0.05);
  }

  function fallbackColors(label){
    const hash = hashCategory(label);
    const hue = hash % 360;
    const bg = { h: hue, s: 45, l: 92 };
    const fg = { h: hue, s: 60, l: 32 };
    let currentFg = { ...fg };
    let ratio = contrastRatio(bg, currentFg);
    while(ratio < 4.5 && currentFg.l > 0){
      currentFg = { ...currentFg, l: Math.max(0, currentFg.l - 10) };
      ratio = contrastRatio(bg, currentFg);
    }
    return {
      background: `hsl(${bg.h}, ${bg.s}%, ${bg.l}%)`,
      foreground: `hsl(${currentFg.h}, ${currentFg.s}%, ${currentFg.l}%)`
    };
  }

  function chipStyle(label, slugOverride){
    const slug = slugOverride || slugify(label);
    const preset = categoryColors[slug];
    if(preset){
      return { className: `cat-${slug}`, style: '' };
    }
    const colors = fallbackColors(label);
    const style = `background:${colors.background};border-color:${colors.foreground};color:${colors.foreground}`;
    return { className: `cat-${slug}`, style };
  }

  const styleEl = document.createElement('style');
  styleEl.textContent = Object.entries(categoryColors).map(([slug, colors]) => `
    .chip-cat.cat-${slug}{background:${colors.background};color:${colors.foreground};border-color:${colors.foreground};}
  `).join('');
  document.head.appendChild(styleEl);

  const ESC_MAP = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'};
  const ESC_RE = /[&<>"']/g;
  function esc(s){
    return String(s==null?'':s).replace(ESC_RE, c => ESC_MAP[c]);
  }

  function slugify(str){
    return str.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
  }

  function parseDelimited(text){
    const sep = text.includes('\t') ? '\t' : ',';
    const rows = text.trim().split(/\r?\n/).map(r =>
      r.split(new RegExp(`${sep}(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)`)).map(c => c.replace(/^\"|\"$/g,''))
    );
    const rawHeaders = rows.shift() || [];
    const headers = rawHeaders.map((h, i) => {
      const cleaned = String(h == null ? '' : h).replace(/^\uFEFF/, '').trim();
      return cleaned || `col${i}`;
    });
    const data = rows.map(r => Object.fromEntries(r.map((v, i) => [headers[i] || `col${i}`, v])));
    return {headers, rows:data};
  }

  function handleJSON(text){
    const data = JSON.parse(text);
    let rows = [];
    if(Array.isArray(data)) rows = data;
    else if(Array.isArray(data.rows)) rows = data.rows;
    const headers = rows.length ? Object.keys(rows[0]) : [];
    return {headers, rows};
  }

  /* ---------- Per-site Dashboards: helpers ---------- */

  function toSiteKey(location){
    const s = String(location||'').toLowerCase();
    if (s.includes('byron')) return 'by';
    if (s.includes('mugiemoss') || s.includes('bucksburn')) return 'mm';
    if (s.includes('keith')) return 'keith';
    if (s.includes('cathkin') || s.includes('east kilbride') || s.includes('ek')) return 'ek';
    return 'other';
  }

  function kpiCard(label, value){
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `<h3>${esc(label)}</h3><div class="big">${esc(value)}</div>`;
    return el;
  }

  const PRIORITY_ORDER = ['critical','high','medium','low',''];
  const STATUS_ORDER   = ['open','in-progress','on-hold','done',''];

  function parseDateLoose(v){
    if(!v) return null;
    const m = String(v).match(/^(\d{2})\/(\d{2})\/(\d{4})(?:\s+(\d{2}):(\d{2}))?$/);
    if (!m) return null;
    const [ , d, M, y, hh='00', mm='00'] = m;
    const dt = new Date(`${y}-${M}-${d}T${hh}:${mm}:00`);
    return isNaN(dt.getTime()) ? null : dt;
  }
  function normalizePriority(v){
    if(v == null) return '';
    let slug = slugify(String(v).trim());
    if(!slug) return '';
    if(slug.endsWith('-priority')) slug = slug.replace(/-priority$/,'');
    if(slug === 'med') slug = 'medium';
    if(slug === 'normal') slug = 'medium';
    if(slug === 'urgent' || slug === 'emergency') slug = 'critical';
    return slug;
  }
  function cmpPriority(a,b){
    const ia = PRIORITY_ORDER.indexOf(normalizePriority(a));
    const ib = PRIORITY_ORDER.indexOf(normalizePriority(b));
    const safe = idx => (idx === -1 ? PRIORITY_ORDER.length : idx);
    const diff = safe(ia) - safe(ib);
    return diff || String(a??'').localeCompare(String(b??''), undefined, {numeric:true, sensitivity:'base'});
  }
  function cmpStatus(a,b){
    const ia = STATUS_ORDER.indexOf(statusClass(a));
    const ib = STATUS_ORDER.indexOf(statusClass(b));
    const safe = idx => (idx === -1 ? STATUS_ORDER.length : idx);
    const diff = safe(ia) - safe(ib);
    return diff || String(a??'').localeCompare(String(b??''), undefined, {numeric:true, sensitivity:'base'});
  }
  function cmpId(a,b){
    const na = parseInt(String(a).replace(/\D+/g,''),10) || 0;
    const nb = parseInt(String(b).replace(/\D+/g,''),10) || 0;
    return na - nb;
  }
  function detectType(col, rows){
    const colNorm = String(col||'').trim().toLowerCase();
    const sample = rows.slice(0, 10).map(r => r[col]);
    const allDates   = sample.length && sample.every(v => parseDateLoose(v) !== null);
    const allNumbers = sample.length && sample.every(v => typeof v === 'number' || /^\s*[-+]?\d+(\.\d+)?\s*$/.test(String(v)));
    if (allDates) return 'date';
    if (allNumbers) return 'number';
    if (colNorm === 'id') return 'id';
    if (colNorm === 'priority') return 'priority';
    if (colNorm === 'status') return 'status';
    return 'string';
  }
  function statusClass(v){
    const map = new Map([
      ['done','done'], ['complete','done'], ['completed','done'],
      ['open','open'],
      ['in-progress','in-progress'], ['in progress','in-progress'], ['progress','in-progress'], ['inprogress','in-progress'],
      ['on-hold','on-hold'], ['on hold','on-hold'], ['hold','on-hold'], ['onhold','on-hold']
    ]);
    const s = slugify(String(v||'')); return map.get(s) || s;
  }

  function renderDashboard(container, headers, rows){
    container.innerHTML = '';

    // KPIs
    const kpiWrap = document.createElement('div'); kpiWrap.className = 'kpis';
    const total = rows.length;
    const open  = rows.filter(r => /^open$/i.test(r.Status)).length;
    const prog  = rows.filter(r => /^in\s*progress$/i.test(r.Status)).length;
    const hold  = rows.filter(r => /^on\s*hold$/i.test(r.Status)).length;
    const done  = rows.filter(r => /^done$/i.test(r.Status)).length;
    const lastUpd = rows.map(r => parseDateLoose(r['Last updated'])).filter(Boolean).sort((a,b)=>b-a)[0];

    kpiWrap.appendChild(kpiCard('Total WOs', total));
    kpiWrap.appendChild(kpiCard('Open', open));
    kpiWrap.appendChild(kpiCard('In Progress', prog));
    kpiWrap.appendChild(kpiCard('On Hold', hold));
    kpiWrap.appendChild(kpiCard('Done', done));

    container.appendChild(kpiWrap);

    // Table
    const table = document.createElement('table'); table.setAttribute('role','table'); table.setAttribute('aria-label','Work Orders');
    const thead = document.createElement('thead'); const tbody = document.createElement('tbody');
    table.appendChild(thead); table.appendChild(tbody); container.appendChild(table);

    // Scoped header with sort
    thead.innerHTML = `<tr>${headers.map(h=>`<th scope="col" data-col="${esc(h)}" tabindex="0"><span>${esc(h)}</span><span class="sort-arrow" aria-hidden="true"></span></th>`).join('')}</tr>`;
    thead.querySelectorAll('th').forEach(th=>{
      th.addEventListener('click', ()=> sortScoped(th, tbody, headers, rows, container));
      th.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); sortScoped(th, tbody, headers, rows, container); } });
    });

    // Rows
    renderRowsScoped(tbody, headers, rows);

    // Keep a copy for re-sorting later
    container.__rows = rows.slice();

    // Footer stamps
    const ftL = document.querySelector('footer span:first-child');
    const ftR = document.querySelector('footer span:last-child');
    if (ftL && lastUpd) ftL.textContent = `Last update: ${lastUpd.toLocaleString()}`;
    if (ftR) ftR.textContent = `${total} work orders`;
  }

  function renderRowsScoped(tbodyEl, headers, rows){
    const norm = s => String(s||'').trim().toLowerCase();
    tbodyEl.innerHTML = rows.map(row => {
      return `<tr>${headers.map(h=>{
        const v = row[h];
        const hNorm = norm(h);

        if (hNorm === 'categories'){
          const seen = new Set();
          const chips = String(v||'').split(',').map(c => c.trim()).filter(Boolean).map(cat => {
            const slug = slugify(cat);
            if(seen.has(slug)) return '';
            seen.add(slug);
            const { className, style } = chipStyle(cat, slug);
            const styleAttr = style ? ` style="${style}"` : '';
            const classAttr = className ? ` ${className}` : '';
            return `<span class="chip-cat${classAttr}"${styleAttr}>${esc(cat)}</span>`;
          }).filter(Boolean).join('');
          return `<td>${chips}</td>`;
        }

        if (hNorm === 'status'){
          const cls = statusClass(v);
          return `<td><span class="status-chip ${cls}">${esc(v)}</span></td>`;
        }

        return `<td>${esc(v)}</td>`;
      }).join('')}</tr>`;
    }).join('\n');
  }

  function sortScoped(th, tbodyEl, headers, rows, container){
    const col = th.getAttribute('data-col');
    const dir = th.getAttribute('data-sort') === 'asc' ? 'desc' : 'asc';
    Array.from(th.parentElement.children).forEach(h=>{ if(h!==th){ h.removeAttribute('data-sort'); h.setAttribute('aria-sort','none'); }});
    th.setAttribute('data-sort', dir); th.setAttribute('aria-sort', dir==='asc'?'ascending':'descending');

    const type = detectType(col, rows);
    const f = dir === 'asc' ? 1 : -1;

    const sorted = [...(container.__rows || rows)].sort((a,b)=>{
      const va=a[col], vb=b[col];
      if(type==='date'){ const da=parseDateLoose(va), db=parseDateLoose(vb); return f * (((da?.getTime()||0)-(db?.getTime()||0))); }
      if(type==='number'){ return f * ((parseFloat(va)||0)-(parseFloat(vb)||0)); }
      if(type==='priority'){ return f * cmpPriority(va, vb); }
      if(type==='status'){ return f * cmpStatus(va, vb); }
      if(type==='id'){ return f * cmpId(va, vb); }
      return f * String(va??'').localeCompare(String(vb??''), undefined, {numeric:true, sensitivity:'base'});
    });

    container.__rows = sorted;
    renderRowsScoped(tbodyEl, headers, sorted);
  }

  /* ---------- Ingest + dispatch to the 5 dashboards ---------- */

  function ingestToDashboards(headers, rows){
    const expected = ['ID','Title','Status','Priority','Assigned to','Created by','Created on','Completed on','Last updated','Location','Asset','Categories'];
    const present = expected.filter(h => headers.includes(h));
    const safeHeaders = present.length ? present : expected;

    const normalized = rows.map(r => {
      const o = {};
      expected.forEach(h => {
        o[h] = r[h] ?? '';
      });
      return o;
    });

    const groups = {
      all: normalized,
      ek: normalized.filter(r => toSiteKey(r.Location) === 'ek'),
      mm: normalized.filter(r => toSiteKey(r.Location) === 'mm'),
      keith: normalized.filter(r => toSiteKey(r.Location) === 'keith'),
      by: normalized.filter(r => toSiteKey(r.Location) === 'by')
    };

    const map = [
      ['dash-all','all'],
      ['dash-ek','ek'],
      ['dash-mm','mm'],
      ['dash-keith','keith'],
      ['dash-by','by']
    ];

    map.forEach(([id,key])=>{
      const el = document.getElementById(id);
      renderDashboard(el, safeHeaders, groups[key]);
    });

    setActiveDash('dash-all'); // default
  }

  // Tabs
  const tabs = Array.from(document.querySelectorAll('.nav .tab'));
  tabs.forEach(btn => btn.addEventListener('click', ()=> setActiveDash(btn.getAttribute('aria-controls'))));
  function setActiveDash(id){
    document.querySelectorAll('.dash').forEach(sec => sec.setAttribute('data-active', String(sec.id===id)));
    tabs.forEach(t => t.setAttribute('aria-selected', String(t.getAttribute('aria-controls')===id)));
  }

  // File & paste ingest
  document.getElementById('file').addEventListener('change', e=>{
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const text = reader.result;
      let headers = [];
      let rows = [];
      try{
        const result = (/json$/i.test(f.name) || text.trim().startsWith('[') || text.trim().startsWith('{'))
          ? handleJSON(text)
          : parseDelimited(text);
        headers = result.headers;
        rows = result.rows;
      }catch(err){
        alert('Could not parse file: '+err.message);
      }
      ingestToDashboards(headers, rows);
    };
    reader.readAsText(f);
  });

  document.getElementById('pasteBtn').addEventListener('click', ()=>{
    const text = document.getElementById('pasteBox').value;
    if(!text.trim()) return;
    let headers = [];
    let rows=[];
    try{
      const result = (text.trim().startsWith('[') || text.trim().startsWith('{')) ? handleJSON(text) : parseDelimited(text);
      headers = result.headers;
      rows = result.rows;
    }catch(err){ alert('Parse error: '+err.message); }
    ingestToDashboards(headers, rows);
  });

  // Theme toggle
  const themeBtn = document.getElementById('themeBtn');
  function applyTheme(theme){
    const isDark = theme === 'dark';
    document.body.classList.toggle('dark', isDark);
    document.body.classList.toggle('light', !isDark);
    themeBtn.textContent = isDark ? 'Light mode' : 'Dark mode';
    themeBtn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
    themeBtn.setAttribute('aria-label', isDark ? 'Switch to light mode' : 'Switch to dark mode');
  }
  const savedTheme = localStorage.getItem('theme');
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = savedTheme || (prefersDark ? 'dark' : 'light');
  applyTheme(theme);
  themeBtn.addEventListener('click', ()=>{
    const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
    applyTheme(newTheme);
    localStorage.setItem('theme', newTheme);
  });

  // Demo
  const demo = [
    {
      ID:'#8683', Title:'Ironer 1 – Grease and Check Oil Gearboxes', Status:'Done', Priority:'Medium',
      'Created by':'Roger Hunter', 'Created on':'11/09/2025 09:05', 'Completed on':'12/09/2025 14:22', 'Last updated':'12/09/2025 14:26',
      Location:'Cathkin (East Kilbride)', Asset:'Ironer 1 Baker Perkins - EK', Categories:'Inspection; Mechanical; Weekly Procedures'
    },
    {
      ID:'#8731', Title:'Ironer 2 – Grease and Check Oil Gearboxes', Status:'Open', Priority:'Medium',
      'Created by':'Roger Hunter', 'Created on':'12/09/2025 09:10', 'Completed on':'', 'Last updated':'13/09/2025 08:01',
      Location:'Cathkin (East Kilbride)', Asset:'Ironer 2 Baker Perkins - EK', Categories:'Inspection; Mechanical'
    }
  ];
  ingestToDashboards(Object.keys(demo[0]||{}), demo);
</script>
</body>
</html>
