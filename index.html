<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Work Orders List – Aberdeen Laundry Services (Engineering)</title>
  <style>
    :root{
      --ink:#0b0f1a;
      --muted:#6b7280;
      --als-blue:#0b67c2;
      --als-blue-strong:#0a5cb0;
      --thead:#0b67c2;
      --thead-text:#ffffff;
      --grid:#e6e9ef;
      --zebra:#ffffff;
      --chip-cat-tx:#0b67c2;
      --chip-cat-br:#0b67c2;
      --done-tx:#059669;
      --open-tx:#0b67c2;
      --hold-tx:#b45309;
      --done-bg:#0596691a;
      --open-bg:#0b67c21a;
      --hold-bg:#f59e0b1a;
      --paper:#ffffff;
      --sticky-controls-offset:0px;
    }

    @media (prefers-color-scheme: dark){
      :root{
        color-scheme: dark;
        --ink:#f3f4f6;
        --muted:#9ca3af;
        --als-blue:#3b82f6;
        --als-blue-strong:#2563eb;
        --thead:#1e3a8a;
        --thead-text:#ffffff;
        --grid:#374151;
        --zebra:#1f2937;
        --chip-cat-tx:#3b82f6;
        --chip-cat-br:#3b82f6;
        --done-tx:#10b981;
        --open-tx:#3b82f6;
        --hold-tx:#fbbf24;
        --done-bg:#10b98133;
        --open-bg:#3b82f633;
        --hold-bg:#f59e0b33;
        --paper:#111827;
      }
    }

    .dark{
      --ink:#f3f4f6;
      --muted:#9ca3af;
      --als-blue:#3b82f6;
      --als-blue-strong:#2563eb;
      --thead:#1e3a8a;
      --thead-text:#ffffff;
      --grid:#374151;
      --zebra:#1f2937;
      --chip-cat-tx:#3b82f6;
      --chip-cat-br:#3b82f6;
      --done-tx:#10b981;
      --open-tx:#3b82f6;
      --hold-tx:#fbbf24;
      --done-bg:#10b98133;
      --open-bg:#3b82f633;
      --hold-bg:#f59e0b33;
      --paper:#111827;
      color-scheme: dark;
    }

    .light{
      --ink:#0b0f1a;
      --muted:#6b7280;
      --als-blue:#0b67c2;
      --als-blue-strong:#0a5cb0;
      --thead:#0b67c2;
      --thead-text:#ffffff;
      --grid:#e6e9ef;
      --zebra:#ffffff;
      --chip-cat-tx:#0b67c2;
      --chip-cat-br:#0b67c2;
      --done-tx:#059669;
      --open-tx:#0b67c2;
      --hold-tx:#b45309;
      --done-bg:#0596691a;
      --open-bg:#0b67c21a;
      --hold-bg:#f59e0b1a;
      --paper:#ffffff;
      color-scheme: light;
    }

    html,body{height:100%}
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink); background:var(--paper); margin:0; font-size:13px; line-height:1.32;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }

.page{
  /* existing vars + padding kept */
  --page-pad-top:40px;
  --page-pad-inline:48px;
  --page-pad-bottom:56px;
  padding:var(--page-pad-top) var(--page-pad-inline) var(--page-pad-bottom);
  box-sizing:border-box;

  /* NEW: center the page and cap width */
  max-width: clamp(960px, 96vw, 1280px);
  margin-inline: auto;
}

    .page-head{ display:flex; align-items:flex-start; justify-content:space-between; }
    .title{ font-size:28px; font-weight:800; color:var(--ink); margin:0 0 8px; }
    .logo{ height:50px; }

    .top-rule{ height:6px; background:var(--als-blue); border-bottom:1px solid var(--als-blue-strong); margin:8px 0 10px; }

    .table-scroll{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      margin-top:12px;
    }

    table{ width:100%; min-width:900px; border-collapse:separate; border-spacing:0; }
    table th, table td{ overflow-wrap:anywhere; word-break:break-word; }
    thead th { position: sticky; top: var(--sticky-controls-offset); z-index: 3; }
    thead th{
      background:var(--thead); color:var(--thead-text); text-transform:uppercase; letter-spacing:.6px;
      font-weight:800; font-size:11px; padding:10px 8px; border-right:1px solid rgba(255,255,255,.08);
      cursor:pointer;
      box-shadow: 0 1px 0 var(--grid);
    }
    thead th .sort-arrow{ margin-left:4px; }
    thead th[data-sort="asc"] .sort-arrow::after{ content:'\25B2'; }
    thead th[data-sort="desc"] .sort-arrow::after{ content:'\25BC'; }
    thead th:first-child{ border-top-left-radius:3px; }
    thead th:last-child{ border-top-right-radius:3px; border-right:none; }

    tbody td{ background:var(--zebra); border-bottom:1px solid var(--grid); padding:10px 8px; vertical-align:top; }

    .col-id{ width:66px; }
    .col-title{ width:240px; }
    .col-status{ width:120px; }
    .col-priority{ width:92px; }
    .col-createdby{ width:140px; }
    .col-createdon{ width:110px; }
    .col-completedon{ width:110px; }
    .col-updated{ width:120px; }
    .col-location{ width:180px; }
    .col-asset{ width:200px; }
    .col-categories{ width:200px; }

    .id{ font-weight:700; }
    .title-cell b{ display:block; font-weight:800; }

    .chip-cat{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:4px 10px;
      border:1px solid currentColor;
      background:transparent;
      margin:2px 6px 2px 0;
      font-weight:600;
      font-size:12px;
      line-height:1;
      white-space:nowrap;
    }

    .status-chip{ display:inline-flex; align-items:center; padding:2px 8px; border-radius:6px; font-weight:700; }
    .status-chip::before{ margin-right:4px; }
    .status-chip.done{ color:var(--done-tx); background:var(--done-bg); }
    .status-chip.done::before{ content:'\2713'; }
    .status-chip.open{ color:var(--open-tx); background:var(--open-bg); }
    .status-chip.open::before{ content:'\26AA'; }
    .status-chip.in-progress{ color:var(--open-tx); background:var(--open-bg); }
    .status-chip.in-progress::before{ content:'\23F3'; }
    .status-chip.on-hold{ color:var(--hold-tx); background:var(--hold-bg); }
    .status-chip.on-hold::before{ content:'\23F8'; }

    .ico{ width:16px; height:16px; vertical-align:-3px; margin-right:6px; }
    .done{ color:var(--done-tx); font-weight:800; }
    .open{ color:var(--open-tx); font-weight:800; }

/* Controls + sticky + search + filter chips + view-options */
.controls{
  position: sticky;
  top: 0;
  z-index: 10;
  background: var(--paper);
  display:flex;
  gap:12px;
  align-items:center;
  margin:0 0 12px;
  padding:10px 0;
  font-size:12px;
  flex-wrap:wrap;
  box-shadow:0 1px 0 var(--grid);
}
.controls input[type="file"], .controls textarea{ font:inherit; }

/* Search */
.search-input{
  flex:1 1 280px;
  min-width:220px;
  max-width:460px;
  order:-1;
  padding:9px 16px;
  border-radius:999px;
  border:2px solid color-mix(in srgb, var(--als-blue) 65%, transparent);
  background:color-mix(in srgb, var(--als-blue) 12%, var(--paper));
  color:var(--ink);
  font:inherit;
  font-weight:600;
  box-shadow:0 4px 10px color-mix(in srgb, var(--als-blue) 18%, transparent);
  transition:border-color .18s ease, box-shadow .18s ease, background-color .18s ease;
  appearance:none;
}
.search-input::placeholder{ color:color-mix(in srgb, var(--ink) 45%, transparent); font-weight:500; }
.search-input:focus-visible{
  outline:none;
  border-color:var(--als-blue);
  box-shadow:0 0 0 3px color-mix(in srgb, var(--als-blue) 30%, transparent);
  background:color-mix(in srgb, var(--als-blue) 20%, var(--paper));
}

/* Filter selects */
.filter-group{ display:flex; align-items:center; gap:6px; font-weight:600; color:var(--ink); }
.filter-group select{
  font:inherit;
  padding:6px 10px;
  border:1px solid var(--grid);
  border-radius:8px;
  background:var(--paper);
  color:inherit;
  cursor:pointer;
}
.filter-group select:focus-visible{ outline:2px solid color-mix(in srgb, var(--als-blue) 65%, transparent); outline-offset:2px; }

/* Buttons */
.btn{ padding:6px 10px; border:1px solid var(--als-blue); border-radius:8px; background:var(--paper); color:var(--als-blue); font-weight:700; cursor:pointer; }

/* View Options dropdown */
.view-options{ position:relative; }
.view-options__trigger{ display:inline-flex; align-items:center; gap:6px; }
.view-options__menu{
  position:absolute; right:0; top:calc(100% + 6px);
  background:var(--paper); border:1px solid var(--grid); border-radius:12px;
  padding:12px; box-shadow:0 12px 28px rgba(15,23,42,.18);
  min-width:190px; max-width:240px; z-index:40;
}
.view-options__menu[hidden]{ display:none; }
.view-options fieldset{ border:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; }
.view-options__group-label{ font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:var(--muted); }
.view-options__options{ display:flex; flex-direction:column; gap:6px; max-height:min(240px, 55vh); overflow:auto; padding-right:4px; }
.view-options__option{ display:flex; align-items:center; gap:8px; font-weight:600; color:var(--ink); white-space:nowrap; }
.view-options__option input{ margin:0; accent-color:var(--als-blue); }

/* Active filter chips */
.active-filter-chips{
  display:flex; flex-wrap:wrap; gap:8px;
  margin:-4px 0 12px; padding:0;
}
.active-filter-chips[hidden]{ display:none; }
.filter-chip{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 12px; border-radius:999px;
  border:1px solid color-mix(in srgb, var(--als-blue) 32%, var(--grid));
  background:color-mix(in srgb, var(--als-blue) 14%, var(--paper));
  color:var(--ink); font-weight:600; font-size:12px; cursor:pointer; max-width:100%; text-align:left;
  transition:background .2s ease, border-color .2s ease, color .2s ease;
}
.filter-chip:hover{
  background:color-mix(in srgb, var(--als-blue) 22%, var(--paper));
  border-color:color-mix(in srgb, var(--als-blue) 48%, var(--grid));
}
.filter-chip:focus-visible{
  outline:2px solid color-mix(in srgb, var(--als-blue) 65%, transparent);
  outline-offset:2px;
}
.filter-chip__label{ display:inline-block; max-width:min(280px, 100%); white-space:normal; word-break:break-word; }
.filter-chip__icon{ font-size:16px; line-height:1; }

/* --- Per-site dashboards --- */
.nav{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 10px; }
.nav .tab{ padding:8px 12px; border:1px solid var(--grid); border-radius:999px; cursor:pointer; background:var(--paper); color:var(--ink); font-weight:700; }
.nav .tab[aria-selected="true"]{ border-color:var(--als-blue); box-shadow:0 0 0 2px color-mix(in srgb, var(--als-blue) 25%, transparent); }
.kpis{ display:grid; grid-template-columns: repeat(5, minmax(140px,1fr)); gap:10px; margin:12px 0; }
.card{ background:var(--paper); border:1px solid var(--grid); border-radius:14px; padding:12px; }
.card h3{ margin:0 0 6px; font-size:12px; text-transform:uppercase; letter-spacing:.5px; color:var(--muted); }
.card .big{ font-size:22px; font-weight:900; }
.dash{ display:none; }
.dash[data-active="true"]{ display:block; }

/* keep table look consistent in the new dashboards */
tbody td{ overflow-wrap:anywhere; }

/* a11y helper */
.visually-hidden{
  position:absolute;
  width:1px;
  height:1px;
  padding:0;
  margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  white-space:nowrap;
  border:0;
}

@media (min-width: 960px){
  table{ table-layout:fixed; }
}

/* responsive tweaks */
@media (max-width: 960px){
  .page{
    --page-pad-top:32px;
    --page-pad-inline:32px;
    --page-pad-bottom:44px;
  }
}

@media (max-width: 680px){
  .page{
    --page-pad-top:24px;
    --page-pad-inline:18px;
    --page-pad-bottom:32px;
  }
  .page-head{ flex-direction:column; align-items:flex-start; gap:12px; }
  .title{ font-size:24px; margin-bottom:4px; }
  .logo{ height:42px; }
  .controls{ gap:10px; }
  .controls textarea{ width:100%; min-width:0; }
  .controls .search-input{ flex-basis:100%; max-width:none; }
  .view-options__menu{ left:0; right:auto; } /* open from left on mobile */

}

    @media print{
      @page{ size: A4 landscape; margin: 10mm; }
      body{ font-size:11.5px; }
      thead{ display:table-header-group; }
      table{ width:100% !important; table-layout:fixed; border-collapse:collapse; }
      th, td{ box-sizing:border-box; overflow-wrap:anywhere; word-break:break-word; hyphens:auto; }
      thead th { position: static; }
      .title-cell, .col-categories{ break-inside:avoid; }
      html{-webkit-print-color-adjust:exact;}
      .controls{ display:none !important; }
      .active-filter-chips{ display:none !important; }
      .view-options{ display:none !important; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="page-head">
      <h1 class="title">Work Orders List</h1>
      <img class="logo" alt="Aberdeen Laundry Services" src="LOGOlesswhitespace.png">
    </div>
        <div class="top-rule"></div>

    <div class="controls" role="region" aria-label="Table controls">
      <input type="search" id="globalSearch" class="search-input" placeholder="Search work orders" aria-label="Search work orders">
      <label class="btn" for="file">Upload CSV/TSV/JSON</label>
      <input id="file" type="file" accept=".csv,.tsv,.json,application/json,text/csv,text/tab-separated-values" style="display:none" />
      <button class="btn" id="themeBtn" type="button">Dark mode</button>
      <div class="view-options" id="viewOptions">
        <button class="btn view-options__trigger" id="viewOptionsBtn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="viewOptionsMenu">⚙️ View Options</button>
        <div class="view-options__menu" id="viewOptionsMenu" hidden>
          <fieldset>
            <legend class="visually-hidden">Toggle table columns</legend>
            <span class="view-options__group-label">Columns</span>
            <div class="view-options__options" id="columnToggleWrap"></div>
          </fieldset>
        </div>
      </div>

      <label class="filter-group">
        <span>Status</span>
        <select id="statusFilter" name="status-filter">
          <option value="">All</option>
          <option value="open">Open</option>
          <option value="in-progress">In Progress</option>
          <option value="on-hold">On Hold</option>
          <option value="done">Done</option>
          <option value="not:done">Not: Done</option>
        </select>
      </label>

      <label class="filter-group">
        <span>Priority</span>
        <select id="priorityFilter" name="priority-filter">
          <option value="">All</option>
          <option value="critical">Critical</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
      </label>
    </div>

    <div id="activeFilterChips" class="active-filter-chips" hidden aria-live="polite"></div>


    <!-- Tabs -->
    <div class="nav" role="tablist" aria-label="Site dashboards">
      <button class="tab" role="tab" id="tab-all"   aria-controls="dash-all"   aria-selected="true">All Sites</button>
      <button class="tab" role="tab" id="tab-ek"    aria-controls="dash-ek"    aria-selected="false">EK / Cathkin</button>
      <button class="tab" role="tab" id="tab-mm"    aria-controls="dash-mm"    aria-selected="false">Mugiemoss</button>
      <button class="tab" role="tab" id="tab-keith" aria-controls="dash-keith" aria-selected="false">Keith</button>
      <button class="tab" role="tab" id="tab-by"    aria-controls="dash-by"    aria-selected="false">Byron</button>
    </div>

    <!-- Dashboards -->
    <section id="dash-all"   class="dash" data-active="true"  role="tabpanel" aria-labelledby="tab-all"></section>
    <section id="dash-ek"    class="dash" data-active="false" role="tabpanel" aria-labelledby="tab-ek"></section>
    <section id="dash-mm"    class="dash" data-active="false" role="tabpanel" aria-labelledby="tab-mm"></section>
    <section id="dash-keith" class="dash" data-active="false" role="tabpanel" aria-labelledby="tab-keith"></section>
    <section id="dash-by"    class="dash" data-active="false" role="tabpanel" aria-labelledby="tab-by"></section>
  </div>

<script>
// --- CONFIG: Google Sheet (Published CSV) ---
const SHEET_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRJocigDhxneJtrUmezFU7FcWpzSSah8-Wb6Rce8NA1f7jKcINgYU29iYRqt5QQymWATX5zs5k8_rK0/pub?output=csv';

// --- Layout helpers ---
const $controlsBar = document.querySelector('.controls');
const rootStyle = document.documentElement.style;
function updateStickyControlsOffset(){
  if(!$controlsBar || !rootStyle) return;
  const styles = getComputedStyle($controlsBar);
  const marginBottom = parseFloat(styles.marginBottom) || 0;
  const offset = $controlsBar.getBoundingClientRect().height + marginBottom;
  rootStyle.setProperty('--sticky-controls-offset', `${offset}px`);
}
updateStickyControlsOffset();
window.addEventListener('resize', updateStickyControlsOffset);
window.addEventListener('load', updateStickyControlsOffset);
if('ResizeObserver' in window && $controlsBar){
  const observer = new ResizeObserver(updateStickyControlsOffset);
  observer.observe($controlsBar);
}

// --- State cache for rendering ---
let LAST_HEADERS = null;
let ALL_ROWS = null;
const COLUMN_VISIBILITY_KEY = 'als-dashboard-column-visibility';
let COLUMN_VISIBILITY = {};
if(typeof localStorage !== 'undefined'){
  try{
    const stored = JSON.parse(localStorage.getItem(COLUMN_VISIBILITY_KEY) || 'null');
    if(stored && typeof stored === 'object'){
      COLUMN_VISIBILITY = stored;
    }
  }catch(err){
    console.warn('Could not parse saved column visibility state', err);
  }
}
const $viewOptions = document.getElementById('viewOptions');
const $viewOptionsBtn = document.getElementById('viewOptionsBtn');
const $viewOptionsMenu = document.getElementById('viewOptionsMenu');
const $columnToggleWrap = document.getElementById('columnToggleWrap');

// ---------- Utility + theming (unchanged bits you already had) ----------
const ESC_MAP = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}; const ESC_RE=/[&<>"']/g;
function esc(s){ return String(s==null?'':s).replace(ESC_RE, c => ESC_MAP[c]); }
function slugify(str){ return str.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,''); }

function persistColumnVisibility(){
  if(typeof localStorage === 'undefined') return;
  try{
    localStorage.setItem(COLUMN_VISIBILITY_KEY, JSON.stringify(COLUMN_VISIBILITY));
  }catch(err){
    console.warn('Could not store column visibility state', err);
  }
}
function ensureColumnVisibility(headers){
  let mutated=false;
  headers.forEach(h => {
    if(!Object.prototype.hasOwnProperty.call(COLUMN_VISIBILITY, h)){
      COLUMN_VISIBILITY[h]=true;
      mutated=true;
    }
  });
  if(headers.length && !headers.some(h => COLUMN_VISIBILITY[h] !== false)){
    headers.forEach(h => { COLUMN_VISIBILITY[h] = true; });
    mutated=true;
  }
  if(mutated){
    persistColumnVisibility();
  }
}
function getVisibleHeaders(headers){
  ensureColumnVisibility(headers);
  return headers.filter(h => COLUMN_VISIBILITY[h] !== false);
}
function syncColumnToggleUI(headers){
  if(!$columnToggleWrap) return;
  const activeEl=document.activeElement;
  const shouldRestoreFocus=$viewOptionsMenu && activeEl && $viewOptionsMenu.contains(activeEl);
  const activeToggleId=shouldRestoreFocus ? activeEl.id : '';
  ensureColumnVisibility(headers);
  const frag=document.createDocumentFragment();
  headers.forEach((h, idx)=>{
    const option=document.createElement('label');
    option.className='view-options__option';
    const input=document.createElement('input');
    input.type='checkbox';
    const baseSlug=slugify(h);
    const inputId=baseSlug ? `col-toggle-${baseSlug}-${idx}` : `col-toggle-col-${idx}`;
    input.id=inputId;
    input.checked=COLUMN_VISIBILITY[h] !== false;
    input.setAttribute('data-col', h);
    const text=document.createElement('span');
    text.textContent=h;
    option.append(input, text);
    frag.append(option);
  });
  $columnToggleWrap.innerHTML='';
  $columnToggleWrap.appendChild(frag);
  $columnToggleWrap.querySelectorAll('input[type="checkbox"]').forEach(input=>{
    input.addEventListener('change', ()=> handleColumnToggleChange(input));
  });
  if(activeToggleId){
    const focusTarget=document.getElementById(activeToggleId);
    if(focusTarget instanceof HTMLElement){
      focusTarget.focus();
    }
  }
}
function handleColumnToggleChange(input){
  const col=input.getAttribute('data-col');
  if(!col) return;
  if(!input.checked){
    const remaining=Array.from($columnToggleWrap.querySelectorAll('input[type="checkbox"]')).filter(cb=>cb.checked).length;
    if(remaining===0){
      input.checked=true;
      return;
    }
  }
  COLUMN_VISIBILITY[col]=input.checked;
  persistColumnVisibility();
  rerenderDashboards();
}
function setViewOptionsOpen(open){
  if(!$viewOptionsBtn || !$viewOptionsMenu) return;
  $viewOptionsBtn.setAttribute('aria-expanded', String(open));
  $viewOptionsMenu.hidden = !open;
  if($viewOptions){
    $viewOptions.classList.toggle('open', open);
  }
}
$viewOptionsBtn?.addEventListener('click', e=>{
  e.stopPropagation();
  const isOpen=$viewOptionsBtn.getAttribute('aria-expanded')==='true';
  setViewOptionsOpen(!isOpen);
});
$viewOptionsMenu?.addEventListener('click', e=> e.stopPropagation());
document.addEventListener('click', e=>{
  if(!$viewOptionsMenu || $viewOptionsMenu.hidden) return;
  if($viewOptions && $viewOptions.contains(e.target)) return;
  setViewOptionsOpen(false);
});
document.addEventListener('keydown', e=>{
  if(e.key==='Escape' && $viewOptionsMenu && !$viewOptionsMenu.hidden){
    setViewOptionsOpen(false);
    $viewOptionsBtn?.focus();
  }
});

// Category presets + fallback coloring
const CATEGORY_COLOR_PRESETS=[['Search','#E7F3FE','#1887FC'],['Cleaning','#FCEBFF','#EA7BFF'],['Commission','#E7DFFD','#855EF4'],['Contractor','#FFE6CC','#A24900'],['Daily Procedures','#FFE5DF','#FF7C60'],['Damage','#FFF5CC','#CC9900'],['Electrical','#FFE4D0','#FF7439'],['Eng Weekly Meeting','#FFE5DF','#FF7C60'],['Error Codes','#FFDBE6','#FF4A80'],['Fire Safety','#FFDBE6','#FF4A80'],['First Time Fix','#E7F3FE','#1887FC'],['General improvements','#E7DFFD','#855EF4'],['Inspection','#E7F3FE','#1887FC'],['James Indust Cleaner','#D9F5F1','#3FCBBB'],['Leak','#DDF9FC','#1887FC'],['Manufacturers Machine Service Procedure','#FCEBFF','#EA7BFF'],['Mechanical','#E7F3FE','#1A66CC'],['meters','#E7F3FE','#1570B8'],['Monthly Procedures','#FFE4D0','#FF7439'],['Ordering/Purchasing','#DDF9FC','#54DFF2'],['Planned Winter Project','#E7F3FE','#1887FC'],['Plumbing','#FCEBFF','#B24BEA'],['PPM','#E4F9E8','#2FB95A'],['Preventive','#E4F9E8','#2FB95A'],['Product Quality improvements','#E7F3FE','#1887FC'],['Programming','#FFE4D0','#D85E2E'],['Project','#E7F3FE','#2A7BEF'],['Reactive Maintenance','#DDF9FC','#2CCFE3'],['Refrigeration','#D9F5F1','#3FCBBB'],['Safety','#E7F3FE','#1870DA'],['Site maintenance responsabilities','#E7F3FE','#1868C0'],['Smart Check','#FFDBE6','#E43C75'],['Standard Operating Procedure','#FFDBE6','#E43C75'],['Top 5','#E7DFFD','#6D4CE6'],['Training','#E7F3FE','#1870DA'],['Weekly Procedures','#E7F3FE','#1870DA'],['Yearly Procedures','#FFF5CC','#8A6E00'],['Zero Emissions','#D9F5F1','#2AAE9E']];
const categoryColors = CATEGORY_COLOR_PRESETS.reduce((a,[label,bg,fg]) => (a[slugify(label)]={background:bg,foreground:fg}, a),{});
(function injectCategoryCSS(){
  const styleEl=document.createElement('style');
  styleEl.textContent = Object.entries(categoryColors).map(([slug,c]) => `.chip-cat.cat-${slug}{background:${c.background};color:${c.foreground};border-color:${c.foreground};}`).join('');
  document.head.appendChild(styleEl);
})();
function hashCategory(label){ let h=0, s=String(label||''); for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return Math.abs(h); }
function hslToRgb(h,s,l){ const hue=((h%360)+360)%360, S=Math.max(0,Math.min(100,s))/100, L=Math.max(0,Math.min(100,l))/100; const c=(1-Math.abs(2*L-1))*S, x=c*(1-Math.abs(((hue/60)%2)-1)), m=L-c/2; let r1=0,g1=0,b1=0; if(hue<60){r1=c;g1=x;} else if(hue<120){r1=x;g1=c;} else if(hue<180){g1=c;b1=x;} else if(hue<240){g1=x;b1=c;} else if(hue<300){r1=x;b1=c;} else {r1=c;b1=x;} return [r1+m,g1+m,b1+m]; }
function srgbToLinear(c){ return c<=0.04045?c/12.92:Math.pow((c+0.055)/1.055,2.4); }
function relativeLuminance(rgb){ const [r,g,b]=rgb.map(v=>srgbToLinear(Math.max(0,Math.min(1,v)))); return 0.2126*r+0.7152*g+0.0722*b; }
function contrastRatio(bgH,fgH){ const lBg=relativeLuminance(hslToRgb(bgH.h,bgH.s,bgH.l)), lFg=relativeLuminance(hslToRgb(fgH.h,fgH.s,fgH.l)); const light=Math.max(lBg,lFg), dark=Math.min(lBg,lFg); return (light+0.05)/(dark+0.05); }
function fallbackColors(label){ const hue=hashCategory(label)%360, bg={h:hue,s:45,l:92}, fg0={h:hue,s:60,l:32}; let fg={...fg0}; while(contrastRatio(bg,fg)<4.5 && fg.l>0){ fg={...fg,l:Math.max(0,fg.l-10)}; } return {background:`hsl(${bg.h}, ${bg.s}%, ${bg.l}%)`, foreground:`hsl(${fg.h}, ${fg.s}%, ${fg.l}%)`}; }
function chipStyle(label, slugOverride){ const slug=slugOverride||slugify(label), preset=categoryColors[slug]; if(preset) return {className:`cat-${slug}`, style:''}; const c=fallbackColors(label); return {className:`cat-${slug}`, style:`background:${c.background};border-color:${c.foreground};color:${c.foreground}`}; }

// CSV / JSON ingest helpers
function parseDelimited(text){
  const sep = text.includes('\t') ? '\t' : ',';
  const rows = text.trim().split(/\r?\n/).map(r =>
    r.split(new RegExp(`${sep}(?=(?:[^"]*"[^"]*")*[^"]*$)`)).map(c => c.replace(/^"|"$/g,''))
  );
  const rawHeaders = rows.shift() || [];
  const headers = rawHeaders.map((h,i)=>String(h??'').replace(/^\uFEFF/,'').trim()||`col${i}`);
  const data = rows.map(r => Object.fromEntries(r.map((v,i)=>[headers[i]||`col${i}`, v])));
  return { headers, rows: data };
}
function handleJSON(text){
  const data = JSON.parse(text);
  const rows = Array.isArray(data) ? data : (Array.isArray(data.rows) ? data.rows : []);
  const headers = rows.length ? Object.keys(rows[0]) : [];
  return { headers, rows };
}

// Site helpers / sorting / status
function toSiteKey(loc){ const s=String(loc||'').toLowerCase(); if(s.includes('byron'))return'by'; if(s.includes('mugiemoss')||s.includes('bucksburn'))return'mm'; if(s.includes('keith'))return'keith'; if(s.includes('cathkin')||s.includes('east kilbride')||s.includes('ek'))return'ek'; return'other'; }
function kpiCard(label,val){ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<h3>${esc(label)}</h3><div class="big">${esc(val)}</div>`; return el; }
const PRIORITY_ORDER=['critical','high','medium','low','']; const STATUS_ORDER=['open','in-progress','on-hold','done',''];
function parseDateLoose(v){
  if(!v) return null;
  const m=String(v).trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2}))?$/);
  if(!m) return null;
  let [,d,M,y,hh='00',mm='00']=m;
  d=d.padStart(2,'0');
  M=M.padStart(2,'0');
  hh=hh.padStart(2,'0');
  const dt=new Date(`${y}-${M}-${d}T${hh}:${mm}:00`);
  return isNaN(dt.getTime())?null:dt;
}
function normalizePriority(v){ if(v==null) return ''; let slug=slugify(String(v).trim()); if(!slug) return''; if(slug.endsWith('-priority')) slug=slug.replace(/-priority$/,''); if(slug==='med'||slug==='normal') slug='medium'; if(slug==='urgent'||slug==='emergency') slug='critical'; return slug; }
function cmpPriority(a,b){ const ia=PRIORITY_ORDER.indexOf(normalizePriority(a)), ib=PRIORITY_ORDER.indexOf(normalizePriority(b)); const safe=i=>(i===-1?PRIORITY_ORDER.length:i); const diff=safe(ia)-safe(ib); return diff||String(a??'').localeCompare(String(b??''),undefined,{numeric:true,sensitivity:'base'}); }
function statusClass(v){ const map=new Map([['done','done'],['complete','done'],['completed','done'],['open','open'],['in-progress','in-progress'],['in progress','in-progress'],['progress','in-progress'],['inprogress','in-progress'],['on-hold','on-hold'],['on hold','on-hold'],['hold','on-hold'],['onhold','on-hold']]); const s=slugify(String(v||'')); return map.get(s)||s; }
function cmpStatus(a,b){ const ia=STATUS_ORDER.indexOf(statusClass(a)), ib=STATUS_ORDER.indexOf(statusClass(b)); const safe=i=>(i===-1?STATUS_ORDER.length:i); const diff=safe(ia)-safe(ib); return diff||String(a??'').localeCompare(String(b??''),undefined,{numeric:true,sensitivity:'base'}); }
function cmpId(a,b){ const na=parseInt(String(a).replace(/\D+/g,''),10)||0; const nb=parseInt(String(b).replace(/\D+/g,''),10)||0; return na-nb; }
function detectType(col,rows){ const n=String(col||'').trim().toLowerCase(); const sample=rows.slice(0,10).map(r=>r[col]); const allDates=sample.length&&sample.every(v=>parseDateLoose(v)!==null); const allNums=sample.length&&sample.every(v=>typeof v==='number'||/^\s*[-+]?\d+(\.\d+)?\s*$/.test(String(v))); if(allDates)return'date'; if(allNums)return'number'; if(n==='id')return'id'; if(n==='priority')return'priority'; if(n==='status')return'status'; return'string'; }

// Filters
const $searchInput = document.getElementById('globalSearch');
const $statusFilter = document.getElementById('statusFilter');
const $priorityFilter = document.getElementById('priorityFilter');
const $activeFilterChips = document.getElementById('activeFilterChips');

function humanizeFilterValue(value){
  return String(value || '')
    .split(/[-_\s]+/)
    .filter(Boolean)
    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
    .join(' ');
}

function updateActiveFilterChips(filters){
  if(!$activeFilterChips) return;

  const chips=[];

  if(filters.status){
    const label=humanizeFilterValue(filters.status);
    const text=filters.excludeStatus?`Status ≠ ${label}`:`Status: ${label}`;
    const aria=filters.excludeStatus?`Clear status filter (not ${label})`:`Clear status filter: ${label}`;
   chips.push({
  key:'status',
  text,
  aria,
  onRemove:()=>{
    if($statusFilter){
      $statusFilter.value='';
      $statusFilter.dispatchEvent(new Event('change',{bubbles:true}));
    }
  }
});
  }

  if(filters.priority){
    const label=humanizeFilterValue(filters.priority);
    const text=`Priority: ${label}`;
    const aria=`Clear priority filter: ${label}`;
    chips.push({
      key:'priority',
      text,
      aria,
      onRemove:()=>{
        if($priorityFilter){
          $priorityFilter.value='';
          $priorityFilter.dispatchEvent(new Event('change',{bubbles:true}));
        }
      }
    });
  }

  if(filters.search){
    const text=`Search: ${filters.search}`;
    const aria=`Clear search filter: ${filters.search}`;
    chips.push({
  key:'search',
  text,
  aria,
  onRemove:()=>{
    if($searchInput){
      $searchInput.value='';
      // fire input so filtering runs immediately
      $searchInput.dispatchEvent(new Event('input',{bubbles:true}));
    }
  }
});
  }

  if(!chips.length){
    $activeFilterChips.innerHTML='';
    $activeFilterChips.setAttribute('hidden','');
    return;
  }

  const frag=document.createDocumentFragment();
  chips.forEach(chip=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='filter-chip';
    btn.dataset.filter=chip.key;
    btn.setAttribute('aria-label', chip.aria);
    btn.title=chip.aria;

    const label=document.createElement('span');
    label.className='filter-chip__label';
    label.textContent=chip.text;

    const icon=document.createElement('span');
    icon.className='filter-chip__icon';
    icon.setAttribute('aria-hidden','true');
    icon.textContent='×';

    btn.append(label, icon);
    btn.addEventListener('click', chip.onRemove);
    frag.appendChild(btn);
  });

  $activeFilterChips.innerHTML='';
  $activeFilterChips.removeAttribute('hidden');
  $activeFilterChips.appendChild(frag);
}

function getFilters(){
  const rawStatus = ($statusFilter?.value || '').trim().toLowerCase();
  let status = '';
  let excludeStatus = false;

  // use the real input you have in the HTML
  const searchTerm = ($searchInput?.value || '').trim();

  if(rawStatus){
    const negMatch = rawStatus.match(/^(?:not[:\s]+|!)(.+)$/);
    if(negMatch){
      status = negMatch[1].trim();
      excludeStatus = true;
    }else{
      status = rawStatus;
    }
  }

  status = status ? statusClass(status) : '';
  if(!status){
    excludeStatus = false;
  }

  return {
    status,
    excludeStatus,
    priority: normalizePriority($priorityFilter?.value || ''),
    searchTerm
  };
}

const SEARCHABLE_FIELDS = ['ID','Title','Status','Priority','Assigned to','Created by','Created on','Completed on','Last updated','Location','Asset','Categories'];

function applyFilters(rows){
  const filters = getFilters();
  // keep the nice chips UI updated
  updateActiveFilterChips({
    status: filters.status,
    excludeStatus: filters.excludeStatus,
    priority: filters.priority,
    search: filters.searchTerm
  });

  const { status, excludeStatus, priority, searchTerm } = filters;
  const tokens = searchTerm ? searchTerm.toLowerCase().split(/\s+/).filter(Boolean) : [];

  return rows.filter(r => {
    const rowStatus = statusClass(r['Status']);
    const okStatus = !status ? true : (excludeStatus ? rowStatus !== status : rowStatus === status);
    const okPrio   = !priority || normalizePriority(r['Priority']) === priority;

    let okSearch = true;
    if(tokens.length){
      const haystack = SEARCHABLE_FIELDS.map(key => String(r[key] ?? '')).join(' ').toLowerCase();
      okSearch = tokens.every(t => haystack.includes(t));
    }

    return okStatus && okPrio && okSearch;
  });
}

function rerenderDashboards(){
  if (LAST_HEADERS && ALL_ROWS) {
    ingestToDashboards(LAST_HEADERS, ALL_ROWS);
  } else {
    updateActiveFilterChips(getFilters());
  }
}

$statusFilter?.addEventListener('change', rerenderDashboards);
$priorityFilter?.addEventListener('change', rerenderDashboards);
$searchInput?.addEventListener('input', rerenderDashboards);
$searchInput?.addEventListener('change', rerenderDashboards);

// Rendering
function renderDashboard(container, headers, rows){
  container.innerHTML='';
  container.__rows = rows.slice();
  // KPIs
  const kpiWrap=document.createElement('div'); kpiWrap.className='kpis';
  const total=rows.length;
  const open =rows.filter(r=>/^open$/i.test(r.Status)).length;
  const prog =rows.filter(r=>/^in\s*progress$/i.test(r.Status)).length;
  const hold =rows.filter(r=>/^on\s*hold$/i.test(r.Status)).length;
  const done =rows.filter(r=>/^done$/i.test(r.Status)).length;
  kpiWrap.appendChild(kpiCard('Total WOs', total));
  kpiWrap.appendChild(kpiCard('Open', open));
  kpiWrap.appendChild(kpiCard('In Progress', prog));
  kpiWrap.appendChild(kpiCard('On Hold', hold));
  kpiWrap.appendChild(kpiCard('Done', done));
  container.appendChild(kpiWrap);

  if(rows.length===0){
    const msg=document.createElement('div');
    msg.style.margin='8px 0';
    msg.style.color='var(--muted)';
    msg.textContent='No work orders match the current filters.';
    container.appendChild(msg);
    return;
  }

  const visibleHeaders=getVisibleHeaders(headers);
  if(visibleHeaders.length===0){
    const msg=document.createElement('div');
    msg.style.margin='8px 0';
    msg.style.color='var(--muted)';
    msg.textContent='All columns are hidden. Use View Options to show at least one column.';
    container.appendChild(msg);
    return;
  }

  // Table
  const table=document.createElement('table'); table.setAttribute('role','table'); table.setAttribute('aria-label','Work Orders');
  const tableWrap=document.createElement('div'); tableWrap.className='table-scroll';
  const thead=document.createElement('thead'); const tbody=document.createElement('tbody');
  table.appendChild(thead); table.appendChild(tbody); tableWrap.appendChild(table); container.appendChild(tableWrap);

  thead.innerHTML=`<tr>${visibleHeaders.map(h=>`<th scope="col" data-col="${esc(h)}" tabindex="0"><span>${esc(h)}</span><span class="sort-arrow" aria-hidden="true"></span></th>`).join('')}</tr>`;
  thead.querySelectorAll('th').forEach(th=>{
    th.addEventListener('click', ()=> sortScoped(th, tbody, visibleHeaders, rows, container));
    th.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); sortScoped(th, tbody, visibleHeaders, rows, container); } });
  });

  renderRowsScoped(tbody, visibleHeaders, rows);

}

function renderRowsScoped(tbodyEl, headers, rows){
  const norm=s=>String(s||'').trim().toLowerCase();
  tbodyEl.innerHTML = rows.map(row => {
    return `<tr>${headers.map(h=>{
      const v=row[h]; const hNorm=norm(h);

      if(hNorm==='categories'){
        const seen=new Set();
        const chips=String(v||'')
          .split(/[,;]+/)            // <— support commas AND semicolons
          .map(c=>c.trim()).filter(Boolean)
          .map(cat=>{
            const slug=slugify(cat);
            if(seen.has(slug)) return '';
            seen.add(slug);
            const { className, style } = chipStyle(cat, slug);
            const styleAttr = style ? ` style="${style}"` : '';
            const classAttr = className ? ` ${className}` : '';
            return `<span class="chip-cat${classAttr}"${styleAttr}>${esc(cat)}</span>`;
          }).filter(Boolean).join('');
        return `<td>${chips}</td>`;
      }

      if(hNorm==='status'){
        const cls=statusClass(v);
        return `<td><span class="status-chip ${cls}">${esc(v)}</span></td>`;
      }

      return `<td>${esc(v)}</td>`;
    }).join('')}</tr>`;
  }).join('\n');
}

function sortScoped(th, tbodyEl, headers, rows, container){
  const col=th.getAttribute('data-col');
  const dir=th.getAttribute('data-sort')==='asc'?'desc':'asc';
  Array.from(th.parentElement.children).forEach(h=>{ if(h!==th){ h.removeAttribute('data-sort'); h.setAttribute('aria-sort','none'); }});
  th.setAttribute('data-sort', dir); th.setAttribute('aria-sort', dir==='asc'?'ascending':'descending');

  const type=detectType(col, rows); const f=dir==='asc'?1:-1;
  const sorted=[...(container.__rows||rows)].sort((a,b)=>{
    const va=a[col], vb=b[col];
    if(type==='date'){ const da=parseDateLoose(va), db=parseDateLoose(vb); return f*((da?.getTime()||0)-(db?.getTime()||0)); }
    if(type==='number'){ return f*((parseFloat(va)||0)-(parseFloat(vb)||0)); }
    if(type==='priority'){ return f*cmpPriority(va,vb); }
    if(type==='status'){ return f*cmpStatus(va,vb); }
    if(type==='id'){ return f*cmpId(va,vb); }
    return f*String(va??'').localeCompare(String(vb??''),undefined,{numeric:true,sensitivity:'base'});
  });

  container.__rows = sorted;
  renderRowsScoped(tbodyEl, headers, sorted);
}

// Ingest + dashboards
function ingestToDashboards(headers, rows){
  const expected=['ID','Title','Status','Priority','Assigned to','Created by','Created on','Completed on','Last updated','Location','Asset','Categories'];
  const present = expected.filter(h => headers.includes(h));
  const safeHeaders = present.length ? present : expected;
  const activeDashEl=document.querySelector('.dash[data-active="true"]');
  const activeDashId=activeDashEl?.id || 'dash-all';

  const normalized = rows.map(r => {
    const o={}; expected.forEach(h => { o[h] = r[h] ?? ''; }); return o;
  });

  const filtered = applyFilters(normalized);

  syncColumnToggleUI(safeHeaders);

  const groups={
    all  : filtered,
    ek   : filtered.filter(r=>toSiteKey(r.Location)==='ek'),
    mm   : filtered.filter(r=>toSiteKey(r.Location)==='mm'),
    keith: filtered.filter(r=>toSiteKey(r.Location)==='keith'),
    by   : filtered.filter(r=>toSiteKey(r.Location)==='by'),
  };

  [['dash-all','all'],['dash-ek','ek'],['dash-mm','mm'],['dash-keith','keith'],['dash-by','by']].forEach(([id,key])=>{
    const el=document.getElementById(id);
    renderDashboard(el, safeHeaders, groups[key]);
  });

  setActiveDash(activeDashId);
}

// Tabs
const tabs = Array.from(document.querySelectorAll('.nav .tab'));
tabs.forEach(btn => btn.addEventListener('click', ()=> setActiveDash(btn.getAttribute('aria-controls'))));
function setActiveDash(id){
  document.querySelectorAll('.dash').forEach(sec => sec.setAttribute('data-active', String(sec.id===id)));
  tabs.forEach(t => t.setAttribute('aria-selected', String(t.getAttribute('aria-controls')===id)));
}

// File ingest (unchanged, but now reuses the same ingest/render)
document.getElementById('file').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    const text=reader.result; let headers=[], rows=[];
    try{
      const result=(/json$/i.test(f.name) || text.trim().startsWith('[') || text.trim().startsWith('{')) ? handleJSON(text) : parseDelimited(text);
      headers=result.headers; rows=result.rows;
    }catch(err){ alert('Could not parse file: '+err.message); }
    LAST_HEADERS=headers; ALL_ROWS=rows; ingestToDashboards(LAST_HEADERS, ALL_ROWS);
  };
  reader.readAsText(f);
});

// Theme toggle (unchanged)
const themeBtn=document.getElementById('themeBtn');
function applyTheme(theme){
  const isDark=theme==='dark';
  document.body.classList.toggle('dark', isDark);
  document.body.classList.toggle('light', !isDark);
  themeBtn.textContent=isDark?'Light mode':'Dark mode';
  themeBtn.setAttribute('aria-pressed', isDark?'true':'false');
  themeBtn.setAttribute('aria-label', isDark?'Switch to light mode':'Switch to dark mode');
}
const savedTheme=localStorage.getItem('theme');
const prefersDark=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
themeBtn.addEventListener('click', ()=>{
  const newTheme=document.body.classList.contains('dark')?'light':'dark';
  applyTheme(newTheme); localStorage.setItem('theme', newTheme);
});

// --- Load live data from Google Sheet (with cache-buster) ---
async function loadFromGoogleSheetCSV(){
  try{
    const url=SHEET_CSV_URL + '&_ts=' + Date.now();
    const res=await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const text=await res.text();
    const { headers, rows } = parseDelimited(text);
    const REQUIRED=['ID','Title','Status','Priority','Assigned to','Created by','Created on','Completed on','Last updated','Location','Asset','Categories'];
    const missing=REQUIRED.filter(h=>!headers.includes(h));
    if(missing.length>0) console.warn('Missing expected headers:', missing);
    LAST_HEADERS=headers; ALL_ROWS=rows;
    ingestToDashboards(LAST_HEADERS, ALL_ROWS);
  }catch(err){
    console.error('Sheet load failed:', err);
    alert('Could not load Google Sheet. Check sharing/publish settings and URL.');
  }
}
document.addEventListener('DOMContentLoaded', loadFromGoogleSheetCSV);

</script>
</body>
</html>
