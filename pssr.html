<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSSR Inspection Tracker – ALS Engineering Dashboard</title>
  <style>
    :root {
      --bg:#f3f5f9;
      --paper:#ffffff;
      --ink:#0b0f1a;
      --muted:#6b7280;
      --border:#e5e9f2;

      --brand:#0b67c2;
      --brand-strong:#0a5cb0;

      --btn-fg:#ffffff;
      --btn-bg:var(--brand);
      --btn-bg-hover:var(--brand-strong);
      --btn-outline-fg:var(--brand);
      --btn-outline-bd:#bcd7f4;
      --btn-ghost-fg:var(--brand);
      --btn-ghost-bg:transparent;
      --btn-ghost-bg-hover:rgba(11,103,194,.10);

      --input-bg:#ffffff;
      --input-fg:var(--ink);
      --input-bd:var(--border);
      --input-bd-focus:var(--brand);
      --shadow:0 1px 2px rgba(16,24,40,.06),0 4px 10px rgba(16,24,40,.06);

      --als-blue:var(--brand);
      --als-blue-strong:var(--brand-strong);
      --thead:var(--brand);
      --thead-text:#fff;
      --grid:var(--border);
      --zebra:var(--paper);
      --sticky-controls-offset:0px;
      --table-min-width:720px;
      color-scheme:light;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        color-scheme:dark;
        --bg:#0f1422;
        --paper:#131a2b;
        --ink:#f3f4f6;
        --muted:#9ca3af;
        --border:#233150;
        --brand:#3b82f6;
        --brand-strong:#2563eb;
        --btn-outline-bd:#2b3a63;
        --btn-ghost-bg-hover:rgba(11,103,194,.18);
        --input-bg:#0f1422;
        --input-fg:#f3f4f6;
        --input-bd:#233150;
        --input-bd-focus:#3b82f6;
        --als-blue:var(--brand);
        --als-blue-strong:var(--brand-strong);
        --thead:#1e3a8a;
        --grid:#233150;
        --zebra:#1c2438;
      }
    }

    body {
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      font-size:13px;
      line-height:1.4;
      -webkit-font-smoothing:antialiased;
    }

    body::before {
      content:"";
      position:fixed;
      inset:0 0 auto 0;
      height:var(--sticky-controls-offset);
      background:var(--bg);
      pointer-events:none;
      z-index:180;
    }

    .page {
      --page-pad-top:12px;
      --page-pad-inline:clamp(20px,4vw,32px);
      --page-pad-bottom:28px;
      padding:var(--page-pad-top) var(--page-pad-inline) var(--page-pad-bottom);
      max-width:clamp(920px,94vw,1320px);
      margin-inline:auto;
      box-sizing:border-box;
    }

    @media (max-width: 960px){
      .page {
        --page-pad-inline:clamp(18px,6vw,26px);
        --page-pad-bottom:24px;
      }
    }

    @media (max-width: 720px){
      .page {
        --page-pad-inline:16px;
        --page-pad-bottom:20px;
      }
    }

    .page-head {
      display:flex;
      align-items:center;
      gap:16px;
      justify-content:space-between;
      margin-bottom:8px;
      position:relative;
      z-index:260;
    }

    .page-head__title {
      display:flex;
      align-items:center;
      gap:12px;
      flex:1 1 auto;
      min-width:0;
      flex-wrap:wrap;
    }

    .page-head__title .title {
      margin:0;
      flex:1 1 auto;
      min-width:0;
    }

    .title {
      font-size:24px;
      font-weight:800;
      margin:0;
    }

    .logo {
      height:38px;
      margin-left:auto;
      flex-shrink:0;
    }

    .nav {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin:4px 0 0;
    }

    .nav .tab {
      padding:7px 12px;
      border-radius:999px;
      border:1px solid var(--grid);
      background:transparent;
      color:var(--ink);
      font-weight:700;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:box-shadow .15s ease,border-color .15s ease,background .15s ease;
    }

    .nav .tab[aria-selected="true"],
    .nav .tab:focus-visible {
      outline:none;
      border-color:var(--als-blue);
      background:color-mix(in srgb,var(--als-blue) 8%,var(--paper));
      box-shadow:0 0 0 2px color-mix(in srgb,var(--als-blue) 30%,transparent);
    }

    .top-rule {
      height:2px;
      background:var(--als-blue);
      border-bottom:1px solid var(--als-blue-strong);
      margin:0;
    }

    .pssr-overview {
      margin:18px 0 12px;
      padding:18px;
      border:1px solid color-mix(in srgb,var(--grid) 78%,transparent);
      border-radius:14px;
      background:color-mix(in srgb,var(--als-blue) 3%,var(--paper));
      display:grid;
      gap:16px;
    }

    .pssr-overview__intro {
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .pssr-overview__eyebrow {
      font-size:12px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--als-blue);
      margin:0;
    }

    .pssr-overview__headline {
      margin:0;
      font-size:19px;
      font-weight:750;
      line-height:1.28;
    }

    .pssr-overview__description {
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
      max-width:48ch;
    }

    .pssr-metrics {
      margin:0;
      display:grid;
      gap:10px;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
    }

    .pssr-metrics__item {
      padding:12px 14px;
      border-radius:12px;
      border:1px solid color-mix(in srgb,var(--als-blue) 12%,var(--grid));
      background:color-mix(in srgb,var(--paper) 96%,var(--als-blue) 1%);
      box-shadow:0 4px 10px rgba(15,23,42,0.05);
      display:flex;
      flex-direction:column;
      gap:4px;
      min-height:96px;
      transition:border-color .18s ease, box-shadow .18s ease, transform .18s ease;
    }

    .pssr-metrics__item:hover,
    .pssr-metrics__item:focus-within {
      transform:translateY(-1px);
      box-shadow:0 8px 16px rgba(15,23,42,0.08);
    }

    .pssr-metrics__item.is-alert {
      border-color:color-mix(in srgb,#dc2626 45%,transparent);
      box-shadow:0 12px 24px rgba(220,38,38,0.18);
    }

    .pssr-metrics__item.is-warning {
      border-color:color-mix(in srgb,#b45309 45%,transparent);
      box-shadow:0 12px 24px rgba(180,83,9,0.18);
    }

    .pssr-metrics__label {
      margin:0;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:color-mix(in srgb,var(--muted) 82%,var(--ink));
    }

    .pssr-metrics__value {
      font-size:24px;
      font-weight:800;
      line-height:1.1;
    }

    .pssr-metrics__note {
      margin:0;
      color:var(--muted);
      font-size:11.5px;
      line-height:1.4;
    }

    @media (prefers-reduced-motion: reduce){
      .pssr-metrics__item,
      .pssr-metrics__item:hover,
      .pssr-metrics__item:focus-within {
        transition:none;
        transform:none;
        box-shadow:0 6px 14px rgba(15,23,42,0.06);
      }
    }

    @media (min-width: 1080px){
      .pssr-overview {
        grid-template-columns:minmax(0,1.2fr) minmax(0,1.8fr);
        align-items:start;
      }
    }

    @media (max-width: 640px){
      .pssr-overview {
        padding:16px;
        gap:14px;
      }
    }

    .sticky-top {
      position:sticky;
      top:0;
      z-index:300;
      background:color-mix(in srgb,var(--bg) 20%,transparent);
      border-bottom:1px solid color-mix(in srgb,var(--border) 55%,transparent);
      padding:8px 0;
      backdrop-filter:blur(12px);
    }

    .sticky-top__content {
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      row-gap:8px;
      flex-wrap:wrap;
    }

    .controls-bar {
      background:transparent;
      border:0;
      box-shadow:none;
      padding:8px 0;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .controls-bar>* {
      flex:0 0 auto;
    }

    .sticky-controls {
      display:flex;
      gap:10px;
      row-gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .controls-bar label {
      color:var(--muted);
      font-weight:600;
    }

    .controls-bar select {
      background:var(--input-bg);
      color:var(--input-fg);
      border:1px solid var(--input-bd);
      border-radius:10px;
      padding:8px 10px;
      font:inherit;
      transition:border-color .18s ease,box-shadow .18s ease,background-color .18s ease;
      flex:1 1 auto;
      min-width:0;
    }

    .controls-bar select:focus {
      outline:0;
      border-color:var(--input-bd-focus);
      box-shadow:0 0 0 3px color-mix(in oklab,var(--input-bd-focus) 30%,transparent);
    }

    .mobile-sort {
      display:none;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--ink);
    }

    .btn {
      --pad-x:14px;
      --pad-y:8px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:var(--pad-y) var(--pad-x);
      border-radius:999px;
      font-weight:600;
      line-height:1;
      border:1px solid transparent;
      cursor:pointer;
      transition:transform .02s ease,background .15s ease,border-color .15s ease;
      color:var(--ink);
      background:var(--btn-ghost-bg);
    }

    .btn:active {
      transform:translateY(1px);
    }

    .btn--primary {
      color:var(--btn-fg);
      background:var(--btn-bg);
      border-color:var(--btn-bg);
    }

    .btn--primary:hover {
      background:var(--btn-bg-hover);
    }

    .btn--outline {
      color:var(--btn-outline-fg);
      background:transparent;
      border-color:var(--btn-outline-bd);
    }

    .btn--outline:hover {
      border-color:var(--btn-outline-fg);
    }

    .btn--ghost {
      color:var(--btn-ghost-fg);
      background:var(--btn-ghost-bg);
    }

    .btn--ghost:hover {
      background:var(--btn-ghost-bg-hover);
    }

    .btn--sm {
      --pad-x:10px;
      --pad-y:6px;
      font-size:12px;
    }

    .refresh-btn {
      margin-right:auto;
    }

    .table-wrapper {
      margin-top:16px;
    }

    table {
      width:100%;
      min-width:var(--table-min-width, 720px);
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }

    .visually-hidden {
      position:absolute !important;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    .table-scroll {
      position:relative;
      overflow:auto;
      border:1px solid var(--grid);
      border-radius:12px;
      background:var(--paper);
      box-shadow:0 2px 10px rgba(15, 23, 42, 0.05);
      max-height:calc(100vh - var(--sticky-controls-offset) - 220px);
      padding:0 2px 2px;
    }

    .table-scroll thead {
      position:sticky;
      top:0;
      background:var(--thead);
      z-index:2;
    }

    .table-scroll thead th {
      background:var(--thead);
      color:var(--thead-text);
      font-weight:750;
      letter-spacing:0.1px;
      padding:9px 8px;
      border-bottom:1px solid color-mix(in srgb,#000 18%,transparent);
      text-align:left;
      white-space:nowrap;
      position:relative;
      cursor:pointer;
    }

    .table-scroll thead th[data-col="Last Inspection Date"],
    .table-scroll thead th[data-col="Next Inspection Date"] {
      white-space:normal;
    }

    .table-scroll thead th:first-child {
      border-top-left-radius:12px;
    }

    .table-scroll thead th:last-child {
      border-top-right-radius:12px;
    }

    .table-scroll thead th .sort-arrow {
      display:inline-block;
      margin-left:8px;
      width:0;
      height:0;
      border-left:5px solid transparent;
      border-right:5px solid transparent;
      border-top:7px solid currentColor;
      opacity:0.25;
      transform:translateY(-1px);
      transition:opacity .15s ease, transform .15s ease;
    }

    .table-scroll thead th[data-sort="asc"] .sort-arrow {
      opacity:1;
      transform:translateY(-1px);
    }

    .table-scroll thead th[data-sort="desc"] .sort-arrow {
      opacity:1;
      transform:rotate(180deg) translateY(-1px);
    }

    tbody td {
      padding:9px 8px;
      border-bottom:1px solid var(--grid);
      background:var(--zebra);
      vertical-align:top;
      word-break:break-word;
      line-height:1.35;
    }

    tbody tr:last-child td {
      border-bottom:none;
    }

    tbody tr:nth-child(even) td {
      background:color-mix(in srgb,var(--grid) 12%,var(--zebra));
    }

    tbody tr.row-overdue td {
      background:color-mix(in srgb,#dc2626 16%,var(--zebra));
      color:color-mix(in srgb,#1f2937 15%,var(--ink));
    }

    .table-scroll thead th[data-col="Last Inspection Date"],
    .table-scroll tbody td[data-col="Last Inspection Date"],
    .table-scroll thead th[data-col="Next Inspection Date"],
    .table-scroll tbody td[data-col="Next Inspection Date"] {
      width:132px;
    }

    .table-scroll thead th[data-col="Location"],
    .table-scroll tbody td[data-col="Location"] {
      width:200px;
    }

    .table-scroll thead th[data-col="Comments"],
    .table-scroll tbody td[data-col="Comments"] {
      width:360px;
    }

    tbody td[data-col="Comments"] {
      max-width:420px;
    }

    tbody td[data-col] > span {
      display:block;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    tbody td[data-col="Comments"] > span,
    tbody td[data-col="Comments"] {
      white-space:normal;
      overflow:visible;
    }

    .countdown-chip {
      display:inline-flex;
      align-items:center;
      font-weight:800;
      font-size:12px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid currentColor;
      font-variant-numeric:tabular-nums;
    }

    .countdown-chip.is-unknown {
      color:var(--muted);
      border-style:dashed;
    }

    .countdown-chip.is-urgent {
      color:#b91c1c;
      background:color-mix(in srgb,#b91c1c 20%,transparent);
      box-shadow:0 0 0 1px color-mix(in srgb,#b91c1c 35%,transparent);
    }

    .countdown-chip.is-warning {
      color:#b45309;
      background:color-mix(in srgb,#b45309 18%,transparent);
    }

    .countdown-chip.is-healthy {
      color:#047857;
      background:color-mix(in srgb,#047857 18%,transparent);
    }

    .countdown-chip.is-excellent {
      color:#0f766e;
      background:color-mix(in srgb,#0f766e 18%,transparent);
    }

    .empty-state {
      padding:20px;
      text-align:center;
      color:var(--muted);
    }

    .status-note {
      font-size:12px;
      color:var(--muted);
    }

    .table-scroll[data-loading="true"] tbody {
      opacity:.4;
    }

    .loading-banner,
    .error-banner {
      display:flex;
      align-items:center;
      gap:8px;
      padding:12px 16px;
      border-radius:12px;
      font-weight:600;
      margin-top:18px;
    }

    .loading-banner {
      background:color-mix(in srgb,var(--als-blue) 12%,var(--paper));
      color:var(--als-blue);
      border:1px solid color-mix(in srgb,var(--als-blue) 35%,transparent);
    }

    .error-banner {
      background:color-mix(in srgb,#dc2626 12%,var(--paper));
      color:#991b1b;
      border:1px solid color-mix(in srgb,#b91c1c 35%,transparent);
    }

    .mobile-cards {
      display:none;
      margin-top:18px;
    }

    body[data-table-mode="mobile"] .table-wrapper {
      display:none;
    }

    body[data-table-mode="mobile"] .mobile-cards {
      display:block;
    }

    body[data-table-mode="mobile"] .sticky-top__content {
      flex-direction:column;
      align-items:flex-start;
    }

    body[data-table-mode="mobile"] .sticky-controls {
      width:100%;
      flex-direction:column;
      align-items:stretch;
      gap:12px;
    }

    body[data-table-mode="mobile"] .refresh-btn {
      width:100%;
      justify-content:center;
    }

    body[data-table-mode="mobile"] .mobile-sort {
      display:grid;
      width:100%;
      gap:8px;
    }

    body[data-table-mode="mobile"] .mobile-sort label {
      font-weight:600;
    }

    body[data-table-mode="mobile"] .mobile-sort select,
    body[data-table-mode="mobile"] .mobile-sort__direction {
      width:100%;
    }

    .mobile-card {
      border:1px solid var(--grid);
      border-radius:14px;
      padding:14px;
      background:var(--paper);
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      box-shadow:0 4px 12px rgba(15,23,42,.08);
    }

    .mobile-card + .mobile-card {
      margin-top:12px;
    }

    .mobile-card__title {
      font-weight:800;
      font-size:15px;
      line-height:1.35;
    }

    .mobile-card__meta {
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
      color:var(--muted);
    }

    .mobile-card__row {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      font-size:12px;
    }

    .mobile-card.row-overdue {
      border-color:color-mix(in srgb,#dc2626 45%,var(--grid));
      box-shadow:0 0 0 2px color-mix(in srgb,#dc2626 22%,transparent);
    }

    .mobile-card--status {
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      color:var(--muted);
      font-weight:600;
      min-height:96px;
      gap:8px;
    }

    @media (max-width:540px) {
      .mobile-card {
        padding:12px;
      }
      .mobile-card__row {
        flex-direction:column;
        align-items:flex-start;
        gap:4px;
      }
      .mobile-card__meta {
        font-size:11.5px;
      }
    }

    @media (max-width:1170px) {
      .page {
        --page-pad-inline:24px;
      }
      table {
        min-width:var(--table-min-width, 720px);
      }
    }

    @media (max-width:936px) {
      .table-wrapper { display:none; }
      .mobile-cards { display:block; }
      .sticky-top__content { flex-direction:column; align-items:flex-start; }
      .sticky-controls { width:100%; flex-direction:column; align-items:stretch; gap:12px; }
      .refresh-btn { width:100%; justify-content:center; }
      .mobile-sort { display:grid; width:100%; gap:8px; }
      .mobile-sort label { font-weight:600; }
      .mobile-sort select { width:100%; }
      .mobile-sort__direction { width:100%; }
    }

    @media print {
      body::before { display:none; }
      .sticky-top { position:static; }
      .table-scroll { max-height:none; box-shadow:none; border-radius:0; }
      .mobile-cards { display:none !important; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-head">
      <div class="page-head__title">
        <h1 class="title">PSSR Inspection Tracker</h1>
        <nav class="nav" aria-label="Dashboard sections">
          <a class="tab" href="index.html">Work Orders</a>
          <a class="tab" href="facilities.html">Facilities</a>
          <a class="tab" aria-selected="true" href="pssr.html">PSSR Inspections</a>
        </nav>
      </div>
      <img src="LOGOlesswhitespace.png" alt="ALS Engineering" class="logo" />
    </header>
    <div class="top-rule" role="presentation"></div>
    <section class="pssr-overview">
      <div class="pssr-overview__intro">
        <p class="pssr-overview__eyebrow">Regulatory compliance</p>
        <h2 class="pssr-overview__headline">Upcoming PSSR inspections at a glance</h2>
        <p class="pssr-overview__description">Monitor the statutory schedule for pressure system inspections and spot overdue actions before they escalate.</p>
        <p class="status-note">Data refreshes automatically from the published Google Sheet once available.</p>
      </div>
      <dl class="pssr-metrics" data-role="pssr-metrics">
        <div class="pssr-metrics__item" data-metric="total">
          <dt class="pssr-metrics__label">Total inspections</dt>
          <dd class="pssr-metrics__value" data-metric-value>—</dd>
          <dd class="pssr-metrics__note" data-metric-note>Awaiting data</dd>
        </div>
        <div class="pssr-metrics__item" data-metric="due-soon">
          <dt class="pssr-metrics__label">Due soon</dt>
          <dd class="pssr-metrics__value" data-metric-value>—</dd>
          <dd class="pssr-metrics__note" data-metric-note>Due within 60 days</dd>
        </div>
        <div class="pssr-metrics__item" data-metric="overdue">
          <dt class="pssr-metrics__label">Overdue</dt>
          <dd class="pssr-metrics__value" data-metric-value>—</dd>
          <dd class="pssr-metrics__note" data-metric-note>Requires immediate action</dd>
        </div>
        <div class="pssr-metrics__item" data-metric="next">
          <dt class="pssr-metrics__label">Next scheduled</dt>
          <dd class="pssr-metrics__value" data-metric-value>—</dd>
          <dd class="pssr-metrics__note" data-metric-note>Awaiting schedule</dd>
        </div>
      </dl>
    </section>
    <section class="sticky-top" data-component="sticky-controls">
      <div class="sticky-top__content">
        <div class="sticky-controls controls-bar">
          <button type="button" class="refresh-btn btn btn--outline" data-action="refresh">Refresh data</button>
          <div class="mobile-sort" data-role="mobile-sort">
            <label for="mobile-sort-select">Sort by</label>
            <select id="mobile-sort-select" data-role="mobile-sort-select" aria-label="Select column to sort">
              <option value="Asset">Asset</option>
              <option value="Location">Location</option>
              <option value="Last Inspection Date">Last Inspection Date</option>
              <option value="Next Inspection Date">Next Inspection Date</option>
              <option value="Countdown">Countdown</option>
              <option value="Comments">Comments</option>
            </select>
            <button type="button" class="mobile-sort__direction btn btn--outline btn--sm" data-role="mobile-sort-direction" data-direction="asc" aria-label="Toggle sort direction (currently ascending)">Ascending</button>
          </div>
        </div>
      </div>
    </section>
    <section class="table-wrapper" data-component="pssr-table">
      <div class="table-scroll" data-role="scroll-region" data-loading="true">
        <table aria-describedby="pssr-table-caption">
          <caption id="pssr-table-caption" class="visually-hidden">PSSR inspection schedule</caption>
          <thead>
            <tr>
              <th scope="col" data-col="Asset" aria-sort="none">Asset <span class="sort-arrow" aria-hidden="true"></span></th>
              <th scope="col" data-col="Location" aria-sort="none">Location <span class="sort-arrow" aria-hidden="true"></span></th>
              <th scope="col" data-col="Last Inspection Date" aria-sort="none">Last Inspection Date <span class="sort-arrow" aria-hidden="true"></span></th>
              <th scope="col" data-col="Next Inspection Date" aria-sort="none">Next Inspection Date <span class="sort-arrow" aria-hidden="true"></span></th>
              <th scope="col" data-col="Countdown" aria-sort="none">Countdown <span class="sort-arrow" aria-hidden="true"></span></th>
              <th scope="col" data-col="Comments" aria-sort="none">Comments <span class="sort-arrow" aria-hidden="true"></span></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="6" class="empty-state">Loading inspection data…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
    <section class="mobile-cards" data-role="mobile-cards" aria-live="polite" role="list"></section>
    <div class="loading-banner" data-state="loading" role="status">Fetching latest inspections…</div>
    <div class="error-banner" data-state="error" role="alert" hidden>We were unable to load the inspection sheet. Please check the network or sheet permissions and try again.</div>
  </div>

  <script>
    const DEFAULT_PSSR_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQhXb-392ExhOiESN5E6IqM5ScrrB4oFpPcLhf8yis6_ZhFqjanoHomQJcqL-feiPi-t-sygaGb85at/pub?output=csv';
    const PSSR_SHEET_URL = resolveSheetUrl();
    if(PSSR_SHEET_URL){
      window.__PSSR_SHEET_URL = PSSR_SHEET_URL;
    }else{
      console.error('PSSR sheet URL could not be resolved. Update DEFAULT_PSSR_SHEET_URL or supply ?sheetUrl=');
    }
    const SAMPLE_PSSR_ROWS = [
      {
        Asset: 'Steam Boiler 03',
        Location: 'Aberdeen – Plant Room',
        'Last Inspection Date': '15/02/2024',
        'Next Inspection Date': '15/08/2024',
        Comments: 'Six-month statutory inspection window.'
      },
      {
        Asset: 'Air Receiver B',
        Location: 'ALS Keith',
        'Last Inspection Date': '04/07/2023',
        'Next Inspection Date': '04/01/2024',
        Comments: 'Overhaul required before recommissioning.'
      },
      {
        Asset: 'Tunnel Washer 2',
        Location: 'Cathkin – Wash Line',
        'Last Inspection Date': '20/11/2023',
        'Next Inspection Date': '20/11/2025',
        Comments: 'PSSR inspection aligned with OEM service schedule.'
      }
    ];

    const DUE_SOON_THRESHOLD_DAYS = 60;

    const TABLE_WIDTH_TOLERANCE = 1;
    const MOBILE_BREAKPOINT = 936;
    let __tableMinWidthCache = null;

    function getTableMinWidth(){
      if (__tableMinWidthCache != null) return __tableMinWidthCache;
      const raw = getComputedStyle(document.documentElement).getPropertyValue('--table-min-width');
      const parsed = parseFloat(raw);
      __tableMinWidthCache = Number.isFinite(parsed) ? parsed : 720;
      return __tableMinWidthCache;
    }

    function pageAvailableWidth(){
      const page = document.querySelector('.page');
      return (page?.clientWidth || document.documentElement.clientWidth || window.innerWidth || 0);
    }

    function needsMobileLayout(container){
      if (window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT}px)`).matches) return true;

      const minWidth = getTableMinWidth();
      const wrap = container?.__scrollRegion;

      if (wrap && !wrap.hidden && wrap.offsetParent !== null){
        const available = wrap.clientWidth;
        if (available > 0){
          const table = wrap.querySelector('table');
          const required = table ? (table.scrollWidth || table.offsetWidth || minWidth) : minWidth;
          const delta = required - available;
          if (delta > TABLE_WIDTH_TOLERANCE) return true;
          if (delta < -TABLE_WIDTH_TOLERANCE) return false;
        }
      }

      return pageAvailableWidth() + TABLE_WIDTH_TOLERANCE < minWidth;
    }

    function updateResponsiveMode(container){
      if (!container){
        document.body.removeAttribute('data-table-mode');
        return;
      }

      if (needsMobileLayout(container)){
        document.body.setAttribute('data-table-mode','mobile');
      } else {
        document.body.removeAttribute('data-table-mode');
      }
    }

    function sanitizeSheetUrl(value){
      if(!value) return null;
      const trimmed = String(value).trim();
      if(!trimmed) return null;
      const candidate = trimmed.startsWith('//') ? `https:${trimmed}` : trimmed;
      try {
        const url = new URL(candidate, window.location.href);
        if(url.protocol === 'http:'){
          url.protocol = 'https:';
        }
        if(url.protocol !== 'https:') return null;
        return url.toString();
      } catch {
        return null;
      }
    }

    function getSheetOverrideFromQuery(){
      try {
        const search = window.location.search;
        if(!search) return null;
        const params = new URLSearchParams(search);
        const candidate = params.get('sheetUrl') || params.get('sheet');
        return candidate || null;
      } catch {
        return null;
      }
    }

    function resolveSheetUrl(){
      const candidates = [
        getSheetOverrideFromQuery(),
        document.body?.dataset?.sheetUrl,
        DEFAULT_PSSR_SHEET_URL
      ];
      for(const candidate of candidates){
        const sanitized = sanitizeSheetUrl(candidate);
        if(sanitized) return sanitized;
      }
      return null;
    }

    function esc(str){
      return String(str ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function parseDateLoose(value){
      if(value instanceof Date && !isNaN(value)) return value;
      if(typeof value === 'number'){ const d = new Date(value); return isNaN(d) ? null : d; }
      if(!value) return null;
      const str = String(value).trim();
      if(!str) return null;
      const ddmmyyyy = str.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/);
      if(ddmmyyyy){
        let [,d,m,y,h='00',min='00'] = ddmmyyyy;
        if(y.length === 2){ y = `20${y}`; }
        const iso = `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}T${h.padStart(2,'0')}:${min.padStart(2,'0')}:00`;
        const parsed = new Date(iso);
        return isNaN(parsed) ? null : parsed;
      }
      const parsed = new Date(str);
      return isNaN(parsed) ? null : parsed;
    }

    function formatDisplayDate(date, fallback='—'){
      if(!(date instanceof Date) || isNaN(date)) return fallback;
      const d = date.getDate().toString().padStart(2,'0');
      const m = (date.getMonth()+1).toString().padStart(2,'0');
      const y = date.getFullYear();
      return `${d}/${m}/${y}`;
    }

    function detectType(column, rows){
      if(!column || !rows.length) return 'string';
      const sample = rows.slice(0, 10).map(r => r[column]);
      const allDates = sample.length && sample.every(v => !!parseDateLoose(v));
      if(allDates) return 'date';
      const allNumbers = sample.length && sample.every(v => v === '' || v == null || /^\s*[-+]?\d+(\.\d+)?\s*$/.test(String(v)));
      if(allNumbers) return 'number';
      return 'string';
    }

    const stringCollator = new Intl.Collator(undefined, { sensitivity:'base', numeric:false });

    function applySort(rows, column, direction){
      const list = Array.isArray(rows) ? rows.slice() : [];
      if(!column) return list;
      const dir = direction === 'asc' ? 'asc' : 'desc';
      const factor = dir === 'asc' ? 1 : -1;

      if(column === 'Next Inspection Date'){
        const fallback = dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;
        return list.sort((a,b) => {
          const aTime = (a.__nextDate instanceof Date && !Number.isNaN(a.__nextDate.getTime())) ? a.__nextDate.getTime() : fallback;
          const bTime = (b.__nextDate instanceof Date && !Number.isNaN(b.__nextDate.getTime())) ? b.__nextDate.getTime() : fallback;
          return factor * (aTime - bTime);
        });
      }

      if(column === 'Last Inspection Date'){
        const fallback = dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;
        return list.sort((a,b) => {
          const aTime = (a.__lastDate instanceof Date && !Number.isNaN(a.__lastDate.getTime())) ? a.__lastDate.getTime() : fallback;
          const bTime = (b.__lastDate instanceof Date && !Number.isNaN(b.__lastDate.getTime())) ? b.__lastDate.getTime() : fallback;
          return factor * (aTime - bTime);
        });
      }

      if(column === 'Countdown'){
        const fallback = dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;
        return list.sort((a,b) => {
          const aVal = typeof a.__countdownDays === 'number' ? a.__countdownDays : fallback;
          const bVal = typeof b.__countdownDays === 'number' ? b.__countdownDays : fallback;
          return factor * (aVal - bVal);
        });
      }

      const type = detectType(column, list);
      return list.sort((a,b) => {
        const va = a[column];
        const vb = b[column];
        if(type === 'date'){
          const da = parseDateLoose(va);
          const db = parseDateLoose(vb);
          return factor * (((da ? da.getTime() : 0) - (db ? db.getTime() : 0)));
        }
        if(type === 'number'){
          return factor * (((parseFloat(va) || 0) - (parseFloat(vb) || 0)));
        }
        const normalizedA = String(va ?? '').trim();
        const normalizedB = String(vb ?? '').trim();
        return factor * stringCollator.compare(normalizedA, normalizedB);
      });
    }

    function syncDesktopSortIndicators(container, column, direction){
      const thead = container.__thead;
      if(!thead) return;
      thead.querySelectorAll('th').forEach(th => {
        const col = th.getAttribute('data-col');
        if(col === column){
          th.setAttribute('data-sort', direction);
          th.setAttribute('aria-sort', direction === 'asc' ? 'ascending' : 'descending');
        }else{
          th.removeAttribute('data-sort');
          th.setAttribute('aria-sort','none');
        }
      });
    }

    function updateMobileSortControls(container){
      const select = container.__mobileSortSelect;
      const dirBtn = container.__mobileSortDirectionBtn;
      const state = container.__currentSort;
      if(select && state){
        select.value = state.column;
      }
      if(dirBtn){
        const dir = state ? state.direction : 'asc';
        dirBtn.dataset.direction = dir;
        dirBtn.textContent = dir === 'asc' ? 'Ascending' : 'Descending';
        dirBtn.setAttribute('aria-label', `Toggle sort direction (currently ${dirBtn.textContent.toLowerCase()})`);
      }
    }

    function normalizeCountdown(nextDate){
      if(!(nextDate instanceof Date) || isNaN(nextDate)){
        return { label:'Unknown', className:'is-unknown', diffDays:null, overdue:false };
      }
      const today = new Date();
      const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
      const normalized = new Date(nextDate.getFullYear(), nextDate.getMonth(), nextDate.getDate()).getTime();
      const diffDays = Math.round((normalized - startOfToday) / (1000 * 60 * 60 * 24));
      if(diffDays < 0){
        const days = Math.abs(diffDays);
        return { label: `${days}d overdue`, className:'is-urgent', diffDays, overdue:true };
      }
      if(diffDays === 0){
        return { label:'Due today', className:'is-urgent', diffDays, overdue:false };
      }
      const months = diffDays / 30;
      if(months < 2){
        return { label:`Due in ${diffDays}d`, className:'is-urgent', diffDays, overdue:false };
      }
      if(months < 6){
        return { label:`Due in ${Math.round(months*10)/10}mo`, className:'is-warning', diffDays, overdue:false };
      }
      if(months < 18){
        return { label:`Due in ${Math.round(months)}mo`, className:'is-healthy', diffDays, overdue:false };
      }
      return { label:`Due in ${Math.round(months)}mo`, className:'is-excellent', diffDays, overdue:false };
    }

    function parseCsv(text){
      const rows = [];
      let current = [];
      let field = '';
      let inQuotes = false;
      for(let i=0;i<text.length;i++){
        const char = text[i];
        if(inQuotes){
          if(char === '"'){
            if(text[i+1] === '"'){
              field += '"';
              i++;
            }else{
              inQuotes = false;
            }
          }else{
            field += char;
          }
        }else{
          if(char === '"'){
            inQuotes = true;
          }else if(char === ','){
            current.push(field);
            field='';
          }else if(char === '\r'){
            continue;
          }else if(char === '\n'){
            current.push(field);
            rows.push(current);
            current=[];
            field='';
          }else{
            field += char;
          }
        }
      }
      if(field.length || current.length){
        current.push(field);
        rows.push(current);
      }
      if(!rows.length) return { headers: [], rows: [] };
      const headerRow = rows.shift();
      const headers = headerRow.map((h,i)=>String(h??'').replace(/^\uFEFF/,'').trim() || `Column ${i+1}`);
      const data = rows
        .filter(r => r.some(cell => String(cell ?? '').trim().length))
        .map(row => headers.reduce((acc, header, idx) => {
          acc[header] = row[idx] ?? '';
          return acc;
        }, {}));
      return { headers, rows: data };
    }

    function pickField(row, keys){
      for(const key of keys){
        if(key in row && row[key] !== undefined){
          const value = row[key];
          if(String(value).trim().length) return value;
        }
      }
      return '';
    }

    async function fetchSheet(){
      if(!PSSR_SHEET_URL){
        throw new Error('No PSSR inspection sheet URL is configured.');
      }
      const response = await fetch(PSSR_SHEET_URL, { cache:'no-store' });
      if(!response.ok) throw new Error('Sheet request failed');
      const text = await response.text();
      if(/^[\[{]/.test(text.trim())){
        const json = JSON.parse(text);
        const rows = Array.isArray(json) ? json : (Array.isArray(json.rows) ? json.rows : []);
        const headers = rows.length ? Object.keys(rows[0]) : [];
        return { headers, rows };
      }
      return parseCsv(text);
    }

    function looksLikeFacilitiesSheet(headers, rows){
      const normalize = list => (Array.isArray(list) ? list : []).map(h => String(h ?? '').trim().toLowerCase());
      const headerSet = new Set(normalize(headers));
      const facilityCols = ['id','title','status','priority'];
      const hasFacilityHeader = facilityCols.every(col => headerSet.has(col));
      if(hasFacilityHeader) return true;
      if(Array.isArray(rows) && rows.length){
        const sampleKeys = Object.keys(rows.find(r => r && typeof r === 'object') || {}).map(k => k.toLowerCase());
        if(sampleKeys.length){
          const sampleSet = new Set(sampleKeys);
          if(facilityCols.slice(0,3).every(col => sampleSet.has(col))){
            return true;
          }
        }
      }
      return false;
    }

    function ensurePssrSheet(headers, rows){
      if(looksLikeFacilitiesSheet(headers, rows)){
        throw new Error('The configured sheet appears to point to the Facilities work orders data. Please double-check the published PSSR sheet link.');
      }
    }

    function buildRowModel(raw){
      const asset = pickField(raw, ['Asset','Asset ID','Asset Name','Equipment']);
      const location = pickField(raw, ['Location','Site','Area']);
      const lastRaw = pickField(raw, ['Last Inspection Date','Last Inspection','Previous Inspection']);
      const nextRaw = pickField(raw, ['Next Inspection Date','Next Inspection','Inspection Due']);
      const comments = pickField(raw, ['Comments','Notes','Remarks']);
      const lastDate = parseDateLoose(lastRaw);
      const nextDate = parseDateLoose(nextRaw);
      const countdown = normalizeCountdown(nextDate instanceof Date ? new Date(nextDate) : nextDate);
      return {
        Asset: asset || '—',
        Location: location || '—',
        'Last Inspection Date': lastDate ? formatDisplayDate(lastDate) : (lastRaw || '—'),
        'Next Inspection Date': nextDate ? formatDisplayDate(nextDate) : (nextRaw || '—'),
        Countdown: countdown.label,
        Comments: comments || '—',
        __lastDate: lastDate,
        __nextDate: nextDate,
        __countdownClass: countdown.className,
        __countdownDays: countdown.diffDays,
        __overdue: countdown.overdue,
        __raw: raw
      };
    }

    function renderTable(container, rows){
      const tbody = container.__tbody;
      const scrollRegion = container.__scrollRegion;
      if(!tbody) return;
      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No inspections are currently scheduled.</td></tr>';
        scrollRegion?.setAttribute('data-loading','false');
        updateResponsiveMode(container);
        return;
      }
      const html = rows.map(row => {
        const overdueClass = row.__overdue ? 'row-overdue' : '';
        const assetTitle = esc(row.Asset);
        const locationTitle = esc(row.Location);
        const lastTitle = esc(row['Last Inspection Date']);
        const nextTitle = esc(row['Next Inspection Date']);
        const commentsTitle = esc(row.Comments);
        return `
          <tr class="${overdueClass}">
            <td data-col="Asset" title="${assetTitle}"><span>${assetTitle}</span></td>
            <td data-col="Location" title="${locationTitle}"><span>${locationTitle}</span></td>
            <td data-col="Last Inspection Date" title="${lastTitle}"><span>${lastTitle}</span></td>
            <td data-col="Next Inspection Date" title="${nextTitle}"><span>${nextTitle}</span></td>
            <td data-col="Countdown" title="${esc(row.Countdown)}"><span><span class="countdown-chip ${row.__countdownClass}">${esc(row.Countdown)}</span></span></td>
            <td data-col="Comments" title="${commentsTitle}"><span>${commentsTitle}</span></td>
          </tr>
        `;
      }).join('');
      tbody.innerHTML = html;
      scrollRegion?.setAttribute('data-loading','false');
      updateResponsiveMode(container);
    }

    function renderMobileCards(container, rows){
      const mobile = container.__mobileCards;
      if(!mobile) return;
      const list = Array.isArray(rows) ? rows : [];
      mobile.dataset.state = list.length ? 'ready' : 'empty';
      mobile.setAttribute('aria-busy','false');
      if(!list.length){
        mobile.innerHTML = '<div class="mobile-card mobile-card--status empty-state" role="listitem">No inspections are currently scheduled.</div>';
        return;
      }
      const html = list.map(row => {
        const overdueClass = row.__overdue ? 'row-overdue' : '';
        return `
          <article class="mobile-card ${overdueClass}" aria-label="Inspection for ${esc(row.Asset)}" role="listitem">
            <header class="mobile-card__row">
              <div class="mobile-card__title">${esc(row.Asset)}</div>
              <span class="countdown-chip ${row.__countdownClass}">${esc(row.Countdown)}</span>
            </header>
            <div class="mobile-card__meta">
              <div><strong>Location:</strong> ${esc(row.Location)}</div>
              <div><strong>Last inspection:</strong> ${esc(row['Last Inspection Date'])}</div>
              <div><strong>Next inspection:</strong> ${esc(row['Next Inspection Date'])}</div>
            </div>
            <div class="mobile-card__row"><strong>Comments:</strong> ${esc(row.Comments)}</div>
          </article>
        `;
      }).join('');
      mobile.innerHTML = html;
    }

    function updateSummaryMetrics(rows){
      const metricsRoot = document.querySelector('[data-role="pssr-metrics"]');
      if(!metricsRoot) return;
      const list = Array.isArray(rows) ? rows : [];
      const total = list.length;
      const dueSoonThreshold = DUE_SOON_THRESHOLD_DAYS;
      const dueSoonRows = list.filter(row => typeof row?.__countdownDays === 'number' && row.__countdownDays >= 0 && row.__countdownDays <= dueSoonThreshold);
      const overdueRows = list.filter(row => row?.__overdue);
      const upcomingRows = list
        .filter(row => typeof row?.__countdownDays === 'number')
        .sort((a,b) => a.__countdownDays - b.__countdownDays);
      const nextDue = upcomingRows.length ? upcomingRows[0] : null;

      const setMetric = (key, value, note, state=null) => {
        const item = metricsRoot.querySelector(`[data-metric="${key}"]`);
        if(!item) return;
        const valueNode = item.querySelector('[data-metric-value]');
        const noteNode = item.querySelector('[data-metric-note]');
        if(valueNode){
          valueNode.textContent = value;
        }
        if(noteNode){
          noteNode.textContent = note;
        }
        item.classList.remove('is-alert','is-warning');
        if(state === 'alert'){
          item.classList.add('is-alert');
        }else if(state === 'warning'){
          item.classList.add('is-warning');
        }
      };

      setMetric(
        'total',
        total.toString(),
        total === 0 ? 'Awaiting published data' : total === 1 ? 'Asset currently on the schedule' : 'Assets currently on the schedule'
      );

      setMetric(
        'due-soon',
        dueSoonRows.length.toString(),
        dueSoonRows.length ? `Due within ${dueSoonThreshold} days` : `All inspections beyond ${dueSoonThreshold} days`,
        dueSoonRows.length ? 'warning' : null
      );

      setMetric(
        'overdue',
        overdueRows.length.toString(),
        overdueRows.length ? 'Requires immediate action' : 'All inspections in compliance',
        overdueRows.length ? 'alert' : null
      );

      if(nextDue){
        const nextDate = nextDue['Next Inspection Date'];
        const hasKnownDate = nextDate && nextDate !== '—';
        const headline = hasKnownDate ? nextDate : nextDue.Countdown;
        const pieces = [nextDue.Asset, nextDue.Location].map(v => String(v ?? '').trim()).filter(v => v && v !== '—');
        const note = pieces.length ? pieces.join(' • ') : 'Scheduled item';
        const state = nextDue.__overdue ? 'alert' : (typeof nextDue.__countdownDays === 'number' && nextDue.__countdownDays <= dueSoonThreshold ? 'warning' : null);
        setMetric('next', headline, note, state);
      }else if(list.length){
        setMetric('next', '—', 'No inspections with a scheduled date');
      }else{
        setMetric('next', '—', 'Awaiting schedule');
      }
    }

    function setSort(container, column, direction){
      const dir = direction === 'asc' ? 'asc' : 'desc';
      container.__currentSort = { column, direction: dir };
      syncDesktopSortIndicators(container, column, dir);
      updateMobileSortControls(container);
      const sorted = applySort(container.__rows, column, dir);
      container.__viewRows = sorted;
      renderTable(container, sorted);
      renderMobileCards(container, sorted);
      updateSummaryMetrics(container.__rows);
    }

    function attachSortHandlers(container){
      const thead = container.__thead;
      if(!thead) return;
      thead.querySelectorAll('th').forEach(th => {
        th.addEventListener('click', () => {
          const column = th.getAttribute('data-col');
          const current = container.__currentSort;
          const nextDirection = current && current.column === column && current.direction === 'asc' ? 'desc' : 'asc';
          setSort(container, column, nextDirection);
        });
      });
    }

    function handleMobileSort(container){
      const select = container.__mobileSortSelect;
      const button = container.__mobileSortDirectionBtn;
      if(select){
        select.addEventListener('change', () => {
          const column = select.value;
          const current = container.__currentSort;
          const direction = current && current.column === column ? current.direction : 'asc';
          setSort(container, column, direction);
        });
      }
      if(button){
        button.addEventListener('click', () => {
          const current = container.__currentSort || { column: select?.value || 'Next Inspection Date', direction:'asc' };
          const direction = current.direction === 'asc' ? 'desc' : 'asc';
          setSort(container, current.column, direction);
        });
      }
    }

    function updateStickyOffsets(){
      const sticky = document.querySelector('.sticky-top');
      if(!sticky) return;
      const height = sticky.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--sticky-controls-offset', `${Math.ceil(height)}px`);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const container = document.querySelector('[data-component="pssr-table"]');

      const handleResize = () => {
        updateStickyOffsets();
        updateResponsiveMode(container);
      };

      updateStickyOffsets();
      updateResponsiveMode(container);
      window.addEventListener('resize', () => window.requestAnimationFrame(handleResize));

      if(!container) return;
      container.__thead = container.querySelector('thead');
      container.__tbody = container.querySelector('tbody');
      container.__scrollRegion = container.querySelector('[data-role="scroll-region"]');
      container.__mobileCards = document.querySelector('[data-role="mobile-cards"]');
      container.__mobileSortSelect = document.querySelector('[data-role="mobile-sort-select"]');
      container.__mobileSortDirectionBtn = document.querySelector('[data-role="mobile-sort-direction"]');
      container.__rows = [];
      container.__viewRows = [];
      container.__currentSort = { column:'Next Inspection Date', direction:'asc' };

      attachSortHandlers(container);
      handleMobileSort(container);

      const refreshButton = document.querySelector('[data-action="refresh"]');
      const loadingBanner = document.querySelector('[data-state="loading"]');
      const errorBanner = document.querySelector('[data-state="error"]');
      const defaultErrorMessage = errorBanner?.textContent?.trim() || 'We were unable to load the inspection sheet. Please check the network or sheet permissions and try again.';

      async function loadData(){
        loadingBanner.hidden = false;
        errorBanner.hidden = true;
        errorBanner.textContent = defaultErrorMessage;
        container.__scrollRegion?.setAttribute('data-loading','true');
        if(container.__mobileCards){
          container.__mobileCards.dataset.state = 'loading';
          container.__mobileCards.setAttribute('aria-busy','true');
          container.__mobileCards.innerHTML = '<div class="mobile-card mobile-card--status" role="listitem" aria-live="polite">Loading inspection data…</div>';
        }
        try {
          const { headers, rows } = await fetchSheet();
          ensurePssrSheet(headers, rows);
          const mapped = rows.map(buildRowModel);
          container.__rows = mapped;
          setSort(container, container.__currentSort.column, container.__currentSort.direction);
        } catch (error) {
          console.error('Failed to load PSSR sheet', error);
          const message = (error && typeof error.message === 'string' && error.message.trim()) ? error.message.trim() : defaultErrorMessage;
          if(!container.__rows.length && SAMPLE_PSSR_ROWS.length){
            const fallback = SAMPLE_PSSR_ROWS.map(buildRowModel);
            container.__rows = fallback;
            setSort(container, container.__currentSort.column, container.__currentSort.direction);
          }
          errorBanner.textContent = message;
          errorBanner.hidden = false;
          if(!container.__rows.length){
            renderTable(container, []);
            renderMobileCards(container, []);
          }
        } finally {
          loadingBanner.hidden = true;
          container.__scrollRegion?.setAttribute('data-loading','false');
        }
      }

      refreshButton?.addEventListener('click', () => loadData());

      loadData();
    });
  </script>
</body>
</html>
