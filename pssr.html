<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSSR Inspection Tracker â€“ ALS Engineering Dashboard</title>
  <style>
    :root {
      --bg:#f3f5f9;
      --paper:#ffffff;
      --ink:#0b0f1a;
      --muted:#6b7280;
      --border:#e5e9f2;

      --brand:#0b67c2;
      --brand-strong:#0a5cb0;

      --btn-fg:#ffffff;
      --btn-bg:var(--brand);
      --btn-bg-hover:var(--brand-strong);
      --btn-outline-fg:var(--brand);
      --btn-outline-bd:#bcd7f4;
      --btn-ghost-fg:var(--brand);
      --btn-ghost-bg:transparent;
      --btn-ghost-bg-hover:rgba(11,103,194,.10);

      --input-bg:#ffffff;
      --input-fg:var(--ink);
      --input-bd:var(--border);
      --input-bd-focus:var(--brand);
      --shadow:0 1px 2px rgba(16,24,40,.06),0 4px 10px rgba(16,24,40,.06);

      --als-blue:var(--brand);
      --als-blue-strong:var(--brand-strong);
      --risk-critical:#dc2626;
      --risk-warning:#b45309;
      --risk-ok:#059669;
      --surface-subtle:color-mix(in srgb,var(--als-blue) 4%,var(--paper));
      --surface-strong:color-mix(in srgb,var(--als-blue) 9%,var(--paper));
      --thead:var(--brand);
      --thead-text:#fff;
      --grid:var(--border);
      --zebra:var(--paper);
      --sticky-controls-offset:0px;
      --table-min-width:720px;
      --ui-offset:0px;
      color-scheme:light;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        color-scheme:dark;
        --bg:#0f1422;
        --paper:#131a2b;
        --ink:#f3f4f6;
        --muted:#9ca3af;
        --border:#233150;
        --brand:#3b82f6;
        --brand-strong:#2563eb;
        --btn-outline-bd:#2b3a63;
        --btn-ghost-bg-hover:rgba(11,103,194,.18);
        --input-bg:#0f1422;
        --input-fg:#f3f4f6;
        --input-bd:#233150;
        --input-bd-focus:#3b82f6;
        --als-blue:var(--brand);
        --als-blue-strong:var(--brand-strong);
        --risk-critical:#f87171;
        --risk-warning:#fbbf24;
        --risk-ok:#34d399;
        --surface-subtle:color-mix(in srgb,var(--als-blue) 14%,var(--paper));
        --surface-strong:color-mix(in srgb,var(--als-blue) 20%,var(--paper));
        --thead:#1e3a8a;
        --grid:#233150;
        --zebra:#1c2438;
      }
    }

    body {
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      font-size:13px;
      line-height:1.4;
      -webkit-font-smoothing:antialiased;
    }

    body::before {
      content:"";
      position:fixed;
      inset:0 0 auto 0;
      height:var(--ui-offset, var(--sticky-controls-offset, 0px));
      background:var(--bg);
      pointer-events:none;
      z-index:180;
    }

    .page {
      --page-pad-top:12px;
      --page-pad-inline:clamp(20px,4vw,36px);
      --page-pad-bottom:48px;
      padding:var(--page-pad-top) var(--page-pad-inline) var(--page-pad-bottom);
      max-width:clamp(960px,96vw,1680px);
      margin-inline:auto;
      box-sizing:border-box;
    }

    @media (max-width: 960px){
      .page {
        --page-pad-inline:clamp(18px,6vw,26px);
        --page-pad-bottom:24px;
      }
    }

    @media (max-width: 720px){
      .page {
        --page-pad-inline:16px;
        --page-pad-bottom:20px;
      }
    }

    .page-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding-bottom:12px;
      margin-bottom:0;
      position:relative;
      z-index:260;
      gap:16px;
    }

    .page-head__title {
      display:flex;
      align-items:center;
      gap:12px;
      flex:1 1 auto;
      min-width:0;
      flex-wrap:wrap;
    }

    .page-head__title .title {
      margin:0;
      flex:1 1 auto;
      min-width:0;
    }

    .title {
      font-size:24px;
      font-weight:800;
      margin:0;
    }

    .logo {
      height:50px;
      margin-left:auto;
      flex-shrink:0;
    }

    .nav {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin:4px 0 0;
    }

    .nav .tab {
      padding:7px 12px;
      border-radius:999px;
      border:1px solid var(--grid);
      background:transparent;
      color:var(--ink);
      font-weight:700;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:box-shadow .15s ease,border-color .15s ease,background .15s ease;
    }

    .nav .tab[aria-selected="true"],
    .nav .tab:focus-visible {
      outline:none;
      border-color:var(--als-blue);
      background:color-mix(in srgb,var(--als-blue) 8%,var(--paper));
      box-shadow:0 0 0 2px color-mix(in srgb,var(--als-blue) 30%,transparent);
    }

    .site-filter {
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .site-filter__label {
      font-weight:600;
      color:var(--muted);
      font-size:12px;
    }

    .site-filter__label [data-role="site-filter-active"] {
      color:var(--ink);
      font-weight:700;
    }

    .site-filter__tabs {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    .site-filter__tab {
      padding:7px 12px;
      border-radius:999px;
      border:1px solid var(--grid);
      background:transparent;
      color:var(--ink);
      font-weight:700;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      cursor:pointer;
      transition:box-shadow .15s ease,border-color .15s ease,background .15s ease;
      white-space:nowrap;
    }

    .site-filter__tab[aria-pressed="true"],
    .site-filter__tab:focus-visible {
      outline:none;
      border-color:var(--als-blue);
      background:color-mix(in srgb,var(--als-blue) 8%,var(--paper));
      box-shadow:0 0 0 2px color-mix(in srgb,var(--als-blue) 30%,transparent);
    }

    .site-filter__tab[disabled] {
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
    }

    .top-rule {
      height:2px;
      background:var(--als-blue);
      border-bottom:1px solid var(--als-blue-strong);
      margin:0;
      position:relative;
      z-index:320;
    }

    .pssr-overview {
      margin:12px 0 8px;
      padding:16px;
      border:1px solid color-mix(in srgb,var(--grid) 72%,transparent);
      border-radius:16px;
      background:var(--surface-subtle);
      display:grid;
      gap:16px;
      grid-template-columns:minmax(0,1fr);
    }

    .pssr-overview__summary {
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .pssr-overview__insights {
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .pssr-site-panel {
      display:flex;
      flex-direction:column;
      gap:10px;
      border-radius:10px;
      padding:10px 12px;
      border:1px solid color-mix(in srgb,var(--grid) 68%,transparent);
      background:var(--surface-strong);
      box-shadow:0 3px 8px rgba(15,23,42,0.08);
      grid-column:1 / -1;
    }

    .pssr-overview__eyebrow {
      font-size:12px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--als-blue);
      margin:0;
    }

    .pssr-overview__headline {
      margin:0;
      font-size:19px;
      font-weight:750;
      line-height:1.28;
    }

    .pssr-overview__description {
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
      max-width:48ch;
    }

    .pssr-signal {
      border-radius:12px;
      padding:14px 16px;
      display:grid;
      gap:6px;
      border:1px solid color-mix(in srgb,var(--als-blue) 18%,transparent);
      background:color-mix(in srgb,var(--als-blue) 6%,var(--paper));
      box-shadow:0 4px 12px rgba(15,23,42,0.1);
      transition:background .18s ease, border-color .18s ease, box-shadow .18s ease;
    }

    .pssr-signal[data-state="critical"] {
      border-color:color-mix(in srgb,var(--risk-critical) 60%,transparent);
      background:color-mix(in srgb,var(--risk-critical) 16%,var(--paper));
      box-shadow:0 12px 28px rgba(220,38,38,0.18);
    }

    .pssr-signal[data-state="warning"] {
      border-color:color-mix(in srgb,var(--risk-warning) 60%,transparent);
      background:color-mix(in srgb,var(--risk-warning) 18%,var(--paper));
      box-shadow:0 10px 24px rgba(180,83,9,0.18);
    }

    .pssr-signal[data-state="stable"] {
      border-color:color-mix(in srgb,var(--risk-ok) 45%,transparent);
      background:color-mix(in srgb,var(--risk-ok) 18%,var(--paper));
      box-shadow:0 8px 20px rgba(5,150,105,0.16);
    }

    .pssr-signal[data-state="empty"] {
      background:color-mix(in srgb,var(--als-blue) 4%,var(--paper));
      border-color:color-mix(in srgb,var(--grid) 75%,transparent);
      box-shadow:none;
    }

    .pssr-signal__label {
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:color-mix(in srgb,var(--muted) 82%,var(--ink));
      font-weight:700;
    }

    .pssr-signal__value {
      font-size:26px;
      font-weight:900;
      letter-spacing:-0.01em;
    }

    .pssr-signal__note {
      margin:0;
      font-size:12px;
      color:color-mix(in srgb,var(--muted) 72%,var(--ink));
      max-width:44ch;
    }

    .pssr-risk-panel {
      border-radius:12px;
      padding:14px 14px 16px;
      border:1px solid color-mix(in srgb,var(--grid) 70%,transparent);
      background:color-mix(in srgb,var(--paper) 92%,var(--als-blue) 3%);
      box-shadow:0 4px 12px rgba(15,23,42,0.08);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .pssr-risk-panel__title {
      font-size:13px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:color-mix(in srgb,var(--muted) 68%,var(--ink));
      margin:0;
    }

    .pssr-risk-panel__message {
      margin:0;
      font-size:13px;
      font-weight:600;
    }

    .pssr-risk-panel[data-state="critical"] .pssr-risk-panel__message { color:var(--risk-critical); }
    .pssr-risk-panel[data-state="warning"] .pssr-risk-panel__message { color:var(--risk-warning); }
    .pssr-risk-panel[data-state="stable"] .pssr-risk-panel__message { color:var(--risk-ok); }

    .pssr-risk-bar {
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .pssr-risk-bar__track {
      position:relative;
      width:100%;
      height:10px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid color-mix(in srgb,var(--grid) 80%,transparent);
      background:color-mix(in srgb,var(--paper) 95%,var(--als-blue) 4%);
    }

    .pssr-risk-bar__segment {
      position:absolute;
      top:0;
      bottom:0;
      transition:width .24s ease;
    }

    .pssr-risk-bar__segment.is-alert { background:color-mix(in srgb,var(--risk-critical) 90%,transparent); }
    .pssr-risk-bar__segment.is-warning { background:color-mix(in srgb,var(--risk-warning) 90%,transparent); }
    .pssr-risk-bar__segment.is-ok { background:color-mix(in srgb,var(--risk-ok) 80%,transparent); }

    .pssr-risk-bar__legend {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:11px;
      color:color-mix(in srgb,var(--muted) 70%,var(--ink));
    }

    .pssr-risk-bar__legend-item {
      display:inline-flex;
      align-items:center;
      gap:5px;
      font-weight:600;
    }

    .pssr-risk-bar__dot {
      width:10px;
      height:10px;
      border-radius:50%;
      background:currentColor;
      opacity:0.9;
    }

    .pssr-risk-bar__legend-item.is-alert { color:var(--risk-critical); }
    .pssr-risk-bar__legend-item.is-warning { color:var(--risk-warning); }
    .pssr-risk-bar__legend-item.is-ok { color:var(--risk-ok); }

    .pssr-site-panel__title {
      margin:0;
      font-size:12.5px;
      font-weight:780;
      letter-spacing:0.06em;
      text-transform:uppercase;
    }

    .pssr-site-panel__hint {
      margin:0;
      font-size:10.5px;
      color:color-mix(in srgb,var(--muted) 66%,var(--ink));
      max-width:46ch;
    }

    .pssr-site-breakdown {
      list-style:none;
      margin:0;
      padding:0;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(clamp(200px,20vw,260px),1fr));
      gap:8px;
      align-items:stretch;
      justify-content:stretch;
      grid-auto-rows:1fr;
    }

    @media (max-width: 720px) {
      .pssr-site-breakdown {
        grid-template-columns:minmax(0,1fr);
      }
    }

    .pssr-site-breakdown__item {
      padding:8px 10px;
      border-radius:8px;
      border:1px solid color-mix(in srgb,var(--grid) 74%,transparent);
      background:color-mix(in srgb,var(--paper) 94%,var(--als-blue) 3%);
      display:grid;
      gap:5px;
      box-shadow:0 2px 6px rgba(15,23,42,0.08);
    }

    .pssr-site-breakdown__item.is-empty {
      text-align:center;
      color:var(--muted);
      font-weight:600;
    }

    .pssr-site-breakdown__header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .pssr-site-breakdown__name {
      font-weight:720;
      font-size:12.5px;
    }

    .pssr-site-breakdown__status {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(92px,1fr));
      gap:8px;
      align-items:stretch;
    }

    .pssr-site-breakdown__badge {
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:4px;
      border-radius:12px;
      padding:10px 8px;
      min-height:76px;
      text-align:center;
      font-size:10.5px;
      font-weight:630;
      letter-spacing:-0.01em;
      background:color-mix(in srgb,var(--als-blue) 8%,var(--paper));
      color:color-mix(in srgb,var(--muted) 52%,var(--ink));
      border:1px solid color-mix(in srgb,var(--grid) 74%,transparent);
      box-shadow:0 3px 10px rgba(15,23,42,0.08);
    }

    .pssr-site-breakdown__badge[data-empty="true"] {
      opacity:0.55;
      border-style:dashed;
    }

    .pssr-site-breakdown__badge.is-total {
      background:color-mix(in srgb,var(--als-blue) 16%,var(--paper));
      border-color:color-mix(in srgb,var(--als-blue) 55%,transparent);
      color:color-mix(in srgb,var(--ink) 85%,var(--als-blue));
    }

    .pssr-site-breakdown__badge.is-alert {
      background:color-mix(in srgb,var(--risk-critical) 20%,var(--paper));
      border-color:color-mix(in srgb,var(--risk-critical) 65%,transparent);
      color:var(--risk-critical);
    }

    .pssr-site-breakdown__badge.is-warning {
      background:color-mix(in srgb,var(--risk-warning) 22%,var(--paper));
      border-color:color-mix(in srgb,var(--risk-warning) 65%,transparent);
      color:var(--risk-warning);
    }

    .pssr-site-breakdown__badge.is-ok {
      background:color-mix(in srgb,var(--risk-ok) 22%,var(--paper));
      border-color:color-mix(in srgb,var(--risk-ok) 55%,transparent);
      color:var(--risk-ok);
    }

    .pssr-site-breakdown__count {
      font-size:20px;
      font-weight:760;
      line-height:1;
      color:currentColor;
    }

    .pssr-site-breakdown__label {
      font-size:10.5px;
      font-weight:610;
      text-transform:capitalize;
      color:color-mix(in srgb,currentColor 78%,var(--muted));
    }

    .pssr-metrics {
      margin:0;
      display:flex;
      gap:8px;
      overflow-x:auto;
      padding-bottom:4px;
      scrollbar-width:thin;
      scrollbar-color:color-mix(in srgb,var(--als-blue) 45%,transparent) color-mix(in srgb,var(--als-blue) 10%,transparent);
    }

    .pssr-metrics__item {
      padding:10px 12px;
      border-radius:10px;
      border:1px solid color-mix(in srgb,var(--als-blue) 12%,var(--grid));
      background:color-mix(in srgb,var(--paper) 96%,var(--als-blue) 1%);
      box-shadow:0 3px 9px rgba(15,23,42,0.06);
      display:flex;
      flex-direction:column;
      gap:4px;
      min-height:82px;
      transition:border-color .18s ease, box-shadow .18s ease, transform .18s ease;
      flex:1 0 140px;
    }

    .pssr-metrics::-webkit-scrollbar {
      height:6px;
    }

    .pssr-metrics::-webkit-scrollbar-track {
      background:color-mix(in srgb,var(--als-blue) 10%,transparent);
      border-radius:999px;
    }

    .pssr-metrics::-webkit-scrollbar-thumb {
      background:color-mix(in srgb,var(--als-blue) 45%,transparent);
      border-radius:999px;
    }

    .pssr-metrics__item:hover,
    .pssr-metrics__item:focus-within {
      transform:translateY(-1px);
      box-shadow:0 8px 16px rgba(15,23,42,0.08);
    }

    .pssr-metrics__item.is-alert {
      border-color:color-mix(in srgb,#dc2626 45%,transparent);
      box-shadow:0 12px 24px rgba(220,38,38,0.18);
    }

    .pssr-metrics__item.is-warning {
      border-color:color-mix(in srgb,#b45309 45%,transparent);
      box-shadow:0 12px 24px rgba(180,83,9,0.18);
    }

    .pssr-metrics__label {
      margin:0;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:color-mix(in srgb,var(--muted) 82%,var(--ink));
    }

    .pssr-metrics__value {
      font-size:20px;
      font-weight:800;
      line-height:1.1;
    }

    .pssr-metrics__note {
      margin:0;
      color:var(--muted);
      font-size:11px;
      line-height:1.4;
    }

    @media (prefers-reduced-motion: reduce){
      .pssr-metrics__item,
      .pssr-metrics__item:hover,
      .pssr-metrics__item:focus-within {
        transition:none;
        transform:none;
        box-shadow:0 6px 14px rgba(15,23,42,0.06);
      }
    }

    @media (min-width: 960px){
      .pssr-overview {
        grid-template-columns:minmax(0,1.35fr) minmax(0,1.05fr);
        align-items:start;
      }
      .pssr-site-panel {
        grid-column:1 / -1;
      }
    }

    @media (min-width: 1280px){
      .pssr-overview {
        grid-template-columns:minmax(0,1.35fr) minmax(0,1.05fr) minmax(0,0.9fr);
      }
      .pssr-site-panel {
        grid-column:1 / -1;
      }
    }

    @media (max-width: 640px){
      .pssr-overview {
        padding:14px;
        gap:12px;
      }
      .pssr-signal {
        padding:12px 14px;
      }
      .pssr-risk-panel {
        padding:12px 14px;
      }
      .pssr-site-panel {
        padding:12px 14px;
      }
    }

    .sticky-top {
      position:sticky;
      top:0;
      z-index:300;
      background:color-mix(in srgb,var(--bg) 20%,transparent);
      border-bottom:1px solid color-mix(in srgb,var(--border) 55%,transparent);
      padding:10px 0;
      margin:0;
      backdrop-filter:blur(12px);
    }

    .sticky-top__content {
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      row-gap:8px;
      flex-wrap:wrap;
    }

    .controls-bar {
      background:transparent;
      border:0;
      box-shadow:none;
      padding:8px 0;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .controls-bar>* {
      flex:0 0 auto;
    }

    .sticky-controls {
      display:flex;
      gap:10px;
      row-gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .banner{margin-top:12px;padding:10px 12px;border-radius:12px;border:1px solid var(--grid);display:flex;gap:8px;align-items:center}
    .banner.ok{background:color-mix(in srgb, #059669 14%, var(--paper))}
    .banner.warn{background:color-mix(in srgb, #b45309 14%, var(--paper))}
    .banner.err{background:color-mix(in srgb, #b91c1c 14%, var(--paper))}
    .banner [data-msg]{font-weight:700}

    .pssr-content {
      display:flex;
      flex-direction:column;
      gap:18px;
      align-items:stretch;
      margin-top:18px;
    }

    .document-viewer {
      border:1px solid color-mix(in srgb,var(--grid) 78%,transparent);
      border-radius:14px;
      background:color-mix(in srgb,var(--paper) 96%,var(--als-blue) 1%);
      box-shadow:0 4px 10px rgba(15,23,42,0.05);
      min-height:320px;
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
    }

    .document-viewer iframe {
      border:0;
      flex:1 1 auto;
      width:100%;
      min-height:320px;
      background:var(--paper);
    }

    .document-viewer .placeholder {
      padding:18px;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }

    body[data-table-mode="mobile"] .document-viewer {
      display:none;
    }

    body[data-table-mode="mobile"] .pssr-content {
      display:none;
    }


    .controls-bar label {
      color:var(--muted);
      font-weight:600;
    }

    .controls-bar select {
      background:var(--input-bg);
      color:var(--input-fg);
      border:1px solid var(--input-bd);
      border-radius:10px;
      padding:8px 10px;
      font:inherit;
      transition:border-color .18s ease,box-shadow .18s ease,background-color .18s ease;
      flex:1 1 auto;
      min-width:0;
    }

    .controls-bar select:focus {
      outline:0;
      border-color:var(--input-bd-focus);
      box-shadow:0 0 0 3px color-mix(in oklab,var(--input-bd-focus) 30%,transparent);
    }

    .mobile-sort {
      display:none;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--ink);
    }

    .btn {
      --pad-x:14px;
      --pad-y:8px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:var(--pad-y) var(--pad-x);
      border-radius:999px;
      font-weight:600;
      line-height:1;
      border:1px solid transparent;
      cursor:pointer;
      transition:transform .02s ease,background .15s ease,border-color .15s ease;
      color:var(--ink);
      background:var(--btn-ghost-bg);
    }

    .btn:active {
      transform:translateY(1px);
    }

    .btn--primary {
      color:var(--btn-fg);
      background:var(--btn-bg);
      border-color:var(--btn-bg);
    }

    .btn--primary:hover {
      background:var(--btn-bg-hover);
    }

    .btn--outline {
      color:var(--btn-outline-fg);
      background:transparent;
      border-color:var(--btn-outline-bd);
    }

    .btn--outline:hover {
      border-color:var(--btn-outline-fg);
    }

    .btn--ghost {
      color:var(--btn-ghost-fg);
      background:var(--btn-ghost-bg);
    }

    .btn--ghost:hover {
      background:var(--btn-ghost-bg-hover);
    }

    .btn--sm {
      --pad-x:10px;
      --pad-y:6px;
      font-size:12px;
    }

    .refresh-btn {
      margin-right:auto;
    }

    .table-wrapper {
      margin-top:0;
    }

    table {
      width:100%;
      min-width:var(--table-min-width, 720px);
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }

    .visually-hidden {
      position:absolute !important;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    .table-scroll {
      position:relative;
      overflow:auto;
      border:1px solid var(--grid);
      border-radius:12px;
      background:var(--paper);
      box-shadow:0 2px 10px rgba(15, 23, 42, 0.05);
      max-height:calc(100vh - var(--sticky-controls-offset) - 220px);
      padding:0 2px 2px;
    }

    .table-scroll thead {
      position:sticky;
      top:0;
      background:var(--thead);
      z-index:2;
    }

    .table-scroll thead th {
      background:var(--thead);
      color:var(--thead-text);
      font-weight:750;
      letter-spacing:0.1px;
      padding:9px 8px;
      border-bottom:1px solid color-mix(in srgb,#000 18%,transparent);
      text-align:left;
      white-space:nowrap;
      position:relative;
      cursor:pointer;
    }

    .table-scroll thead th[data-col="Last Inspection Date"],
    .table-scroll thead th[data-col="Next Inspection Date"] {
      white-space:normal;
    }

    .table-scroll thead th:first-child {
      border-top-left-radius:12px;
    }

    .table-scroll thead th:last-child {
      border-top-right-radius:12px;
    }

    .table-scroll thead th[data-col="Asset"] {
      position:sticky;
      left:0;
      z-index:3;
      border-right:1px solid color-mix(in srgb, var(--grid) 85%, transparent);
    }

    .table-scroll thead th .sort-arrow {
      display:inline-block;
      margin-left:8px;
      width:0;
      height:0;
      border-left:5px solid transparent;
      border-right:5px solid transparent;
      border-top:7px solid currentColor;
      opacity:0.25;
      transform:translateY(-1px);
      transition:opacity .15s ease, transform .15s ease;
    }

    .table-scroll thead th[data-sort="asc"] .sort-arrow {
      opacity:1;
      transform:translateY(-1px);
    }

    .table-scroll thead th[data-sort="desc"] .sort-arrow {
      opacity:1;
      transform:rotate(180deg) translateY(-1px);
    }

    tbody td {
      padding:9px 8px;
      border-bottom:1px solid var(--grid);
      background:var(--zebra);
      vertical-align:top;
      word-break:break-word;
      line-height:1.35;
    }

    tbody tr:last-child td {
      border-bottom:none;
    }

    tbody tr:nth-child(even) td {
      background:color-mix(in srgb,var(--grid) 12%,var(--zebra));
    }

    tbody tr.row-overdue td {
      background:color-mix(in srgb,#dc2626 16%,var(--zebra));
      color:color-mix(in srgb,#1f2937 15%,var(--ink));
    }

    tbody tr.is-active td {
      box-shadow:inset 0 0 0 2px color-mix(in srgb,var(--als-blue) 45%, transparent);
    }

    .table-scroll thead th[data-col="Last Inspection Date"],
    .table-scroll tbody td[data-col="Last Inspection Date"],
    .table-scroll thead th[data-col="Next Inspection Date"],
    .table-scroll tbody td[data-col="Next Inspection Date"] {
      width:112px;
    }

    .table-scroll thead th[data-col="Location"],
    .table-scroll tbody td[data-col="Location"] {
      width:200px;
    }

    .table-scroll thead th[data-col="Comments"],
    .table-scroll tbody td[data-col="Comments"] {
      width:360px;
    }

    .table-scroll tbody td[data-col="Asset"] {
      position:sticky;
      left:0;
      z-index:1;
      font-weight:700;
      background:var(--zebra);
      border-right:1px solid var(--grid);
    }

    tbody tr:nth-child(even) td[data-col="Asset"] {
      background:color-mix(in srgb,var(--grid) 12%,var(--zebra));
    }

    tbody tr.row-overdue td[data-col="Asset"] {
      background:color-mix(in srgb,#dc2626 16%,var(--zebra));
      color:color-mix(in srgb,#1f2937 15%,var(--ink));
    }

    tbody tr.is-active td[data-col="Asset"] {
      box-shadow:inset 0 0 0 2px color-mix(in srgb,var(--als-blue) 45%, transparent);
    }

    tbody td[data-col="Comments"] {
      max-width:420px;
    }

    tbody td[data-col] > span {
      display:block;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    tbody td[data-col="Comments"] > span,
    tbody td[data-col="Comments"] {
      white-space:normal;
      overflow:visible;
    }

    .countdown-chip {
      display:inline-flex;
      align-items:center;
      font-weight:800;
      font-size:12px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid currentColor;
      font-variant-numeric:tabular-nums;
    }

    .countdown-chip.is-unknown {
      color:var(--muted);
      border-style:dashed;
    }

    .countdown-chip.is-urgent {
      color:#b91c1c;
      background:color-mix(in srgb,#b91c1c 20%,transparent);
      box-shadow:0 0 0 1px color-mix(in srgb,#b91c1c 35%,transparent);
    }

    .countdown-chip.is-warning {
      color:#b45309;
      background:color-mix(in srgb,#b45309 18%,transparent);
    }

    .countdown-chip.is-healthy {
      color:#047857;
      background:color-mix(in srgb,#047857 18%,transparent);
    }

    .countdown-chip.is-excellent {
      color:#0f766e;
      background:color-mix(in srgb,#0f766e 18%,transparent);
    }

    .empty-state {
      padding:20px;
      text-align:center;
      color:var(--muted);
    }

    .status-note {
      font-size:12px;
      color:var(--muted);
    }

    .table-scroll[data-loading="true"] tbody {
      opacity:.4;
    }

    .mobile-cards {
      display:none;
      margin-top:18px;
      grid-template-columns:minmax(0,1fr);
      gap:12px;
      align-items:stretch;
      width:100%;
      max-width:960px;
      margin-inline:auto;
    }

    body[data-table-mode="mobile"] .table-wrapper {
      display:none;
    }

    body[data-table-mode="mobile"] .mobile-cards {
      display:grid;
    }

    body[data-table-mode="mobile"] .sticky-top__content {
      flex-direction:column;
      align-items:flex-start;
    }

    body[data-table-mode="mobile"] .sticky-controls {
      width:100%;
      flex-direction:column;
      align-items:stretch;
      gap:12px;
    }

    body[data-table-mode="mobile"] .refresh-btn {
      width:100%;
      justify-content:center;
    }

    body[data-table-mode="mobile"] .mobile-sort {
      display:grid;
      width:100%;
      gap:8px;
    }

    body[data-table-mode="mobile"] .mobile-sort label {
      font-weight:600;
    }

    body[data-table-mode="mobile"] .mobile-sort select,
    body[data-table-mode="mobile"] .mobile-sort__direction {
      width:100%;
    }

    body[data-table-mode="mobile"] .site-filter {
      width:100%;
      flex-direction:column;
      align-items:stretch;
      gap:10px;
    }

    body[data-table-mode="mobile"] .site-filter__tabs {
      width:100%;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:8px;
    }

    body[data-table-mode="mobile"] .site-filter__tab {
      width:100%;
      justify-content:center;
    }

    .mobile-card {
      border:1px solid var(--grid);
      border-radius:14px;
      padding:16px;
      background:var(--paper);
      display:flex;
      flex-direction:column;
      gap:12px;
      box-shadow:0 4px 12px rgba(15,23,42,.08);
      height:100%;
    }

    .mobile-card__header {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      width:100%;
    }

    .mobile-card__heading {
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      flex:1 1 auto;
    }

    .mobile-card__title {
      font-weight:800;
      font-size:15px;
      line-height:1.35;
      min-width:0;
    }

    .mobile-card__subtitle {
      font-size:12px;
      color:color-mix(in srgb,var(--muted) 68%,var(--ink));
      font-weight:600;
      line-height:1.3;
    }

    .mobile-card__subtitle span + span::before {
      content:'â€¢';
      margin:0 6px;
      color:color-mix(in srgb,var(--muted) 75%,var(--ink));
      font-weight:400;
    }

    .mobile-card__meta {
      margin:0;
      padding:0;
      display:grid;
      gap:8px;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
    }

    .mobile-card__meta-item {
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:2px;
      padding:10px 12px;
      border-radius:12px;
      background:var(--surface-subtle);
      border:1px solid color-mix(in srgb,var(--grid) 65%,transparent);
      min-width:0;
    }

    .mobile-card__meta-label {
      font-size:11px;
      letter-spacing:0.04em;
      text-transform:uppercase;
      color:color-mix(in srgb,var(--muted) 80%,var(--ink));
      font-weight:700;
    }

    .mobile-card__meta-value {
      font-size:12.5px;
      font-weight:600;
      color:color-mix(in srgb,var(--ink) 92%,var(--muted));
      word-break:break-word;
    }

    .mobile-card__comment {
      margin:0;
      font-size:12.5px;
      line-height:1.45;
      color:color-mix(in srgb,var(--muted) 65%,var(--ink));
      background:color-mix(in srgb,var(--als-blue) 6%,var(--paper));
      border:1px solid color-mix(in srgb,var(--grid) 70%,transparent);
      border-radius:12px;
      padding:10px 12px;
    }

    .mobile-card__comment-label {
      display:block;
      font-size:11px;
      letter-spacing:0.04em;
      text-transform:uppercase;
      color:color-mix(in srgb,var(--muted) 80%,var(--ink));
      font-weight:700;
      margin-bottom:4px;
    }

    .mobile-card.row-overdue {
      border-color:color-mix(in srgb,#dc2626 45%,var(--grid));
      box-shadow:0 0 0 2px color-mix(in srgb,#dc2626 22%,transparent);
    }

    .mobile-card--status {
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      color:var(--muted);
      font-weight:600;
      min-height:96px;
      gap:8px;
    }

    @media (min-width: 560px) {
      .mobile-card {
        padding:18px;
        gap:14px;
      }

      .mobile-card__meta {
        grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      }
    }

    @media (max-width:540px) {
      .mobile-cards {
        grid-template-columns:minmax(0,1fr);
      }

      .mobile-card {
        padding:12px;
        gap:10px;
      }

      .mobile-card__subtitle {
        font-size:11.5px;
      }

      .mobile-card__meta-item {
        padding:8px 10px;
      }

      .mobile-card__meta-value,
      .mobile-card__comment {
        font-size:12px;
      }
    }

    @media (max-width:420px) {
      .mobile-card__meta {
        grid-template-columns:minmax(0,1fr);
      }
    }

    @media (max-width:1170px) {
      .page {
        --page-pad-inline:24px;
      }
      table {
        min-width:var(--table-min-width, 720px);
      }
    }

    @media (max-width:1248px) {
      .page { --page-pad-top:16px; --page-pad-inline:clamp(16px,6vw,24px); --page-pad-bottom:40px; }
      .table-wrapper { display:none; }
      .mobile-cards { display:grid; }
      .sticky-top__content { flex-direction:column; align-items:flex-start; }
      .sticky-controls { width:100%; flex-direction:column; align-items:stretch; gap:12px; }
      .refresh-btn { width:100%; justify-content:center; }
      .mobile-sort { display:grid; width:100%; gap:8px; }
      .mobile-sort label { font-weight:600; }
      .mobile-sort select { width:100%; }
      .mobile-sort__direction { width:100%; }
    }

    @media print {
      body::before { display:none; }
      .sticky-top { position:static; }
      .table-scroll { max-height:none; box-shadow:none; border-radius:0; }
      .mobile-cards { display:none !important; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-head">
      <div class="page-head__title">
        <h1 class="title">PSSR Inspection Tracker</h1>
        <nav class="nav" aria-label="Dashboard sections">
          <a class="tab" href="index.html">Work Orders</a>
          <a class="tab" href="facilities.html">Facilities</a>
          <a class="tab" aria-selected="true" href="pssr.html">PSSR Inspections</a>
        </nav>
      </div>
      <img src="LOGOlesswhitespace.png" alt="ALS Engineering" class="logo" />
    </header>
    <div class="top-rule" role="presentation"></div>
    <section class="pssr-overview">
      <div class="pssr-overview__summary">
        <div class="pssr-signal" data-role="pssr-signal" data-state="empty">
          <span class="pssr-signal__label">Current risk posture</span>
          <span class="pssr-signal__value" data-role="pssr-signal-value">â€”</span>
          <p class="pssr-signal__note" data-role="pssr-signal-note">Awaiting data</p>
        </div>
      </div>
      <div class="pssr-overview__insights">
        <dl class="pssr-metrics" data-role="pssr-metrics">
          <div class="pssr-metrics__item" data-metric="total">
            <dt class="pssr-metrics__label">Total inspections</dt>
            <dd class="pssr-metrics__value" data-metric-value>â€”</dd>
            <dd class="pssr-metrics__note" data-metric-note>Awaiting data</dd>
          </div>
          <div class="pssr-metrics__item" data-metric="due-soon">
            <dt class="pssr-metrics__label">Due soon</dt>
            <dd class="pssr-metrics__value" data-metric-value>â€”</dd>
            <dd class="pssr-metrics__note" data-metric-note>Due within 60 days</dd>
          </div>
          <div class="pssr-metrics__item" data-metric="overdue">
            <dt class="pssr-metrics__label">Overdue</dt>
            <dd class="pssr-metrics__value" data-metric-value>â€”</dd>
            <dd class="pssr-metrics__note" data-metric-note>Requires immediate action</dd>
          </div>
          <div class="pssr-metrics__item" data-metric="next">
            <dt class="pssr-metrics__label">Next scheduled</dt>
            <dd class="pssr-metrics__value" data-metric-value>â€”</dd>
            <dd class="pssr-metrics__note" data-metric-note>Awaiting schedule</dd>
          </div>
        </dl>
        <section class="pssr-risk-panel" aria-label="Risk snapshot" data-role="pssr-risk">
          <h3 class="pssr-risk-panel__title">Risk snapshot</h3>
          <p class="pssr-risk-panel__message" data-role="pssr-risk-message">Awaiting inspection data.</p>
          <div class="pssr-risk-bar">
            <div class="pssr-risk-bar__track" data-role="pssr-risk-track">
              <span class="pssr-risk-bar__segment is-alert" data-role="pssr-risk-overdue" style="left:0;width:0%;"></span>
              <span class="pssr-risk-bar__segment is-warning" data-role="pssr-risk-due" style="left:0;width:0%;"></span>
              <span class="pssr-risk-bar__segment is-ok" data-role="pssr-risk-clear" style="left:0;width:0%;"></span>
            </div>
            <div class="pssr-risk-bar__legend">
              <span class="pssr-risk-bar__legend-item is-alert"><span class="pssr-risk-bar__dot" aria-hidden="true"></span><span data-role="pssr-risk-label-overdue">0 overdue</span></span>
              <span class="pssr-risk-bar__legend-item is-warning"><span class="pssr-risk-bar__dot" aria-hidden="true"></span><span data-role="pssr-risk-label-due">0 due soon</span></span>
              <span class="pssr-risk-bar__legend-item is-ok"><span class="pssr-risk-bar__dot" aria-hidden="true"></span><span data-role="pssr-risk-label-clear">0 on track</span></span>
            </div>
          </div>
        </section>
      </div>
      <section class="pssr-site-panel" aria-label="Site health overview">
        <h3 class="pssr-site-panel__title">Site health</h3>
        <p class="pssr-site-panel__hint" data-role="pssr-site-hint">Top sites driving current PSSR risk across the portfolio.</p>
        <ul class="pssr-site-breakdown" data-role="pssr-site-breakdown">
          <li class="pssr-site-breakdown__item is-empty">Awaiting inspection data.</li>
        </ul>
      </section>
    </section>
    <section class="sticky-top" data-component="sticky-controls">
      <div class="sticky-top__content">
        <div class="sticky-controls controls-bar">
          <button type="button" class="refresh-btn btn btn--outline" data-action="refresh">Refresh data</button>
          <div class="site-filter" data-role="site-filter">
            <span class="site-filter__label">Site: <span data-role="site-filter-active">All sites</span></span>
            <div class="site-filter__tabs" role="group" aria-label="Filter inspections by site" data-role="site-nav">
              <button type="button" class="site-filter__tab" data-site-key="all" aria-pressed="true">All sites</button>
              <button type="button" class="site-filter__tab" data-site-key="byron" aria-pressed="false">Byron</button>
              <button type="button" class="site-filter__tab" data-site-key="keith" aria-pressed="false">Keith</button>
              <button type="button" class="site-filter__tab" data-site-key="mugiemoss" aria-pressed="false">Mugiemoss</button>
            </div>
          </div>
          <div class="mobile-sort" data-role="mobile-sort">
            <label for="mobile-sort-select">Sort by</label>
            <select id="mobile-sort-select" data-role="mobile-sort-select" aria-label="Select column to sort">
              <option value="Asset">Asset</option>
              <option value="Location">Location</option>
              <option value="Last Inspection Date">Last Inspection Date</option>
              <option value="Next Inspection Date">Next Inspection Date</option>
              <option value="Countdown">Countdown</option>
              <option value="Comments">Comments</option>
            </select>
            <button type="button" class="mobile-sort__direction btn btn--outline btn--sm" data-role="mobile-sort-direction" data-direction="asc" aria-label="Toggle sort direction (currently ascending)">Ascending</button>
          </div>
        </div>
      </div>
    </section>
    <div id="banner" class="banner ok" hidden>
      <span data-msg>Ready</span><span data-detail></span>
    </div>
    <div class="pssr-content">
      <section class="table-wrapper" data-component="pssr-table">
        <div class="table-scroll" data-role="scroll-region" data-loading="true">
          <table aria-describedby="pssr-table-caption">
            <caption id="pssr-table-caption" class="visually-hidden">PSSR inspection schedule</caption>
            <thead>
              <tr>
                <th scope="col" data-col="Asset" aria-sort="none">Asset <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Location" aria-sort="none">Location <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Last Inspection Date" aria-sort="none">Last Inspection Date <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Next Inspection Date" aria-sort="none">Next Inspection Date <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Countdown" aria-sort="none">Countdown <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Comments" aria-sort="none">Comments <span class="sort-arrow" aria-hidden="true"></span></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="6" class="empty-state">Loading inspection dataâ€¦</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
      <section class="document-viewer" id="viewer" aria-label="Inspection document preview" hidden>
        <div class="placeholder">Select an inspection to preview documentation.</div>
      </section>
    </div>
    <section class="mobile-cards" data-role="mobile-cards" aria-live="polite" role="list"></section>
  </div>

  <script>
    // ===== Config =====
    const DEFAULT_PSSR_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQhXb-392ExhOiESN5E6IqM5ScrrB4oFpPcLhf8yis6_ZhFqjanoHomQJcqL-feiPi-t-sygaGb85at/pub?output=csv';
    const DUE_SOON_THRESHOLD_DAYS = 60;

    // Toggle via query params.
    // Defaults: offline in file/sandbox; online in http(s).
    const PARAMS = new URLSearchParams(location.search);
    const FORCE_ONLINE = PARAMS.get('online') === '1';
    const FORCE_OFFLINE = PARAMS.get('offline') === '1';
    const DEFAULT_OFFLINE = location.protocol === 'file:' || location.hostname === '';
    const ALLOW_NETWORK = FORCE_ONLINE ? true : (FORCE_OFFLINE ? false : !DEFAULT_OFFLINE);
    const DEFAULT_ERROR_MESSAGE = 'We were unable to load the inspection sheet. Please check the network or sheet permissions and try again.';

    function sanitizeSheetUrl(v){
      if(!v) return null;
      const t = String(v).trim();
      if(!t) return null;
      const c = t.startsWith('//') ? `https:${t}` : t;
      try {
        const u = new URL(c, location.href);
        if(u.protocol === 'http:') u.protocol = 'https:';
        return u.protocol === 'https:' ? u.toString() : null;
      } catch { return null; }
    }

    function getSheetUrl(){
      const p = new URLSearchParams(location.search);
      return sanitizeSheetUrl(p.get('sheetUrl') || p.get('sheet') || document.body?.dataset?.sheetUrl || DEFAULT_PSSR_SHEET_URL);
    }

    function resolveSiteLabel(siteKey){
      if(!siteKey) return SITE_LABELS.all;
      const normalized = String(siteKey).trim().toLowerCase();
      if(!normalized) return SITE_LABELS.all;
      if(Object.prototype.hasOwnProperty.call(SITE_LABELS, normalized)){
        return SITE_LABELS[normalized];
      }
      return normalized.split(/[\s_-]+/).map(part => part ? (part[0].toUpperCase() + part.slice(1)) : '').join(' ').trim() || SITE_LABELS.all;
    }

    const SAMPLE = [
      { Asset:'Keith Steam Boiler 2', Site:'Keith', Location:'Keith â€“ Energy Centre', 'Last Inspection Date':'12/03/2024', 'Next Inspection Date':'12/09/2024', Comments:'Internal and external statutory inspection booked for September.', 'Document URL':'about:blank' },
      { Asset:'Byron Compressed Air Receiver', Site:'Byron', Location:'Byron â€“ Maintenance Bay', 'Last Inspection Date':'05/01/2024', 'Next Inspection Date':'05/07/2024', Comments:'Requalification due alongside dryer swap.', 'Document URL':'about:blank' },
      { Asset:'Mugiemoss Tunnel Washer 2', Site:'Mugiemoss', Location:'Mugiemoss â€“ Wash Line', 'Last Inspection Date':'20/11/2023', 'Next Inspection Date':'20/11/2025', Comments:'Inspection aligned with OEM service interval.', 'Document URL':'about:blank' },
      { Asset:'Byron Steam Generator 1', Site:'Byron', Location:'Byron â€“ Plant Room', 'Last Inspection Date':'14/09/2023', 'Next Inspection Date':'14/03/2024', Comments:'Boiler house annual inspection â€“ burner upgrade noted.', 'Document URL':'about:blank' },
      { Asset:'Keith Air Receiver A', Site:'Keith', Location:'Keith â€“ Compressor House', 'Last Inspection Date':'02/06/2023', 'Next Inspection Date':'02/12/2023', Comments:'Receiver drained and ready for recertification.', 'Document URL':'about:blank' },
      { Asset:'Mugiemoss Calorifier 4', Site:'Mugiemoss', Location:'Mugiemoss â€“ Hot Water Plant', 'Last Inspection Date':'22/08/2023', 'Next Inspection Date':'22/02/2024', Comments:'Monitor expansion vessel replacement before inspection.', 'Document URL':'about:blank' }
    ];

    const RESOLVED_PSSR_SHEET_URL = getSheetUrl();
    if(RESOLVED_PSSR_SHEET_URL){
      window.__PSSR_SHEET_URL = RESOLVED_PSSR_SHEET_URL;
    }else{
      console.warn('PSSR sheet URL could not be resolved. Update DEFAULT_PSSR_SHEET_URL or supply ?sheetUrl=.');
    }

    function banner(type, msg, detail=''){
      const el = document.querySelector('#banner');
      if(!el) return;
      el.className = 'banner ' + (type || '');
      el.hidden = false;
      const msgNode = el.querySelector('[data-msg]');
      const detailNode = el.querySelector('[data-detail]');
      if(msgNode) msgNode.textContent = msg;
      if(detailNode) detailNode.textContent = detail ? ' â€“ ' + detail : '';
    }

    function hideBanner(){
      const el = document.querySelector('#banner');
      if(!el) return;
      el.hidden = true;
      el.className = 'banner';
      const msgNode = el.querySelector('[data-msg]');
      const detailNode = el.querySelector('[data-detail]');
      if(msgNode) msgNode.textContent = '';
      if(detailNode) detailNode.textContent = '';
    }

    function setViewerPlaceholder(message, { reveal = false } = {}){
      const viewer = document.querySelector('#viewer');
      if(!viewer) return;
      viewer.innerHTML = '';
      const div = document.createElement('div');
      div.className = 'placeholder';
      div.textContent = message;
      viewer.appendChild(div);
      if(reveal){
        viewer.hidden = false;
        viewer.dataset.viewerState = 'visible';
      }else{
        viewer.dataset.viewerState = 'hidden';
        viewer.hidden = true;
      }
    }

    const TABLE_WIDTH_TOLERANCE = 1;
    const MOBILE_BREAKPOINT = 1248;
    const SITE_LABELS = {
      all:'All sites',
      byron:'Byron',
      keith:'Keith',
      mugiemoss:'Mugiemoss'
    };
    const FALLBACK_SITE_LABEL = 'Unassigned site';
    let __tableMinWidthCache = null;

    async function safeFetch(url, {timeout=7000, retries=2} = {}){
      if(!ALLOW_NETWORK) throw new Error('Network disabled in this environment');
      let lastErr;
      for(let attempt=0; attempt<=retries; attempt++){
        const ctrl = new AbortController();
        const t = setTimeout(()=>ctrl.abort(), timeout);
        try {
          const res = await fetch(url, { cache:'no-store', signal:ctrl.signal });
          clearTimeout(t);
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.text();
        } catch (err) {
          lastErr = err;
          clearTimeout(t);
          if(attempt === retries) throw err;
          await new Promise(r => setTimeout(r, 400 * (attempt+1)));
        }
      }
      throw lastErr || new Error('Fetch failed');
    }

    function getTableMinWidth(){
      if (__tableMinWidthCache != null) return __tableMinWidthCache;
      const raw = getComputedStyle(document.documentElement).getPropertyValue('--table-min-width');
      const parsed = parseFloat(raw);
      __tableMinWidthCache = Number.isFinite(parsed) ? parsed : 720;
      return __tableMinWidthCache;
    }

    function pageAvailableWidth(){
      const page = document.querySelector('.page');
      return (page?.clientWidth || document.documentElement.clientWidth || window.innerWidth || 0);
    }

    function needsMobileLayout(container){
      if (window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT}px)`).matches) return true;

      const minWidth = getTableMinWidth();
      const wrap = container?.__scrollRegion;

      if (wrap && !wrap.hidden && wrap.offsetParent !== null){
        const available = wrap.clientWidth;
        if (available > 0){
          const table = wrap.querySelector('table');
          const required = table ? (table.scrollWidth || table.offsetWidth || minWidth) : minWidth;
          const delta = required - available;
          if (delta > TABLE_WIDTH_TOLERANCE) return true;
          if (delta < -TABLE_WIDTH_TOLERANCE) return false;
        }
      }

      return pageAvailableWidth() + TABLE_WIDTH_TOLERANCE < minWidth;
    }

    function updateResponsiveMode(container){
      if (!container){
        document.body.removeAttribute('data-table-mode');
        return;
      }

      if (needsMobileLayout(container)){
        document.body.setAttribute('data-table-mode','mobile');
      } else {
        document.body.removeAttribute('data-table-mode');
      }
    }

    function esc(str){
      return String(str ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function parseDateLoose(value){
      if(value instanceof Date && !isNaN(value)) return value;
      if(typeof value === 'number'){ const d = new Date(value); return isNaN(d) ? null : d; }
      if(!value) return null;
      const str = String(value).trim();
      if(!str) return null;
      const ddmmyyyy = str.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/);
      if(ddmmyyyy){
        let [,d,m,y,h='00',min='00'] = ddmmyyyy;
        if(y.length === 2){ y = `20${y}`; }
        const iso = `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}T${h.padStart(2,'0')}:${min.padStart(2,'0')}:00`;
        const parsed = new Date(iso);
        return isNaN(parsed) ? null : parsed;
      }
      const parsed = new Date(str);
      return isNaN(parsed) ? null : parsed;
    }

    function formatDisplayDate(date, fallback='â€”'){
      if(!(date instanceof Date) || isNaN(date)) return fallback;
      const d = date.getDate().toString().padStart(2,'0');
      const m = (date.getMonth()+1).toString().padStart(2,'0');
      const y = date.getFullYear();
      return `${d}/${m}/${y}`;
    }

    function detectType(column, rows){
      if(!column || !rows.length) return 'string';
      const sample = rows.slice(0, 10).map(r => r[column]);
      const allDates = sample.length && sample.every(v => !!parseDateLoose(v));
      if(allDates) return 'date';
      const allNumbers = sample.length && sample.every(v => v === '' || v == null || /^\s*[-+]?\d+(\.\d+)?\s*$/.test(String(v)));
      if(allNumbers) return 'number';
      return 'string';
    }

    const stringCollator = new Intl.Collator(undefined, { sensitivity:'base', numeric:false });

    function applySort(rows, column, direction){
      const list = Array.isArray(rows) ? rows.slice() : [];
      if(!column) return list;
      const dir = direction === 'asc' ? 'asc' : 'desc';
      const factor = dir === 'asc' ? 1 : -1;

      if(column === 'Next Inspection Date'){
        const fallback = dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;
        return list.sort((a,b) => {
          const aTime = (a.__nextDate instanceof Date && !Number.isNaN(a.__nextDate.getTime())) ? a.__nextDate.getTime() : fallback;
          const bTime = (b.__nextDate instanceof Date && !Number.isNaN(b.__nextDate.getTime())) ? b.__nextDate.getTime() : fallback;
          return factor * (aTime - bTime);
        });
      }

      if(column === 'Last Inspection Date'){
        const fallback = dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;
        return list.sort((a,b) => {
          const aTime = (a.__lastDate instanceof Date && !Number.isNaN(a.__lastDate.getTime())) ? a.__lastDate.getTime() : fallback;
          const bTime = (b.__lastDate instanceof Date && !Number.isNaN(b.__lastDate.getTime())) ? b.__lastDate.getTime() : fallback;
          return factor * (aTime - bTime);
        });
      }

      if(column === 'Countdown'){
        const fallback = dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;
        return list.sort((a,b) => {
          const aVal = typeof a.__countdownDays === 'number' ? a.__countdownDays : fallback;
          const bVal = typeof b.__countdownDays === 'number' ? b.__countdownDays : fallback;
          return factor * (aVal - bVal);
        });
      }

      const type = detectType(column, list);
      return list.sort((a,b) => {
        const va = a[column];
        const vb = b[column];
        if(type === 'date'){
          const da = parseDateLoose(va);
          const db = parseDateLoose(vb);
          return factor * (((da ? da.getTime() : 0) - (db ? db.getTime() : 0)));
        }
        if(type === 'number'){
          return factor * (((parseFloat(va) || 0) - (parseFloat(vb) || 0)));
        }
        const normalizedA = String(va ?? '').trim();
        const normalizedB = String(vb ?? '').trim();
        return factor * stringCollator.compare(normalizedA, normalizedB);
      });
    }

    function sortRows(rows, column, direction){
      return applySort(Array.isArray(rows) ? rows.slice() : [], column, direction);
    }

    function matchesSite(row, siteKey){
      if(!row || !siteKey || siteKey === 'all') return true;
      const target = siteKey.toLowerCase();
      const values = [
        row?.__raw?.Site,
        row?.__raw?.Location,
        row?.__raw?.Area,
        row?.__siteName,
        row?.Location
      ];
      return values.some(value => {
        if(!value) return false;
        return String(value).toLowerCase().includes(target);
      });
    }

    function applySiteFilter(rows, siteKey){
      const list = Array.isArray(rows) ? rows.slice() : [];
      if(!siteKey || siteKey === 'all') return list;
      return list.filter(row => matchesSite(row, siteKey));
    }

    function applyFilters(rows){
      return Array.isArray(rows) ? rows.slice() : [];
    }

    function syncDesktopSortIndicators(container, column, direction){
      const thead = container.__thead;
      if(!thead) return;
      thead.querySelectorAll('th').forEach(th => {
        const col = th.getAttribute('data-col');
        if(col === column){
          th.setAttribute('data-sort', direction);
          th.setAttribute('aria-sort', direction === 'asc' ? 'ascending' : 'descending');
        }else{
          th.removeAttribute('data-sort');
          th.setAttribute('aria-sort','none');
        }
      });
    }

    function updateMobileSortControls(container){
      const select = container.__mobileSortSelect;
      const dirBtn = container.__mobileSortDirectionBtn;
      const state = container.__currentSort;
      if(select && state){
        select.value = state.column;
      }
      if(dirBtn){
        const dir = state ? state.direction : 'asc';
        dirBtn.dataset.direction = dir;
        dirBtn.textContent = dir === 'asc' ? 'Ascending' : 'Descending';
        dirBtn.setAttribute('aria-label', `Toggle sort direction (currently ${dirBtn.textContent.toLowerCase()})`);
      }
    }

    function updateSiteFilterControls(container){
      const nav = container.__siteFilterNav;
      const activeKey = container.__siteFilter || 'all';
      if(nav){
        nav.querySelectorAll('[data-site-key]').forEach(btn => {
          const key = btn.dataset.siteKey || 'all';
          const isActive = key === activeKey;
          btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
          if(isActive){
            btn.setAttribute('aria-current','true');
          }else{
            btn.removeAttribute('aria-current');
          }
        });
      }
      const activeLabel = container.__siteFilterActiveLabel;
      if(activeLabel){
        const buttons = nav ? Array.from(nav.querySelectorAll('[data-site-key]')) : [];
        const activeBtn = buttons.find(btn => (btn.dataset.siteKey || 'all') === activeKey);
        const text = activeBtn?.textContent?.trim() || 'All sites';
        activeLabel.textContent = text;
      }
    }

    function syncSiteFilterAvailability(container){
      const nav = container.__siteFilterNav;
      if(!nav) return;
      const rows = Array.isArray(container.__rows) ? container.__rows : [];
      let current = container.__siteFilter || 'all';
      let currentAvailable = current === 'all';
      nav.querySelectorAll('[data-site-key]').forEach(btn => {
        const key = btn.dataset.siteKey || 'all';
        if(key === 'all'){
          btn.disabled = false;
          btn.removeAttribute('aria-disabled');
          return;
        }
        const hasRows = rows.some(row => matchesSite(row, key));
        btn.disabled = !hasRows;
        if(btn.disabled){
          btn.setAttribute('aria-disabled','true');
        }else{
          btn.removeAttribute('aria-disabled');
        }
        if(key === current && !hasRows){
          currentAvailable = false;
        }
      });
      if(!currentAvailable){
        current = 'all';
        container.__siteFilter = current;
      }
      updateSiteFilterControls(container);
    }

    function refreshView(container){
      if(!container) return;
      const state = container.__currentSort || { column:'Next Inspection Date', direction:'asc' };
      const filtered = applySiteFilter(container.__rows, container.__siteFilter);
      const sorted = applySort(filtered, state.column, state.direction);
      container.__viewRows = sorted;
      renderTable(container, sorted);
      if(container.__selectedDocUrl){
        const stillExists = sorted.some(row => (row.__docUrl || '') === container.__selectedDocUrl);
        if(!stillExists){
          container.__selectedDocUrl = '';
          setViewerPlaceholder('Select an inspection to preview documentation.');
          if(container.__tbody){
            container.__tbody.querySelectorAll('tr').forEach(row => row.classList.remove('is-active'));
          }
        }
      }
      renderMobileCards(container, sorted);
      updateSummaryMetrics(filtered, {
        siteFilter: container.__siteFilter,
        totalRowCount: Array.isArray(container.__rows) ? container.__rows.length : 0
      });
    }

    function attachSiteFilterHandlers(container){
      const nav = container.__siteFilterNav;
      if(!nav) return;
      nav.querySelectorAll('[data-site-key]').forEach(btn => {
        btn.addEventListener('click', () => {
          if(btn.disabled) return;
          const key = btn.dataset.siteKey || 'all';
          if(container.__siteFilter === key) return;
          container.__siteFilter = key;
          updateSiteFilterControls(container);
          refreshView(container);
        });
      });
    }

    function normalizeCountdown(nextDate){
      if(!(nextDate instanceof Date) || isNaN(nextDate)){
        return { label:'Unknown', className:'is-unknown', diffDays:null, days:null, overdue:false };
      }
      const today = new Date();
      const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
      const normalized = new Date(nextDate.getFullYear(), nextDate.getMonth(), nextDate.getDate()).getTime();
      const diffDays = Math.round((normalized - startOfToday) / (1000 * 60 * 60 * 24));
      if(diffDays < 0){
        const days = Math.abs(diffDays);
        return { label: `${days}d overdue`, className:'is-urgent', diffDays, days:diffDays, overdue:true };
      }
      if(diffDays === 0){
        return { label:'Due today', className:'is-urgent', diffDays, days:diffDays, overdue:false };
      }
      const months = diffDays / 30;
      if(months < 2){
        return { label:`Due in ${diffDays}d`, className:'is-urgent', diffDays, days:diffDays, overdue:false };
      }
      if(months < 6){
        return { label:`Due in ${Math.round(months*10)/10}mo`, className:'is-warning', diffDays, days:diffDays, overdue:false };
      }
      if(months < 18){
        return { label:`Due in ${Math.round(months)}mo`, className:'is-healthy', diffDays, days:diffDays, overdue:false };
      }
      return { label:`Due in ${Math.round(months)}mo`, className:'is-excellent', diffDays, days:diffDays, overdue:false };
    }

    function parseCsv(text){
      const rows = [];
      let current = [];
      let field = '';
      let inQuotes = false;
      for(let i=0;i<text.length;i++){
        const char = text[i];
        if(inQuotes){
          if(char === '"'){
            if(text[i+1] === '"'){
              field += '"';
              i++;
            }else{
              inQuotes = false;
            }
          }else{
            field += char;
          }
        }else{
          if(char === '"'){
            inQuotes = true;
          }else if(char === ','){
            current.push(field);
            field='';
          }else if(char === '\r'){
            continue;
          }else if(char === '\n'){
            current.push(field);
            rows.push(current);
            current=[];
            field='';
          }else{
            field += char;
          }
        }
      }
      if(field.length || current.length){
        current.push(field);
        rows.push(current);
      }
      if(!rows.length) return { headers: [], rows: [] };
      const headerRow = rows.shift();
      const headers = headerRow.map((h,i)=>String(h??'').replace(/^\uFEFF/,'').trim() || `Column ${i+1}`);
      const data = rows
        .filter(r => r.some(cell => String(cell ?? '').trim().length))
        .map(row => headers.reduce((acc, header, idx) => {
          acc[header] = row[idx] ?? '';
          return acc;
        }, {}));
      return { headers, rows: data };
    }

    function pickField(row, keys){
      for(const key of keys){
        if(key in row && row[key] !== undefined){
          const value = row[key];
          if(String(value).trim().length) return value;
        }
      }
      return '';
    }

    async function fetchSheet(){
      const url = getSheetUrl();
      if(!url){
        throw new Error('No PSSR inspection sheet URL is configured.');
      }
      const text = await safeFetch(url, { timeout:7000, retries:2 });
      if(/^[\[{]/.test(text.trim())){
        const json = JSON.parse(text);
        const rows = Array.isArray(json) ? json : (Array.isArray(json.rows) ? json.rows : []);
        const headers = rows.length ? Object.keys(rows[0]) : [];
        return { headers, rows };
      }
      return parseCsv(text);
    }

    function looksLikeFacilitiesSheet(headers, rows){
      const normalize = list => (Array.isArray(list) ? list : []).map(h => String(h ?? '').trim().toLowerCase());
      const headerSet = new Set(normalize(headers));
      const facilityCols = ['id','title','status','priority'];
      const hasFacilityHeader = facilityCols.every(col => headerSet.has(col));
      if(hasFacilityHeader) return true;
      if(Array.isArray(rows) && rows.length){
        const sampleKeys = Object.keys(rows.find(r => r && typeof r === 'object') || {}).map(k => k.toLowerCase());
        if(sampleKeys.length){
          const sampleSet = new Set(sampleKeys);
          if(facilityCols.slice(0,3).every(col => sampleSet.has(col))){
            return true;
          }
        }
      }
      return false;
    }

    function ensurePssrSheet(headers, rows){
      if(looksLikeFacilitiesSheet(headers, rows)){
        throw new Error('The configured sheet appears to point to the Facilities work orders data. Please double-check the published PSSR sheet link.');
      }
    }

    function buildRowModel(raw){
      const asset = pickField(raw, ['Asset','Asset ID','Asset Name','Equipment']);
      const locationValue = pickField(raw, ['Location','Site','Area']);
      const siteNameRaw = pickField(raw, ['Site']);
      const primarySite = siteNameRaw || (typeof locationValue === 'string' ? locationValue.split(/[â€“â€”-]/)[0].trim() : locationValue);
      const location = locationValue;
      const lastRaw = pickField(raw, ['Last Inspection Date','Last Inspection','Previous Inspection']);
      const nextRaw = pickField(raw, ['Next Inspection Date','Next Inspection','Inspection Due']);
      const comments = pickField(raw, ['Comments','Notes','Remarks']);
      const documentUrl = pickField(raw, ['Document URL','Document','Link','Document Link','Attachment','Attachment URL']);
      const lastDate = parseDateLoose(lastRaw);
      const nextDate = parseDateLoose(nextRaw);
      const countdown = normalizeCountdown(nextDate instanceof Date ? new Date(nextDate) : nextDate);
      return {
        Asset: asset || 'â€”',
        Location: location || primarySite || 'â€”',
        'Last Inspection Date': lastDate ? formatDisplayDate(lastDate) : (lastRaw || 'â€”'),
        'Next Inspection Date': nextDate ? formatDisplayDate(nextDate) : (nextRaw || 'â€”'),
        Countdown: countdown.label,
        Comments: comments || 'â€”',
        __lastDate: lastDate,
        __nextDate: nextDate,
        __countdownClass: countdown.className,
        __countdownDays: countdown.diffDays,
        __overdue: countdown.overdue,
        __siteName: primarySite || '',
        __docUrl: documentUrl || '',
        __raw: raw
      };
    }

    function renderTable(container, rows){
      const tbody = container.__tbody;
      const scrollRegion = container.__scrollRegion;
      if(!tbody) return;
      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No inspections are currently scheduled.</td></tr>';
        scrollRegion?.setAttribute('data-loading','false');
        updateResponsiveMode(container);
        return;
      }
      const html = rows.map(row => {
        const overdueClass = row.__overdue ? 'row-overdue' : '';
        const assetTitle = esc(row.Asset);
        const locationTitle = esc(row.Location);
        const lastTitle = esc(row['Last Inspection Date']);
        const nextTitle = esc(row['Next Inspection Date']);
        const commentsTitle = esc(row.Comments);
        const docAttr = row.__docUrl ? ` data-doc="${esc(row.__docUrl)}"` : '';
        return `
          <tr class="${overdueClass}" tabindex="0"${docAttr}>
            <td data-col="Asset" title="${assetTitle}"><span>${assetTitle}</span></td>
            <td data-col="Location" title="${locationTitle}"><span>${locationTitle}</span></td>
            <td data-col="Last Inspection Date" title="${lastTitle}"><span>${lastTitle}</span></td>
            <td data-col="Next Inspection Date" title="${nextTitle}"><span>${nextTitle}</span></td>
            <td data-col="Countdown" title="${esc(row.Countdown)}"><span><span class="countdown-chip ${row.__countdownClass}">${esc(row.Countdown)}</span></span></td>
            <td data-col="Comments" title="${commentsTitle}"><span>${commentsTitle}</span></td>
          </tr>
        `;
      }).join('');
      tbody.innerHTML = html;
      if(container.__selectedDocUrl){
        const active = Array.from(tbody.querySelectorAll('tr')).find(tr => (tr.dataset.doc || '') === container.__selectedDocUrl);
        if(active){
          active.classList.add('is-active');
        }
      }
      scrollRegion?.setAttribute('data-loading','false');
      updateResponsiveMode(container);
    }

    function wireViewer(container){
      const viewer = document.querySelector('#viewer');
      if(!viewer || !container?.__tbody) return;
      const tbody = container.__tbody;
      const highlight = (tr) => {
        if(!tbody) return;
        tbody.querySelectorAll('tr').forEach(row => row.classList.remove('is-active'));
        if(tr) tr.classList.add('is-active');
      };
      const open = (url) => {
        if(!url){
          setViewerPlaceholder('No document link on this row.', { reveal:true });
          return;
        }
        const raw = typeof url === 'string' ? url.trim() : '';
        const sanitized = sanitizeSheetUrl(raw);
        const safeUrl = sanitized || (raw.startsWith('data:') || raw.startsWith('about:') ? raw : '');
        if(!safeUrl){
          setViewerPlaceholder('No document link on this row.', { reveal:true });
          return;
        }
        const offline = !ALLOW_NETWORK && !safeUrl.startsWith('data:') && !safeUrl.startsWith('about:');
        if(offline){
          setViewerPlaceholder('Document preview disabled offline.', { reveal:true });
          return;
        }
        viewer.innerHTML = '';
        const frame = document.createElement('iframe');
        frame.src = safeUrl;
        frame.loading = 'lazy';
        frame.title = 'Inspection document preview';
        viewer.appendChild(frame);
        viewer.hidden = false;
        viewer.dataset.viewerState = 'visible';
      };
      const selectRow = (tr) => {
        if(!tr) return;
        container.__selectedDocUrl = tr.dataset.doc || '';
        highlight(tr);
        open(container.__selectedDocUrl);
      };
      tbody.addEventListener('click', event => {
        const tr = event.target.closest('tr');
        if(!tr) return;
        selectRow(tr);
      });
      tbody.addEventListener('keydown', event => {
        if(event.key === 'Enter' || event.key === ' '){
          const tr = event.target.closest('tr');
          if(!tr) return;
          selectRow(tr);
          event.preventDefault();
        }
      });
      container.__openDocument = open;
    }

    function renderMobileCards(container, rows){
      const mobile = container.__mobileCards;
      if(!mobile) return;
      const list = Array.isArray(rows) ? rows : [];
      mobile.dataset.state = list.length ? 'ready' : 'empty';
      mobile.setAttribute('aria-busy','false');
      if(!list.length){
        mobile.innerHTML = '<div class="mobile-card mobile-card--status empty-state" role="listitem">No inspections are currently scheduled.</div>';
        return;
      }
      const html = list.map(row => {
        const overdueClass = row.__overdue ? 'row-overdue' : '';
        const siteRaw = (row.__siteName || '').trim();
        const locationRaw = (row.Location || '').trim();
        const siteClean = siteRaw && siteRaw !== 'â€”' ? siteRaw : '';
        const locationClean = locationRaw && locationRaw !== 'â€”' ? locationRaw : '';
        const showSite = !!siteClean;
        const showLocation = !!locationClean && locationClean.toLowerCase() !== siteClean.toLowerCase();
        const subtitle = (showSite || showLocation)
          ? `<div class="mobile-card__subtitle">${showSite ? `<span>${esc(siteClean)}</span>` : ''}${showLocation ? `<span>${esc(locationClean)}</span>` : ''}</div>`
          : '';
        const locationMeta = showLocation && showSite
          ? `<div class="mobile-card__meta-item"><span class="mobile-card__meta-label">Location</span><span class="mobile-card__meta-value">${esc(locationClean)}</span></div>`
          : '';
        const commentsRaw = (row.Comments || '').trim();
        const hasComment = !!commentsRaw && commentsRaw !== 'â€”';
        const commentText = hasComment ? esc(commentsRaw) : 'No comments provided.';
        return `
          <article class="mobile-card ${overdueClass}" aria-label="Inspection for ${esc(row.Asset)}" role="listitem">
            <header class="mobile-card__header">
              <div class="mobile-card__heading">
                <div class="mobile-card__title">${esc(row.Asset)}</div>
                ${subtitle}
              </div>
              <span class="countdown-chip ${row.__countdownClass}">${esc(row.Countdown)}</span>
            </header>
            <div class="mobile-card__meta">
              ${locationMeta}
              <div class="mobile-card__meta-item"><span class="mobile-card__meta-label">Last inspection</span><span class="mobile-card__meta-value">${esc(row['Last Inspection Date'])}</span></div>
              <div class="mobile-card__meta-item"><span class="mobile-card__meta-label">Next inspection</span><span class="mobile-card__meta-value">${esc(row['Next Inspection Date'])}</span></div>
            </div>
            <p class="mobile-card__comment"><span class="mobile-card__comment-label">Comments</span>${commentText}</p>
          </article>
        `;
      }).join('');
      mobile.innerHTML = html;
    }

    function updateSummaryMetrics(rows, context={}){
      const metricsRoot = document.querySelector('[data-role="pssr-metrics"]');
      const signalRoot = document.querySelector('[data-role="pssr-signal"]');
      const signalValueNode = document.querySelector('[data-role="pssr-signal-value"]');
      const signalNoteNode = document.querySelector('[data-role="pssr-signal-note"]');
      const riskPanel = document.querySelector('[data-role="pssr-risk"]');
      const riskMessageNode = document.querySelector('[data-role="pssr-risk-message"]');
      const riskSegments = {
        overdue: document.querySelector('[data-role="pssr-risk-overdue"]'),
        due: document.querySelector('[data-role="pssr-risk-due"]'),
        clear: document.querySelector('[data-role="pssr-risk-clear"]')
      };
      const riskLabels = {
        overdue: document.querySelector('[data-role="pssr-risk-label-overdue"]'),
        due: document.querySelector('[data-role="pssr-risk-label-due"]'),
        clear: document.querySelector('[data-role="pssr-risk-label-clear"]')
      };
      const siteListRoot = document.querySelector('[data-role="pssr-site-breakdown"]');
      const siteHintNode = document.querySelector('[data-role="pssr-site-hint"]');

      if(!metricsRoot && !signalRoot && !riskPanel && !siteListRoot) return;

      const list = Array.isArray(rows) ? rows : [];
      const total = list.length;
      const dueSoonThreshold = DUE_SOON_THRESHOLD_DAYS;
      const siteFilter = context.siteFilter || 'all';
      const overallCount = typeof context.totalRowCount === 'number' ? context.totalRowCount : total;
      const isFiltered = siteFilter !== 'all';
      const dueSoonRows = list.filter(row => typeof row?.__countdownDays === 'number' && row.__countdownDays >= 0 && row.__countdownDays <= dueSoonThreshold);
      const overdueRows = list.filter(row => row?.__overdue);
      const compliantCount = Math.max(total - overdueRows.length - dueSoonRows.length, 0);
      const upcomingRows = list
        .filter(row => typeof row?.__countdownDays === 'number')
        .sort((a,b) => a.__countdownDays - b.__countdownDays);
      const nextDue = upcomingRows.length ? upcomingRows[0] : null;

      const riskState = total === 0
        ? 'empty'
        : (overdueRows.length > 0 ? 'critical' : (dueSoonRows.length > 0 ? 'warning' : 'stable'));

      const setMetric = (key, value, note, state=null) => {
        if(!metricsRoot) return;
        const item = metricsRoot.querySelector(`[data-metric="${key}"]`);
        if(!item) return;
        const valueNode = item.querySelector('[data-metric-value]');
        const noteNode = item.querySelector('[data-metric-note]');
        if(valueNode){
          valueNode.textContent = value;
        }
        if(noteNode){
          noteNode.textContent = note;
        }
        item.classList.remove('is-alert','is-warning');
        if(state === 'alert'){
          item.classList.add('is-alert');
        }else if(state === 'warning'){
          item.classList.add('is-warning');
        }
      };

      setMetric(
        'total',
        total.toString(),
        total === 0
          ? (isFiltered && overallCount > 0 ? 'No inspections for this site' : 'Awaiting published data')
          : total === 1
            ? 'Asset currently on the schedule'
            : 'Assets currently on the schedule'
      );

      setMetric(
        'due-soon',
        dueSoonRows.length.toString(),
        dueSoonRows.length ? `Due within ${dueSoonThreshold} days` : `All inspections beyond ${dueSoonThreshold} days`,
        dueSoonRows.length ? 'warning' : null
      );

      setMetric(
        'overdue',
        overdueRows.length.toString(),
        overdueRows.length ? 'Requires immediate action' : 'All inspections in compliance',
        overdueRows.length ? 'alert' : null
      );

      if(nextDue){
        const nextDate = nextDue['Next Inspection Date'];
        const hasKnownDate = nextDate && nextDate !== 'â€”';
        const headline = hasKnownDate ? nextDate : nextDue.Countdown;
        const pieces = [nextDue.Asset, nextDue.Location].map(v => String(v ?? '').trim()).filter(v => v && v !== 'â€”');
        const note = pieces.length ? pieces.join(' â€¢ ') : 'Scheduled item';
        const state = nextDue.__overdue ? 'alert' : (typeof nextDue.__countdownDays === 'number' && nextDue.__countdownDays <= dueSoonThreshold ? 'warning' : null);
        setMetric('next', headline, note, state);
      }else if(list.length){
        setMetric('next', 'â€”', 'No inspections with a scheduled date');
      }else if(isFiltered && overallCount > 0){
        setMetric('next', 'â€”', 'No inspections scheduled for this site');
      }else{
        setMetric('next', 'â€”', 'Awaiting schedule');
      }

      if(signalRoot){
        let signalValue = 'â€”';
        let signalNote = isFiltered && overallCount > 0
          ? `No inspections currently match the ${resolveSiteLabel(siteFilter)} filter.`
          : 'Awaiting data from the published schedule.';

        if(total > 0){
          if(riskState === 'critical'){
            signalValue = 'Critical';
            signalNote = overdueRows.length === 1
              ? '1 inspection is overdue and needs immediate action.'
              : `${overdueRows.length} inspections are overdue and need immediate action.`;
          }else if(riskState === 'warning'){
            signalValue = 'Caution';
            signalNote = dueSoonRows.length === 1
              ? '1 inspection is due within the next 60 days.'
              : `${dueSoonRows.length} inspections are due within the next ${dueSoonThreshold} days.`;
          }else{
            signalValue = 'Stable';
            signalNote = 'All inspections are currently outside the next 60 days.';
          }
        }

        signalRoot.setAttribute('data-state', riskState);
        if(signalValueNode){
          signalValueNode.textContent = signalValue;
        }
        if(signalNoteNode){
          signalNoteNode.textContent = signalNote;
        }
      }

      if(riskPanel){
        riskPanel.removeAttribute('data-state');
        if(riskState === 'critical' || riskState === 'warning' || riskState === 'stable'){
          riskPanel.setAttribute('data-state', riskState);
        }
      }

      if(riskMessageNode){
        let message = 'Awaiting inspection data.';
        if(total === 0){
          message = isFiltered && overallCount > 0
            ? `No inspections fall under the ${resolveSiteLabel(siteFilter)} filter.`
            : 'Awaiting inspection data.';
        }else if(riskState === 'critical'){
          message = overdueRows.length === 1
            ? '1 inspection is overdue and needs immediate action.'
            : `${overdueRows.length} inspections are overdue and need immediate action.`;
        }else if(riskState === 'warning'){
          message = dueSoonRows.length === 1
            ? '1 inspection is due within the next 60 days.'
            : `${dueSoonRows.length} inspections are due within the next ${dueSoonThreshold} days.`;
        }else if(riskState === 'stable'){
          message = 'All inspections are currently outside the next 60 days.';
        }
        riskMessageNode.textContent = message;
      }

      const percent = (count) => {
        if(total <= 0) return 0;
        const value = (count / total) * 100;
        return Number.isFinite(value) ? Math.max(0, Math.min(100, value)) : 0;
      };

      const formatLegend = (count, singular, plural=null) => {
        const label = count === 1 ? singular : (plural || `${singular}s`);
        if(total <= 0){
          return `${count} ${label}`;
        }
        const pct = Math.round(percent(count));
        return `${count} ${label} (${pct}%)`;
      };

      const overdueWidth = percent(overdueRows.length);
      const dueWidth = Math.max(0, Math.min(100 - overdueWidth, percent(dueSoonRows.length)));
      const startClear = overdueWidth + dueWidth;
      const clearWidth = total > 0 ? Math.max(0, Math.min(100, 100 - startClear)) : 0;

      if(riskSegments.overdue){
        riskSegments.overdue.style.left = '0%';
        riskSegments.overdue.style.width = `${overdueWidth}%`;
      }
      if(riskSegments.due){
        riskSegments.due.style.left = `${overdueWidth}%`;
        riskSegments.due.style.width = `${dueWidth}%`;
      }
      if(riskSegments.clear){
        riskSegments.clear.style.left = `${startClear}%`;
        riskSegments.clear.style.width = `${clearWidth}%`;
      }

      if(riskLabels.overdue){
        riskLabels.overdue.textContent = formatLegend(overdueRows.length, 'overdue', 'overdue');
      }
      if(riskLabels.due){
        riskLabels.due.textContent = formatLegend(dueSoonRows.length, 'due soon', 'due soon');
      }
      if(riskLabels.clear){
        riskLabels.clear.textContent = formatLegend(compliantCount, 'on track', 'on track');
      }

      if(siteHintNode){
        if(total === 0){
          siteHintNode.textContent = isFiltered && overallCount > 0
            ? `No inspections currently align with ${resolveSiteLabel(siteFilter)}.`
            : 'Awaiting data from the published schedule.';
        }else if(isFiltered){
          siteHintNode.textContent = `Status for ${resolveSiteLabel(siteFilter)}.`;
        }else{
          siteHintNode.textContent = 'Sites ordered by highest risk first.';
        }
      }

      if(siteListRoot){
        if(!list.length){
          const message = isFiltered && overallCount > 0
            ? `No inspections match ${resolveSiteLabel(siteFilter)}.`
            : 'Awaiting inspection data.';
          siteListRoot.innerHTML = `<li class="pssr-site-breakdown__item is-empty">${esc(message)}</li>`;
        }else{
          const siteStats = new Map();
          list.forEach(row => {
            const rawValue = String(row?.__siteName || '').trim();
            const normalizedName = rawValue && rawValue !== 'â€”' ? rawValue : '';
            const name = normalizedName || FALLBACK_SITE_LABEL;
            const key = name.toLowerCase();
            if(!siteStats.has(key)){
              siteStats.set(key, { name, total:0, overdue:0, dueSoon:0, clear:0 });
            }
            const stat = siteStats.get(key);
            stat.total += 1;
            if(row?.__overdue){
              stat.overdue += 1;
            }else if(typeof row?.__countdownDays === 'number' && row.__countdownDays >= 0 && row.__countdownDays <= dueSoonThreshold){
              stat.dueSoon += 1;
            }else{
              stat.clear += 1;
            }
          });

          const ordered = Array.from(siteStats.values()).sort((a,b) => {
            if(b.overdue !== a.overdue) return b.overdue - a.overdue;
            if(b.dueSoon !== a.dueSoon) return b.dueSoon - a.dueSoon;
            if(b.total !== a.total) return b.total - a.total;
            return a.name.localeCompare(b.name);
          });

          const limit = isFiltered ? 1 : Math.min(4, ordered.length);
          const visible = ordered.slice(0, limit);
          const siteHtml = visible.map(stat => {
            const buildBadge = (count, className, label, { isEmpty = count === 0 } = {}) => `
              <span class="pssr-site-breakdown__badge ${className}" data-empty="${isEmpty}" aria-label="${esc(`${count} ${label}`)}">
                <span class="pssr-site-breakdown__count">${esc(count)}</span>
                <span class="pssr-site-breakdown__label">${esc(label)}</span>
              </span>
            `;
            const totalBadge = buildBadge(stat.total, 'is-total', 'total', { isEmpty: false });
            const overdueBadge = buildBadge(stat.overdue, 'is-alert', 'overdue');
            const dueBadge = buildBadge(stat.dueSoon, 'is-warning', 'due soon');
            const clearBadge = buildBadge(stat.clear, 'is-ok', 'on track');
            return `
              <li class="pssr-site-breakdown__item">
                <div class="pssr-site-breakdown__header">
                  <span class="pssr-site-breakdown__name">${esc(stat.name)}</span>
                </div>
                <div class="pssr-site-breakdown__status">
                  ${totalBadge}
                  ${overdueBadge}
                  ${dueBadge}
                  ${clearBadge}
                </div>
              </li>
            `;
          }).join('');

          siteListRoot.innerHTML = siteHtml;
        }
      }
    }

    function setSort(container, column, direction){
      const dir = direction === 'asc' ? 'asc' : 'desc';
      container.__currentSort = { column, direction: dir };
      syncDesktopSortIndicators(container, column, dir);
      updateMobileSortControls(container);
      refreshView(container);
    }

    function attachSortHandlers(container){
      const thead = container.__thead;
      if(!thead) return;
      thead.querySelectorAll('th').forEach(th => {
        th.addEventListener('click', () => {
          const column = th.getAttribute('data-col');
          const current = container.__currentSort;
          const nextDirection = current && current.column === column && current.direction === 'asc' ? 'desc' : 'asc';
          setSort(container, column, nextDirection);
        });
      });
    }

    function handleMobileSort(container){
      const select = container.__mobileSortSelect;
      const button = container.__mobileSortDirectionBtn;
      if(select){
        select.addEventListener('change', () => {
          const column = select.value;
          const current = container.__currentSort;
          const direction = current && current.column === column ? current.direction : 'asc';
          setSort(container, column, direction);
        });
      }
      if(button){
        button.addEventListener('click', () => {
          const current = container.__currentSort || { column: select?.value || 'Next Inspection Date', direction:'asc' };
          const direction = current.direction === 'asc' ? 'desc' : 'asc';
          setSort(container, current.column, direction);
        });
      }
    }

    function updateStickyOffsets(){
      const sticky = document.querySelector('.sticky-top');
      if(!sticky) return;
      const height = sticky.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--sticky-controls-offset', `${Math.ceil(height)}px`);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const container = document.querySelector('[data-component="pssr-table"]');

      const handleResize = () => {
        updateStickyOffsets();
        updateResponsiveMode(container);
      };

      updateStickyOffsets();
      updateResponsiveMode(container);
      window.addEventListener('resize', () => window.requestAnimationFrame(handleResize));

      if(!container) return;
      container.__thead = container.querySelector('thead');
      container.__tbody = container.querySelector('tbody');
      container.__scrollRegion = container.querySelector('[data-role="scroll-region"]');
      container.__mobileCards = document.querySelector('[data-role="mobile-cards"]');
      container.__mobileSortSelect = document.querySelector('[data-role="mobile-sort-select"]');
      container.__mobileSortDirectionBtn = document.querySelector('[data-role="mobile-sort-direction"]');
      container.__siteFilterNav = document.querySelector('[data-role="site-nav"]');
      container.__siteFilterActiveLabel = document.querySelector('[data-role="site-filter-active"]');
      container.__rows = [];
      container.__viewRows = [];
      container.__currentSort = { column:'Next Inspection Date', direction:'asc' };
      container.__siteFilter = 'all';
      container.__selectedDocUrl = '';

      setViewerPlaceholder('Select an inspection to preview documentation.');
      wireViewer(container);

      attachSortHandlers(container);
      handleMobileSort(container);
      updateSiteFilterControls(container);
      attachSiteFilterHandlers(container);

      const refreshButton = document.querySelector('[data-action="refresh"]');

      async function loadData(){
        banner('', 'Fetching latest inspectionsâ€¦');
        container.__scrollRegion?.setAttribute('data-loading','true');
        container.__selectedDocUrl = '';
        setViewerPlaceholder('Select an inspection to preview documentation.');
        if(container.__mobileCards){
          container.__mobileCards.dataset.state = 'loading';
          container.__mobileCards.setAttribute('aria-busy','true');
          container.__mobileCards.innerHTML = '<div class="mobile-card mobile-card--status" role="listitem" aria-live="polite">Loading inspection dataâ€¦</div>';
        }
        try {
          if(!ALLOW_NETWORK){
            throw new Error('Network disabled in this environment');
          }
          const { headers, rows } = await fetchSheet();
          ensurePssrSheet(headers, rows);
          const hasRows = Array.isArray(rows) && rows.length > 0;
          const sourceRows = hasRows ? rows : SAMPLE;
          const mapped = sourceRows.map(buildRowModel);
          container.__rows = mapped;
          syncSiteFilterAvailability(container);
          setSort(container, container.__currentSort.column, container.__currentSort.direction);
          if(hasRows){
            hideBanner();
          }else{
            banner('warn', 'Showing sample data', 'sheet returned no rows');
          }
        } catch (error) {
          console.warn('Falling back to SAMPLE. Reason:', error?.message || error);
          const message = (error && typeof error.message === 'string' && error.message.trim()) ? error.message.trim() : DEFAULT_ERROR_MESSAGE;
          const fallback = SAMPLE.map(buildRowModel);
          container.__rows = fallback;
          syncSiteFilterAvailability(container);
          setSort(container, container.__currentSort.column, container.__currentSort.direction);
          banner('warn', 'Showing sample data', message);
        } finally {
          container.__scrollRegion?.setAttribute('data-loading','false');
        }
      }

      refreshButton?.addEventListener('click', () => loadData());

      loadData();
    });
  </script>
</body>
</html>
