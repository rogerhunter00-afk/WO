<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>Inspections Tracker – ALS Engineering Dashboard</title>
  <style>
    :root {
      --bg:#f3f5f9;
      --paper:#ffffff;
      --ink:#0b0f1a;
      --muted:#6b7280;
      --border:#e5e9f2;

      --brand:#0b67c2;
      --brand-strong:#0a5cb0;

      --btn-fg:#ffffff;
      --btn-bg:var(--brand);
      --btn-bg-hover:var(--brand-strong);
      --btn-outline-fg:var(--brand);
      --btn-outline-bd:#bcd7f4;
      --btn-ghost-fg:var(--brand);
      --btn-ghost-bg:transparent;
      --btn-ghost-bg-hover:rgba(11,103,194,.10);

      --input-bg:#ffffff;
      --input-fg:var(--ink);
      --input-bd:var(--border);
      --input-bd-focus:var(--brand);
      --shadow:0 1px 2px rgba(16,24,40,.06),0 4px 10px rgba(16,24,40,.06);

      --als-blue:var(--brand);
      --als-blue-strong:var(--brand-strong);
      --risk-critical:#dc2626;
      --risk-warning:#b45309;
      --risk-ok:#059669;
      --surface-subtle:color-mix(in srgb,var(--als-blue) 4%,var(--paper));
      --surface-strong:color-mix(in srgb,var(--als-blue) 9%,var(--paper));
      --thead:var(--brand);
      --thead-text:#fff;
      --grid:var(--border);
      --zebra:var(--paper);
      --sticky-controls-offset:0px;
      --table-min-width:720px;
      --ui-offset:0px;
      --ctrl-bg:#ffffff;
      --ctrl-fg:#0b0f1a;
      --ctrl-muted:#6b7280;
      --ctrl-ring:#3b82f6;
      --ctrl-pill:#f3f6fb;
      --ctrl-pill-border:#dfe6ef;
      --ctrl-shadow:0 1px 2px rgba(0,0,0,.05);
      --ctrl-hover:rgba(11,103,194,.08);
      --ctrl-on:#0b67c2;
      color-scheme:light;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        color-scheme:dark;
        --bg:#0f1422;
        --paper:#131a2b;
        --ink:#f3f4f6;
        --muted:#9ca3af;
        --border:#233150;
        --brand:#3b82f6;
        --brand-strong:#2563eb;
        --btn-outline-bd:#2b3a63;
        --btn-ghost-bg-hover:rgba(11,103,194,.18);
        --input-bg:#0f1422;
        --input-fg:#f3f4f6;
        --input-bd:#233150;
        --input-bd-focus:#3b82f6;
        --als-blue:var(--brand);
        --als-blue-strong:var(--brand-strong);
        --risk-critical:#f87171;
        --risk-warning:#fbbf24;
        --risk-ok:#34d399;
        --surface-subtle:color-mix(in srgb,var(--als-blue) 14%,var(--paper));
        --surface-strong:color-mix(in srgb,var(--als-blue) 20%,var(--paper));
        --thead:#1e3a8a;
        --grid:#233150;
        --zebra:#1c2438;
        --ctrl-bg:#0d1117;
        --ctrl-fg:#e8edf5;
        --ctrl-muted:#9aa7b7;
        --ctrl-ring:#60a5fa;
        --ctrl-pill:#111827;
        --ctrl-pill-border:#1f2937;
        --ctrl-shadow:0 1px 0 rgba(255,255,255,.06) inset;
        --ctrl-hover:rgba(96,165,250,.15);
        --ctrl-on:#60a5fa;
      }
    }

    .dark {
      color-scheme:dark;
      --bg:#0f1422;
      --paper:#131a2b;
      --ink:#f3f4f6;
      --muted:#9ca3af;
      --border:#233150;
      --brand:#3b82f6;
      --brand-strong:#2563eb;
      --btn-outline-bd:#2b3a63;
      --btn-ghost-bg-hover:rgba(11,103,194,.18);
      --input-bg:#0f1422;
      --input-fg:#f3f4f6;
      --input-bd:#233150;
      --input-bd-focus:#3b82f6;
      --als-blue:var(--brand);
      --als-blue-strong:var(--brand-strong);
      --risk-critical:#f87171;
      --risk-warning:#fbbf24;
      --risk-ok:#34d399;
      --surface-subtle:color-mix(in srgb,var(--als-blue) 14%,var(--paper));
      --surface-strong:color-mix(in srgb,var(--als-blue) 20%,var(--paper));
      --thead:#1e3a8a;
      --grid:#233150;
      --zebra:#1c2438;
      --ctrl-bg:#0d1117;
      --ctrl-fg:#e8edf5;
      --ctrl-muted:#9aa7b7;
      --ctrl-ring:#60a5fa;
      --ctrl-pill:#111827;
      --ctrl-pill-border:#1f2937;
      --ctrl-shadow:0 1px 0 rgba(255,255,255,.06) inset;
      --ctrl-hover:rgba(96,165,250,.15);
      --ctrl-on:#60a5fa;
    }

    .light {
      color-scheme:light;
      --bg:#f3f5f9;
      --paper:#ffffff;
      --ink:#0b0f1a;
      --muted:#6b7280;
      --border:#e5e9f2;
      --brand:#0b67c2;
      --brand-strong:#0a5cb0;
      --btn-outline-bd:#bcd7f4;
      --btn-ghost-bg-hover:rgba(11,103,194,.10);
      --input-bg:#ffffff;
      --input-fg:var(--ink);
      --input-bd:var(--border);
      --input-bd-focus:var(--brand);
      --als-blue:var(--brand);
      --als-blue-strong:var(--brand-strong);
      --risk-critical:#dc2626;
      --risk-warning:#b45309;
      --risk-ok:#059669;
      --surface-subtle:color-mix(in srgb,var(--als-blue) 4%,var(--paper));
      --surface-strong:color-mix(in srgb,var(--als-blue) 9%,var(--paper));
      --thead:var(--brand);
      --grid:var(--border);
      --zebra:var(--paper);
      --ctrl-bg:#ffffff;
      --ctrl-fg:#0b0f1a;
      --ctrl-muted:#6b7280;
      --ctrl-ring:#3b82f6;
      --ctrl-pill:#f3f6fb;
      --ctrl-pill-border:#dfe6ef;
      --ctrl-shadow:0 1px 2px rgba(0,0,0,.05);
      --ctrl-hover:rgba(11,103,194,.08);
      --ctrl-on:#0b67c2;
    }

    body {
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      font-size:13px;
      line-height:1.4;
      -webkit-font-smoothing:antialiased;
    }

    body::before {
      content:"";
      position:fixed;
      inset:0 0 auto 0;
      height:var(--ui-offset, var(--sticky-controls-offset, 0px));
      background:var(--bg);
      pointer-events:none;
      z-index:180;
    }

    .page {
      --page-pad-top:12px;
      --page-pad-inline:clamp(20px,4vw,36px);
      --page-pad-bottom:48px;
      padding:var(--page-pad-top) var(--page-pad-inline) var(--page-pad-bottom);
      max-width:clamp(960px,96vw,1680px);
      margin-inline:auto;
      box-sizing:border-box;
    }

    @media (max-width: 960px){
      .page {
        --page-pad-inline:clamp(18px,6vw,26px);
        --page-pad-bottom:24px;
      }
    }

    @media (max-width: 720px){
      .page {
        --page-pad-inline:16px;
        --page-pad-bottom:20px;
      }
    }

    .page-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding-bottom:12px;
      margin-bottom:0;
      position:relative;
      z-index:260;
      gap:16px;
    }

    .page-head__title {
      display:flex;
      align-items:center;
      gap:12px;
      flex:1 1 auto;
      min-width:0;
      flex-wrap:wrap;
    }

    .page-head__title .title {
      margin:0;
      flex:1 1 auto;
      min-width:0;
    }

    .title {
      font-size:24px;
      font-weight:800;
      margin:0;
    }

    .logo {
      height:50px;
      margin-left:auto;
      flex-shrink:0;
    }

    .nav {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin:4px 0 0;
    }

    .nav .tab {
      padding:7px 12px;
      border-radius:999px;
      border:1px solid var(--grid);
      background:transparent;
      color:var(--ink);
      font-weight:700;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:box-shadow .15s ease,border-color .15s ease,background .15s ease;
    }

    .nav .tab[aria-selected="true"],
    .nav .tab:focus-visible {
      outline:none;
      border-color:var(--als-blue);
      background:color-mix(in srgb,var(--als-blue) 8%,var(--paper));
      box-shadow:0 0 0 2px color-mix(in srgb,var(--als-blue) 30%,transparent);
    }

    .site-filter {
      display:flex;
      align-items:center;
      gap:4px;
      flex-wrap:wrap;
    }

    .site-filter__label {
      font-weight:600;
      color:var(--muted);
      font-size:12px;
    }

    .site-filter__label [data-role="site-filter-active"] {
      color:var(--ink);
      font-weight:700;
    }

    .site-filter__tabs {
      display:flex;
      gap:4px;
      flex-wrap:wrap;
    }

    .site-filter__tab {
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--grid);
      background:transparent;
      color:var(--ink);
      font-weight:700;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      cursor:pointer;
      transition:box-shadow .15s ease,border-color .15s ease,background .15s ease;
      white-space:nowrap;
    }

    .site-filter__tab[aria-pressed="true"],
    .site-filter__tab:focus-visible {
      outline:none;
      border-color:var(--als-blue);
      background:color-mix(in srgb,var(--als-blue) 8%,var(--paper));
      box-shadow:0 0 0 2px color-mix(in srgb,var(--als-blue) 30%,transparent);
    }

    .site-filter__tab[disabled] {
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
    }

    .top-rule {
      height:2px;
      background:var(--als-blue);
      border-bottom:1px solid var(--als-blue-strong);
      margin:0;
      position:relative;
      z-index:320;
    }

    .pssr-overview {
      margin:12px 0 8px;
      padding:16px;
      border:1px solid color-mix(in srgb,var(--grid) 72%,transparent);
      border-radius:16px;
      background:var(--surface-subtle);
      display:grid;
      gap:16px;
      grid-template-columns:minmax(0,1fr);
    }

    .pssr-overview__summary {
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .pssr-overview__insights {
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .pssr-site-panel {
      display:flex;
      flex-direction:column;
      gap:10px;
      border-radius:10px;
      padding:10px 12px;
      border:1px solid color-mix(in srgb,var(--grid) 68%,transparent);
      background:var(--surface-strong);
      box-shadow:0 3px 8px rgba(15,23,42,0.08);
      grid-column:1 / -1;
    }

    .pssr-overview__eyebrow {
      font-size:12px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--als-blue);
      margin:0;
    }

    .pssr-overview__headline {
      margin:0;
      font-size:19px;
      font-weight:750;
      line-height:1.28;
    }

    .pssr-overview__description {
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
      max-width:48ch;
    }

    .pssr-signal {
      border-radius:12px;
      padding:14px 16px;
      display:grid;
      gap:6px;
      border:1px solid color-mix(in srgb,var(--als-blue) 18%,transparent);
      background:color-mix(in srgb,var(--als-blue) 6%,var(--paper));
      box-shadow:0 4px 12px rgba(15,23,42,0.1);
      transition:background .18s ease, border-color .18s ease, box-shadow .18s ease;
    }

    .pssr-signal[data-state="critical"] {
      border-color:color-mix(in srgb,var(--risk-critical) 60%,transparent);
      background:color-mix(in srgb,var(--risk-critical) 16%,var(--paper));
      box-shadow:0 12px 28px rgba(220,38,38,0.18);
    }

    .pssr-signal[data-state="warning"] {
      border-color:color-mix(in srgb,var(--risk-warning) 60%,transparent);
      background:color-mix(in srgb,var(--risk-warning) 18%,var(--paper));
      box-shadow:0 10px 24px rgba(180,83,9,0.18);
    }

    .pssr-signal[data-state="stable"] {
      border-color:color-mix(in srgb,var(--risk-ok) 45%,transparent);
      background:color-mix(in srgb,var(--risk-ok) 18%,var(--paper));
      box-shadow:0 8px 20px rgba(5,150,105,0.16);
    }

    .pssr-signal[data-state="empty"] {
      background:color-mix(in srgb,var(--als-blue) 4%,var(--paper));
      border-color:color-mix(in srgb,var(--grid) 75%,transparent);
      box-shadow:none;
    }

    .pssr-signal__label {
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:color-mix(in srgb,var(--muted) 82%,var(--ink));
      font-weight:700;
    }

    .pssr-signal__value {
      font-size:26px;
      font-weight:900;
      letter-spacing:-0.01em;
    }

    .pssr-signal__note {
      margin:0;
      font-size:12px;
      color:color-mix(in srgb,var(--muted) 72%,var(--ink));
      max-width:44ch;
    }

    .pssr-risk-panel {
      border-radius:12px;
      padding:14px 14px 16px;
      border:1px solid color-mix(in srgb,var(--grid) 70%,transparent);
      background:color-mix(in srgb,var(--paper) 92%,var(--als-blue) 3%);
      box-shadow:0 4px 12px rgba(15,23,42,0.08);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .pssr-risk-panel__title {
      font-size:13px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:color-mix(in srgb,var(--muted) 68%,var(--ink));
      margin:0;
    }

    .pssr-risk-panel__message {
      margin:0;
      font-size:13px;
      font-weight:600;
    }

    .pssr-risk-panel[data-state="critical"] .pssr-risk-panel__message { color:var(--risk-critical); }
    .pssr-risk-panel[data-state="warning"] .pssr-risk-panel__message { color:var(--risk-warning); }
    .pssr-risk-panel[data-state="stable"] .pssr-risk-panel__message { color:var(--risk-ok); }

    .pssr-risk-bar {
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .pssr-risk-bar__track {
      position:relative;
      width:100%;
      height:10px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid color-mix(in srgb,var(--grid) 80%,transparent);
      background:color-mix(in srgb,var(--paper) 95%,var(--als-blue) 4%);
    }

    .pssr-risk-bar__segment {
      position:absolute;
      top:0;
      bottom:0;
      transition:width .24s ease;
    }

    .pssr-risk-bar__segment.is-alert { background:color-mix(in srgb,var(--risk-critical) 90%,transparent); }
    .pssr-risk-bar__segment.is-warning { background:color-mix(in srgb,var(--risk-warning) 90%,transparent); }
    .pssr-risk-bar__segment.is-ok { background:color-mix(in srgb,var(--risk-ok) 80%,transparent); }

    .pssr-risk-bar__legend {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:11px;
      color:color-mix(in srgb,var(--muted) 70%,var(--ink));
    }

    .pssr-risk-bar__legend-item {
      display:inline-flex;
      align-items:center;
      gap:5px;
      font-weight:600;
    }

    .pssr-risk-bar__dot {
      width:10px;
      height:10px;
      border-radius:50%;
      background:currentColor;
      opacity:0.9;
    }

    .pssr-risk-bar__legend-item.is-alert { color:var(--risk-critical); }
    .pssr-risk-bar__legend-item.is-warning { color:var(--risk-warning); }
    .pssr-risk-bar__legend-item.is-ok { color:var(--risk-ok); }

    .pssr-site-panel__title {
      margin:0;
      font-size:12.5px;
      font-weight:780;
      letter-spacing:0.06em;
      text-transform:uppercase;
    }

    .pssr-site-panel__hint {
      margin:0;
      font-size:10.5px;
      color:color-mix(in srgb,var(--muted) 66%,var(--ink));
      max-width:46ch;
    }

    .pssr-site-breakdown {
      list-style:none;
      margin:0;
      padding:0;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(clamp(200px,20vw,260px),1fr));
      gap:8px;
      align-items:stretch;
      justify-content:stretch;
      grid-auto-rows:1fr;
    }

    @media (max-width: 720px) {
      .pssr-site-breakdown {
        grid-template-columns:minmax(0,1fr);
      }
    }

    .pssr-site-breakdown__item {
      padding:8px 10px;
      border-radius:8px;
      border:1px solid color-mix(in srgb,var(--grid) 74%,transparent);
      background:color-mix(in srgb,var(--paper) 94%,var(--als-blue) 3%);
      display:grid;
      gap:5px;
      box-shadow:0 2px 6px rgba(15,23,42,0.08);
    }

    .pssr-site-breakdown__item.is-empty {
      text-align:center;
      color:var(--muted);
      font-weight:600;
    }

    .pssr-site-breakdown__header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .pssr-site-breakdown__name {
      font-weight:720;
      font-size:12.5px;
    }

    .pssr-site-breakdown__status {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(92px,1fr));
      gap:8px;
      align-items:stretch;
    }

    .pssr-site-breakdown__badge {
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:4px;
      border-radius:12px;
      padding:10px 8px;
      min-height:76px;
      text-align:center;
      font-size:10.5px;
      font-weight:630;
      letter-spacing:-0.01em;
      background:color-mix(in srgb,var(--als-blue) 8%,var(--paper));
      color:color-mix(in srgb,var(--muted) 52%,var(--ink));
      border:1px solid color-mix(in srgb,var(--grid) 74%,transparent);
      box-shadow:0 3px 10px rgba(15,23,42,0.08);
      cursor:pointer;
      appearance:none;
      background-clip:padding-box;
      transition:background .15s ease,color .15s ease,border-color .15s ease,box-shadow .15s ease,transform .15s ease;
    }

    .pssr-site-breakdown__badge:focus-visible {
      outline:none;
      border-color:color-mix(in srgb,var(--als-blue) 65%,transparent);
      box-shadow:0 0 0 3px color-mix(in srgb,var(--als-blue) 30%,transparent);
    }

    .pssr-site-breakdown__badge:hover {
      transform:translateY(-1px);
      box-shadow:0 5px 14px rgba(15,23,42,0.14);
    }

    .pssr-site-breakdown__badge[aria-pressed="true"] {
      background:color-mix(in srgb,var(--als-blue) 18%,var(--paper));
      border-color:color-mix(in srgb,var(--als-blue) 70%,transparent);
      color:color-mix(in srgb,var(--als-blue-strong) 85%,var(--ink));
      box-shadow:0 7px 18px rgba(15,23,42,0.2);
      transform:translateY(-1px);
    }

    .pssr-site-breakdown__badge[data-empty="true"] {
      opacity:0.55;
      border-style:dashed;
      cursor:default;
      transform:none;
      box-shadow:0 3px 10px rgba(15,23,42,0.08);
    }

    .pssr-site-breakdown__badge[data-empty="true"]:hover {
      transform:none;
      box-shadow:0 3px 10px rgba(15,23,42,0.08);
    }

    .pssr-site-breakdown__badge.is-total {
      background:color-mix(in srgb,var(--als-blue) 16%,var(--paper));
      border-color:color-mix(in srgb,var(--als-blue) 55%,transparent);
      color:color-mix(in srgb,var(--ink) 85%,var(--als-blue));
    }

    .pssr-site-breakdown__badge.is-alert {
      background:color-mix(in srgb,var(--risk-critical) 20%,var(--paper));
      border-color:color-mix(in srgb,var(--risk-critical) 65%,transparent);
      color:var(--risk-critical);
    }

    .pssr-site-breakdown__badge.is-warning {
      background:color-mix(in srgb,var(--risk-warning) 22%,var(--paper));
      border-color:color-mix(in srgb,var(--risk-warning) 65%,transparent);
      color:var(--risk-warning);
    }

    .pssr-site-breakdown__badge.is-ok {
      background:color-mix(in srgb,var(--risk-ok) 22%,var(--paper));
      border-color:color-mix(in srgb,var(--risk-ok) 55%,transparent);
      color:var(--risk-ok);
    }

    .pssr-site-breakdown__count {
      font-size:20px;
      font-weight:760;
      line-height:1;
      color:currentColor;
    }

    .pssr-site-breakdown__label {
      font-size:10.5px;
      font-weight:610;
      text-transform:capitalize;
      color:color-mix(in srgb,currentColor 78%,var(--muted));
    }

    @media (min-width: 960px){
      .pssr-overview {
        grid-template-columns:minmax(0,1.35fr) minmax(0,1.05fr);
        align-items:start;
      }
      .pssr-site-panel {
        grid-column:1 / -1;
      }
    }

    @media (min-width: 1280px){
      .pssr-overview {
        grid-template-columns:minmax(0,1.35fr) minmax(0,1.05fr) minmax(0,0.9fr);
      }
      .pssr-site-panel {
        grid-column:1 / -1;
      }
    }

    @media (max-width: 640px){
      .pssr-overview {
        padding:14px;
        gap:12px;
      }
      .pssr-signal {
        padding:12px 14px;
      }
      .pssr-risk-panel {
        padding:12px 14px;
      }
      .pssr-site-panel {
        padding:12px 14px;
      }
    }

    .sticky-top {
      position:sticky;
      top:0;
      z-index:300;
      background:color-mix(in srgb,var(--bg) 20%,transparent);
      border-bottom:1px solid color-mix(in srgb,var(--border) 55%,transparent);
      padding:10px 0;
      margin:0;
      backdrop-filter:blur(12px);
    }

    .sticky-top__content {
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      row-gap:8px;
      flex-wrap:wrap;
    }

    .controls-bar {
      background:transparent;
      border:0;
      box-shadow:none;
      padding:4px 0;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }

    .controls-bar>* {
      flex:0 0 auto;
    }

    .sticky-controls {
      display:flex;
      gap:6px;
      row-gap:4px;
      align-items:center;
      flex-wrap:wrap;
    }

    .banner{margin-top:12px;padding:10px 12px;border-radius:12px;border:1px solid var(--grid);display:flex;gap:8px;align-items:center}
    .banner.ok{background:color-mix(in srgb, #059669 14%, var(--paper))}
    .banner.warn{background:color-mix(in srgb, #b45309 14%, var(--paper))}
    .banner.err{background:color-mix(in srgb, #b91c1c 14%, var(--paper))}
    .banner [data-msg]{font-weight:700}

    .pssr-content {
      display:flex;
      flex-direction:column;
      gap:18px;
      align-items:stretch;
      margin-top:18px;
    }

    .document-viewer {
      border:1px solid color-mix(in srgb,var(--grid) 78%,transparent);
      border-radius:14px;
      background:color-mix(in srgb,var(--paper) 96%,var(--als-blue) 1%);
      box-shadow:0 4px 10px rgba(15,23,42,0.05);
      min-height:clamp(420px, 50vh, 640px);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
    }

    .document-viewer__controls {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 18px;
      background:color-mix(in srgb,var(--paper) 94%,var(--als-blue) 4%);
      border-bottom:1px solid color-mix(in srgb,var(--grid) 70%,transparent);
    }

    .document-viewer__title {
      margin:0;
      font-size:14px;
      font-weight:600;
      color:var(--ink);
    }

    .document-viewer__toggle {
      appearance:none;
      border:1px solid color-mix(in srgb,var(--btn-outline-bd) 80%,transparent);
      background:var(--btn-ghost-bg);
      color:var(--btn-ghost-fg);
      border-radius:999px;
      font-weight:600;
      font-size:12px;
      padding:6px 12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:background .18s ease,border-color .18s ease,color .18s ease;
    }

    .document-viewer__toggle:hover {
      background:var(--btn-ghost-bg-hover);
    }

    .document-viewer__toggle:focus {
      outline:0;
      border-color:var(--btn-outline-bd);
      box-shadow:0 0 0 3px color-mix(in oklab,var(--btn-outline-bd) 30%,transparent);
    }

    .document-viewer__body {
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .document-viewer__body iframe {
      border:0;
      flex:1 1 auto;
      width:100%;
      min-height:inherit;
      background:var(--paper);
    }

    .document-viewer__body .placeholder {
      padding:18px;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }

    .document-viewer[data-viewer-collapsed="true"] {
      min-height:auto;
    }

    .document-viewer[data-viewer-collapsed="true"] .document-viewer__controls {
      border-bottom:0;
    }

    body[data-table-mode="mobile"] .document-viewer {
      display:none;
    }

    body[data-table-mode="mobile"] .pssr-content {
      display:none;
    }


    .sort-control {
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
    }

    .sort-control__label {
      color:var(--muted);
      font-weight:600;
    }

    .search-control,
    .category-filter {
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
    }

    .search-control label,
    .category-filter label {
      color:var(--muted);
      font-weight:600;
    }

    .search-control input,
    .category-filter select {
      background:var(--input-bg);
      color:var(--input-fg);
      border:1px solid var(--input-bd);
      border-radius:10px;
      padding:6px 10px;
      font:inherit;
      transition:border-color .18s ease,box-shadow .18s ease,background-color .18s ease;
      min-width:0;
    }

    .search-control input:focus,
    .category-filter select:focus {
      outline:0;
      border-color:var(--input-bd-focus);
      box-shadow:0 0 0 3px color-mix(in srgb,var(--input-bd-focus) 28%,transparent);
    }

    .sort-control__inputs {
      display:flex;
      align-items:center;
      gap:4px;
    }

    .sort-control select,
    .mobile-sort select {
      background:var(--input-bg);
      color:var(--input-fg);
      border:1px solid var(--input-bd);
      border-radius:10px;
      padding:6px 10px;
      font:inherit;
      transition:border-color .18s ease,box-shadow .18s ease,background-color .18s ease;
      min-width:0;
    }

    .sort-control select:focus,
    .mobile-sort select:focus {
      outline:0;
      border-color:var(--input-bd-focus);
      box-shadow:0 0 0 2px color-mix(in oklab,var(--input-bd-focus) 28%,transparent);
    }

    .sort-control__direction {
      --pad-x:10px;
      --pad-y:5px;
    }

    .mobile-sort {
      display:none;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--ink);
    }

    .mobile-sort label {
      color:var(--muted);
      font-weight:600;
    }

    .btn {
      --pad-x:14px;
      --pad-y:8px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:var(--pad-y) var(--pad-x);
      border-radius:999px;
      font-weight:600;
      line-height:1;
      border:1px solid transparent;
      cursor:pointer;
      transition:transform .02s ease,background .15s ease,border-color .15s ease;
      color:var(--ink);
      background:var(--btn-ghost-bg);
    }

    .btn:active {
      transform:translateY(1px);
    }

    .btn--primary {
      color:var(--btn-fg);
      background:var(--btn-bg);
      border-color:var(--btn-bg);
    }

    .btn--primary:hover {
      background:var(--btn-bg-hover);
    }

    .btn--outline {
      color:var(--btn-outline-fg);
      background:transparent;
      border-color:var(--btn-outline-bd);
    }

    .btn--outline:hover {
      border-color:var(--btn-outline-fg);
    }

    .btn--ghost {
      color:var(--btn-ghost-fg);
      background:var(--btn-ghost-bg);
    }

    .btn--ghost:hover {
      background:var(--btn-ghost-bg-hover);
    }

    .btn--sm {
      --pad-x:10px;
      --pad-y:6px;
      font-size:12px;
    }

    .ctrl-pill {
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      height:36px;
      padding:0 .75rem;
      border-radius:9999px;
      border:1px solid var(--ctrl-pill-border);
      background:var(--ctrl-pill);
      color:var(--ctrl-fg);
      box-shadow:var(--ctrl-shadow);
      font:inherit;
      font-weight:600;
      letter-spacing:.1px;
      cursor:pointer;
      user-select:none;
      transition:background .2s ease,border-color .2s ease,color .2s ease,transform .06s ease;
    }

    .ctrl-pill:hover {
      background:var(--ctrl-hover);
    }

    .ctrl-pill:active {
      transform:translateY(1px);
    }

    .ctrl-pill:focus-visible {
      outline:2px solid var(--ctrl-ring);
      outline-offset:2px;
    }

    .ctrl-pill:disabled {
      opacity:.6;
      cursor:not-allowed;
      box-shadow:none;
    }

    .switch-wrap {
      display:inline-flex;
      align-items:center;
      gap:.5rem;
    }

    .switch {
      position:relative;
      width:56px;
      height:28px;
      border-radius:9999px;
      background:color-mix(in oklab,var(--ctrl-fg) 12%,transparent);
      border:1px solid var(--ctrl-pill-border);
      transition:background .2s ease,border-color .2s ease;
    }

    .switch__thumb {
      position:absolute;
      top:3px;
      left:3px;
      width:22px;
      height:22px;
      border-radius:50%;
      background:var(--ctrl-bg);
      box-shadow:var(--ctrl-shadow);
      transition:left .2s ease,background .2s ease;
    }

    [role="switch"][aria-checked="true"] .switch {
      background:color-mix(in oklab,var(--ctrl-on) 40%,transparent);
      border-color:color-mix(in oklab,var(--ctrl-on) 55%,var(--ctrl-pill-border));
    }

    [role="switch"][aria-checked="true"] .switch__thumb {
      left:31px;
      background:var(--ctrl-bg);
    }

    .switch-label {
      color:var(--ctrl-fg);
      font-weight:600;
    }

    .refresh-btn {
      margin-right:auto;
    }

    .table-wrapper {
      margin-top:0;
    }

    table {
      width:100%;
      min-width:var(--table-min-width, 720px);
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }

    .visually-hidden {
      position:absolute !important;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    .table-scroll {
      position:relative;
      overflow:auto;
      border:1px solid var(--grid);
      border-radius:12px;
      background:var(--paper);
      box-shadow:0 2px 10px rgba(15, 23, 42, 0.05);
      max-height:calc(100vh - var(--sticky-controls-offset) - 220px);
      padding:0 2px 2px;
    }

    .table-scroll thead {
      position:sticky;
      top:0;
      background:var(--thead);
      z-index:2;
    }

    .table-scroll thead th {
      background:var(--thead);
      color:var(--thead-text);
      font-weight:750;
      letter-spacing:0.1px;
      padding:13px 8px;
      border-bottom:1px solid color-mix(in srgb,#000 18%,transparent);
      text-align:left;
      white-space:nowrap;
      position:relative;
      cursor:pointer;
    }

    .table-scroll thead th[data-col="Last Inspection Date"],
    .table-scroll thead th[data-col="Next Inspection Date"] {
      white-space:normal;
    }

    .table-scroll thead th:first-child {
      border-top-left-radius:12px;
    }

    .table-scroll thead th:last-child {
      border-top-right-radius:12px;
    }

    .table-scroll thead th[data-col="Asset"] {
      position:sticky;
      left:0;
      z-index:3;
      border-right:1px solid color-mix(in srgb, var(--grid) 85%, transparent);
    }

    .table-scroll thead th .sort-arrow {
      display:inline-block;
      margin-left:8px;
      width:0;
      height:0;
      border-left:5px solid transparent;
      border-right:5px solid transparent;
      border-top:7px solid currentColor;
      opacity:0.25;
      transform:translateY(-1px);
      transition:opacity .15s ease, transform .15s ease;
    }

    .table-scroll thead th[data-sort="asc"] .sort-arrow {
      opacity:1;
      transform:translateY(-1px);
    }

    .table-scroll thead th[data-sort="desc"] .sort-arrow {
      opacity:1;
      transform:rotate(180deg) translateY(-1px);
    }

    tbody td {
      padding:13px 8px;
      border-bottom:1px solid var(--grid);
      background:var(--zebra);
      vertical-align:top;
      word-break:break-word;
      line-height:1.5;
    }

    tbody tr:last-child td {
      border-bottom:none;
    }

    tbody tr:nth-child(even) td {
      background:color-mix(in srgb,var(--grid) 12%,var(--zebra));
    }

    tbody tr.row-overdue td {
      background:color-mix(in srgb,#dc2626 16%,var(--zebra));
      color:color-mix(in srgb,#1f2937 15%,var(--ink));
    }

    tbody tr.is-active td {
      box-shadow:inset 0 0 0 2px color-mix(in srgb,var(--als-blue) 45%, transparent);
    }

    .table-scroll thead th[data-col="Last Inspection Date"],
    .table-scroll tbody td[data-col="Last Inspection Date"],
    .table-scroll thead th[data-col="Next Inspection Date"],
    .table-scroll tbody td[data-col="Next Inspection Date"] {
      width:112px;
    }

    .table-scroll thead th[data-col="Location"],
    .table-scroll tbody td[data-col="Location"] {
      width:200px;
    }

    .table-scroll thead th[data-col="Comments"],
    .table-scroll tbody td[data-col="Comments"] {
      width:360px;
    }

    .table-scroll tbody td[data-col="Asset"] {
      position:sticky;
      left:0;
      z-index:1;
      font-weight:700;
      background:var(--zebra);
      border-right:1px solid var(--grid);
    }

    tbody tr:nth-child(even) td[data-col="Asset"] {
      background:color-mix(in srgb,var(--grid) 12%,var(--zebra));
    }

    tbody tr.row-overdue td[data-col="Asset"] {
      background:color-mix(in srgb,#dc2626 16%,var(--zebra));
      color:color-mix(in srgb,#1f2937 15%,var(--ink));
    }

    tbody tr.is-active td[data-col="Asset"] {
      box-shadow:inset 0 0 0 2px color-mix(in srgb,var(--als-blue) 45%, transparent);
    }

    tbody td[data-col="Notes"] {
      max-width:420px;
    }

    tbody td[data-col] > span {
      display:block;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    tbody td[data-col="Notes"] > span,
    tbody td[data-col="Notes"] {
      white-space:normal;
      overflow:visible;
    }

    .countdown-chip {
      display:inline-flex;
      align-items:center;
      font-weight:800;
      font-size:12px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid currentColor;
      font-variant-numeric:tabular-nums;
    }

    .countdown-chip.is-unknown {
      color:var(--muted);
      border-style:dashed;
    }

    .countdown-chip.is-urgent {
      color:#b91c1c;
      background:color-mix(in srgb,#b91c1c 20%,transparent);
      box-shadow:0 0 0 1px color-mix(in srgb,#b91c1c 35%,transparent);
    }

    .countdown-chip.is-warning {
      color:#b45309;
      background:color-mix(in srgb,#b45309 18%,transparent);
    }

    .countdown-chip.is-healthy {
      color:#047857;
      background:color-mix(in srgb,#047857 18%,transparent);
    }

    .countdown-chip.is-excellent {
      color:#0f766e;
      background:color-mix(in srgb,#0f766e 18%,transparent);
    }

    .status-pill {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      background:var(--surface-strong);
      color:var(--ink);
      border:1px solid color-mix(in srgb,var(--grid) 70%,transparent);
      white-space:nowrap;
      min-width:0;
    }

    .status-pill.is-overdue { background:color-mix(in srgb,var(--risk-critical) 18%,var(--paper)); color:var(--risk-critical); border-color:color-mix(in srgb,var(--risk-critical) 60%,transparent); }
    .status-pill.is-due { background:color-mix(in srgb,var(--risk-warning) 16%,var(--paper)); color:var(--risk-warning); border-color:color-mix(in srgb,var(--risk-warning) 55%,transparent); }
    .status-pill.is-clear { background:color-mix(in srgb,var(--risk-ok) 18%,var(--paper)); color:var(--risk-ok); border-color:color-mix(in srgb,var(--risk-ok) 55%,transparent); }
    .status-pill.is-completed { background:color-mix(in srgb,var(--als-blue) 14%,var(--paper)); color:var(--als-blue); border-color:color-mix(in srgb,var(--als-blue) 60%,transparent); }
    .status-pill.is-in-progress { background:color-mix(in srgb,var(--als-blue) 10%,var(--paper)); color:color-mix(in srgb,var(--als-blue) 80%,var(--ink)); border-color:color-mix(in srgb,var(--als-blue) 40%,transparent); }
    .status-pill.is-scheduled { background:color-mix(in srgb,var(--muted) 12%,var(--paper)); color:color-mix(in srgb,var(--muted) 78%,var(--ink)); border-color:color-mix(in srgb,var(--muted) 45%,transparent); }
    .status-pill.is-unknown { background:color-mix(in srgb,var(--muted) 8%,var(--paper)); color:color-mix(in srgb,var(--muted) 65%,var(--ink)); border-color:color-mix(in srgb,var(--muted) 40%,transparent); }

    .empty-state {
      padding:20px;
      text-align:center;
      color:var(--muted);
    }

    .status-note {
      font-size:12px;
      color:var(--muted);
    }

    .table-scroll[data-loading="true"] tbody {
      opacity:.4;
    }

    .mobile-cards {
      display:none;
      margin-top:18px;
      padding-bottom:24px;
      width:100%;
    }

    body[data-table-mode="mobile"] .table-wrapper {
      display:none;
    }

    body[data-table-mode="mobile"] .mobile-cards {
      display:block;
    }

    body[data-table-mode="mobile"] .sticky-top__content {
      flex-direction:column;
      align-items:flex-start;
    }

    body[data-table-mode="mobile"] .sticky-controls {
      width:100%;
      flex-direction:column;
      align-items:stretch;
      gap:12px;
    }

    body[data-table-mode="mobile"] .sort-control {
      display:none;
    }

    body[data-table-mode="mobile"] .mobile-sort {
      display:grid;
      width:100%;
      gap:8px;
    }

    body[data-table-mode="mobile"] .mobile-sort label {
      font-weight:600;
    }

    body[data-table-mode="mobile"] .mobile-sort select,
    body[data-table-mode="mobile"] .mobile-sort__direction {
      width:100%;
    }

    body[data-table-mode="mobile"] .site-filter {
      width:100%;
      flex-direction:column;
      align-items:stretch;
      gap:10px;
    }

    body[data-table-mode="mobile"] .site-filter__tabs {
      width:100%;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:8px;
    }

    body[data-table-mode="mobile"] .site-filter__tab {
      width:100%;
      justify-content:center;
    }

    body.force-desktop .table-wrapper {
      display:block !important;
    }

    body.force-desktop .mobile-cards {
      display:none !important;
    }

    body.force-desktop .mobile-sort {
      display:none !important;
    }

    .mobile-card {
      border:1px solid var(--grid);
      border-radius:14px;
      padding:12px;
      background:var(--paper);
      display:grid;
      grid-template-columns:1fr auto;
      gap:8px 12px;
      width:100%;
    }

    .mobile-card + .mobile-card {
      margin-top:10px;
    }

    .mobile-card__header {
      grid-column:1/-1;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      width:100%;
    }

    .mobile-card__heading {
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      flex:1 1 auto;
    }

    .mobile-card__title {
      font-weight:800;
      font-size:13px;
      line-height:1.3;
      min-width:0;
    }

    .mobile-card__subtitle {
      font-size:11px;
      color:var(--muted);
      font-weight:600;
      line-height:1.2;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }

    .mobile-card__subtitle span + span::before {
      content:'•';
      margin:0 3px;
      color:color-mix(in srgb,var(--muted) 78%,var(--ink));
      font-weight:400;
    }

    .mobile-card__chip {
      align-self:flex-start;
      font-size:11px;
      padding-inline:8px;
      white-space:nowrap;
    }

    .mobile-card__details {
      grid-column:1/-1;
      margin:0;
      padding:0;
      display:flex;
      flex-wrap:wrap;
      gap:8px 12px;
      row-gap:6px;
      align-items:center;
    }

    .mobile-card__details dt,
    .mobile-card__details dd {
      margin:0;
      font-size:11px;
    }

    .mobile-card__detail-label {
      font-weight:600;
      letter-spacing:0;
      text-transform:none;
      color:var(--muted);
    }

    .mobile-card__detail-label::after {
      content:':';
      margin-left:4px;
      opacity:.65;
    }

    .mobile-card__detail-value {
      font-weight:700;
      color:var(--ink);
      text-align:left;
      word-break:break-word;
    }

    .mobile-card__detail-value--wide {
      flex:1 1 100%;
    }

    .mobile-card__note {
      grid-column:1/-1;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .mobile-card__note-label {
      font-size:11px;
      font-weight:600;
      letter-spacing:0;
      text-transform:none;
      color:var(--muted);
    }

    .mobile-card__note-text {
      margin:0;
      font-size:11px;
      line-height:1.4;
      color:color-mix(in srgb,var(--ink) 80%,var(--muted));
    }

    .mobile-card__actions {
      width:100%;
      display:flex;
      justify-content:flex-start;
      margin:0;
    }

    .mobile-card__action {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      font-weight:600;
      color:var(--als-blue);
      text-decoration:none;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid color-mix(in srgb,var(--als-blue) 60%,transparent);
      background:color-mix(in srgb,var(--als-blue) 10%,var(--paper));
      transition:background .18s ease,border-color .18s ease,color .18s ease;
    }

    .mobile-card__action:hover,
    .mobile-card__action:focus-visible {
      background:color-mix(in srgb,var(--als-blue) 18%,var(--paper));
      border-color:color-mix(in srgb,var(--als-blue) 75%,transparent);
      outline:none;
    }

    .mobile-card.row-overdue {
      border-color:color-mix(in srgb,#dc2626 45%,var(--grid));
    }

    .mobile-card--status {
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      color:var(--muted);
      font-weight:600;
      min-height:96px;
      gap:8px;
    }

    @media (min-width: 560px) {
      .mobile-card {
        padding:14px;
        gap:10px 14px;
      }
    }

    @media (max-width:540px) {
      .mobile-card {
        padding:11px;
        gap:8px 12px;
      }
    }

    @media (max-width:420px) {
      .mobile-card__details {
        column-gap:8px;
      }

      .mobile-card__detail-label {
        font-size:9px;
      }
    }

    @media (max-width:1170px) {
      .page {
        --page-pad-inline:24px;
      }
      table {
        min-width:var(--table-min-width, 720px);
      }
    }

    @media (max-width:1248px) {
      .page { --page-pad-top:16px; --page-pad-inline:clamp(16px,6vw,24px); --page-pad-bottom:40px; }
      .table-wrapper { display:none; }
      .mobile-cards { display:flex; flex-direction:column; align-items:center; gap:10px; padding-bottom:24px; }
      .sticky-top__content { flex-direction:column; align-items:flex-start; }
      .sticky-controls { width:100%; flex-direction:column; align-items:stretch; gap:12px; }
      .search-control,
      .category-filter { width:100%; }
      .search-control input,
      .category-filter select { width:100%; }
      .mobile-sort { display:grid; width:100%; gap:8px; }
      .mobile-sort label { font-weight:600; }
      .mobile-sort select { width:100%; }
      .mobile-sort__direction { width:100%; }
    }

    @media print {
      body::before { display:none; }
      .sticky-top { position:static; }
      .table-scroll { max-height:none; box-shadow:none; border-radius:0; }
      .mobile-cards { display:none !important; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-head">
      <div class="page-head__title">
        <h1 class="title">Inspections Tracker</h1>
        <nav class="nav" aria-label="Dashboard sections">
          <a class="tab" href="index.html">Work Orders</a>
          <a class="tab" href="facilities.html">Facilities</a>
          <a class="tab" href="pssr.html">PSSR Inspections</a>
          <a class="tab" aria-selected="true" href="inspections.html">Inspections Tracker</a>
        </nav>
      </div>
      <img src="LOGOlesswhitespace.png" alt="ALS Engineering" class="logo" />
    </header>
    <div class="top-rule" role="presentation"></div>
    <section class="pssr-overview">
      <div class="pssr-overview__summary">
        <div class="pssr-signal" data-role="inspections-signal" data-state="empty">
          <span class="pssr-signal__label">Current risk posture</span>
          <span class="pssr-signal__value" data-role="inspections-signal-value">—</span>
          <p class="pssr-signal__note" data-role="inspections-signal-note">Awaiting data</p>
        </div>
      </div>
      <div class="pssr-overview__insights">
        <section class="pssr-risk-panel" aria-label="Risk snapshot" data-role="inspections-risk">
          <h3 class="pssr-risk-panel__title">Risk snapshot</h3>
          <p class="pssr-risk-panel__message" data-role="inspections-risk-message">Awaiting inspection data.</p>
          <div class="pssr-risk-bar">
            <div class="pssr-risk-bar__track" data-role="inspections-risk-track">
              <span class="pssr-risk-bar__segment is-alert" data-role="inspections-risk-overdue" style="left:0;width:0%;"></span>
              <span class="pssr-risk-bar__segment is-warning" data-role="inspections-risk-due" style="left:0;width:0%;"></span>
              <span class="pssr-risk-bar__segment is-ok" data-role="inspections-risk-clear" style="left:0;width:0%;"></span>
            </div>
            <div class="pssr-risk-bar__legend">
              <span class="pssr-risk-bar__legend-item is-alert"><span class="pssr-risk-bar__dot" aria-hidden="true"></span><span data-role="inspections-risk-label-overdue">0 overdue</span></span>
              <span class="pssr-risk-bar__legend-item is-warning"><span class="pssr-risk-bar__dot" aria-hidden="true"></span><span data-role="inspections-risk-label-due">0 due soon</span></span>
              <span class="pssr-risk-bar__legend-item is-ok"><span class="pssr-risk-bar__dot" aria-hidden="true"></span><span data-role="inspections-risk-label-clear">0 on track</span></span>
            </div>
          </div>
        </section>
      </div>
      <section class="pssr-site-panel" aria-label="Site health overview">
        <h3 class="pssr-site-panel__title">Site health</h3>
        <p class="pssr-site-panel__hint" data-role="inspections-site-hint">Awaiting inspection data.</p>
        <ul class="pssr-site-breakdown" data-role="inspections-site-breakdown">
          <li class="pssr-site-breakdown__item is-empty">Awaiting inspection data.</li>
        </ul>
      </section>
    </section>
    <section class="sticky-top" data-component="sticky-controls">
      <div class="sticky-top__content">
        <div class="sticky-controls controls-bar">
          <button type="button" class="refresh-btn btn btn--outline" data-action="refresh">Refresh data</button>
          <button class="ctrl-pill switch-wrap" id="layout-toggle" type="button" role="switch" aria-checked="false" aria-label="Switch to mobile view">
            <span class="switch" aria-hidden="true"><span class="switch__thumb"></span></span>
            <span class="switch-label">Auto</span>
          </button>
          <button class="ctrl-pill switch-wrap" id="dark-toggle" type="button" role="switch" aria-checked="false" aria-label="Toggle dark theme">
            <span class="switch" aria-hidden="true"><span class="switch__thumb"></span></span>
            <span class="switch-label">Dark</span>
          </button>
          <div class="site-filter" data-role="site-filter">
            <span class="site-filter__label">Site: <span data-role="site-filter-active">All sites</span></span>
            <div class="site-filter__tabs" role="group" aria-label="Filter inspections by site" data-role="site-nav">
              <button type="button" class="site-filter__tab" data-site-key="all" aria-pressed="true">All sites</button>
              <button type="button" class="site-filter__tab" data-site-key="byron" aria-pressed="false">Byron</button>
              <button type="button" class="site-filter__tab" data-site-key="keith" aria-pressed="false">Keith</button>
              <button type="button" class="site-filter__tab" data-site-key="east-kilbride" aria-pressed="false">East Kilbride</button>
              <button type="button" class="site-filter__tab" data-site-key="mugiemoss" aria-pressed="false">Mugiemoss</button>
            </div>
          </div>
          <div class="category-filter" data-role="category-filter">
            <label for="category-select">Category</label>
            <select id="category-select" data-role="category-select" aria-label="Filter inspections by category">
              <option value="all">All categories</option>
            </select>
          </div>
          <div class="search-control" data-role="search-control">
            <label for="inspection-search">Search</label>
            <input type="search" id="inspection-search" placeholder="Search inspections" data-role="search-input" autocomplete="off" />
          </div>
          <div class="sort-control" data-role="sort-control">
            <label class="sort-control__label" for="desktop-sort-select">Sort by</label>
            <div class="sort-control__inputs">
              <select id="desktop-sort-select" data-role="sort-select" aria-label="Select column to sort">
                <option value="Next Due" selected>Next Due</option>
                <option value="Asset">Asset</option>
                <option value="Site">Site</option>
                <option value="Category">Category</option>
                <option value="Last Completed">Last Completed</option>
                <option value="Status">Status</option>
                <option value="WO/Link">WO/Link</option>
                <option value="Notes">Notes</option>
              </select>
              <button type="button" class="sort-control__direction btn btn--ghost btn--sm" data-role="sort-direction" data-direction="asc" aria-label="Toggle sort direction (currently ascending)">Ascending</button>
            </div>
          </div>
          <div class="mobile-sort" data-role="mobile-sort">
            <label for="mobile-sort-select">Sort by</label>
            <select id="mobile-sort-select" data-role="mobile-sort-select" aria-label="Select column to sort">
              <option value="Next Due" selected>Next Due</option>
              <option value="Asset">Asset</option>
              <option value="Site">Site</option>
              <option value="Category">Category</option>
              <option value="Last Completed">Last Completed</option>
              <option value="Status">Status</option>
              <option value="WO/Link">WO/Link</option>
              <option value="Notes">Notes</option>
            </select>
            <button type="button" class="mobile-sort__direction btn btn--outline btn--sm" data-role="mobile-sort-direction" data-direction="asc" aria-label="Toggle sort direction (currently ascending)">Ascending</button>
          </div>
        </div>
      </div>
    </section>
    <div id="banner" class="banner ok" hidden>
      <span data-msg>Ready</span><span data-detail></span>
    </div>
    <div class="pssr-content">
      <section class="table-wrapper" data-component="inspections-table">
        <div class="table-scroll" data-role="scroll-region" data-loading="true">
          <table aria-describedby="inspections-table-caption">
            <caption id="inspections-table-caption" class="visually-hidden">Inspections schedule</caption>
            <thead>
              <tr>
                <th scope="col" data-col="Site" aria-sort="none">Site <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Asset" aria-sort="none">Asset <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Category" aria-sort="none">Category <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Last Completed" aria-sort="none">Last Completed <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Next Due" aria-sort="none">Next Due <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Status" aria-sort="none">Status <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="WO/Link" aria-sort="none">WO/Link <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Notes" aria-sort="none">Notes <span class="sort-arrow" aria-hidden="true"></span></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="8" class="empty-state">Loading inspection data…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
      <section class="document-viewer" id="viewer" aria-label="Inspection document preview" data-viewer-collapsed="true" hidden>
        <div class="document-viewer__controls">
          <h3 class="document-viewer__title">Inspection document preview</h3>
          <button type="button" class="document-viewer__toggle" data-role="viewer-toggle" aria-expanded="false" aria-controls="viewer-body" aria-label="Expand inspection document preview">Expand preview</button>
        </div>
        <div class="document-viewer__body" id="viewer-body" data-role="viewer-content" hidden>
          <div class="placeholder">Select an inspection to preview documentation.</div>
        </div>
      </section>
    </div>
    <section class="mobile-cards" data-role="mobile-cards" aria-live="polite" role="list"></section>
  </div>

  <script>
    // ===== Config =====
    const INSPECTIONS_SHEET_NAME = 'Inspections';
    const DEFAULT_INSPECTIONS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQhXb-392ExhOiESN5E6IqM5ScrrB4oFpPcLhf8yis6_ZhFqjanoHomQJcqL-feiPi-t-sygaGb85at/pub?gid=1634430248&output=csv';
    const DUE_SOON_DAYS = 30;
    const DUE_SOON_THRESHOLD_DAYS = DUE_SOON_DAYS;

    // Toggle via query params.
    // Defaults: offline in file/sandbox; online in http(s).
    const PARAMS = new URLSearchParams(location.search);
    const FORCE_ONLINE = PARAMS.get('online') === '1';
    const FORCE_OFFLINE = PARAMS.get('offline') === '1';
    const DEFAULT_OFFLINE = location.protocol === 'file:' || location.hostname === '';
    const ALLOW_NETWORK = FORCE_ONLINE ? true : (FORCE_OFFLINE ? false : !DEFAULT_OFFLINE);
    const DEFAULT_ERROR_MESSAGE = 'We were unable to load the inspection sheet. Please check the network or sheet permissions and try again.';

    const themeBtn = document.getElementById('dark-toggle');
    const themeBtnLabel = themeBtn?.querySelector('.switch-label') || themeBtn?.querySelector('.label');
    const layoutToggleBtn = document.getElementById('layout-toggle');
    const LAYOUT_MODE_STORAGE_KEY = 'alsLayoutMode';

    function currentForcedLayout(){
      if(document.body.classList.contains('force-mobile')) return 'mobile';
      if(document.body.classList.contains('force-desktop')) return 'desktop';
      return 'auto';
    }

    function syncLayoutToggle(){
      if(!layoutToggleBtn) return;
      const mode = currentForcedLayout();
      const labelEl = layoutToggleBtn.querySelector('.switch-label') || layoutToggleBtn.querySelector('.label');
      if(labelEl){
        if(mode === 'mobile') labelEl.textContent = 'Mobile view';
        else if(mode === 'desktop') labelEl.textContent = 'Desktop view';
        else {
          const autoMobile = document.body.getAttribute('data-table-mode') === 'mobile';
          labelEl.textContent = autoMobile ? 'Auto · Mobile' : 'Auto · Desktop';
        }
      }
      const nextAction = mode === 'mobile'
        ? 'Switch to desktop view'
        : mode === 'desktop'
          ? 'Return to automatic view'
          : 'Switch to mobile view';
      layoutToggleBtn.setAttribute('aria-checked', mode === 'mobile' ? 'true' : 'false');
      layoutToggleBtn.setAttribute('aria-label', nextAction);
      layoutToggleBtn.title = nextAction;
    }

    function getLayoutContainer(){
      return document.querySelector('[data-component="inspections-table"]');
    }

    function applyLayoutMode(mode,{ persist=true, container } = {}){
      const desired = mode === 'mobile' ? 'mobile' : mode === 'desktop' ? 'desktop' : 'auto';
      const target = container || getLayoutContainer();

      if(desired === 'mobile'){
        document.body.classList.add('force-mobile');
        document.body.classList.remove('force-desktop');
        document.body.setAttribute('data-table-mode','mobile');
        if(persist) localStorage.setItem(LAYOUT_MODE_STORAGE_KEY,'mobile');
      }else if(desired === 'desktop'){
        document.body.classList.add('force-desktop');
        document.body.classList.remove('force-mobile');
        document.body.removeAttribute('data-table-mode');
        if(persist) localStorage.setItem(LAYOUT_MODE_STORAGE_KEY,'desktop');
      }else{
        document.body.classList.remove('force-mobile','force-desktop');
        document.body.removeAttribute('data-table-mode');
        if(persist) localStorage.removeItem(LAYOUT_MODE_STORAGE_KEY);
      }

      if(target){
        if(desired === 'auto'){
          updateResponsiveMode(target);
        }
        if(target.__rows){
          refreshView(target);
        }else{
          updateResponsiveMode(target);
        }
      }else if(desired !== 'mobile'){
        updateResponsiveMode(null);
      }

      updateStickyOffsets();
      syncLayoutToggle();
    }

    function cycleLayoutMode(){
      const mode = currentForcedLayout();
      const next = mode === 'mobile' ? 'desktop' : mode === 'desktop' ? 'auto' : 'mobile';
      applyLayoutMode(next, { container: getLayoutContainer() });
    }

    function restoreStoredLayoutMode(container){
      const stored = localStorage.getItem(LAYOUT_MODE_STORAGE_KEY);
      if(stored === 'mobile' || stored === 'desktop'){
        applyLayoutMode(stored, { persist:false, container });
      }else{
        syncLayoutToggle();
      }
    }

    layoutToggleBtn?.addEventListener('click', cycleLayoutMode);
    const metaColorScheme = document.querySelector('meta[name="color-scheme"]');
    const THEME_STORAGE_KEY = 'theme';

    function setThemeButtonLabel(text){
      if(!themeBtn) return;
      if(themeBtnLabel){
        themeBtnLabel.textContent = text;
      }else{
        themeBtn.textContent = text;
      }
    }

    function applyTheme(theme){
      const normalized = theme === 'dark' ? 'dark' : 'light';
      const isDark = normalized === 'dark';
      document.body.classList.toggle('dark', isDark);
      document.body.classList.toggle('light', !isDark);
      document.body.classList.toggle('theme-dark', isDark);
      document.documentElement.setAttribute('color-scheme', normalized);
      metaColorScheme?.setAttribute('content', normalized);
      setThemeButtonLabel(isDark ? 'Light' : 'Dark');
      const label = isDark ? 'Switch to light mode' : 'Switch to dark mode';
      themeBtn?.setAttribute('aria-checked', isDark ? 'true' : 'false');
      themeBtn?.setAttribute('aria-label', label);
      themeBtn?.setAttribute('title', label);
    }

    const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    let hasStoredTheme = storedTheme === 'dark' || storedTheme === 'light';
    let activeTheme = hasStoredTheme ? storedTheme : (prefersDark ? 'dark' : 'light');
    applyTheme(activeTheme);

    const colorSchemeQuery = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
    if(colorSchemeQuery && typeof colorSchemeQuery.addEventListener === 'function'){
      colorSchemeQuery.addEventListener('change', (event) => {
        if(hasStoredTheme) return;
        activeTheme = event.matches ? 'dark' : 'light';
        applyTheme(activeTheme);
      });
    }else if(colorSchemeQuery && typeof colorSchemeQuery.addListener === 'function'){
      colorSchemeQuery.addListener((event) => {
        if(hasStoredTheme) return;
        activeTheme = event.matches ? 'dark' : 'light';
        applyTheme(activeTheme);
      });
    }

    themeBtn?.addEventListener('click', () => {
      activeTheme = document.body.classList.contains('theme-dark') ? 'light' : 'dark';
      applyTheme(activeTheme);
      localStorage.setItem(THEME_STORAGE_KEY, activeTheme);
      hasStoredTheme = true;
    });

    function sanitizeSheetUrl(v){
      if(!v) return null;
      const t = String(v).trim();
      if(!t) return null;
      const c = t.startsWith('//') ? `https:${t}` : t;
      try {
        const u = new URL(c, location.href);
        if(u.protocol === 'http:') u.protocol = 'https:';
        return u.protocol === 'https:' ? u.toString() : null;
      } catch { return null; }
    }

    function ensureSheetName(url, sheetName){
      if(!url || !sheetName) return url;
      try {
        const resolved = new URL(url, location.href);
        if(!resolved.searchParams.has('gid')){
          resolved.searchParams.set('sheet', sheetName);
        }
        return resolved.toString();
      } catch {
        return url;
      }
    }

    function getSheetUrl(){
      const p = new URLSearchParams(location.search);
      const raw = p.get('sheetUrl') || p.get('sheet') || document.body?.dataset?.sheetUrl || DEFAULT_INSPECTIONS_SHEET_URL;
      const sanitized = sanitizeSheetUrl(raw);
      return sanitized ? ensureSheetName(sanitized, INSPECTIONS_SHEET_NAME) : sanitized;
    }

    function normalizeGoogleDocumentUrl(url){
      if(!url) return '';
      const host = (url.hostname || '').toLowerCase();
      const path = (url.pathname || '').replace(/\/+$/, '');
      const encodeId = (id) => encodeURIComponent(id || '');

      if(host === 'drive.google.com'){
        const folderMatch = path.match(/^\/drive\/folders\/([^/]+)/i);
        if(folderMatch){
          const id = encodeId(folderMatch[1]);
          return new URL(`https://drive.google.com/embeddedfolderview?id=${id}#grid`);
        }
        const fileMatch = path.match(/^\/file\/d\/([^/]+)/i);
        if(fileMatch){
          const id = encodeId(fileMatch[1]);
          return new URL(`https://drive.google.com/file/d/${id}/preview`);
        }
        const genericId = url.searchParams?.get('id');
        if(genericId){
          const id = encodeId(genericId);
          return new URL(`https://drive.google.com/file/d/${id}/preview`);
        }
      }

      if(host === 'docs.google.com'){
        const docMatch = path.match(/^\/(document|spreadsheets|presentation|forms)\/d\/([^/]+)/i);
        if(docMatch){
          const type = docMatch[1].toLowerCase();
          const id = encodeId(docMatch[2]);
          if(type === 'forms'){
            return new URL(`https://docs.google.com/forms/d/${id}/viewform?embedded=true`);
          }
          return new URL(`https://docs.google.com/${type}/d/${id}/preview`);
        }
      }

      return url;
    }

    function normalizeDocumentUrl(raw){
      if(!raw) return '';
      const value = String(raw).trim();
      if(!value) return '';
      if(value.startsWith('data:') || value.startsWith('about:')){
        return value;
      }
      try {
        const url = new URL(value, location.href);
        if(url.protocol === 'http:'){
          url.protocol = 'https:';
        }
        if(url.protocol !== 'https:'){
          return '';
        }
        const normalized = normalizeGoogleDocumentUrl(url);
        return normalized ? normalized.toString() : '';
      } catch {
        return '';
      }
    }

    function normalizeExternalUrl(raw){
      if(!raw) return '';
      const value = String(raw).trim();
      if(!value) return '';
      if(value.startsWith('mailto:')) return value;
      try {
        const url = new URL(value, location.href);
        if(url.protocol === 'http:'){
          url.protocol = 'https:';
        }
        if(url.protocol !== 'https:') return '';
        return url.toString();
      } catch {
        return '';
      }
    }

    function resolveSiteLabel(siteKey){
      if(!siteKey) return SITE_LABELS.all;
      const normalized = String(siteKey).trim().toLowerCase();
      if(!normalized) return SITE_LABELS.all;
      if(Object.prototype.hasOwnProperty.call(SITE_LABELS, normalized)){
        return SITE_LABELS[normalized];
      }
      return normalized.split(/[\s_-]+/).map(part => part ? (part[0].toUpperCase() + part.slice(1)) : '').join(' ').trim() || SITE_LABELS.all;
    }

    function resolveCategoryLabel(categoryKey){
      const normalized = normalizeCategoryKey(categoryKey);
      if(!normalized || normalized === 'all') return 'All categories';
      const select = document.querySelector('[data-role="category-select"]');
      if(select){
        const option = Array.from(select.options || []).find(opt => normalizeCategoryKey(opt.value) === normalized);
        if(option){
          const text = option.textContent?.trim();
          if(text) return text.replace(/\s+\(\d+\)$/, '');
        }
      }
      if(normalized === 'uncategorised') return 'Uncategorised';
      return normalized.split('-').map(part => part ? (part[0].toUpperCase() + part.slice(1)) : '').join(' ').trim() || 'All categories';
    }

    function resolveRiskLabel(riskKey){
      const normalized = normalizeRiskKey(riskKey);
      if(!normalized || normalized === 'all') return RISK_LABELS.all;
      if(Object.prototype.hasOwnProperty.call(RISK_LABELS, normalized)){
        return RISK_LABELS[normalized];
      }
      return normalized.split(/[\s_-]+/).map(part => part ? (part[0].toUpperCase() + part.slice(1)) : '').join(' ').trim() || RISK_LABELS.all;
    }

    const SAMPLE = [
      { Site:'Byron', Asset:'Compressed Air Receiver', Category:'Pressure Systems', 'Last Completed':'12/02/2024', 'Next Due':'12/08/2024', Status:'Due soon', 'WO/Link':'WO-48219', Notes:'Requalification scheduled alongside dryer swap.', 'Document URL':'about:blank' },
      { Site:'Keith', Asset:'Steam Boiler 2', Category:'Steam Plant', 'Last Completed':'18/09/2023', 'Next Due':'18/03/2024', 'WO/Link':'https://example.com/workorders/123', Notes:'Coordinate statutory inspection with burner maintenance.' },
      { Site:'Mugiemoss', Asset:'Tunnel Washer 2', Category:'Process Equipment', 'Last Completed':'20/11/2023', 'Next Due':'20/11/2025', Status:'On track', Notes:'Inspection aligned with OEM service interval.' },
      { Site:'East Kilbride', Asset:'Calorifier 4', Category:'Water Systems', 'Last Completed':'22/08/2023', 'Next Due':'22/02/2024', Notes:'Monitor expansion vessel replacement before inspection.', 'Document URL':'about:blank' },
      { Site:'Keith', Asset:'Air Receiver A', Category:'Pressure Systems', 'Last Completed':'02/06/2023', 'Next Due':'02/12/2023', Notes:'Receiver drained and ready for recertification.', Status:'' }
    ];

    const RESOLVED_INSPECTIONS_SHEET_URL = getSheetUrl();
    if(RESOLVED_INSPECTIONS_SHEET_URL){
      window.__INSPECTIONS_SHEET_URL = RESOLVED_INSPECTIONS_SHEET_URL;
    }else{
      console.warn('Inspections sheet URL could not be resolved. Update DEFAULT_INSPECTIONS_SHEET_URL or supply ?sheetUrl=.');
    }

    function banner(type, msg, detail=''){
      const el = document.querySelector('#banner');
      if(!el) return;
      el.className = 'banner ' + (type || '');
      el.hidden = false;
      const msgNode = el.querySelector('[data-msg]');
      const detailNode = el.querySelector('[data-detail]');
      if(msgNode) msgNode.textContent = msg;
      if(detailNode) detailNode.textContent = detail ? ' – ' + detail : '';
    }

    function hideBanner(){
      const el = document.querySelector('#banner');
      if(!el) return;
      el.hidden = true;
      el.className = 'banner';
      const msgNode = el.querySelector('[data-msg]');
      const detailNode = el.querySelector('[data-detail]');
      if(msgNode) msgNode.textContent = '';
      if(detailNode) detailNode.textContent = '';
    }

    function getViewerElements(){
      const viewer = document.querySelector('#viewer');
      if(!viewer) return { viewer:null, body:null, toggle:null };
      const body = viewer.querySelector('[data-role="viewer-content"]') || viewer;
      const toggle = viewer.querySelector('[data-role="viewer-toggle"]');
      return { viewer, body, toggle };
    }

    function setViewerCollapsed(collapsed, { respectPreference = true } = {}){
      const { viewer, body, toggle } = getViewerElements();
      if(!viewer || !body) return;
      let next = !!collapsed;
      if(respectPreference){
        const pref = viewer.dataset.viewerCollapsedPreference;
        if(pref === 'true') next = true;
        if(pref === 'false') next = false;
      }
      viewer.dataset.viewerCollapsed = next ? 'true' : 'false';
      if(toggle){
        const expanded = next ? 'false' : 'true';
        toggle.setAttribute('aria-expanded', expanded);
        toggle.setAttribute('aria-label', next ? 'Expand inspection document preview' : 'Collapse inspection document preview');
        toggle.textContent = next ? 'Expand preview' : 'Collapse preview';
      }
      body.hidden = next;
    }

    function initViewerToggle(){
      const { viewer, toggle } = getViewerElements();
      if(!viewer || !toggle) return;
      if(!viewer.dataset.viewerCollapsedPreference){
        viewer.dataset.viewerCollapsedPreference = 'true';
      }
      toggle.addEventListener('click', () => {
        const current = viewer.dataset.viewerCollapsed === 'true';
        const next = !current;
        viewer.dataset.viewerCollapsedPreference = next ? 'true' : 'false';
        setViewerCollapsed(next, { respectPreference:false });
      });
    }

    function setViewerPlaceholder(message, { reveal = false } = {}){
      const { viewer, body } = getViewerElements();
      if(!viewer || !body) return;
      body.innerHTML = '';
      const div = document.createElement('div');
      div.className = 'placeholder';
      div.textContent = message;
      body.appendChild(div);
      if(reveal){
        viewer.hidden = false;
        viewer.dataset.viewerState = 'visible';
        setViewerCollapsed(false);
      }else{
        viewer.dataset.viewerState = 'hidden';
        viewer.hidden = true;
      }
    }

    const TABLE_WIDTH_TOLERANCE = 1;
    const MOBILE_BREAKPOINT = 1248;
    const SITE_LABELS = {
      all:'All sites',
      byron:'Byron',
      keith:'Keith',
      'east-kilbride':'East Kilbride',
      mugiemoss:'Mugiemoss'
    };
    const FALLBACK_SITE_LABEL = 'Unassigned site';
    const KNOWN_SITE_KEYS = Object.keys(SITE_LABELS).filter(key => key !== 'all');
    const RISK_LABELS = {
      all:'All statuses',
      overdue:'Overdue',
      due:'Due soon',
      clear:'On track'
    };
    const RISK_KEY_ALIASES = {
      all:'all',
      total:'all',
      overdue:'overdue',
      'past-due':'overdue',
      'past due':'overdue',
      due:'due',
      'due-soon':'due',
      'due soon':'due',
      soon:'due',
      clear:'clear',
      'on-track':'clear',
      'on track':'clear',
      'ontrack':'clear'
    };
    const STATUS_KEY_ALIASES = {
      overdue:'overdue',
      'past due':'overdue',
      'past-due':'overdue',
      late:'overdue',
      'overdue!':'overdue',
      due:'due',
      'due soon':'due',
      'due-soon':'due',
      upcoming:'due',
      pending:'scheduled',
      scheduled:'scheduled',
      planning:'scheduled',
      planned:'scheduled',
      'not started':'scheduled',
      'not-started':'scheduled',
      open:'in-progress',
      'in progress':'in-progress',
      'in-progress':'in-progress',
      active:'in-progress',
      clear:'clear',
      'on track':'clear',
      'on-track':'clear',
      ok:'clear',
      complete:'completed',
      completed:'completed',
      done:'completed',
      closed:'completed',
      finished:'completed'
    };
    const STATUS_DISPLAY_LABELS = {
      overdue:'Overdue',
      due:'Due soon',
      clear:'On track',
      completed:'Completed',
      'in-progress':'In progress',
      scheduled:'Scheduled',
      unknown:'Not set'
    };
    const STATUS_CLASS_MAP = {
      overdue:'is-overdue',
      due:'is-due',
      clear:'is-clear',
      completed:'is-completed',
      'in-progress':'is-in-progress',
      scheduled:'is-scheduled',
      unknown:'is-unknown'
    };
    let __tableMinWidthCache = null;

    async function safeFetch(url, {timeout=7000, retries=2} = {}){
      if(!ALLOW_NETWORK) throw new Error('Network disabled in this environment');
      let lastErr;
      for(let attempt=0; attempt<=retries; attempt++){
        const ctrl = new AbortController();
        const t = setTimeout(()=>ctrl.abort(), timeout);
        try {
          const res = await fetch(url, { cache:'no-store', signal:ctrl.signal });
          clearTimeout(t);
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.text();
        } catch (err) {
          lastErr = err;
          clearTimeout(t);
          if(attempt === retries) throw err;
          await new Promise(r => setTimeout(r, 400 * (attempt+1)));
        }
      }
      throw lastErr || new Error('Fetch failed');
    }

    function getTableMinWidth(){
      if (__tableMinWidthCache != null) return __tableMinWidthCache;
      const raw = getComputedStyle(document.documentElement).getPropertyValue('--table-min-width');
      const parsed = parseFloat(raw);
      __tableMinWidthCache = Number.isFinite(parsed) ? parsed : 720;
      return __tableMinWidthCache;
    }

    function pageAvailableWidth(){
      const page = document.querySelector('.page');
      return (page?.clientWidth || document.documentElement.clientWidth || window.innerWidth || 0);
    }

    function needsMobileLayout(container){
      if(document.body.classList.contains('force-mobile')) return true;
      if(document.body.classList.contains('force-desktop')) return false;
      if (window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT}px)`).matches) return true;

      const minWidth = getTableMinWidth();
      const wrap = container?.__scrollRegion;

      if (wrap && !wrap.hidden && wrap.offsetParent !== null){
        const available = wrap.clientWidth;
        if (available > 0){
          const table = wrap.querySelector('table');
          const required = table ? (table.scrollWidth || table.offsetWidth || minWidth) : minWidth;
          const delta = required - available;
          if (delta > TABLE_WIDTH_TOLERANCE) return true;
          if (delta < -TABLE_WIDTH_TOLERANCE) return false;
        }
      }

      return pageAvailableWidth() + TABLE_WIDTH_TOLERANCE < minWidth;
    }

    function updateResponsiveMode(container){
      if(document.body.classList.contains('force-mobile')){
        document.body.setAttribute('data-table-mode','mobile');
        syncLayoutToggle();
        return;
      }

      if(document.body.classList.contains('force-desktop')){
        document.body.removeAttribute('data-table-mode');
        syncLayoutToggle();
        return;
      }

      if (!container){
        document.body.removeAttribute('data-table-mode');
        syncLayoutToggle();
        return;
      }

      if (needsMobileLayout(container)){
        document.body.setAttribute('data-table-mode','mobile');
      } else {
        document.body.removeAttribute('data-table-mode');
      }
      syncLayoutToggle();
    }

    function esc(str){
      return String(str ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function parseDateLoose(value){
      if(value instanceof Date && !isNaN(value)) return value;
      if(typeof value === 'number'){ const d = new Date(value); return isNaN(d) ? null : d; }
      if(!value) return null;
      const str = String(value).trim();
      if(!str) return null;
      const ddmmyyyy = str.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/);
      if(ddmmyyyy){
        let [,d,m,y,h='00',min='00'] = ddmmyyyy;
        if(y.length === 2){ y = `20${y}`; }
        const iso = `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}T${h.padStart(2,'0')}:${min.padStart(2,'0')}:00`;
        const parsed = new Date(iso);
        return isNaN(parsed) ? null : parsed;
      }
      const parsed = new Date(str);
      return isNaN(parsed) ? null : parsed;
    }

    function formatDisplayDate(date, fallback='—'){
      if(!(date instanceof Date) || isNaN(date)) return fallback;
      try {
        return DATE_DISPLAY_FORMATTER.format(date);
      } catch {
        const d = date.getDate().toString().padStart(2,'0');
        const m = (date.getMonth()+1).toString().padStart(2,'0');
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
      }
    }

    function detectType(column, rows){
      if(!column || !rows.length) return 'string';
      const sample = rows.slice(0, 10).map(r => r[column]);
      const allDates = sample.length && sample.every(v => !!parseDateLoose(v));
      if(allDates) return 'date';
      const allNumbers = sample.length && sample.every(v => v === '' || v == null || /^\s*[-+]?\d+(\.\d+)?\s*$/.test(String(v)));
      if(allNumbers) return 'number';
      return 'string';
    }

    const stringCollator = new Intl.Collator(undefined, { sensitivity:'base', numeric:false });
    const DATE_DISPLAY_FORMATTER = new Intl.DateTimeFormat('en-GB', { day:'2-digit', month:'short', year:'numeric' });

    function applySort(rows, column, direction){
      const list = Array.isArray(rows) ? rows.slice() : [];
      if(!column) return list;
      const dir = direction === 'asc' ? 'asc' : 'desc';
      const factor = dir === 'asc' ? 1 : -1;

      if(column === 'Next Due'){
        const fallback = dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;
        return list.sort((a,b) => {
          const aTime = (a.__nextDate instanceof Date && !Number.isNaN(a.__nextDate.getTime())) ? a.__nextDate.getTime() : fallback;
          const bTime = (b.__nextDate instanceof Date && !Number.isNaN(b.__nextDate.getTime())) ? b.__nextDate.getTime() : fallback;
          return factor * (aTime - bTime);
        });
      }

      if(column === 'Last Completed'){
        const fallback = dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;
        return list.sort((a,b) => {
          const aTime = (a.__lastDate instanceof Date && !Number.isNaN(a.__lastDate.getTime())) ? a.__lastDate.getTime() : fallback;
          const bTime = (b.__lastDate instanceof Date && !Number.isNaN(b.__lastDate.getTime())) ? b.__lastDate.getTime() : fallback;
          return factor * (aTime - bTime);
        });
      }

      if(column === 'Status'){
        const order = ['overdue','due','clear','completed','in-progress','scheduled','unknown'];
        return list.sort((a,b) => {
          const aKey = a.__statusKey || 'unknown';
          const bKey = b.__statusKey || 'unknown';
          const aIndex = order.indexOf(aKey);
          const bIndex = order.indexOf(bKey);
          const normalizedA = aIndex >= 0 ? aIndex : order.length;
          const normalizedB = bIndex >= 0 ? bIndex : order.length;
          if(normalizedA === normalizedB){
            return factor * stringCollator.compare(String(a.Status ?? ''), String(b.Status ?? ''));
          }
          return factor * (normalizedA - normalizedB);
        });
      }

      const type = detectType(column, list);
      return list.sort((a,b) => {
        const va = a[column];
        const vb = b[column];
        if(type === 'date'){
          const da = parseDateLoose(va);
          const db = parseDateLoose(vb);
          return factor * (((da ? da.getTime() : 0) - (db ? db.getTime() : 0)));
        }
        if(type === 'number'){
          return factor * (((parseFloat(va) || 0) - (parseFloat(vb) || 0)));
        }
        const normalizedA = String(va ?? '').trim();
        const normalizedB = String(vb ?? '').trim();
        return factor * stringCollator.compare(normalizedA, normalizedB);
      });
    }

    function sortRows(rows, column, direction){
      return applySort(Array.isArray(rows) ? rows.slice() : [], column, direction);
    }

    const SITE_SEPARATOR_PATTERN = /[\s/_\u2010-\u2015-]+/g;

    function normalizeSiteBase(value){
      if(!value) return '';
      return String(value).toLowerCase().replace(/[\u2010-\u2015]/g, '-').trim();
    }

    function createSiteVariants(value){
      const base = normalizeSiteBase(value);
      if(!base){
        return { base:'', hyphenated:'', collapsed:'' };
      }
      const hyphenated = base
        .replace(SITE_SEPARATOR_PATTERN, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '');
      const collapsed = base.replace(SITE_SEPARATOR_PATTERN, '');
      return { base, hyphenated, collapsed };
    }

    function normalizeSiteKey(value){
      const normalized = String(value ?? '').trim().toLowerCase();
      return normalized || 'all';
    }

    function normalizeCategoryKey(value){
      const normalized = String(value ?? '').trim().toLowerCase();
      const cleaned = normalized.replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
      return cleaned || 'uncategorised';
    }

    function normalizeRiskKey(value){
      const normalized = String(value ?? '').trim().toLowerCase();
      if(!normalized) return 'all';
      if(Object.prototype.hasOwnProperty.call(RISK_KEY_ALIASES, normalized)){
        return RISK_KEY_ALIASES[normalized];
      }
      return normalized;
    }

    function normalizeStatusKey(value){
      const normalized = String(value ?? '').trim().toLowerCase();
      if(!normalized) return '';
      if(Object.prototype.hasOwnProperty.call(STATUS_KEY_ALIASES, normalized)){
        return STATUS_KEY_ALIASES[normalized];
      }
      return normalized.replace(/\s+/g, '-');
    }

    function deriveStatusKey(statusValue, diffDays){
      const normalized = normalizeStatusKey(statusValue);
      const fallback = () => {
        if(typeof diffDays === 'number'){
          if(diffDays < 0) return 'overdue';
          if(diffDays <= DUE_SOON_DAYS) return 'due';
          return 'clear';
        }
        return 'unknown';
      };
      if(!normalized || normalized === 'unknown' || normalized === 'n/a' || normalized === 'na'){
        return fallback();
      }
      if(normalized === 'overdue' || normalized === 'due' || normalized === 'clear' || normalized === 'completed'){
        return normalized;
      }
      if(normalized === 'scheduled' || normalized === 'planned' || normalized === 'planning' || normalized === 'pending' || normalized === 'not-started'){
        const derived = fallback();
        return derived === 'unknown' ? 'scheduled' : derived;
      }
      if(normalized === 'in-progress' || normalized === 'open' || normalized === 'active'){
        const derived = fallback();
        return derived === 'unknown' ? 'in-progress' : derived;
      }
      if(normalized === 'done' || normalized === 'closed' || normalized === 'finished'){
        return 'completed';
      }
      return fallback();
    }

    function statusToRiskKey(statusKey, diffDays){
      const key = statusKey || 'unknown';
      if(key === 'overdue') return 'overdue';
      if(key === 'due') return 'due';
      if(typeof diffDays === 'number'){
        if(diffDays < 0) return 'overdue';
        if(diffDays <= DUE_SOON_DAYS) return 'due';
      }
      if(key === 'clear' || key === 'completed') return 'clear';
      if(key === 'scheduled' || key === 'in-progress'){
        if(typeof diffDays === 'number'){
          if(diffDays < 0) return 'overdue';
          if(diffDays <= DUE_SOON_DAYS) return 'due';
        }
        return 'clear';
      }
      return 'clear';
    }

    function matchesSite(row, siteKey){
      if(!row || !siteKey || siteKey === 'all') return true;
      const target = createSiteVariants(siteKey);
      if(!target.base && !target.hyphenated && !target.collapsed) return true;
      const values = [
        row?.__raw?.Site,
        row?.__raw?.Location,
        row?.__raw?.Area,
        row?.__siteName,
        row?.Location
      ];
      return values.some(value => {
        if(!value) return false;
        const variants = createSiteVariants(value);
        if(target.base && variants.base.includes(target.base)) return true;
        if(target.hyphenated && variants.hyphenated.includes(target.hyphenated)) return true;
        if(target.collapsed && variants.collapsed.includes(target.collapsed)) return true;
        return false;
      });
    }

    function deriveKnownSiteKey(row){
      if(!row) return '';
      for(const key of KNOWN_SITE_KEYS){
        if(matchesSite(row, key)){
          return key;
        }
      }
      return '';
    }

    function applySiteFilter(rows, siteKey){
      const list = Array.isArray(rows) ? rows.slice() : [];
      if(!siteKey || siteKey === 'all') return list;
      return list.filter(row => matchesSite(row, siteKey));
    }

    function applyCategoryFilter(rows, categoryKey){
      const list = Array.isArray(rows) ? rows.slice() : [];
      if(!categoryKey || categoryKey === 'all') return list;
      const normalized = normalizeCategoryKey(categoryKey);
      return list.filter(row => normalizeCategoryKey(row?.__categoryName) === normalized);
    }

    function applySearchFilter(rows, query){
      const list = Array.isArray(rows) ? rows.slice() : [];
      const raw = String(query ?? '').trim().toLowerCase();
      if(!raw) return list;
      const tokens = raw.split(/\s+/).filter(Boolean);
      if(!tokens.length) return list;
      return list.filter(row => {
        const haystack = String(row?.__searchText ?? '').toLowerCase();
        if(!haystack) return false;
        return tokens.every(token => haystack.includes(token));
      });
    }

    function applyRiskFilter(rows, riskKey){
      const list = Array.isArray(rows) ? rows.slice() : [];
      const normalized = normalizeRiskKey(riskKey);
      if(!normalized || normalized === 'all') return list;
      if(normalized === 'overdue'){
        return list.filter(row => row?.__overdue);
      }
      if(normalized === 'due'){
        return list.filter(row => !row?.__overdue && typeof row?.__countdownDays === 'number' && row.__countdownDays >= 0 && row.__countdownDays <= DUE_SOON_THRESHOLD_DAYS);
      }
      if(normalized === 'clear'){
        return list.filter(row => {
          if(row?.__overdue) return false;
          const days = row?.__countdownDays;
          if(typeof days === 'number' && days >= 0 && days <= DUE_SOON_THRESHOLD_DAYS){
            return false;
          }
          return true;
        });
      }
      return list;
    }

    function syncDesktopSortIndicators(container, column, direction){
      const thead = container.__thead;
      if(!thead) return;
      thead.querySelectorAll('th').forEach(th => {
        const col = th.getAttribute('data-col');
        if(col === column){
          th.setAttribute('data-sort', direction);
          th.setAttribute('aria-sort', direction === 'asc' ? 'ascending' : 'descending');
        }else{
          th.removeAttribute('data-sort');
          th.setAttribute('aria-sort','none');
        }
      });
    }

    function updateSortControls(container){
      const state = container.__currentSort || { column:'Next Due', direction:'asc' };
      const selects = Array.isArray(container.__sortSelects) ? container.__sortSelects : [];
      selects.forEach(select => {
        if(select){
          select.value = state.column;
        }
      });
      const buttons = Array.isArray(container.__sortDirectionButtons) ? container.__sortDirectionButtons : [];
      buttons.forEach(button => {
        if(!button) return;
        const dir = state.direction === 'desc' ? 'desc' : 'asc';
        button.dataset.direction = dir;
        button.textContent = dir === 'asc' ? 'Ascending' : 'Descending';
        button.setAttribute('aria-label', `Toggle sort direction (currently ${button.textContent.toLowerCase()})`);
      });
    }

    function updateSiteFilterControls(container){
      const nav = container.__siteFilterNav;
      const activeKey = container.__siteFilter || 'all';
      if(nav){
        nav.querySelectorAll('[data-site-key]').forEach(btn => {
          const key = btn.dataset.siteKey || 'all';
          const isActive = key === activeKey;
          btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
          if(isActive){
            btn.setAttribute('aria-current','true');
          }else{
            btn.removeAttribute('aria-current');
          }
        });
      }
      const activeLabel = container.__siteFilterActiveLabel;
      if(activeLabel){
        const buttons = nav ? Array.from(nav.querySelectorAll('[data-site-key]')) : [];
        const activeBtn = buttons.find(btn => (btn.dataset.siteKey || 'all') === activeKey);
        const siteText = activeBtn?.textContent?.trim() || resolveSiteLabel(activeKey);
        const riskKey = normalizeRiskKey(container.__riskFilter);
        if(riskKey === 'all'){
          activeLabel.textContent = siteText;
        }else{
          activeLabel.textContent = `${siteText} – ${resolveRiskLabel(riskKey)}`;
        }
      }
    }

    function syncSiteFilterAvailability(container){
      const nav = container.__siteFilterNav;
      if(!nav) return;
      const rows = Array.isArray(container.__rows) ? container.__rows : [];
      let current = container.__siteFilter || 'all';
      let currentAvailable = current === 'all';
      nav.querySelectorAll('[data-site-key]').forEach(btn => {
        const key = btn.dataset.siteKey || 'all';
        if(key === 'all'){
          btn.disabled = false;
          btn.removeAttribute('aria-disabled');
          return;
        }
        const hasRows = rows.some(row => matchesSite(row, key));
        btn.disabled = !hasRows;
        if(btn.disabled){
          btn.setAttribute('aria-disabled','true');
        }else{
          btn.removeAttribute('aria-disabled');
        }
        if(key === current && !hasRows){
          currentAvailable = false;
        }
      });
      if(!currentAvailable){
        current = 'all';
        container.__siteFilter = current;
        container.__riskFilter = 'all';
      }
      updateSiteFilterControls(container);
    }

    function updateCategoryFilterControls(container){
      const select = container.__categorySelect;
      if(!select) return;
      const value = container.__categoryFilter || 'all';
      if(select.value !== value){
        select.value = value;
      }
    }

    function updateCategoryFilterOptions(container){
      const select = container.__categorySelect;
      if(!select) return;
      const rows = Array.isArray(container.__rows) ? container.__rows : [];
      const counts = new Map();
      rows.forEach(row => {
        const labelRaw = String(row?.__categoryName || '').trim();
        const label = labelRaw || 'Uncategorised';
        const key = normalizeCategoryKey(label);
        if(!counts.has(key)){
          counts.set(key, { key, label, count:0 });
        }
        counts.get(key).count += 1;
      });
      const sorted = Array.from(counts.values()).sort((a,b) => a.label.localeCompare(b.label));
      const current = container.__categoryFilter || 'all';
      let hasCurrent = current === 'all';
      const options = ['<option value="all">All categories</option>'];
      sorted.forEach(item => {
        const optionLabel = `${item.label} (${item.count})`;
        options.push(`<option value="${esc(item.key)}">${esc(optionLabel)}</option>`);
        if(item.key === current){
          hasCurrent = true;
        }
      });
      select.innerHTML = options.join('');
      if(!hasCurrent){
        container.__categoryFilter = 'all';
      }
      updateCategoryFilterControls(container);
    }

    function attachCategoryFilterHandlers(container){
      const select = container.__categorySelect;
      if(!select) return;
      select.addEventListener('change', () => {
        const value = select.value || 'all';
        container.__categoryFilter = value || 'all';
        refreshView(container);
      });
    }

    function updateSearchControl(container){
      const input = container.__searchInput;
      if(!input) return;
      const value = container.__searchTerm || '';
      if(input.value !== value){
        input.value = value;
      }
    }

    function attachSearchHandlers(container){
      const input = container.__searchInput;
      if(!input) return;
      const apply = () => {
        container.__searchTerm = input.value || '';
        refreshView(container);
      };
      input.addEventListener('input', apply);
      input.addEventListener('search', apply);
    }

    function refreshView(container){
      if(!container) return;
      const state = container.__currentSort || { column:'Next Due', direction:'asc' };
      const allRows = Array.isArray(container.__rows) ? container.__rows : [];
      const siteFiltered = applySiteFilter(allRows, container.__siteFilter);
      const riskFiltered = applyRiskFilter(siteFiltered, container.__riskFilter);
      const categoryFiltered = applyCategoryFilter(riskFiltered, container.__categoryFilter);
      const searched = applySearchFilter(categoryFiltered, container.__searchTerm);
      const sorted = applySort(searched, state.column, state.direction);
      container.__viewRows = sorted;
      renderTable(container, sorted);
      if(container.__selectedDocUrl){
        const stillExists = sorted.some(row => (row.__docUrl || '') === container.__selectedDocUrl);
        if(!stillExists){
          container.__selectedDocUrl = '';
          setViewerPlaceholder('Select an inspection to preview documentation.');
          if(container.__tbody){
            container.__tbody.querySelectorAll('tr').forEach(row => row.classList.remove('is-active'));
          }
        }
      }
      renderMobileCards(container, sorted);
      updateSummaryMetrics(searched, {
        siteFilter: container.__siteFilter,
        riskFilter: container.__riskFilter,
        categoryFilter: container.__categoryFilter,
        searchTerm: container.__searchTerm,
        totalRowCount: allRows.length
      });
    }

    function attachSiteFilterHandlers(container){
      const nav = container.__siteFilterNav;
      if(!nav) return;
      nav.querySelectorAll('[data-site-key]').forEach(btn => {
        btn.addEventListener('click', () => {
          if(btn.disabled) return;
          const key = btn.dataset.siteKey || 'all';
          if(container.__siteFilter === key) return;
          container.__siteFilter = key;
          container.__riskFilter = 'all';
          updateSiteFilterControls(container);
          refreshView(container);
        });
      });
    }

    function attachSiteKpiHandlers(container){
      const list = document.querySelector('[data-role="inspections-site-breakdown"]');
      if(!list) return;
      list.addEventListener('click', event => {
        const button = event.target.closest('[data-role="inspections-site-kpi"]');
        if(!button) return;
        const siteKey = normalizeSiteKey(button.dataset.siteKey);
        const riskKey = normalizeRiskKey(button.dataset.riskKey);
        const currentSite = normalizeSiteKey(container.__siteFilter);
        const currentRisk = normalizeRiskKey(container.__riskFilter);
        if(button.dataset.empty === 'true' && !(currentSite === siteKey && currentRisk === riskKey)){
          return;
        }
        if(currentSite === siteKey && currentRisk === riskKey){
          if(riskKey !== 'all'){
            container.__riskFilter = 'all';
            updateSiteFilterControls(container);
            refreshView(container);
            return;
          }
          if(siteKey !== 'all'){
            container.__siteFilter = 'all';
            updateSiteFilterControls(container);
            refreshView(container);
          }
          return;
        }
        container.__siteFilter = siteKey;
        container.__riskFilter = riskKey;
        updateSiteFilterControls(container);
        refreshView(container);
      });
    }

    function normalizeCountdown(nextDate){
      if(!(nextDate instanceof Date) || isNaN(nextDate)){
        return { label:'Unknown', className:'is-unknown', diffDays:null, days:null, overdue:false };
      }

      const today = new Date();
      const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
      const normalized = new Date(nextDate.getFullYear(), nextDate.getMonth(), nextDate.getDate()).getTime();
      const diffDays = Math.round((normalized - startOfToday) / (1000 * 60 * 60 * 24));

      const classify = () => {
        if(diffDays <= DUE_SOON_DAYS){
          return 'is-urgent';
        }
        if(diffDays <= 180){
          return 'is-warning';
        }
        if(diffDays <= 540){
          return 'is-healthy';
        }
        return 'is-excellent';
      };

      const formatValue = (value) => {
        if(Number.isFinite(value) && Math.abs(value - Math.round(value)) > 0){
          return value.toFixed(1).replace(/\.0$/, '');
        }
        return String(value);
      };

      const describe = (days) => {
        if(days <= DUE_SOON_DAYS){
          return { value: days, unit:'d' };
        }
        if(days < 365){
          const months = days / 30;
          const rounded = months < 3 ? Math.round(months * 10) / 10 : Math.round(months);
          return { value: rounded, unit:'mo' };
        }
        const years = days / 365;
        const roundedYears = years < 5 ? Math.round(years * 10) / 10 : Math.round(years);
        return { value: roundedYears, unit:'yr' };
      };

      if(diffDays < 0){
        const absDays = Math.abs(diffDays);
        const { value, unit } = describe(absDays);
        const formattedValue = formatValue(value);
        const label = unit === 'd' ? `${formattedValue}d overdue` : `${formattedValue}${unit} overdue`;
        return { label, className:'is-urgent', diffDays, days:diffDays, overdue:true };
      }

      if(diffDays === 0){
        return { label:'Due today', className:'is-urgent', diffDays, days:diffDays, overdue:false };
      }

      const { value, unit } = describe(diffDays);
      const formattedValue = formatValue(value);
      const label = unit === 'd' ? `Due in ${formattedValue}d` : `Due in ${formattedValue}${unit}`;
      return { label, className: classify(), diffDays, days:diffDays, overdue:false };
    }

    function parseCsv(text){
      const rows = [];
      let current = [];
      let field = '';
      let inQuotes = false;
      for(let i=0;i<text.length;i++){
        const char = text[i];
        if(inQuotes){
          if(char === '"'){
            if(text[i+1] === '"'){
              field += '"';
              i++;
            }else{
              inQuotes = false;
            }
          }else{
            field += char;
          }
        }else{
          if(char === '"'){
            inQuotes = true;
          }else if(char === ','){
            current.push(field);
            field='';
          }else if(char === '\r'){
            continue;
          }else if(char === '\n'){
            current.push(field);
            rows.push(current);
            current=[];
            field='';
          }else{
            field += char;
          }
        }
      }
      if(field.length || current.length){
        current.push(field);
        rows.push(current);
      }
      if(!rows.length) return { headers: [], rows: [] };
      const headerRow = rows.shift();
      const headers = headerRow.map((h,i)=>String(h??'').replace(/^\uFEFF/,'').trim() || `Column ${i+1}`);
      const data = rows
        .filter(r => r.some(cell => String(cell ?? '').trim().length))
        .map(row => headers.reduce((acc, header, idx) => {
          acc[header] = row[idx] ?? '';
          return acc;
        }, {}));
      return { headers, rows: data };
    }

    function normalizeFieldKeyName(name){
      return String(name ?? '')
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, ' ')
        .replace(/\s{2,}/g, ' ')
        .trim();
    }

    function pickField(row, keys, options={}){
      const { fuzzy=[], fallbackUrl=false } = options;
      for(const key of keys){
        if(key in row && row[key] !== undefined){
          const value = row[key];
          if(String(value).trim().length) return value;
        }
      }
      const entries = row && typeof row === 'object' ? Object.entries(row) : [];
      if(fuzzy.length && entries.length){
        const tokenized = entries.map(([key, value]) => {
          const normalized = normalizeFieldKeyName(key);
          return {
            key,
            value,
            normalized,
            tokens: normalized.split(/\s+/).filter(Boolean)
          };
        });
        for(const descriptor of fuzzy){
          const match = tokenized.find(({ tokens, normalized }) => {
            if(!tokens.length) return false;
            if(typeof descriptor === 'function'){
              try {
                return !!descriptor({ tokens, normalized });
              } catch { return false; }
            }
            const all = Array.isArray(descriptor?.all) ? descriptor.all : null;
            const any = Array.isArray(descriptor?.any) ? descriptor.any : null;
            const includesAll = all ? all.every(token => tokens.some(t => t === token || t.startsWith(token))) : true;
            const includesAny = any ? any.some(token => tokens.some(t => t === token || t.startsWith(token))) : true;
            return includesAll && includesAny;
          });
          if(match && String(match.value ?? '').trim().length){
            return match.value;
          }
        }
      }
      if(fallbackUrl && entries.length){
        const urlLike = entries.find(([key, value]) => {
          if(value == null) return false;
          const text = String(value).trim();
          if(!text) return false;
          if(/^https?:\/\//i.test(text)) return true;
          if(/^www\./i.test(text)) return true;
          if(/drive\.google\.com|docs\.google\.com/i.test(text)) return true;
          return false;
        });
        if(urlLike){
          return urlLike[1];
        }
      }
      return '';
    }

    async function fetchSheet(){
      const url = getSheetUrl();
      if(!url){
        throw new Error('No inspections sheet URL is configured.');
      }
      const text = await safeFetch(url, { timeout:7000, retries:2 });
      if(/^[\[{]/.test(text.trim())){
        const json = JSON.parse(text);
        const rows = Array.isArray(json) ? json : (Array.isArray(json.rows) ? json.rows : []);
        const headers = rows.length ? Object.keys(rows[0]) : [];
        return { headers, rows };
      }
      return parseCsv(text);
    }

    function looksLikeFacilitiesSheet(headers, rows){
      const normalize = list => (Array.isArray(list) ? list : []).map(h => String(h ?? '').trim().toLowerCase());
      const headerSet = new Set(normalize(headers));
      const facilityCols = ['id','title','status','priority'];
      const hasFacilityHeader = facilityCols.every(col => headerSet.has(col));
      if(hasFacilityHeader) return true;
      if(Array.isArray(rows) && rows.length){
        const sampleKeys = Object.keys(rows.find(r => r && typeof r === 'object') || {}).map(k => k.toLowerCase());
        if(sampleKeys.length){
          const sampleSet = new Set(sampleKeys);
          if(facilityCols.slice(0,3).every(col => sampleSet.has(col))){
            return true;
          }
        }
      }
      return false;
    }

    function ensureInspectionsSheet(headers, rows){
      if(looksLikeFacilitiesSheet(headers, rows)){
        throw new Error('The configured sheet appears to point to the Facilities work orders data. Please double-check the published Inspections sheet link.');
      }
    }

    function buildRowModel(raw){
      const siteValue = pickField(raw, ['Site','Facility','Location','Plant','Area']);
      const asset = pickField(raw, ['Asset','Asset ID','Asset Name','Equipment','Inspection Item','Title','Item']);
      const categoryValue = pickField(raw, ['Category','Discipline','Programme','Type','Inspection Category','Categories']);
      const lastRaw = pickField(raw, ['Last Completed','Last Inspection','Previous Inspection','Last Done','Last Date','Completed on']);
      const nextRaw = pickField(raw, ['Next Due','Next Inspection','Inspection Due','Due Date','Next Date','Due','Due date']);
      const statusRaw = pickField(raw, ['Status','Current Status','State','Risk','Condition']);
      const workOrderRaw = pickField(
        raw,
        ['WO/Link','WO','Work Order','Work Order Link','Work Order URL','Link','URL','Reference','ID'],
        {
          fuzzy:[
            { all:['work','order'], any:['link','url','ref'] },
            { all:['wo'], any:['link','url'] }
          ],
          fallbackUrl:true
        }
      );
      const documentRaw = pickField(
        raw,
        ['Document URL','Document','Attachment','Attachment URL','Evidence','Certificate','Supporting Document'],
        {
          fuzzy:[
            { all:['document'], any:['link','url','hyperlink','href'] },
            { all:['certificate'], any:['link','url'] },
            { all:['inspection','report'], any:['link','url'] }
          ],
          fallbackUrl:true
        }
      );
      const notesRaw = pickField(raw, ['Notes','Comments','Remarks','Summary','Details','Description','Comment']);
      const titleRaw = pickField(raw, ['Title','Inspection Title','Inspection Name','Task','Summary Title']);
      const priorityRaw = pickField(raw, ['Priority','Risk Priority','Priority Level']);
      const assignedRaw = pickField(raw, ['Assigned to','Assigned','Assignee','Owner','Responsible']);
      const createdRaw = pickField(raw, ['Created on','Created','Created Date','Date Created']);
      const plannedRaw = pickField(raw, ['Planned Start Date','Planned Start','Scheduled Start','Start Date']);
      const updatedRaw = pickField(raw, ['Last updated','Last Update','Updated on','Last Modified','Modified']);
      const createdDate = parseDateLoose(createdRaw);
      const plannedDate = parseDateLoose(plannedRaw);
      const updatedDate = parseDateLoose(updatedRaw);
      const createdDisplay = createdDate ? formatDisplayDate(createdDate) : (createdRaw || '');
      const plannedDisplay = plannedDate ? formatDisplayDate(plannedDate) : (plannedRaw || '');
      const updatedDisplay = updatedDate ? formatDisplayDate(updatedDate) : (updatedRaw || '');
      const normalizedDocumentUrl = normalizeDocumentUrl(documentRaw || workOrderRaw);
      const workOrderUrl = normalizeExternalUrl(workOrderRaw);
      const lastDate = parseDateLoose(lastRaw);
      const nextDate = parseDateLoose(nextRaw);
      const countdown = normalizeCountdown(nextDate instanceof Date ? new Date(nextDate) : nextDate);
      const diffDays = typeof countdown.diffDays === 'number' ? countdown.diffDays : null;
      const statusKey = deriveStatusKey(statusRaw, diffDays);
      const riskKey = statusToRiskKey(statusKey, diffDays);
      const statusLabel = (() => {
        const rawText = String(statusRaw ?? '').trim();
        if(rawText) return rawText.replace(/\s+/g,' ').trim();
        return STATUS_DISPLAY_LABELS[statusKey] || '—';
      })();
      const statusClass = STATUS_CLASS_MAP[statusKey] || STATUS_CLASS_MAP.unknown;
      const siteDisplay = siteValue || FALLBACK_SITE_LABEL;
      const categoryDisplay = categoryValue || 'Uncategorised';
      const notesDisplay = (() => {
        if(notesRaw) return notesRaw;
        const meta = [];
        if(titleRaw && String(titleRaw).trim().length){
          const normalizedTitle = String(titleRaw).trim().toLowerCase();
          const normalizedAsset = String(asset ?? '').trim().toLowerCase();
          if(!normalizedAsset || normalizedAsset !== normalizedTitle){
            meta.push(titleRaw);
          }
        }
        const detailParts = [];
        if(priorityRaw) detailParts.push(`Priority: ${priorityRaw}`);
        if(assignedRaw) detailParts.push(`Assigned: ${assignedRaw}`);
        const scheduleParts = [];
        if(plannedDisplay) scheduleParts.push(`Planned: ${plannedDisplay}`);
        if(createdDisplay) scheduleParts.push(`Created: ${createdDisplay}`);
        if(updatedDisplay) scheduleParts.push(`Updated: ${updatedDisplay}`);
        return [...meta, ...detailParts, ...scheduleParts].filter(Boolean).join(' • ') || '—';
      })();
      const workOrderLabel = (() => {
        const text = String(workOrderRaw ?? '').trim();
        if(text) return text;
        if(workOrderUrl){
          try {
            const host = new URL(workOrderUrl).hostname.replace(/^www\./i,'');
            return host || 'Open link';
          } catch {
            return 'Open link';
          }
        }
        return '—';
      })();
      const searchParts = [
        siteValue,
        asset,
        categoryValue,
        statusLabel,
        notesRaw,
        notesDisplay,
        workOrderRaw,
        titleRaw,
        priorityRaw,
        assignedRaw,
        plannedRaw,
        createdRaw,
        updatedRaw
      ]
        .filter(Boolean)
        .map(part => String(part).toLowerCase())
        .join(' ');
      return {
        Site: siteDisplay || '—',
        Asset: asset || '—',
        Category: categoryDisplay,
        'Last Completed': lastDate ? formatDisplayDate(lastDate) : (lastRaw || '—'),
        'Next Due': nextDate ? formatDisplayDate(nextDate) : (nextRaw || '—'),
        Status: statusLabel || STATUS_DISPLAY_LABELS[statusKey] || '—',
        'WO/Link': workOrderLabel,
        Notes: notesDisplay,
        __lastDate: lastDate,
        __nextDate: nextDate,
        __countdownClass: countdown.className,
        __countdownDays: diffDays,
        __overdue: statusKey === 'overdue' || countdown.overdue,
        __siteName: siteValue || '',
        __categoryName: categoryDisplay,
        __categoryKey: normalizeCategoryKey(categoryDisplay),
        __statusKey: statusKey,
        __statusClass: statusClass,
        __riskKey: riskKey,
        __docUrl: normalizedDocumentUrl,
        __workOrderUrl: workOrderUrl,
        __searchText: searchParts,
        __title: titleRaw || '',
        __priority: priorityRaw || '',
        __assigned: assignedRaw || '',
        __planned: plannedDisplay || '',
        __created: createdDisplay || '',
        __updated: updatedDisplay || '',
        __raw: raw
      };
    }

    function renderTable(container, rows){
      const tbody = container.__tbody;
      const scrollRegion = container.__scrollRegion;
      if(!tbody) return;
      if(!Array.isArray(rows) || !rows.length){
        const hasSource = Array.isArray(container?.__rows) && container.__rows.length > 0;
        const message = hasSource ? 'No inspections match your filters.' : 'No inspections are currently scheduled.';
        tbody.innerHTML = `<tr><td colspan="8" class="empty-state">${esc(message)}</td></tr>`;
        scrollRegion?.setAttribute('data-loading','false');
        updateResponsiveMode(container);
        return;
      }
      const html = rows.map(row => {
        const overdueClass = row.__overdue ? 'row-overdue' : '';
        const docAttr = row.__docUrl ? ` data-doc="${esc(row.__docUrl)}"` : '';
        const statusKey = row.__statusKey || 'unknown';
        const statusClass = row.__statusClass || STATUS_CLASS_MAP.unknown;
        const statusPill = `<span class="status-pill ${statusClass}" data-status="${esc(statusKey)}">${esc(row.Status)}</span>`;
        const woLabel = String(row['WO/Link'] ?? '—').trim() || '—';
        let woCell = esc(woLabel);
        if(row.__workOrderUrl){
          woCell = `<a href="${esc(row.__workOrderUrl)}" target="_blank" rel="noopener">${esc(woLabel)}</a>`;
        }else if(/^https?:\/\//i.test(woLabel)){
          const safe = normalizeExternalUrl(woLabel);
          if(safe){
            woCell = `<a href="${esc(safe)}" target="_blank" rel="noopener">${esc(woLabel)}</a>`;
          }
        }
        return `
          <tr class="${overdueClass}" tabindex="0"${docAttr}>
            <td data-col="Site" title="${esc(row.Site)}"><span>${esc(row.Site)}</span></td>
            <td data-col="Asset" title="${esc(row.Asset)}"><span>${esc(row.Asset)}</span></td>
            <td data-col="Category" title="${esc(row.Category)}"><span>${esc(row.Category)}</span></td>
            <td data-col="Last Completed" title="${esc(row['Last Completed'])}"><span>${esc(row['Last Completed'])}</span></td>
            <td data-col="Next Due" title="${esc(row['Next Due'])}"><span>${esc(row['Next Due'])}</span></td>
            <td data-col="Status" title="${esc(row.Status)}"><span>${statusPill}</span></td>
            <td data-col="WO/Link" title="${esc(woLabel)}"><span>${woCell}</span></td>
            <td data-col="Notes" title="${esc(row.Notes)}"><span>${esc(row.Notes)}</span></td>
          </tr>
        `;
      }).join('');
      tbody.innerHTML = html;
      if(container.__selectedDocUrl){
        const active = Array.from(tbody.querySelectorAll('tr')).find(tr => (tr.dataset.doc || '') === container.__selectedDocUrl);
        if(active){
          active.classList.add('is-active');
        }
      }
      scrollRegion?.setAttribute('data-loading','false');
      updateResponsiveMode(container);
    }

    function wireViewer(container){
      const { viewer, body } = getViewerElements();
      if(!viewer || !body || !container?.__tbody) return;
      const tbody = container.__tbody;
      const highlight = (tr) => {
        if(!tbody) return;
        tbody.querySelectorAll('tr').forEach(row => row.classList.remove('is-active'));
        if(tr) tr.classList.add('is-active');
      };
      const open = (url) => {
        if(!url){
          setViewerPlaceholder('No document link on this row.', { reveal:true });
          return;
        }
        const raw = typeof url === 'string' ? url.trim() : '';
        const safeUrl = normalizeDocumentUrl(raw);
        if(!safeUrl){
          setViewerPlaceholder('No document link on this row.', { reveal:true });
          return;
        }
        const offline = !ALLOW_NETWORK && !safeUrl.startsWith('data:') && !safeUrl.startsWith('about:');
        if(offline){
          setViewerPlaceholder('Document preview disabled offline.', { reveal:true });
          return;
        }
        body.innerHTML = '';
        const frame = document.createElement('iframe');
        frame.src = safeUrl;
        frame.loading = 'lazy';
        frame.title = 'Inspection document preview';
        body.appendChild(frame);
        viewer.hidden = false;
        viewer.dataset.viewerState = 'visible';
        setViewerCollapsed(false);
      };
      const selectRow = (tr) => {
        if(!tr) return;
        container.__selectedDocUrl = tr.dataset.doc || '';
        highlight(tr);
        open(container.__selectedDocUrl);
      };
      tbody.addEventListener('click', event => {
        const tr = event.target.closest('tr');
        if(!tr) return;
        selectRow(tr);
      });
      tbody.addEventListener('keydown', event => {
        if(event.key === 'Enter' || event.key === ' '){
          const tr = event.target.closest('tr');
          if(!tr) return;
          selectRow(tr);
          event.preventDefault();
        }
      });
      container.__openDocument = open;
    }

    function renderMobileCards(container, rows){
      const mobile = container.__mobileCards;
      if(!mobile) return;
      const list = Array.isArray(rows) ? rows : [];
      mobile.dataset.state = list.length ? 'ready' : 'empty';
      mobile.setAttribute('aria-busy','false');
      if(!list.length){
        mobile.innerHTML = '<div class="mobile-card mobile-card--status empty-state" role="listitem">No inspections match your filters.</div>';
        return;
      }
      const html = list.map(row => {
        const overdueClass = row.__overdue ? 'row-overdue' : '';
        const cardTitle = row.__title && String(row.__title).trim().length ? row.__title : row.Asset;
        const subtitleParts = [];
        if(row.Site) subtitleParts.push(row.Site);
        if(row.Asset && cardTitle !== row.Asset) subtitleParts.push(row.Asset);
        if(row.Category) subtitleParts.push(row.Category);
        const subtitle = subtitleParts.length
          ? `<div class="mobile-card__subtitle">${subtitleParts.map(part => `<span>${esc(part)}</span>`).join('')}</div>`
          : '';
        const statusClass = row.__statusClass || STATUS_CLASS_MAP.unknown;
        const statusKey = row.__statusKey || 'unknown';
        const statusPill = `<span class="status-pill ${statusClass}" data-status="${esc(statusKey)}">${esc(row.Status)}</span>`;
        const notesRaw = String(row.Notes ?? '').trim();
        const notesText = notesRaw || 'No notes provided.';
        const linkBlock = row.__workOrderUrl
          ? `<div class="mobile-card__actions"><a class="mobile-card__action" href="${esc(row.__workOrderUrl)}" target="_blank" rel="noopener">Open link</a></div>`
          : '';
          return `
          <article class="mobile-card ${overdueClass}" aria-label="Inspection for ${esc(cardTitle)}" role="listitem">
            <header class="mobile-card__header">
              <div class="mobile-card__heading">
                <div class="mobile-card__title">${esc(cardTitle)}</div>
                ${subtitle}
              </div>
              ${statusPill}
            </header>
            <dl class="mobile-card__details">
              <dt class="mobile-card__detail-label">Last</dt><dd class="mobile-card__detail-value">${esc(row['Last Completed'])}</dd>
              <dt class="mobile-card__detail-label">Next</dt><dd class="mobile-card__detail-value">${esc(row['Next Due'])}</dd>
            </dl>
            ${linkBlock}
            <div class="mobile-card__note">
              <span class="mobile-card__note-label">Notes</span>
              <p class="mobile-card__note-text">${esc(notesText)}</p>
            </div>
          </article>
        `;
      }).join('');
      mobile.innerHTML = html;
    }

    function updateSummaryMetrics(rows, context={}){
      const signalRoot = document.querySelector('[data-role="inspections-signal"]');
      const signalValueNode = document.querySelector('[data-role="inspections-signal-value"]');
      const signalNoteNode = document.querySelector('[data-role="inspections-signal-note"]');
      const riskPanel = document.querySelector('[data-role="inspections-risk"]');
      const riskMessageNode = document.querySelector('[data-role="inspections-risk-message"]');
      const riskSegments = {
        overdue: document.querySelector('[data-role="inspections-risk-overdue"]'),
        due: document.querySelector('[data-role="inspections-risk-due"]'),
        clear: document.querySelector('[data-role="inspections-risk-clear"]')
      };
      const riskLabels = {
        overdue: document.querySelector('[data-role="inspections-risk-label-overdue"]'),
        due: document.querySelector('[data-role="inspections-risk-label-due"]'),
        clear: document.querySelector('[data-role="inspections-risk-label-clear"]')
      };
      const siteListRoot = document.querySelector('[data-role="inspections-site-breakdown"]');
      const siteHintNode = document.querySelector('[data-role="inspections-site-hint"]');

      const list = Array.isArray(rows) ? rows : [];
      const total = list.length;
      const dueSoonThreshold = DUE_SOON_DAYS;
      const siteFilter = normalizeSiteKey(context.siteFilter);
      const riskFilter = normalizeRiskKey(context.riskFilter);
      const categoryFilter = normalizeCategoryKey(context.categoryFilter);
      const searchTermRaw = String(context.searchTerm ?? '').trim();
      const overallCount = typeof context.totalRowCount === 'number' ? context.totalRowCount : total;
      const isFiltered = siteFilter !== 'all';
      const isRiskFiltered = riskFilter !== 'all';
      const isCategoryFiltered = categoryFilter !== 'all';
      const isSearchFiltered = searchTermRaw.length > 0;
      const categoryLabel = resolveCategoryLabel(context.categoryFilter);
      const filterLabelParts = [];
      if(isFiltered){
        filterLabelParts.push(resolveSiteLabel(siteFilter));
      }
      if(isCategoryFiltered){
        filterLabelParts.push(categoryLabel);
      }
      const filterLabel = filterLabelParts.join(' · ');
      const appliedFilters = [];
      if(filterLabelParts.length){
        appliedFilters.push(filterLabel);
      }
      if(isRiskFiltered){
        appliedFilters.push(resolveRiskLabel(riskFilter).toLowerCase());
      }
      if(isSearchFiltered){
        appliedFilters.push(`search “${searchTermRaw}”`);
      }
      const filterSummaryText = appliedFilters.length ? appliedFilters.join(' · ') : '';
      const hasActiveFilters = (isFiltered || isRiskFiltered || isCategoryFiltered || isSearchFiltered) && overallCount > 0;
      const dueSoonRows = list.filter(row => typeof row?.__countdownDays === 'number' && row.__countdownDays >= 0 && row.__countdownDays <= dueSoonThreshold);
      const overdueRows = list.filter(row => row?.__overdue);
      const compliantCount = Math.max(total - overdueRows.length - dueSoonRows.length, 0);

      const riskState = total === 0
        ? 'empty'
        : (overdueRows.length > 0 ? 'critical' : (dueSoonRows.length > 0 ? 'warning' : 'stable'));

      if(signalRoot){
        let signalValue = '—';
        let signalNote;

        if(total === 0){
          if(hasActiveFilters){
            const summary = filterSummaryText || 'selected';
            signalValue = 'Filtered';
            signalNote = `No inspections currently match the ${summary} filter.`;
          }else{
            signalNote = 'Awaiting data from the published schedule.';
          }
        }else if(riskState === 'critical'){
          signalValue = 'Critical';
          signalNote = overdueRows.length === 1
            ? '1 inspection is overdue and needs immediate action.'
            : `${overdueRows.length} inspections are overdue and need immediate action.`;
        }else if(riskState === 'warning'){
          signalValue = 'Caution';
          signalNote = dueSoonRows.length === 1
            ? `1 inspection is due within the next ${dueSoonThreshold} days.`
            : `${dueSoonRows.length} inspections are due within the next ${dueSoonThreshold} days.`;
        }else{
          signalValue = 'Stable';
          signalNote = `All inspections are currently outside the next ${dueSoonThreshold} days.`;
        }

        signalRoot.setAttribute('data-state', riskState);
        if(signalValueNode){
          signalValueNode.textContent = signalValue;
        }
        if(signalNoteNode){
          signalNoteNode.textContent = signalNote;
        }
      }

      if(riskPanel){
        riskPanel.removeAttribute('data-state');
        if(riskState === 'critical' || riskState === 'warning' || riskState === 'stable'){
          riskPanel.setAttribute('data-state', riskState);
        }
      }

      if(riskMessageNode){
        let message = 'Awaiting inspection data.';
        if(total === 0){
          message = hasActiveFilters
            ? `No inspections fall under the ${filterSummaryText || 'selected'} filter.`
            : 'Awaiting inspection data.';
        }else if(riskState === 'critical'){
          message = overdueRows.length === 1
            ? '1 inspection is overdue and needs immediate action.'
            : `${overdueRows.length} inspections are overdue and need immediate action.`;
        }else if(riskState === 'warning'){
          message = dueSoonRows.length === 1
            ? `1 inspection is due within the next ${dueSoonThreshold} days.`
            : `${dueSoonRows.length} inspections are due within the next ${dueSoonThreshold} days.`;
        }else if(riskState === 'stable'){
          message = `All inspections are currently outside the next ${dueSoonThreshold} days.`;
        }
        riskMessageNode.textContent = message;
      }

      const percent = (count) => {
        if(total <= 0) return 0;
        const value = (count / total) * 100;
        return Number.isFinite(value) ? Math.max(0, Math.min(100, value)) : 0;
      };

      const formatLegend = (count, singular, plural=null) => {
        const label = count === 1 ? singular : (plural || `${singular}s`);
        if(total <= 0){
          return `${count} ${label}`;
        }
        const pct = Math.round(percent(count));
        return `${count} ${label} (${pct}%)`;
      };

      const overdueWidth = percent(overdueRows.length);
      const dueWidth = Math.max(0, Math.min(100 - overdueWidth, percent(dueSoonRows.length)));
      const startClear = overdueWidth + dueWidth;
      const clearWidth = total > 0 ? Math.max(0, Math.min(100, 100 - startClear)) : 0;

      if(riskSegments.overdue){
        riskSegments.overdue.style.left = '0%';
        riskSegments.overdue.style.width = `${overdueWidth}%`;
      }
      if(riskSegments.due){
        riskSegments.due.style.left = `${overdueWidth}%`;
        riskSegments.due.style.width = `${dueWidth}%`;
      }
      if(riskSegments.clear){
        riskSegments.clear.style.left = `${startClear}%`;
        riskSegments.clear.style.width = `${clearWidth}%`;
      }

      if(riskLabels.overdue){
        riskLabels.overdue.textContent = formatLegend(overdueRows.length, 'overdue', 'overdue');
      }
      if(riskLabels.due){
        riskLabels.due.textContent = formatLegend(dueSoonRows.length, 'due soon', 'due soon');
      }
      if(riskLabels.clear){
        riskLabels.clear.textContent = formatLegend(compliantCount, 'on track', 'on track');
      }

      if(siteHintNode){
        if(total === 0){
          siteHintNode.textContent = hasActiveFilters
            ? `No inspections currently align with the ${filterSummaryText || 'selected'} filter.`
            : 'Awaiting inspection data.';
        }else if(filterLabel && isRiskFiltered){
          siteHintNode.textContent = `Viewing ${resolveRiskLabel(riskFilter).toLowerCase()} inspections for ${filterLabel}${isSearchFiltered ? ` matching “${searchTermRaw}”` : ''}.`;
        }else if(filterLabel){
          siteHintNode.textContent = `Status for ${filterLabel}${isSearchFiltered ? ` matching “${searchTermRaw}”` : ''}.`;
        }else if(isRiskFiltered){
          siteHintNode.textContent = `${resolveRiskLabel(riskFilter)} inspections across all sites${isCategoryFiltered ? ` – ${categoryLabel}` : ''}${isSearchFiltered ? ` matching “${searchTermRaw}”` : ''}.`;
        }else if(isSearchFiltered){
          siteHintNode.textContent = `Results matching “${searchTermRaw}”.`;
        }else{
          siteHintNode.textContent = 'Sites ordered by highest risk first.';
        }
      }

      if(siteListRoot){
        if(!list.length){
          const message = hasActiveFilters
            ? `No inspections match the ${filterSummaryText || 'selected'} filter.`
            : 'Awaiting inspection data.';
          siteListRoot.innerHTML = `<li class="pssr-site-breakdown__item is-empty">${esc(message)}</li>`;
        }else{
          const siteStats = new Map();
          list.forEach(row => {
            const rawValue = String(row?.__siteName || '').trim();
            const normalizedName = rawValue && rawValue !== '—' ? rawValue : '';
            const name = normalizedName || FALLBACK_SITE_LABEL;
            const knownKey = deriveKnownSiteKey(row);
            const variants = createSiteVariants(name);
            const fallbackKey = variants.hyphenated || variants.base || name.toLowerCase();
            const mapKey = (knownKey || fallbackKey || name).toLowerCase();
            if(!siteStats.has(mapKey)){
              siteStats.set(mapKey, {
                name,
                displayName: name,
                total:0,
                overdue:0,
                dueSoon:0,
                clear:0,
                siteKey: knownKey || fallbackKey || mapKey,
                fallbackKey,
                knownKey: knownKey || ''
              });
            }
            const stat = siteStats.get(mapKey);
            if(stat){
              if(name && name !== FALLBACK_SITE_LABEL && stat.displayName === FALLBACK_SITE_LABEL){
                stat.displayName = name;
              }
              if(stat.name === FALLBACK_SITE_LABEL && name !== FALLBACK_SITE_LABEL){
                stat.name = name;
              }
              if(!stat.knownKey && knownKey){
                stat.knownKey = knownKey;
                stat.siteKey = knownKey;
              }
              stat.total += 1;
              if(row?.__overdue){
                stat.overdue += 1;
              }else if(typeof row?.__countdownDays === 'number' && row.__countdownDays >= 0 && row.__countdownDays <= dueSoonThreshold){
                stat.dueSoon += 1;
              }else{
                stat.clear += 1;
              }
            }
          });

          const ordered = Array.from(siteStats.values()).map(stat => {
            const siteKey = normalizeSiteKey(stat.siteKey || stat.fallbackKey || stat.name);
            const displayName = stat.displayName || stat.name || FALLBACK_SITE_LABEL;
            return {
              ...stat,
              siteKey,
              displayName
            };
          }).sort((a,b) => {
            if(b.overdue !== a.overdue) return b.overdue - a.overdue;
            if(b.dueSoon !== a.dueSoon) return b.dueSoon - a.dueSoon;
            if(b.total !== a.total) return b.total - a.total;
            return a.displayName.localeCompare(b.displayName);
          });

          const limit = isFiltered ? 1 : Math.min(4, ordered.length);
          const visible = ordered.slice(0, limit);
          const activeSiteKey = siteFilter;
          const activeRiskKey = riskFilter;
          const siteHtml = visible.map(stat => {
            const buildBadge = (count, className, label, { isEmpty = count === 0, riskKey = 'all' } = {}) => {
              const normalizedSite = normalizeSiteKey(stat.siteKey);
              const normalizedRisk = normalizeRiskKey(riskKey);
              const isActive = activeSiteKey === normalizedSite && activeRiskKey === normalizedRisk;
              const ariaLabel = `${stat.displayName}: ${count} ${label}`;
              return `
                <button type="button" class="pssr-site-breakdown__badge ${className}" data-role="inspections-site-kpi" data-site-key="${esc(normalizedSite)}" data-risk-key="${esc(normalizedRisk)}" data-empty="${isEmpty}" aria-label="${esc(ariaLabel)}" title="${esc(ariaLabel)}" aria-pressed="${isActive ? 'true' : 'false'}">
                  <span class="pssr-site-breakdown__count">${esc(count)}</span>
                  <span class="pssr-site-breakdown__label">${esc(label)}</span>
                </button>
              `;
            };
            const totalBadge = buildBadge(stat.total, 'is-total', 'total', { isEmpty: false, riskKey:'all' });
            const overdueBadge = buildBadge(stat.overdue, 'is-alert', 'overdue', { riskKey:'overdue' });
            const dueBadge = buildBadge(stat.dueSoon, 'is-warning', 'due soon', { riskKey:'due' });
            const clearBadge = buildBadge(stat.clear, 'is-ok', 'on track', { riskKey:'clear' });
            return `
              <li class="pssr-site-breakdown__item">
                <div class="pssr-site-breakdown__header">
                  <span class="pssr-site-breakdown__name">${esc(stat.displayName)}</span>
                </div>
                <div class="pssr-site-breakdown__status">
                  ${totalBadge}
                  ${overdueBadge}
                  ${dueBadge}
                  ${clearBadge}
                </div>
              </li>
            `;
          }).join('');

          siteListRoot.innerHTML = siteHtml;
        }
      }
    }

    function setSort(container, column, direction){
      const dir = direction === 'asc' ? 'asc' : 'desc';
      container.__currentSort = { column, direction: dir };
      syncDesktopSortIndicators(container, column, dir);
      updateSortControls(container);
      refreshView(container);
    }

    function attachSortHandlers(container){
      const thead = container.__thead;
      if(!thead) return;
      thead.querySelectorAll('th').forEach(th => {
        th.addEventListener('click', () => {
          const column = th.getAttribute('data-col');
          const current = container.__currentSort;
          const nextDirection = current && current.column === column && current.direction === 'asc' ? 'desc' : 'asc';
          setSort(container, column, nextDirection);
        });
      });
    }

    function attachSortControlHandlers(container){
      const selects = Array.isArray(container.__sortSelects) ? container.__sortSelects : [];
      selects.forEach(select => {
        if(!select) return;
        select.addEventListener('change', () => {
          const column = select.value;
          const current = container.__currentSort;
          const direction = current && current.column === column ? current.direction : 'asc';
          setSort(container, column, direction);
        });
      });
      const buttons = Array.isArray(container.__sortDirectionButtons) ? container.__sortDirectionButtons : [];
      buttons.forEach(button => {
        if(!button) return;
        button.addEventListener('click', () => {
          const fallbackColumn = container.__currentSort?.column || container.__sortSelects?.[0]?.value || 'Next Due';
          const current = container.__currentSort || { column:fallbackColumn, direction:'asc' };
          const direction = current.direction === 'asc' ? 'desc' : 'asc';
          setSort(container, current.column || fallbackColumn, direction);
        });
      });
    }

    function updateStickyOffsets(){
      const sticky = document.querySelector('.sticky-top');
      if(!sticky) return;
      const height = sticky.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--sticky-controls-offset', `${Math.ceil(height)}px`);
    }

    async function refreshInspections(containerOverride){
      const container = containerOverride || document.querySelector('[data-component="inspections-table"]');
      if(!container) return;
      banner('', 'Fetching latest inspections…');
      container.__scrollRegion?.setAttribute('data-loading','true');
      container.__selectedDocUrl = '';
      setViewerPlaceholder('Select an inspection to preview documentation.');
      if(container.__mobileCards){
        container.__mobileCards.dataset.state = 'loading';
        container.__mobileCards.setAttribute('aria-busy','true');
        container.__mobileCards.innerHTML = '<div class="mobile-card mobile-card--status" role="listitem" aria-live="polite">Loading inspection data…</div>';
      }
      try {
        if(!ALLOW_NETWORK){
          throw new Error('Network disabled in this environment');
        }
        const { headers, rows } = await fetchSheet();
        ensureInspectionsSheet(headers, rows);
        const hasRows = Array.isArray(rows) && rows.length > 0;
        const sourceRows = hasRows ? rows : SAMPLE;
        const mapped = sourceRows.map(buildRowModel);
        container.__rows = mapped;
        updateCategoryFilterOptions(container);
        syncSiteFilterAvailability(container);
        setSort(container, container.__currentSort.column, container.__currentSort.direction);
        if(hasRows){
          hideBanner();
        }else{
          banner('warn', 'Showing sample data', 'sheet returned no rows');
        }
      } catch (error) {
        console.warn('Falling back to SAMPLE. Reason:', error?.message || error);
        const message = (error && typeof error.message === 'string' && error.message.trim()) ? error.message.trim() : DEFAULT_ERROR_MESSAGE;
        const fallback = SAMPLE.map(buildRowModel);
        container.__rows = fallback;
        updateCategoryFilterOptions(container);
        syncSiteFilterAvailability(container);
        setSort(container, container.__currentSort.column, container.__currentSort.direction);
        banner('warn', 'Showing sample data', message);
      } finally {
        container.__scrollRegion?.setAttribute('data-loading','false');
      }
    }

    function initInspections(){
      const container = document.querySelector('[data-component="inspections-table"]');

      restoreStoredLayoutMode(container);

      const handleResize = () => {
        updateStickyOffsets();
        updateResponsiveMode(container);
      };

      updateStickyOffsets();
      updateResponsiveMode(container);
      window.addEventListener('resize', () => window.requestAnimationFrame(handleResize));

      initViewerToggle();
      setViewerCollapsed(true, { respectPreference:false });

      if(!container) return null;
      container.__thead = container.querySelector('thead');
      container.__tbody = container.querySelector('tbody');
      container.__scrollRegion = container.querySelector('[data-role="scroll-region"]');
      container.__mobileCards = document.querySelector('[data-role="mobile-cards"]');
      container.__sortSelects = Array.from(document.querySelectorAll('[data-role="sort-select"], [data-role="mobile-sort-select"]'));
      container.__sortDirectionButtons = Array.from(document.querySelectorAll('[data-role="sort-direction"], [data-role="mobile-sort-direction"]'));
      container.__siteFilterNav = document.querySelector('[data-role="site-nav"]');
      container.__siteFilterActiveLabel = document.querySelector('[data-role="site-filter-active"]');
      container.__categorySelect = document.querySelector('[data-role="category-select"]');
      container.__searchInput = document.querySelector('[data-role="search-input"]');
      container.__rows = [];
      container.__viewRows = [];
      container.__currentSort = { column:'Next Due', direction:'asc' };
      container.__siteFilter = 'all';
      container.__riskFilter = 'all';
      container.__categoryFilter = 'all';
      container.__searchTerm = '';
      container.__selectedDocUrl = '';

      setViewerPlaceholder('Select an inspection to preview documentation.');
      wireViewer(container);

      attachSortHandlers(container);
      updateSortControls(container);
      attachSortControlHandlers(container);
      updateSiteFilterControls(container);
      attachSiteFilterHandlers(container);
      attachSiteKpiHandlers(container);
      updateCategoryFilterControls(container);
      attachCategoryFilterHandlers(container);
      updateSearchControl(container);
      attachSearchHandlers(container);

      const refreshButton = document.querySelector('[data-action="refresh"]');
      if(refreshButton){
        refreshButton.addEventListener('click', () => refreshInspections(container));
      }

      refreshInspections(container);
      return container;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const container = initInspections();
      if(container){
        window.refreshInspections = () => refreshInspections(container);
      }else{
        window.refreshInspections = () => refreshInspections();
      }
    });
  </script>
</body>
</html>
