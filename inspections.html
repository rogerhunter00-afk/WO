<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>Inspections Tracker ‚Äì ALS Engineering Dashboard</title>
  <style>
    :root {
      --bg:#f3f5f9;
      --paper:#ffffff;
      --ink:#0b0f1a;
      --muted:#6b7280;
      --border:#e5e9f2;

      --brand:#0b67c2;
      --brand-strong:#0a5cb0;

      --btn-fg:#ffffff;
      --btn-bg:var(--brand);
      --btn-bg-hover:var(--brand-strong);
      --btn-outline-fg:var(--brand);
      --btn-outline-bd:#bcd7f4;
      --btn-ghost-fg:var(--brand);
      --btn-ghost-bg:transparent;
      --btn-ghost-bg-hover:rgba(11,103,194,.10);

      --input-bg:#ffffff;
      --input-fg:var(--ink);
      --input-bd:var(--border);
      --input-bd-focus:var(--brand);
      --shadow:0 1px 2px rgba(16,24,40,.06),0 4px 10px rgba(16,24,40,.06);

      --als-blue:var(--brand);
      --als-blue-strong:var(--brand-strong);
      --risk-critical:#dc2626;
      --risk-warning:#b45309;
      --risk-ok:#059669;
      --done-tx:var(--risk-ok);
      --done-bg:color-mix(in srgb,var(--done-tx) 18%,transparent);
      --surface-subtle:color-mix(in srgb,var(--als-blue) 4%,var(--paper));
      --surface-strong:color-mix(in srgb,var(--als-blue) 9%,var(--paper));
      --thead:var(--brand);
      --thead-text:#fff;
      --grid:var(--border);
      --zebra:var(--paper);
      --sticky-controls-offset:0px;
      --table-min-width:1280px;
      --table-max-width:1480px;
      --ui-offset:0px;
      --ctrl-bg:#ffffff;
      --ctrl-fg:#0b0f1a;
      --ctrl-muted:#6b7280;
      --ctrl-ring:#3b82f6;
      --ctrl-pill:#f3f6fb;
      --ctrl-pill-border:#dfe6ef;
      --ctrl-shadow:0 1px 2px rgba(0,0,0,.05);
      --ctrl-hover:rgba(11,103,194,.08);
      --ctrl-on:#0b67c2;
      color-scheme:light;
    }

    /* Dark mode is now controlled by JavaScript only - removed auto dark mode detection */

    .dark {
      color-scheme:dark;
      --bg:#0f1422;
      --paper:#131a2b;
      --ink:#f3f4f6;
      --muted:#9ca3af;
      --border:#233150;
      --brand:#3b82f6;
      --brand-strong:#2563eb;
      --btn-outline-bd:#2b3a63;
      --btn-ghost-bg-hover:rgba(11,103,194,.18);
      --input-bg:#0f1422;
      --input-fg:#f3f4f6;
      --input-bd:#233150;
      --input-bd-focus:#3b82f6;
      --als-blue:var(--brand);
      --als-blue-strong:var(--brand-strong);
      --risk-critical:#f87171;
      --risk-warning:#fbbf24;
      --risk-ok:#34d399;
      --done-tx:var(--risk-ok);
      --done-bg:color-mix(in srgb,var(--done-tx) 22%,transparent);
      --surface-subtle:color-mix(in srgb,var(--als-blue) 14%,var(--paper));
      --surface-strong:color-mix(in srgb,var(--als-blue) 20%,var(--paper));
      --thead:#1e3a8a;
      --grid:#233150;
      --zebra:#1c2438;
      --ctrl-bg:#0d1117;
      --ctrl-fg:#e8edf5;
      --ctrl-muted:#9aa7b7;
      --ctrl-ring:#60a5fa;
      --ctrl-pill:#111827;
      --ctrl-pill-border:#1f2937;
      --ctrl-shadow:0 1px 0 rgba(255,255,255,.06) inset;
      --ctrl-hover:rgba(96,165,250,.15);
      --ctrl-on:#60a5fa;
    }

    .light {
      color-scheme:light;
      --bg:#f3f5f9;
      --paper:#ffffff;
      --ink:#0b0f1a;
      --muted:#6b7280;
      --border:#e5e9f2;
      --brand:#0b67c2;
      --brand-strong:#0a5cb0;
      --btn-outline-bd:#bcd7f4;
      --btn-ghost-bg-hover:rgba(11,103,194,.10);
      --input-bg:#ffffff;
      --input-fg:var(--ink);
      --input-bd:var(--border);
      --input-bd-focus:var(--brand);
      --als-blue:var(--brand);
      --als-blue-strong:var(--brand-strong);
      --risk-critical:#dc2626;
      --risk-warning:#b45309;
      --risk-ok:#059669;
      --done-tx:var(--risk-ok);
      --done-bg:color-mix(in srgb,var(--done-tx) 18%,transparent);
      --surface-subtle:color-mix(in srgb,var(--als-blue) 4%,var(--paper));
      --surface-strong:color-mix(in srgb,var(--als-blue) 9%,var(--paper));
      --thead:var(--brand);
      --grid:var(--border);
      --zebra:var(--paper);
      --ctrl-bg:#ffffff;
      --ctrl-fg:#0b0f1a;
      --ctrl-muted:#6b7280;
      --ctrl-ring:#3b82f6;
      --ctrl-pill:#f3f6fb;
      --ctrl-pill-border:#dfe6ef;
      --ctrl-shadow:0 1px 2px rgba(0,0,0,.05);
      --ctrl-hover:rgba(11,103,194,.08);
      --ctrl-on:#0b67c2;
    }

    body {
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      font-size:13px;
      line-height:1.4;
      -webkit-font-smoothing:antialiased;
    }

    body::before {
      content:"";
      position:fixed;
      inset:0 0 auto 0;
      height:var(--ui-offset, var(--sticky-controls-offset, 0px));
      background:var(--bg);
      pointer-events:none;
      z-index:180;
    }

    .page {
      --page-pad-top:12px;
      --page-pad-inline:clamp(20px,4vw,36px);
      --page-pad-bottom:48px;
      padding:var(--page-pad-top) var(--page-pad-inline) var(--page-pad-bottom);
      max-width:clamp(960px,96vw,1680px);
      margin-inline:auto;
      box-sizing:border-box;
    }

    @media (max-width: 960px){
      .page {
        --page-pad-inline:clamp(18px,6vw,26px);
        --page-pad-bottom:24px;
      }
    }

    @media (max-width: 720px){
      .page {
        --page-pad-inline:16px;
        --page-pad-bottom:20px;
      }
    }

    .page-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding-bottom:12px;
      margin-bottom:0;
      position:relative;
      z-index:260;
      gap:16px;
    }

    .page-head__title {
      display:flex;
      align-items:center;
      gap:12px;
      flex:1 1 auto;
      min-width:0;
      flex-wrap:wrap;
    }

    .page-head__title .title {
      margin:0;
      flex:1 1 auto;
      min-width:0;
    }

    .title {
      font-size:24px;
      font-weight:800;
      margin:0;
    }

    .logo {
      height:50px;
      margin-left:auto;
      flex-shrink:0;
    }

    .nav {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin:4px 0 0;
    }

    .nav .tab {
      padding:7px 12px;
      border-radius:999px;
      border:1px solid var(--grid);
      background:transparent;
      color:var(--ink);
      font-weight:700;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:box-shadow .15s ease,border-color .15s ease,background .15s ease;
    }

    .nav .tab[aria-selected="true"],
    .nav .tab:focus-visible {
      outline:none;
      border-color:var(--als-blue);
      background:color-mix(in srgb,var(--als-blue) 8%,var(--paper));
      box-shadow:0 0 0 2px color-mix(in srgb,var(--als-blue) 30%,transparent);
    }

    .site-filter {
      display:flex;
      align-items:center;
      gap:4px;
      flex-wrap:wrap;
    }

    .site-filter__label {
      font-weight:600;
      color:var(--muted);
      font-size:12px;
    }

    .site-filter__label [data-role="site-filter-active"] {
      color:var(--ink);
      font-weight:700;
    }

    .site-filter__tabs {
      display:flex;
      gap:4px;
      flex-wrap:wrap;
    }

    .site-filter__tab {
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--grid);
      background:transparent;
      color:var(--ink);
      font-weight:700;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      cursor:pointer;
      transition:box-shadow .15s ease,border-color .15s ease,background .15s ease;
      white-space:nowrap;
    }

    .site-filter__tab[aria-pressed="true"],
    .site-filter__tab:focus-visible {
      outline:none;
      border-color:var(--als-blue);
      background:color-mix(in srgb,var(--als-blue) 8%,var(--paper));
      box-shadow:0 0 0 2px color-mix(in srgb,var(--als-blue) 30%,transparent);
    }

    .site-filter__tab[disabled] {
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
    }

    .top-rule {
      height:2px;
      background:var(--als-blue);
      border-bottom:1px solid var(--als-blue-strong);
      margin:0;
      position:relative;
      z-index:320;
    }

    .pssr-overview {
      margin:12px 0 8px;
      padding:16px;
      border:1px solid color-mix(in srgb,var(--grid) 72%,transparent);
      border-radius:16px;
      background:var(--surface-subtle);
      display:grid;
      gap:16px;
      grid-template-columns:minmax(0,1fr);
    }

    .pssr-overview__summary {
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .pssr-overview__insights {
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .pssr-site-panel {
      display:flex;
      flex-direction:column;
      gap:10px;
      border-radius:10px;
      padding:10px 12px;
      border:1px solid color-mix(in srgb,var(--grid) 68%,transparent);
      background:var(--surface-strong);
      box-shadow:0 3px 8px rgba(15,23,42,0.08);
      grid-column:1 / -1;
    }

    .pssr-overview__eyebrow {
      font-size:12px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--als-blue);
      margin:0;
    }

    .pssr-overview__headline {
      margin:0;
      font-size:19px;
      font-weight:750;
      line-height:1.28;
    }

    .pssr-overview__description {
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
      max-width:48ch;
    }

    .pssr-signal {
      border-radius:12px;
      padding:14px 16px;
      display:grid;
      gap:6px;
      border:1px solid color-mix(in srgb,var(--als-blue) 18%,transparent);
      background:color-mix(in srgb,var(--als-blue) 6%,var(--paper));
      box-shadow:0 4px 12px rgba(15,23,42,0.1);
      transition:background .18s ease, border-color .18s ease, box-shadow .18s ease;
    }

    .pssr-signal[data-state="critical"] {
      border-color:color-mix(in srgb,var(--risk-critical) 60%,transparent);
      background:color-mix(in srgb,var(--risk-critical) 16%,var(--paper));
      box-shadow:0 12px 28px rgba(220,38,38,0.18);
    }

    .pssr-signal[data-state="warning"] {
      border-color:color-mix(in srgb,var(--risk-warning) 60%,transparent);
      background:color-mix(in srgb,var(--risk-warning) 18%,var(--paper));
      box-shadow:0 10px 24px rgba(180,83,9,0.18);
    }

    .pssr-signal[data-state="stable"] {
      border-color:color-mix(in srgb,var(--risk-ok) 45%,transparent);
      background:color-mix(in srgb,var(--risk-ok) 18%,var(--paper));
      box-shadow:0 8px 20px rgba(5,150,105,0.16);
    }

    .pssr-signal[data-state="empty"] {
      background:color-mix(in srgb,var(--als-blue) 4%,var(--paper));
      border-color:color-mix(in srgb,var(--grid) 75%,transparent);
      box-shadow:none;
    }

    .pssr-signal__label {
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:color-mix(in srgb,var(--muted) 82%,var(--ink));
      font-weight:700;
    }

    .pssr-signal__value {
      font-size:26px;
      font-weight:900;
      letter-spacing:-0.01em;
    }

    .pssr-signal__note {
      margin:0;
      font-size:12px;
      color:color-mix(in srgb,var(--muted) 72%,var(--ink));
      max-width:44ch;
    }

    .pssr-risk-panel {
      border-radius:12px;
      padding:14px 14px 16px;
      border:1px solid color-mix(in srgb,var(--grid) 70%,transparent);
      background:color-mix(in srgb,var(--paper) 92%,var(--als-blue) 3%);
      box-shadow:0 4px 12px rgba(15,23,42,0.08);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .pssr-risk-panel__title {
      font-size:13px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:color-mix(in srgb,var(--muted) 68%,var(--ink));
      margin:0;
    }

    .pssr-risk-panel__message {
      margin:0;
      font-size:13px;
      font-weight:600;
    }

    .pssr-risk-panel[data-state="critical"] .pssr-risk-panel__message { color:var(--risk-critical); }
    .pssr-risk-panel[data-state="warning"] .pssr-risk-panel__message { color:var(--risk-warning); }
    .pssr-risk-panel[data-state="stable"] .pssr-risk-panel__message { color:var(--risk-ok); }

    .pssr-risk-bar {
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .pssr-risk-bar__track {
      position:relative;
      width:100%;
      height:10px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid color-mix(in srgb,var(--grid) 80%,transparent);
      background:color-mix(in srgb,var(--paper) 95%,var(--als-blue) 4%);
    }

    .pssr-risk-bar__segment {
      position:absolute;
      top:0;
      bottom:0;
      transition:width .24s ease;
    }

    .pssr-risk-bar__segment.is-alert { background:color-mix(in srgb,var(--risk-critical) 90%,transparent); }
    .pssr-risk-bar__segment.is-warning { background:color-mix(in srgb,var(--risk-warning) 90%,transparent); }
    .pssr-risk-bar__segment.is-ok { background:color-mix(in srgb,var(--risk-ok) 80%,transparent); }

    .pssr-risk-bar__legend {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:11px;
      color:color-mix(in srgb,var(--muted) 70%,var(--ink));
    }

    .pssr-risk-bar__legend-item {
      display:inline-flex;
      align-items:center;
      gap:5px;
      font-weight:600;
    }

    .pssr-risk-bar__dot {
      width:10px;
      height:10px;
      border-radius:50%;
      background:currentColor;
      opacity:0.9;
    }

    .pssr-risk-bar__legend-item.is-alert { color:var(--risk-critical); }
    .pssr-risk-bar__legend-item.is-warning { color:var(--risk-warning); }
    .pssr-risk-bar__legend-item.is-ok { color:var(--risk-ok); }

    .pssr-site-panel__title {
      margin:0;
      font-size:12.5px;
      font-weight:780;
      letter-spacing:0.06em;
      text-transform:uppercase;
    }

    .pssr-site-panel__hint {
      margin:0;
      font-size:10.5px;
      color:color-mix(in srgb,var(--muted) 66%,var(--ink));
      max-width:46ch;
    }

    .pssr-site-breakdown {
      list-style:none;
      margin:0;
      padding:0;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(clamp(200px,20vw,260px),1fr));
      gap:8px;
      align-items:stretch;
      justify-content:stretch;
      grid-auto-rows:1fr;
    }

    @media (max-width: 720px) {
      .pssr-site-breakdown {
        grid-template-columns:minmax(0,1fr);
      }
    }

    .pssr-site-breakdown__item {
      padding:8px 10px;
      border-radius:8px;
      border:1px solid color-mix(in srgb,var(--grid) 74%,transparent);
      background:color-mix(in srgb,var(--paper) 94%,var(--als-blue) 3%);
      display:grid;
      gap:5px;
      box-shadow:0 2px 6px rgba(15,23,42,0.08);
    }

    .pssr-site-breakdown__item.is-empty {
      text-align:center;
      color:var(--muted);
      font-weight:600;
    }

    .pssr-site-breakdown__header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .pssr-site-breakdown__name {
      font-weight:720;
      font-size:12.5px;
    }

    .pssr-site-breakdown__status {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(92px,1fr));
      gap:8px;
      align-items:stretch;
    }

    .pssr-site-breakdown__badge {
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:4px;
      border-radius:12px;
      padding:10px 8px;
      min-height:76px;
      text-align:center;
      font-size:10.5px;
      font-weight:630;
      letter-spacing:-0.01em;
      background:color-mix(in srgb,var(--als-blue) 8%,var(--paper));
      color:color-mix(in srgb,var(--muted) 52%,var(--ink));
      border:1px solid color-mix(in srgb,var(--grid) 74%,transparent);
      box-shadow:0 3px 10px rgba(15,23,42,0.08);
      cursor:pointer;
      appearance:none;
      background-clip:padding-box;
      transition:background .15s ease,color .15s ease,border-color .15s ease,box-shadow .15s ease,transform .15s ease;
    }

    .pssr-site-breakdown__badge:focus-visible {
      outline:none;
      border-color:color-mix(in srgb,var(--als-blue) 65%,transparent);
      box-shadow:0 0 0 3px color-mix(in srgb,var(--als-blue) 30%,transparent);
    }

    .pssr-site-breakdown__badge:hover {
      transform:translateY(-1px);
      box-shadow:0 5px 14px rgba(15,23,42,0.14);
    }

    .pssr-site-breakdown__badge[aria-pressed="true"] {
      background:color-mix(in srgb,var(--als-blue) 18%,var(--paper));
      border-color:color-mix(in srgb,var(--als-blue) 70%,transparent);
      color:color-mix(in srgb,var(--als-blue-strong) 85%,var(--ink));
      box-shadow:0 7px 18px rgba(15,23,42,0.2);
      transform:translateY(-1px);
    }

    .pssr-site-breakdown__badge[data-empty="true"] {
      opacity:0.55;
      border-style:dashed;
      cursor:default;
      transform:none;
      box-shadow:0 3px 10px rgba(15,23,42,0.08);
    }

    .pssr-site-breakdown__badge[data-empty="true"]:hover {
      transform:none;
      box-shadow:0 3px 10px rgba(15,23,42,0.08);
    }

    .pssr-site-breakdown__badge.is-total {
      background:color-mix(in srgb,var(--als-blue) 16%,var(--paper));
      border-color:color-mix(in srgb,var(--als-blue) 55%,transparent);
      color:color-mix(in srgb,var(--ink) 85%,var(--als-blue));
    }

    .pssr-site-breakdown__badge.is-alert {
      background:color-mix(in srgb,var(--risk-critical) 20%,var(--paper));
      border-color:color-mix(in srgb,var(--risk-critical) 65%,transparent);
      color:var(--risk-critical);
    }

    .pssr-site-breakdown__badge.is-warning {
      background:color-mix(in srgb,var(--risk-warning) 22%,var(--paper));
      border-color:color-mix(in srgb,var(--risk-warning) 65%,transparent);
      color:var(--risk-warning);
    }

    .pssr-site-breakdown__badge.is-ok {
      background:color-mix(in srgb,var(--risk-ok) 22%,var(--paper));
      border-color:color-mix(in srgb,var(--risk-ok) 55%,transparent);
      color:var(--risk-ok);
    }

    .pssr-site-breakdown__count {
      font-size:20px;
      font-weight:760;
      line-height:1;
      color:currentColor;
    }

    .pssr-site-breakdown__label {
      font-size:10.5px;
      font-weight:610;
      text-transform:capitalize;
      color:color-mix(in srgb,currentColor 78%,var(--muted));
    }

    @media (min-width: 960px){
      .pssr-overview {
        grid-template-columns:minmax(0,1.35fr) minmax(0,1.05fr);
        align-items:start;
      }
      .pssr-site-panel {
        grid-column:1 / -1;
      }
    }

    @media (min-width: 1280px){
      .pssr-overview {
        grid-template-columns:minmax(0,1.35fr) minmax(0,1.05fr) minmax(0,0.9fr);
      }
      .pssr-site-panel {
        grid-column:1 / -1;
      }
    }

    @media (max-width: 640px){
      .pssr-overview {
        padding:14px;
        gap:12px;
      }
      .pssr-signal {
        padding:12px 14px;
      }
      .pssr-risk-panel {
        padding:12px 14px;
      }
      .pssr-site-panel {
        padding:12px 14px;
      }
    }

    .sticky-top {
      position:static;
      top:auto;
      z-index:initial;
      background:color-mix(in srgb,var(--bg) 20%,transparent);
      border-bottom:1px solid color-mix(in srgb,var(--border) 55%,transparent);
      padding:10px 0;
      margin:0;
      backdrop-filter:blur(12px);
    }

    .sticky-top__content {
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      row-gap:8px;
      flex-wrap:wrap;
    }

    .controls-bar {
      background:transparent;
      border:0;
      box-shadow:none;
      padding:4px 0;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }

    .controls-bar>* {
      flex:0 0 auto;
    }

    .sticky-controls {
      display:flex;
      gap:6px;
      row-gap:4px;
      align-items:center;
      flex-wrap:wrap;
    }


    .pssr-content {
      display:flex;
      flex-direction:column;
      gap:18px;
      align-items:stretch;
      margin-top:18px;
    }

    .document-viewer {
      border:1px solid color-mix(in srgb,var(--grid) 78%,transparent);
      border-radius:14px;
      background:color-mix(in srgb,var(--paper) 96%,var(--als-blue) 1%);
      box-shadow:0 4px 10px rgba(15,23,42,0.05);
      min-height:clamp(420px, 50vh, 640px);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
    }

    .document-viewer__controls {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 18px;
      background:color-mix(in srgb,var(--paper) 94%,var(--als-blue) 4%);
      border-bottom:1px solid color-mix(in srgb,var(--grid) 70%,transparent);
    }

    .document-viewer__title {
      margin:0;
      font-size:14px;
      font-weight:600;
      color:var(--ink);
    }

    .document-viewer__toggle {
      appearance:none;
      border:1px solid color-mix(in srgb,var(--btn-outline-bd) 80%,transparent);
      background:var(--btn-ghost-bg);
      color:var(--btn-ghost-fg);
      border-radius:999px;
      font-weight:600;
      font-size:12px;
      padding:6px 12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:background .18s ease,border-color .18s ease,color .18s ease;
    }

    .document-viewer__toggle:hover {
      background:var(--btn-ghost-bg-hover);
    }

    .document-viewer__toggle:focus {
      outline:0;
      border-color:var(--btn-outline-bd);
      box-shadow:0 0 0 3px color-mix(in oklab,var(--btn-outline-bd) 30%,transparent);
    }

    .document-viewer__body {
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .document-viewer__body iframe {
      border:0;
      flex:1 1 auto;
      width:100%;
      min-height:inherit;
      background:var(--paper);
    }

    .document-viewer__body .placeholder {
      padding:18px;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }

    .document-viewer__body .chip-stack {
      gap:4px;
    }

    .document-viewer__body .chip-cat {
      margin:2px 4px 2px 0;
      font-size:11px;
      padding:3px 8px;
    }

    .document-viewer[data-viewer-collapsed="true"] {
      min-height:auto;
    }

    .document-viewer[data-viewer-collapsed="true"] .document-viewer__controls {
      border-bottom:0;
    }

    body[data-table-mode="mobile"] .document-viewer {
      display:none;
    }

    body[data-table-mode="mobile"] .pssr-content {
      display:none;
    }


    .sort-control {
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
    }

    .sort-control__label {
      color:var(--muted);
      font-weight:600;
    }

    .search-control,
    .category-filter {
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
    }

    .controls-bar > .category-filter {
      flex:1 1 100%;
    }

    .category-filter + .search-control,
    .category-filter + .sort-control,
    .category-filter + .mobile-sort {
      margin-top:4px;
    }

    .search-control label,
    .category-filter__label {
      color:var(--muted);
      font-weight:600;
    }

    .category-filter__label {
      display:block;
    }

    .search-control input {
      background:var(--input-bg);
      color:var(--input-fg);
      border:1px solid var(--input-bd);
      border-radius:10px;
      padding:6px 10px;
      font:inherit;
      transition:border-color .18s ease,box-shadow .18s ease,background-color .18s ease;
      min-width:0;
    }

    .category-hotbar {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(148px,1fr));
      gap:8px;
    }

    .category-hotbar__btn {
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:6px;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--paper);
      color:var(--ink);
      box-shadow:var(--shadow);
      cursor:pointer;
      font:inherit;
      font-size:12px;
      text-align:left;
      transition:background-color .18s ease,border-color .18s ease,box-shadow .18s ease,transform .12s ease;
    }

    .category-hotbar__btn:hover {
      background:color-mix(in srgb,var(--als-blue) 6%,var(--paper));
      transform:translateY(-1px);
    }

    .category-hotbar__btn:focus-visible {
      outline:2px solid var(--ctrl-ring);
      outline-offset:2px;
    }

    .category-hotbar__btn--active {
      border-color:var(--als-blue);
      box-shadow:0 0 0 2px color-mix(in srgb,var(--als-blue) 30%,transparent);
      background:color-mix(in srgb,var(--als-blue) 12%,var(--paper));
    }

    .category-hotbar__label {
      font-weight:700;
      letter-spacing:.15px;
    }

    .category-hotbar__count {
      font-size:11px;
      color:var(--muted);
      font-weight:600;
    }

    @media (max-width: 720px){
      .category-hotbar {
        grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      }
    }

    .search-control input:focus {
      outline:0;
      border-color:var(--input-bd-focus);
      box-shadow:0 0 0 3px color-mix(in srgb,var(--input-bd-focus) 28%,transparent);
    }

    .sort-control__inputs {
      display:flex;
      align-items:center;
      gap:4px;
    }

    .sort-control select,
    .mobile-sort select {
      background:var(--input-bg);
      color:var(--input-fg);
      border:1px solid var(--input-bd);
      border-radius:10px;
      padding:6px 10px;
      font:inherit;
      transition:border-color .18s ease,box-shadow .18s ease,background-color .18s ease;
      min-width:0;
    }

    .sort-control select:focus,
    .mobile-sort select:focus {
      outline:0;
      border-color:var(--input-bd-focus);
      box-shadow:0 0 0 2px color-mix(in oklab,var(--input-bd-focus) 28%,transparent);
    }

    .sort-control__direction {
      --pad-x:10px;
      --pad-y:5px;
    }

    .mobile-sort {
      display:none;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--ink);
    }

    .mobile-sort label {
      color:var(--muted);
      font-weight:600;
    }

    .btn {
      --pad-x:14px;
      --pad-y:8px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:var(--pad-y) var(--pad-x);
      border-radius:999px;
      font-weight:600;
      line-height:1;
      border:1px solid transparent;
      cursor:pointer;
      transition:transform .02s ease,background .15s ease,border-color .15s ease;
      color:var(--ink);
      background:var(--btn-ghost-bg);
    }

    .btn:active {
      transform:translateY(1px);
    }

    .btn--primary {
      color:var(--btn-fg);
      background:var(--btn-bg);
      border-color:var(--btn-bg);
    }

    .btn--primary:hover {
      background:var(--btn-bg-hover);
    }

    .btn--outline {
      color:var(--btn-outline-fg);
      background:transparent;
      border-color:var(--btn-outline-bd);
    }

    .btn--outline:hover {
      border-color:var(--btn-outline-fg);
    }

    .btn--ghost {
      color:var(--btn-ghost-fg);
      background:var(--btn-ghost-bg);
    }

    .btn--ghost:hover {
      background:var(--btn-ghost-bg-hover);
    }

    .btn--sm {
      --pad-x:10px;
      --pad-y:6px;
      font-size:12px;
    }

    .ctrl-pill {
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      height:36px;
      padding:0 .75rem;
      border-radius:9999px;
      border:1px solid var(--ctrl-pill-border);
      background:var(--ctrl-pill);
      color:var(--ctrl-fg);
      box-shadow:var(--ctrl-shadow);
      font:inherit;
      font-weight:600;
      letter-spacing:.1px;
      cursor:pointer;
      user-select:none;
      transition:background .2s ease,border-color .2s ease,color .2s ease,transform .06s ease;
    }

    .ctrl-pill:hover {
      background:var(--ctrl-hover);
    }

    .ctrl-pill:active {
      transform:translateY(1px);
    }

    .ctrl-pill:focus-visible {
      outline:2px solid var(--ctrl-ring);
      outline-offset:2px;
    }

    .ctrl-pill:disabled {
      opacity:.6;
      cursor:not-allowed;
      box-shadow:none;
    }

    .ctrl-pill__status {
      font-size:11px;
      color:var(--ctrl-muted);
      font-weight:700;
      letter-spacing:.1px;
    }

    .ctrl-pill[data-state="on"] {
      background:color-mix(in srgb,var(--ctrl-on) 16%,var(--ctrl-pill));
      border-color:color-mix(in srgb,var(--ctrl-on) 55%,var(--ctrl-pill-border));
      color:color-mix(in srgb,var(--ctrl-on) 90%,var(--ctrl-fg));
      box-shadow:0 4px 12px rgba(11,103,194,0.18);
    }

    .ctrl-pill[data-state="on"] .ctrl-pill__status {
      color:color-mix(in srgb,var(--ctrl-on) 80%,var(--ctrl-muted));
    }

    .switch-wrap {
      display:inline-flex;
      align-items:center;
      gap:.5rem;
    }

    .switch {
      position:relative;
      width:56px;
      height:28px;
      border-radius:9999px;
      background:color-mix(in oklab,var(--ctrl-fg) 12%,transparent);
      border:1px solid var(--ctrl-pill-border);
      transition:background .2s ease,border-color .2s ease;
    }

    .switch__thumb {
      position:absolute;
      top:3px;
      left:3px;
      width:22px;
      height:22px;
      border-radius:50%;
      background:var(--ctrl-bg);
      box-shadow:var(--ctrl-shadow);
      transition:left .2s ease,background .2s ease;
    }

    [role="switch"][aria-checked="true"] .switch {
      background:color-mix(in oklab,var(--ctrl-on) 40%,transparent);
      border-color:color-mix(in oklab,var(--ctrl-on) 55%,var(--ctrl-pill-border));
    }

    [role="switch"][aria-checked="true"] .switch__thumb {
      left:31px;
      background:var(--ctrl-bg);
    }

    .switch-label {
      color:var(--ctrl-fg);
      font-weight:600;
    }

    .refresh-btn {
      margin-right:auto;
    }

    .table-wrapper {
      margin-top:0;
      width:100%;
      margin-inline:auto;
    }

    table {
      width:100%;
      min-width:var(--table-min-width, 720px);
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }

    .visually-hidden {
      position:absolute !important;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    .table-scroll {
      position:relative;
      overflow-x:auto;
      overflow-y:visible;
      border:1px solid var(--grid);
      border-radius:12px;
      background:var(--paper);
      box-shadow:0 2px 10px rgba(15, 23, 42, 0.05);
      max-height:none;
      padding:0 2px 2px;
    }

    .table-scroll thead {
      position:sticky;
      top:0;
      background:var(--thead);
      z-index:2;
    }

    .table-scroll thead th {
      background:var(--thead);
      color:var(--thead-text);
      font-weight:750;
      letter-spacing:0.1px;
      padding:8px 8px;
      border-bottom:1px solid color-mix(in srgb,#000 18%,transparent);
      text-align:left;
      white-space:nowrap;
      position:relative;
      cursor:pointer;
    }

    .table-scroll thead th[data-col="Planned Start Date"],
    .table-scroll thead th[data-col="Assigned to"],
    .table-scroll thead th[data-col="Last updated"] {
      white-space:normal;
    }

    .table-scroll thead th:first-child {
      border-top-left-radius:12px;
    }

    .table-scroll thead th:last-child {
      border-top-right-radius:12px;
    }

    .table-scroll thead th .sort-arrow {
      display:inline-block;
      margin-left:8px;
      width:0;
      height:0;
      border-left:5px solid transparent;
      border-right:5px solid transparent;
      border-top:7px solid currentColor;
      opacity:0.25;
      transform:translateY(-1px);
      transition:opacity .15s ease, transform .15s ease;
    }

    .table-scroll thead th[data-sort="asc"] .sort-arrow {
      opacity:1;
      transform:translateY(-1px);
    }

    .table-scroll thead th[data-sort="desc"] .sort-arrow {
      opacity:1;
      transform:rotate(180deg) translateY(-1px);
    }

    tbody td {
      padding:6px 8px;
      border-bottom:1px solid var(--grid);
      background:var(--zebra);
      vertical-align:middle;
      word-break:break-word;
      line-height:1.3;
    }

    .table-scroll tbody td[data-col="Assigned to"],
    .table-scroll tbody td[data-col="Location"] {
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .table-scroll tbody td[data-col="Categories"] {
      white-space:normal;
      overflow:visible;
    }

    .chip-cat {
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:4px 10px;
      border:1px solid currentColor;
      background:transparent;
      margin:2px 6px 2px 0;
      font-weight:600;
      font-size:12px;
      line-height:1;
      white-space:nowrap;
    }

    .chip-stack {
      display:flex;
      flex-wrap:wrap;
      gap:4px 6px;
      align-items:center;
    }

    .chip-stack--inline {
      display:inline-flex;
    }

    .table-scroll td[data-col="Categories"] .chip-stack {
      justify-content:flex-start;
    }

    .table-scroll td[data-col="Categories"] .chip-cat {
      margin:0;
      font-size:11px;
      padding:3px 8px;
    }

    tbody tr:last-child td {
      border-bottom:none;
    }

    tbody tr:nth-child(even) td {
      background:color-mix(in srgb,var(--grid) 12%,var(--zebra));
    }

    tbody tr.row-overdue td {
      background:color-mix(in srgb,#dc2626 16%,var(--zebra));
      color:color-mix(in srgb,#1f2937 15%,var(--ink));
    }

    tbody tr.row-done td {
      background:color-mix(in srgb,var(--done-tx) 14%,var(--zebra));
      color:color-mix(in srgb,var(--done-tx) 18%,var(--ink));
    }

    tbody tr.row-done:nth-child(even) td {
      background:color-mix(in srgb,var(--done-tx) 14%,var(--zebra));
    }

    tbody tr.is-active td {
      box-shadow:inset 0 0 0 2px color-mix(in srgb,var(--als-blue) 45%, transparent);
    }

    .table-scroll thead th[data-col="ID"],
    .table-scroll tbody td[data-col="ID"] {
      width:132px;
    }

    .table-scroll thead th[data-col="Created on"],
    .table-scroll tbody td[data-col="Created on"],
    .table-scroll thead th[data-col="Planned Start Date"],
    .table-scroll tbody td[data-col="Planned Start Date"],
    .table-scroll thead th[data-col="Due date"],
    .table-scroll tbody td[data-col="Due date"],
    .table-scroll thead th[data-col="Completed on"],
    .table-scroll tbody td[data-col="Completed on"],
    .table-scroll thead th[data-col="Last updated"],
    .table-scroll tbody td[data-col="Last updated"] {
      width:148px;
    }

    .table-scroll thead th[data-col="Title"],
    .table-scroll tbody td[data-col="Title"] {
      width:260px;
    }

    .table-scroll thead th[data-col="Status"],
    .table-scroll tbody td[data-col="Status"] {
      width:140px;
    }

    .table-scroll thead th[data-col="Priority"],
    .table-scroll tbody td[data-col="Priority"] {
      width:120px;
      white-space:nowrap;
    }

    .table-scroll thead th[data-col="Assigned to"],
    .table-scroll tbody td[data-col="Assigned to"] {
      width:220px;
    }

    .table-scroll thead th[data-col="Location"],
    .table-scroll tbody td[data-col="Location"] {
      width:200px;
    }

    .table-scroll thead th[data-col="Asset"],
    .table-scroll tbody td[data-col="Asset"] {
      width:200px;
    }

    .table-scroll thead th[data-col="Categories"],
    .table-scroll tbody td[data-col="Categories"] {
      width:240px;
    }

    .table-scroll thead th[data-col="ID"] {
      position:sticky;
      left:0;
      z-index:4;
    }

    .table-scroll thead th[data-col="Title"] {
      position:sticky;
      left:132px;
      z-index:4;
      border-right:1px solid color-mix(in srgb, var(--grid) 85%, transparent);
    }

    .table-scroll tbody td[data-col="ID"] {
      position:sticky;
      left:0;
      z-index:1;
      background:var(--zebra);
      border-right:1px solid var(--grid);
      font-weight:600;
    }

    tbody tr:nth-child(even) td[data-col="ID"] {
      background:color-mix(in srgb,var(--grid) 12%,var(--zebra));
    }

    tbody tr.row-overdue td[data-col="ID"] {
      background:color-mix(in srgb,#dc2626 16%,var(--zebra));
      color:color-mix(in srgb,#1f2937 15%,var(--ink));
    }

    tbody tr.row-done td[data-col="ID"] {
      background:color-mix(in srgb,var(--done-tx) 16%,var(--zebra));
      color:color-mix(in srgb,var(--done-tx) 22%,var(--ink));
    }

    tbody tr.is-active td[data-col="ID"] {
      box-shadow:inset 0 0 0 2px color-mix(in srgb,var(--als-blue) 45%, transparent);
    }

    .table-scroll tbody td[data-col="Title"] {
      position:sticky;
      left:132px;
      z-index:1;
      font-weight:700;
      background:var(--zebra);
      border-right:1px solid var(--grid);
    }

    tbody tr:nth-child(even) td[data-col="Title"] {
      background:color-mix(in srgb,var(--grid) 12%,var(--zebra));
    }

    tbody tr.row-overdue td[data-col="Title"] {
      background:color-mix(in srgb,#dc2626 16%,var(--zebra));
      color:color-mix(in srgb,#1f2937 15%,var(--ink));
    }

    tbody tr.row-done td[data-col="Title"] {
      background:color-mix(in srgb,var(--done-tx) 16%,var(--zebra));
      color:color-mix(in srgb,var(--done-tx) 22%,var(--ink));
    }

    tbody tr.is-active td[data-col="Title"] {
      box-shadow:inset 0 0 0 2px color-mix(in srgb,var(--als-blue) 45%, transparent);
    }

    .table-scroll td[data-col="Due date"] {
      white-space:nowrap;
    }

    .countdown-chip {
      display:inline-flex;
      align-items:center;
      font-weight:800;
      font-size:12px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid currentColor;
      font-variant-numeric:tabular-nums;
    }

    .countdown-chip.is-unknown {
      color:var(--muted);
      border-style:dashed;
    }

    .countdown-chip.is-urgent {
      color:#b91c1c;
      background:color-mix(in srgb,#b91c1c 20%,transparent);
      box-shadow:0 0 0 1px color-mix(in srgb,#b91c1c 35%,transparent);
    }

    .countdown-chip.is-warning {
      color:#b45309;
      background:color-mix(in srgb,#b45309 18%,transparent);
    }

    .countdown-chip.is-healthy {
      color:#047857;
      background:color-mix(in srgb,#047857 18%,transparent);
    }

    .countdown-chip.is-excellent {
      color:#0f766e;
      background:color-mix(in srgb,#0f766e 18%,transparent);
    }

    .status-pill {
      --ring:color-mix(in srgb,currentColor 36%,transparent);
      --bg:color-mix(in srgb,currentColor 14%,transparent);
      --glyph:"‚Ä¢";
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      line-height:1;
      letter-spacing:0;
      text-transform:none;
      background:var(--bg);
      color:currentColor;
      border:1px solid var(--ring);
      white-space:nowrap;
      min-width:0;
    }

    .status-pill::before {
      content:"";
      width:14px;
      height:14px;
      display:inline-block;
      background:currentColor;
      mask:var(--icon) no-repeat center/14px 14px;
      -webkit-mask:var(--icon) no-repeat center/14px 14px;
    }

    .status-pill.is-overdue {
      color:var(--risk-critical);
      --bg:color-mix(in srgb,var(--risk-critical) 12%,var(--paper));
      --ring:color-mix(in srgb,var(--risk-critical) 45%,transparent);
      --icon:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='black' d='M7.1 2.2c.35-.7 1.44-.7 1.8 0l5.9 11.8c.31.63-.14 1.4-.9 1.4H2.1c-.76 0-1.21-.77-.9-1.4L7.1 2.2zm.9 3.3c-.34 0-.6.27-.58.6l.17 4.2c.01.32.27.57.58.57s.57-.25.58-.57l.17-4.2c.01-.33-.24-.6-.58-.6zm0 7.1a.9.9 0 1 0 0 1.8.9.9 0 0 0 0-1.8z'/></svg>");
      --glyph:"!";
    }

    .status-pill.is-due {
      color:var(--risk-warning);
      --bg:color-mix(in srgb,var(--risk-warning) 12%,var(--paper));
      --ring:color-mix(in srgb,var(--risk-warning) 45%,transparent);
      --icon:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='black' fill-rule='evenodd' d='M8 1a7 7 0 1 1 0 14A7 7 0 0 1 8 1zm0 2a5 5 0 1 0 0 10A5 5 0 0 0 8 3z'/><rect x='7.25' y='3' width='1.5' height='5' rx='.75' fill='black'/><rect x='7.25' y='8' width='4.5' height='1.5' rx='.75' fill='black'/></svg>");
      --glyph:"‚è≥";
    }

    .status-pill.is-clear {
      color:var(--risk-ok);
      --bg:color-mix(in srgb,var(--risk-ok) 14%,var(--paper));
      --ring:color-mix(in srgb,var(--risk-ok) 45%,transparent);
      --icon:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='black' d='M6.6 12.2 2.9 8.5l1.4-1.4 2.3 2.3 4.9-4.9 1.4 1.4-6.3 6.3z'/></svg>");
      --glyph:"‚úì";
    }

    .status-pill.is-completed {
      color:var(--done-tx);
      --bg:color-mix(in srgb,var(--done-tx) 14%,var(--paper));
      --ring:color-mix(in srgb,var(--done-tx) 45%,transparent);
      --icon:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='black' d='M6.6 12.2 2.9 8.5l1.4-1.4 2.3 2.3 4.9-4.9 1.4 1.4-6.3 6.3z'/></svg>");
      --glyph:"‚úì";
    }

    .status-pill.is-in-progress {
      color:color-mix(in srgb,var(--als-blue) 82%,var(--ink));
      --bg:color-mix(in srgb,var(--als-blue) 12%,var(--paper));
      --ring:color-mix(in srgb,var(--als-blue) 40%,transparent);
      --icon:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='black' fill-rule='evenodd' d='M8 1a7 7 0 1 1 0 14A7 7 0 0 1 8 1zm0 2a5 5 0 1 0 0 10A5 5 0 0 0 8 3z'/><rect x='7.25' y='3' width='1.5' height='5' rx='.75' fill='black'/><rect x='7.25' y='8' width='4.5' height='1.5' rx='.75' fill='black'/></svg>");
      --glyph:"‚è≥";
    }

    .status-pill.is-scheduled {
      color:color-mix(in srgb,var(--muted) 78%,var(--ink));
      --bg:color-mix(in srgb,var(--muted) 12%,var(--paper));
      --ring:color-mix(in srgb,var(--muted) 38%,transparent);
      --icon:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect x='2.5' y='4' width='11' height='9.5' rx='1.5' fill='black'/><rect x='3' y='2' width='2' height='3' rx='1' fill='black'/><rect x='11' y='2' width='2' height='3' rx='1' fill='black'/><rect x='4.5' y='7.5' width='7' height='1.5' rx='.75' fill='white'/></svg>");
      --glyph:"üìÖ";
    }

    .status-pill.is-unknown {
      color:color-mix(in srgb,var(--muted) 65%,var(--ink));
      --bg:color-mix(in srgb,var(--muted) 10%,var(--paper));
      --ring:color-mix(in srgb,var(--muted) 35%,transparent);
      --icon:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='black' d='M8 1.5A6.5 6.5 0 1 0 14.5 8 6.51 6.51 0 0 0 8 1.5zm0 2a2.6 2.6 0 0 1 2.75 2.46c0 1.64-1.38 2.36-1.66 2.66-.12.14-.18.27-.18.53v.45H6.96v-.58c0-.75.26-1.2.84-1.68.34-.3 1-.86 1-1.47A.96.96 0 0 0 8 4.5a.95.95 0 0 0-.96.98H5.54A2.52 2.52 0 0 1 8 3.5zm-.03 6.65a1 1 0 1 1-.01 1.99 1 1 0 0 1 .01-1.99z'/></svg>");
      --glyph:"?";
    }

    @supports not (mask:url("")) {
      .status-pill::before {
        mask:none;
        -webkit-mask:none;
        background:none;
        width:auto;
        margin-right:2px;
        content:var(--glyph, "‚Ä¢");
      }
    }

    .empty-state {
      padding:20px;
      text-align:center;
      color:var(--muted);
    }

    .status-note {
      font-size:12px;
      color:var(--muted);
    }

    .table-scroll[data-loading="true"] tbody {
      opacity:.4;
    }

    .mobile-cards {
      display:none;
      margin-top:18px;
      padding-bottom:24px;
      width:100%;
    }

    body[data-table-mode="mobile"] .table-wrapper {
      display:none;
    }

    body[data-table-mode="mobile"] .mobile-cards {
      display:block;
    }

    body[data-table-mode="mobile"] .sticky-top__content {
      flex-direction:column;
      align-items:flex-start;
    }

    body[data-table-mode="mobile"] .sticky-controls {
      width:100%;
      flex-direction:column;
      align-items:stretch;
      gap:12px;
    }

    body[data-table-mode="mobile"] .sort-control {
      display:none;
    }

    body[data-table-mode="mobile"] .mobile-sort {
      display:grid;
      width:100%;
      gap:8px;
    }

    body[data-table-mode="mobile"] .mobile-sort label {
      font-weight:600;
    }

    body[data-table-mode="mobile"] .mobile-sort select,
    body[data-table-mode="mobile"] .mobile-sort__direction {
      width:100%;
    }

    body[data-table-mode="mobile"] .site-filter {
      width:100%;
      flex-direction:column;
      align-items:stretch;
      gap:10px;
    }

    body[data-table-mode="mobile"] .site-filter__tabs {
      width:100%;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:8px;
    }

    body[data-table-mode="mobile"] .site-filter__tab {
      width:100%;
      justify-content:center;
    }

    body.force-desktop .table-wrapper {
      display:block !important;
    }

    body.force-desktop .mobile-cards {
      display:none !important;
    }

    body.force-desktop .mobile-sort {
      display:none !important;
    }

    .mobile-card {
      border:1px solid var(--grid);
      border-radius:14px;
      padding:12px;
      background:var(--paper);
      display:grid;
      grid-template-columns:1fr auto;
      gap:8px 12px;
      width:100%;
    }

    .mobile-card + .mobile-card {
      margin-top:10px;
    }

    .mobile-card__header {
      grid-column:1/-1;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      width:100%;
    }

    .mobile-card__heading {
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      flex:1 1 auto;
    }

    .mobile-card__title {
      font-weight:800;
      font-size:13px;
      line-height:1.3;
      min-width:0;
    }

    .mobile-card__subtitle {
      font-size:11px;
      color:var(--muted);
      font-weight:600;
      line-height:1.2;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }

    .mobile-card__subtitle span + span::before {
      content:'‚Ä¢';
      margin:0 3px;
      color:color-mix(in srgb,var(--muted) 78%,var(--ink));
      font-weight:400;
    }

    .mobile-card__subtitle .chip-stack {
      gap:4px;
    }

    .mobile-card__subtitle .chip-cat {
      margin:0;
      font-size:10px;
      padding:3px 6px;
    }

    .mobile-card__chip {
      align-self:flex-start;
      font-size:11px;
      padding-inline:8px;
      white-space:nowrap;
    }

    .mobile-card__details {
      grid-column:1/-1;
      margin:0;
      padding:0;
      display:flex;
      flex-wrap:wrap;
      gap:8px 12px;
      row-gap:6px;
      align-items:center;
    }

    .mobile-card__details dt,
    .mobile-card__details dd {
      margin:0;
      font-size:11px;
    }

    .mobile-card__detail-label {
      font-weight:600;
      letter-spacing:0;
      text-transform:none;
      color:var(--muted);
    }

    .mobile-card__detail-label::after {
      content:':';
      margin-left:4px;
      opacity:.65;
    }

    .mobile-card__detail-value {
      font-weight:700;
      color:var(--ink);
      text-align:left;
      word-break:break-word;
    }

    .mobile-card__detail-value--wide {
      flex:1 1 100%;
    }

    .mobile-card__note {
      grid-column:1/-1;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .mobile-card__note-label {
      font-size:11px;
      font-weight:600;
      letter-spacing:0;
      text-transform:none;
      color:var(--muted);
    }

    .mobile-card__note-text {
      margin:0;
      font-size:11px;
      line-height:1.4;
      color:color-mix(in srgb,var(--ink) 80%,var(--muted));
    }

    .mobile-card__actions {
      width:100%;
      display:flex;
      justify-content:flex-start;
      margin:0;
    }

    .mobile-card__action {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      font-weight:600;
      color:var(--als-blue);
      text-decoration:none;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid color-mix(in srgb,var(--als-blue) 60%,transparent);
      background:color-mix(in srgb,var(--als-blue) 10%,var(--paper));
      transition:background .18s ease,border-color .18s ease,color .18s ease;
    }

    .mobile-card__action:hover,
    .mobile-card__action:focus-visible {
      background:color-mix(in srgb,var(--als-blue) 18%,var(--paper));
      border-color:color-mix(in srgb,var(--als-blue) 75%,transparent);
      outline:none;
    }

    .mobile-card.row-overdue {
      border-color:color-mix(in srgb,#dc2626 45%,var(--grid));
    }

    .mobile-card.row-done {
      border-color:color-mix(in srgb,var(--done-tx) 45%,var(--grid));
      box-shadow:0 0 0 1px color-mix(in srgb,var(--done-tx) 28%,transparent);
      background:color-mix(in srgb,var(--done-tx) 14%,var(--paper));
    }

    .mobile-card--status {
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      color:var(--muted);
      font-weight:600;
      min-height:96px;
      gap:8px;
    }

    @media (min-width: 560px) {
      .mobile-card {
        padding:14px;
        gap:10px 14px;
      }
    }

    @media (max-width:540px) {
      .mobile-card {
        padding:11px;
        gap:8px 12px;
      }
    }

    @media (max-width:420px) {
      .mobile-card__details {
        column-gap:8px;
      }

      .mobile-card__detail-label {
        font-size:9px;
      }
    }

    @media (max-width:1170px) {
      .page {
        --page-pad-inline:24px;
      }
      table {
        min-width:var(--table-min-width, 720px);
      }
    }

    @media (max-width:1248px) {
      .page { --page-pad-top:16px; --page-pad-inline:clamp(16px,6vw,24px); --page-pad-bottom:40px; }
      .table-wrapper { display:none; }
      .mobile-cards { display:flex; flex-direction:column; align-items:center; gap:10px; padding-bottom:24px; }
      .sticky-top__content { flex-direction:column; align-items:flex-start; }
      .sticky-controls { width:100%; flex-direction:column; align-items:stretch; gap:12px; }
      .search-control,
      .category-filter { width:100%; }
      .search-control input { width:100%; }
      .mobile-sort { display:grid; width:100%; gap:8px; }
      .mobile-sort label { font-weight:600; }
      .mobile-sort select { width:100%; }
      .mobile-sort__direction { width:100%; }
    }

    @media print {
      body::before { display:none; }
      .sticky-top { position:static; }
      .table-scroll { max-height:none; box-shadow:none; border-radius:0; }
      .mobile-cards { display:none !important; }
    }
  </style>
  <script>
    // Force light mode immediately to prevent flash of dark mode
    (function(){
      const stored = localStorage.getItem('theme');
      if(stored !== 'dark') {
        document.documentElement.classList.add('light');
        document.documentElement.setAttribute('color-scheme', 'light');
      }
    })();
  </script>
</head>
<body class="light">
  <div class="page">
    <header class="page-head">
      <div class="page-head__title">
        <h1 class="title">Inspections Tracker</h1>
        <nav class="nav" aria-label="Dashboard sections">
          <a class="tab" href="index.html">Work Orders</a>
          <a class="tab" href="facilities.html">Facilities</a>
          <a class="tab" href="pssr.html">PSSR Inspections</a>
          <a class="tab" aria-selected="true" href="inspections.html">Inspections Tracker</a>
        </nav>
      </div>
      <img src="LOGOlesswhitespace.png" alt="ALS Engineering" class="logo" />
    </header>
    <div class="top-rule" role="presentation"></div>
    <section class="pssr-overview">
      <div class="pssr-overview__summary">
        <div class="pssr-signal" data-role="inspections-signal" data-state="empty">
          <span class="pssr-signal__label">Current risk posture</span>
          <span class="pssr-signal__value" data-role="inspections-signal-value">‚Äî</span>
          <p class="pssr-signal__note" data-role="inspections-signal-note">Awaiting data</p>
        </div>
      </div>
      <div class="pssr-overview__insights">
        <section class="pssr-risk-panel" aria-label="Risk snapshot" data-role="inspections-risk">
          <h3 class="pssr-risk-panel__title">Risk snapshot</h3>
          <p class="pssr-risk-panel__message" data-role="inspections-risk-message">Awaiting inspection data.</p>
          <div class="pssr-risk-bar">
            <div class="pssr-risk-bar__track" data-role="inspections-risk-track">
              <span class="pssr-risk-bar__segment is-alert" data-role="inspections-risk-overdue" style="left:0;width:0%;"></span>
              <span class="pssr-risk-bar__segment is-warning" data-role="inspections-risk-due" style="left:0;width:0%;"></span>
              <span class="pssr-risk-bar__segment is-ok" data-role="inspections-risk-clear" style="left:0;width:0%;"></span>
            </div>
            <div class="pssr-risk-bar__legend">
              <span class="pssr-risk-bar__legend-item is-alert"><span class="pssr-risk-bar__dot" aria-hidden="true"></span><span data-role="inspections-risk-label-overdue">0 overdue</span></span>
              <span class="pssr-risk-bar__legend-item is-warning"><span class="pssr-risk-bar__dot" aria-hidden="true"></span><span data-role="inspections-risk-label-due">0 due soon</span></span>
              <span class="pssr-risk-bar__legend-item is-ok"><span class="pssr-risk-bar__dot" aria-hidden="true"></span><span data-role="inspections-risk-label-clear">0 on track</span></span>
            </div>
          </div>
        </section>
      </div>
      <section class="pssr-site-panel" aria-label="Site health overview">
        <h3 class="pssr-site-panel__title">Site health</h3>
        <p class="pssr-site-panel__hint" data-role="inspections-site-hint">Awaiting inspection data.</p>
        <ul class="pssr-site-breakdown" data-role="inspections-site-breakdown">
          <li class="pssr-site-breakdown__item is-empty">Awaiting inspection data.</li>
        </ul>
      </section>
    </section>
    <section class="sticky-top" data-component="sticky-controls">
      <div class="sticky-top__content">
        <div class="sticky-controls controls-bar">
          <button type="button" class="refresh-btn btn btn--outline" data-action="refresh">Refresh data</button>
          <button class="ctrl-pill switch-wrap" id="layout-toggle" type="button" role="switch" aria-checked="false" aria-label="Switch to mobile view">
            <span class="switch" aria-hidden="true"><span class="switch__thumb"></span></span>
            <span class="switch-label">Auto</span>
          </button>
          <button class="ctrl-pill switch-wrap" id="dark-toggle" type="button" role="switch" aria-checked="false" aria-label="Toggle dark theme">
            <span class="switch" aria-hidden="true"><span class="switch__thumb"></span></span>
            <span class="switch-label">Dark</span>
          </button>
          <div class="site-filter" data-role="site-filter">
            <span class="site-filter__label">Site: <span data-role="site-filter-active">All sites</span></span>
            <div class="site-filter__tabs" role="group" aria-label="Filter inspections by site" data-role="site-nav">
              <button type="button" class="site-filter__tab" data-site-key="all" aria-pressed="true">All sites</button>
              <button type="button" class="site-filter__tab" data-site-key="byron" aria-pressed="false">Byron</button>
              <button type="button" class="site-filter__tab" data-site-key="keith" aria-pressed="false">Keith</button>
              <button type="button" class="site-filter__tab" data-site-key="east-kilbride" aria-pressed="false">East Kilbride</button>
              <button type="button" class="site-filter__tab" data-site-key="mugiemoss" aria-pressed="false">Mugiemoss</button>
            </div>
          </div>
          <div class="category-filter" data-role="category-filter">
            <span class="category-filter__label">Category</span>
            <div class="category-hotbar" data-role="category-hotbar" role="group" aria-label="Quick category filters"></div>
          </div>
          <div class="search-control" data-role="search-control">
            <label for="inspection-search">Search</label>
            <input type="search" id="inspection-search" placeholder="Search inspections" data-role="search-input" autocomplete="off" />
          </div>
          <button type="button" class="ctrl-pill" data-role="exclude-done-toggle" aria-pressed="false" data-state="off">
            <span class="ctrl-pill__label">Exclude done</span>
            <span class="ctrl-pill__status" data-role="exclude-done-status">Off</span>
          </button>
          <div class="sort-control" data-role="sort-control">
            <label class="sort-control__label" for="desktop-sort-select">Sort by</label>
            <div class="sort-control__inputs">
              <select id="desktop-sort-select" data-role="sort-select" aria-label="Select column to sort">
                <option value="Due date" selected>Due date</option>
                <option value="Status">Status</option>
                <option value="Priority">Priority</option>
                <option value="Assigned to">Assigned to</option>
                <option value="Title">Title</option>
                <option value="Created on">Created on</option>
                <option value="Planned Start Date">Planned Start Date</option>
                <option value="Completed on">Completed on</option>
                <option value="Last updated">Last updated</option>
                <option value="Location">Location</option>
                <option value="Asset">Asset</option>
                <option value="Categories">Categories</option>
                <option value="ID">ID</option>
              </select>
              <button type="button" class="sort-control__direction btn btn--ghost btn--sm" data-role="sort-direction" data-direction="asc" aria-label="Toggle sort direction (currently ascending)">Ascending</button>
            </div>
          </div>
          <div class="mobile-sort" data-role="mobile-sort">
            <label for="mobile-sort-select">Sort by</label>
            <select id="mobile-sort-select" data-role="mobile-sort-select" aria-label="Select column to sort">
              <option value="Due date" selected>Due date</option>
              <option value="Status">Status</option>
              <option value="Priority">Priority</option>
              <option value="Assigned to">Assigned to</option>
              <option value="Title">Title</option>
              <option value="Created on">Created on</option>
              <option value="Planned Start Date">Planned Start Date</option>
              <option value="Completed on">Completed on</option>
              <option value="Last updated">Last updated</option>
              <option value="Location">Location</option>
              <option value="Asset">Asset</option>
              <option value="Categories">Categories</option>
              <option value="ID">ID</option>
            </select>
            <button type="button" class="mobile-sort__direction btn btn--outline btn--sm" data-role="mobile-sort-direction" data-direction="asc" aria-label="Toggle sort direction (currently ascending)">Ascending</button>
          </div>
        </div>
      </div>
    </section>
    <div class="pssr-content">
      <section class="table-wrapper" data-component="inspections-table">
        <div class="table-scroll" data-role="scroll-region" data-loading="true">
          <table aria-describedby="inspections-table-caption">
            <caption id="inspections-table-caption" class="visually-hidden">Inspections schedule</caption>
            <thead>
              <tr>
                <th scope="col" data-col="ID" aria-sort="none">ID <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Title" aria-sort="none">Title <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Status" aria-sort="none">Status <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Priority" aria-sort="none">Priority <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Assigned to" aria-sort="none">Assigned to <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Created on" aria-sort="none">Created on <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Planned Start Date" aria-sort="none">Planned Start Date <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Due date" aria-sort="none">Due date <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Completed on" aria-sort="none">Completed on <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Last updated" aria-sort="none">Last updated <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Location" aria-sort="none">Location <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Asset" aria-sort="none">Asset <span class="sort-arrow" aria-hidden="true"></span></th>
                <th scope="col" data-col="Categories" aria-sort="none">Categories <span class="sort-arrow" aria-hidden="true"></span></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="13" class="empty-state">Loading inspection data‚Ä¶</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
      <section class="document-viewer" id="viewer" aria-label="Inspection document preview" data-viewer-collapsed="true" hidden>
        <div class="document-viewer__controls">
          <h3 class="document-viewer__title">Inspection document preview</h3>
          <button type="button" class="document-viewer__toggle" data-role="viewer-toggle" aria-expanded="false" aria-controls="viewer-body" aria-label="Expand inspection document preview">Expand preview</button>
        </div>
        <div class="document-viewer__body" id="viewer-body" data-role="viewer-content" hidden>
          <div class="placeholder">Select an inspection to preview documentation.</div>
        </div>
      </section>
    </div>
    <section class="mobile-cards" data-role="mobile-cards" aria-live="polite" role="list"></section>
  </div>

    <script>
    const INSPECTIONS_SHEET_NAME = 'Inspections';
    const DEFAULT_INSPECTIONS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1DT58TWpncmpASlYnWzgSGFn61y4eoc9Qz6S5JXcB4ms/gviz/tq?tqx=out:csv';
    const DUE_SOON_DAYS = 30;
    const HIDE_CATEGORY_UI = true; // Temporarily hide selected categories without deleting the logic
    const HIDDEN_CATEGORY_KEYS = ['ppms', 'pssr', 'vent-duct-cleaning', 'flue-stack', 'e-stop-tests'];

    const isCategoryHidden = key => HIDE_CATEGORY_UI && HIDDEN_CATEGORY_KEYS.includes(key);

    const PARAMS = new URLSearchParams(location.search);
    const FORCE_OFFLINE = PARAMS.get('offline') === '1';
    const ALLOW_NETWORK = !FORCE_OFFLINE;
    const DEFAULT_ERROR_MESSAGE = 'We were unable to load the inspection sheet. Please check the network or sheet permissions and try again.';

    const CATEGORY_DEFS = [
      { key: 'all', label: 'All', value: 'all' },
      { key: 'ppms', label: 'PPMs', value: 'PPMs' },
      { key: 'pat-testing', label: 'PAT Testing', value: 'PAT Testing', rx: /(?:\bPAT\b|PAT Testing)/i },
      { key: 'eicr', label: 'EICR', value: 'EICR', rx: /\bEICR\b/i },
      { key: 'gas-safety', label: 'Gas Safety Inspection', value: 'Gas Safety Inspection', rx: /Gas Safety/i },
      { key: 'legionella', label: 'Legionella', value: 'Legionella', rx: /Legionella/i },
      { key: 'e-stop-tests', label: 'E-Stop Tests', value: 'E-Stop Tests', rx: /E-?Stop/i },
      { key: 'loler', label: 'LOLER', value: 'LOLER', rx: /\bLOLER\b/i },
      { key: 'compressor-servicing', label: 'Compressor Servicing', value: 'Compressor Servicing', rx: /Compressor/i },
      { key: 'burner-servicing', label: 'Burner Servicing', value: 'Burner Servicing', rx: /Burner/i },
      { key: 'pssr', label: 'PSSR', value: 'PSSR', rx: /(?:PSSR|Boiler (?:Servicing|Service))/i },
      { key: 'dry-cleaning-servicing', label: 'Dry Cleaning Servicing', value: 'Dry Cleaning Servicing', rx: /(?:Dry Cleaning|\bDCM\b)/i },
      { key: 'vent-duct-cleaning', label: 'Vent/Duct Cleaning', value: 'Vent/Duct Cleaning', rx: /Vent|Duct/i },
      { key: 'flue-stack', label: 'Flue/Stack Inspection & Cleaning', value: 'Flue/Stack Inspection & Cleaning' }
    ];

    const CATEGORY_DEF_BY_VALUE = CATEGORY_DEFS.reduce((acc, def) => {
      acc[def.value.toLowerCase()] = def;
      return acc;
    }, {});

    const CATEGORY_DEF_BY_KEY = CATEGORY_DEFS.reduce((acc, def) => {
      acc[def.key] = def;
      return acc;
    }, {});

    const CATEGORY_REGEX_DEFS = CATEGORY_DEFS.filter(def => def.value !== 'all' && def.rx instanceof RegExp);

    const CATEGORY_FREQUENCY = {
      'PPMs': null,
      'PAT Testing': 12,
      'EICR': 60,
      'Gas Safety Inspection': 12,
      'Legionella': 12,
      'E-Stop Tests': 3,
      'LOLER': 12,
      'Compressor Servicing': 6,
      'Burner Servicing': 6,
      'PSSR': 12,
      'Dry Cleaning Servicing': 6,
      'Flue/Stack Inspection & Cleaning': 12,
      'Vent/Duct Cleaning': 6
    };

    const SITE_KEY_TO_NAME = {
      all: 'All sites',
      byron: 'Byron',
      keith: 'Keith',
      'east-kilbride': 'Cathkin (East Kilbride)',
      mugiemoss: 'Mugiemoss'
    };

    const SITE_NAME_TO_KEY = Object.entries(SITE_KEY_TO_NAME).reduce((acc, [key, name]) => {
      if(key !== 'all'){
        acc[name.toLowerCase()] = key;
      }
      return acc;
    }, {});

    const SITE_NAME_ALIASES = {
      'keith factory - kf (balloch road)': 'keith',
      'keith sorting and packing unit - kp (westerton road)': 'keith'
    };

    const OFFLINE_SAMPLE = [
      {
        'ID': 'MX-4012',
        'Title': 'Fire Alarm Panel',
        'Status': 'On Track',
        'Priority': 'Medium',
        'Assigned to': 'HSE',
        'Created on': '2024-01-12',
        'Planned Start Date': '2024-02-01',
        'Due date': '2024-05-12',
        'Completed on': '2024-02-12',
        'Last updated': '2024-02-13',
        'Location': 'Byron',
        'Asset': 'Fire Alarm Panel',
        'Categories': 'E-Stop Tests',
        'Site': 'Byron',
        'Category': 'E-Stop Tests',
        'Last Done': '2024-02-12',
        'Due Date': '2024-05-12',
        'Owner/Team': 'HSE',
        'WO/Link': 'MX-4012',
        'Notes': 'Quarterly test schedule.'
      },
      {
        'ID': 'MX-3771',
        'Title': 'Main Compressor Service',
        'Status': 'Due Soon',
        'Priority': 'High',
        'Assigned to': 'Engineering',
        'Created on': '2023-11-15',
        'Planned Start Date': '2023-12-01',
        'Due date': '2024-06-01',
        'Completed on': '2023-12-01',
        'Last updated': '2024-01-05',
        'Location': 'Keith',
        'Asset': 'Main Compressor',
        'Categories': 'Compressor Servicing',
        'Site': 'Keith',
        'Category': 'Compressor Servicing',
        'Last Done': '2023-12-01',
        'Due Date': '2024-06-01',
        'Owner/Team': 'Engineering',
        'WO/Link': 'MX-3771',
        'Notes': 'Check vibration levels.'
      },
      {
        'ID': 'MX-3905',
        'Title': 'Legionella Flush',
        'Status': 'On Track',
        'Priority': 'Low',
        'Assigned to': 'Facilities',
        'Created on': '2023-12-15',
        'Planned Start Date': '2024-01-10',
        'Due date': '2024-04-15',
        'Completed on': '2024-01-15',
        'Last updated': '2024-01-16',
        'Location': 'Cathkin (East Kilbride)',
        'Asset': 'Legionella Flush',
        'Categories': 'Legionella',
        'Site': 'Cathkin (East Kilbride)',
        'Category': 'Legionella',
        'Last Done': '2024-01-15',
        'Due Date': '2024-04-15',
        'Owner/Team': 'Facilities',
        'WO/Link': 'MX-3905',
        'Notes': 'Monthly flushing log attached.'
      },
      {
        'ID': 'MX-4120',
        'Title': 'Boiler Burner Service',
        'Status': 'Overdue',
        'Priority': 'High',
        'Assigned to': 'Maintenance',
        'Created on': '2023-09-01',
        'Planned Start Date': '2023-11-01',
        'Due date': '2024-05-20',
        'Completed on': '2023-11-20',
        'Last updated': '2024-02-01',
        'Location': 'Mugiemoss',
        'Asset': 'Boiler Burner',
        'Categories': 'Burner Servicing',
        'Site': 'Mugiemoss',
        'Category': 'Burner Servicing',
        'Last Done': '2023-11-20',
        'Due Date': '2024-05-20',
        'Owner/Team': 'Maintenance',
        'WO/Link': 'MX-4120',
        'Notes': 'Review combustion analysis.'
      },
      {
        'ID': 'MX-4305',
        'Title': 'Dry Cleaning Solvent Recovery',
        'Status': 'On Track',
        'Priority': 'Medium',
        'Assigned to': 'Facilities',
        'Created on': '2024-02-10',
        'Planned Start Date': '2024-03-01',
        'Due date': '2024-07-01',
        'Completed on': '2024-03-02',
        'Last updated': '2024-03-05',
        'Location': 'Byron',
        'Asset': 'Dry Cleaning Unit',
        'Categories': 'Dry Cleaning Servicing',
        'Site': 'Byron',
        'Category': 'Dry Cleaning Servicing',
        'Last Done': '2024-03-02',
        'Due Date': '2024-07-01',
        'Owner/Team': 'Facilities',
        'WO/Link': 'MX-4305',
        'Notes': 'Check solvent filtration and lint build-up.'
      }
    ];

    const state = {
      siteKey: 'all',
      category: 'all',
      categoryHot: 'all',
      search: '',
      sortBy: 'Due date',
      sortDir: 'asc',
      excludeDone: false
    };

    let selectedRowId = '';
    let rowLookup = new Map();

    const DATE_DISPLAY_FORMATTER = new Intl.DateTimeFormat('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });

    const STRING_COLLATOR = new Intl.Collator(undefined, { sensitivity: 'base', numeric: true });

    const LAYOUT_MODE_STORAGE_KEY = 'alsLayoutMode';
    const THEME_STORAGE_KEY = 'theme';

    const CATEGORY_COLOR_PRESETS = [
      ['Search','#E7F3FE','#1887FC'],
      ['Cleaning','#FCEBFF','#EA7BFF'],
      ['Commission','#E7DFFD','#855EF4'],
      ['Contractor','#FFE6CC','#A24900'],
      ['Daily Procedures','#FFE5DF','#FF7C60'],
      ['Damage','#FFF5CC','#CC9900'],
      ['Electrical','#FFE4D0','#FF7439'],
      ['Eng Weekly Meeting','#FFE5DF','#FF7C60'],
      ['Dry Cleaning Servicing','#E0F2FF','#0B67C2'],
      ['Error Codes','#FFDBE6','#FF4A80'],
      ['Fire Safety','#FFDBE6','#FF4A80'],
      ['First Time Fix','#E7F3FE','#1887FC'],
      ['General improvements','#E7DFFD','#855EF4'],
      ['Inspection','#E7F3FE','#1887FC'],
      ['James Indust Cleaner','#D9F5F1','#3FCBBB'],
      ['Leak','#DDF9FC','#1887FC'],
      ['Manufacturers Machine Service Procedure','#FCEBFF','#EA7BFF'],
      ['Mechanical','#E7F3FE','#1A66CC'],
      ['meters','#E7F3FE','#1570B8'],
      ['Monthly Procedures','#FFE4D0','#FF7439'],
      ['Ordering/Purchasing','#DDF9FC','#54DFF2'],
      ['Planned Winter Project','#E7F3FE','#1887FC'],
      ['Plumbing','#FCEBFF','#B24BEA'],
      ['PPM','#E4F9E8','#2FB95A'],
      ['Preventive','#E4F9E8','#2FB95A'],
      ['Product Quality improvements','#E7F3FE','#1887FC'],
      ['Programming','#FFE4D0','#D85E2E'],
      ['Project','#E7F3FE','#2A7BEF'],
      ['Reactive Maintenance','#DDF9FC','#2CCFE3'],
      ['Refrigeration','#D9F5F1','#3FCBBB'],
      ['Safety','#E7F3FE','#1870DA'],
      ['Site maintenance responsabilities','#E7F3FE','#1868C0'],
      ['Smart Check','#FFDBE6','#E43C75'],
      ['Standard Operating Procedure','#FFDBE6','#E43C75'],
      ['Top 5','#E7DFFD','#6D4CE6'],
      ['Training','#E7F3FE','#1870DA'],
      ['Weekly Procedures','#E7F3FE','#1870DA'],
      ['Yearly Procedures','#FFF5CC','#8A6E00'],
      ['Priority','#FFE2E2','#E11D48'],
      ['Zero Emissions','#D9F5F1','#2AAE9E']
    ];

    function esc(value){
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function slugify(value){
      return String(value || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function resolveCategoryValue(value){
      const text = String(value ?? '').trim();
      if(!text) return '';
      const lower = text.toLowerCase();
      if(CATEGORY_DEF_BY_VALUE[lower]){
        return CATEGORY_DEF_BY_VALUE[lower].value;
      }
      for(const def of CATEGORY_REGEX_DEFS){
        if(!(def.rx instanceof RegExp)) continue;
        def.rx.lastIndex = 0;
        if(def.rx.test(text)){
          return def.value;
        }
      }
      const slug = slugify(text);
      if(slug){
        if(CATEGORY_DEF_BY_KEY[slug]){
          return CATEGORY_DEF_BY_KEY[slug].value;
        }
        const slugWithS = `${slug}s`;
        if(CATEGORY_DEF_BY_KEY[slugWithS]){
          return CATEGORY_DEF_BY_KEY[slugWithS].value;
        }
        if(slug.endsWith('s')){
          const singularSlug = slug.slice(0, -1);
          if(CATEGORY_DEF_BY_KEY[singularSlug]){
            return CATEGORY_DEF_BY_KEY[singularSlug].value;
          }
        }
      }
      return text;
    }

    function resolveCategoryKey(value){
      const resolvedValue = resolveCategoryValue(value);
      const lower = resolvedValue.toLowerCase();
      if(lower && CATEGORY_DEF_BY_VALUE[lower]){
        return CATEGORY_DEF_BY_VALUE[lower].key;
      }
      const fallback = slugify(resolvedValue || value || '');
      return fallback;
    }

    function deriveCategoryFromText(title, categories){
      const titleText = String(title ?? '').trim();
      const categoriesText = String(categories ?? '').trim();
      const combined = [categoriesText, titleText].filter(Boolean).join(' ');
      if(!combined){
        return 'PPMs';
      }
      for(const def of CATEGORY_REGEX_DEFS){
        if(!(def.rx instanceof RegExp)) continue;
        def.rx.lastIndex = 0;
        if(def.rx.test(combined)){
          return def.value;
        }
      }
      return 'PPMs';
    }

    const categoryColors = CATEGORY_COLOR_PRESETS.reduce((acc, [label, background, foreground]) => {
      acc[slugify(label)] = { background, foreground };
      return acc;
    }, {});

    function injectCategoryCSS(){
      if(document.getElementById('category-chip-styles')) return;
      const styleEl = document.createElement('style');
      styleEl.id = 'category-chip-styles';
      styleEl.textContent = Object.entries(categoryColors)
        .map(([slug, colors]) => `.chip-cat.cat-${slug}{background:${colors.background};color:${colors.foreground};border-color:${colors.foreground};}`)
        .join('');
      document.head.appendChild(styleEl);
    }

    function hashCategory(label){
      let hash = 0;
      const str = String(label || '');
      for(let i = 0; i < str.length; i += 1){
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }

    function hslToRgb(h, s, l){
      const hue = ((h % 360) + 360) % 360;
      const S = Math.max(0, Math.min(100, s)) / 100;
      const L = Math.max(0, Math.min(100, l)) / 100;
      const c = (1 - Math.abs(2 * L - 1)) * S;
      const x = c * (1 - Math.abs(((hue / 60) % 2) - 1));
      const m = L - c / 2;
      let r1 = 0;
      let g1 = 0;
      let b1 = 0;
      if(hue < 60){
        r1 = c;
        g1 = x;
      }else if(hue < 120){
        r1 = x;
        g1 = c;
      }else if(hue < 180){
        g1 = c;
        b1 = x;
      }else if(hue < 240){
        g1 = x;
        b1 = c;
      }else if(hue < 300){
        r1 = x;
        b1 = c;
      }else{
        r1 = c;
        b1 = x;
      }
      return [r1 + m, g1 + m, b1 + m];
    }

    function srgbToLinear(channel){
      return channel <= 0.04045 ? channel / 12.92 : Math.pow((channel + 0.055) / 1.055, 2.4);
    }

    function relativeLuminance(rgb){
      const [r, g, b] = rgb.map(value => srgbToLinear(Math.max(0, Math.min(1, value))));
      return 0.2126 * r + 0.7152 * g + 0.0722 * b;
    }

    function contrastRatio(bg, fg){
      const bgLum = relativeLuminance(hslToRgb(bg.h, bg.s, bg.l));
      const fgLum = relativeLuminance(hslToRgb(fg.h, fg.s, fg.l));
      const light = Math.max(bgLum, fgLum);
      const dark = Math.min(bgLum, fgLum);
      return (light + 0.05) / (dark + 0.05);
    }

    function fallbackColors(label){
      const hue = hashCategory(label) % 360;
      const background = { h: hue, s: 45, l: 92 };
      const baseForeground = { h: hue, s: 60, l: 32 };
      let foreground = { ...baseForeground };
      while(contrastRatio(background, foreground) < 4.5 && foreground.l > 0){
        foreground = { ...foreground, l: Math.max(0, foreground.l - 10) };
      }
      return {
        background: `hsl(${background.h}, ${background.s}%, ${background.l}%)`,
        foreground: `hsl(${foreground.h}, ${foreground.s}%, ${foreground.l}%)`
      };
    }

    function chipStyle(label, slugOverride){
      const slug = slugOverride || slugify(label);
      const preset = categoryColors[slug];
      if(preset){
        return { className: `cat-${slug}`, style: '' };
      }
      const colors = fallbackColors(label);
      return {
        className: `cat-${slug}`,
        style: `background:${colors.background};border-color:${colors.foreground};color:${colors.foreground}`
      };
    }

    function buildCategoryChips(value){
      const seen = new Set();
      const list = Array.isArray(value)
        ? value.map(item => String(item ?? '').trim())
        : String(value ?? '')
            .split(/[,;]+/)
            .map(item => item.trim());
      return list
        .filter(Boolean)
        .map(cat => {
          const slug = slugify(cat);
          if(seen.has(slug)) return '';
          seen.add(slug);
          const { className, style } = chipStyle(cat, slug);
          const styleAttr = style ? ` style="${style}"` : '';
          const classAttr = className ? ` ${className}` : '';
          return `<span class="chip-cat${classAttr}"${styleAttr}>${esc(cat)}</span>`;
        })
        .filter(Boolean)
        .join('');
    }

    injectCategoryCSS();

    function toStartOfDay(date){
      if(!(date instanceof Date) || isNaN(date)) return null;
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function parseDate(value){
      if(value instanceof Date && !isNaN(value)) return new Date(value.getTime());
      if(typeof value === 'number'){
        if(!Number.isFinite(value)) return null;
        if(value > 1e11){
          const parsedMs = new Date(value);
          return isNaN(parsedMs) ? null : parsedMs;
        }
        const baseSerialDate = new Date(Date.UTC(1899, 11, 30));
        const parsedSerial = new Date(baseSerialDate.getTime() + value * 86400000);
        return isNaN(parsedSerial) ? null : parsedSerial;
      }
      if(!value) return null;
      const str = String(value).trim();
      if(!str) return null;
      const numeric = Number(str);
      if(Number.isFinite(numeric) && str === numeric.toString()){
        return parseDate(numeric);
      }
      const iso = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if(iso){
        const [, y, m, d] = iso;
        const parsed = new Date(Number(y), Number(m) - 1, Number(d));
        return isNaN(parsed) ? null : parsed;
      }
      const european = str.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})(?:[ T](\d{1,2})(?::(\d{2})(?::(\d{2}))?)?)?$/);
      if(european){
        let [, d, m, y, hh = '0', mm = '0', ss = '0'] = european;
        if(y.length === 2){
          const yearNum = Number(y);
          y = yearNum >= 70 ? `19${y}` : `20${y}`;
        }
        const parsed = new Date(
          Number(y),
          Number(m) - 1,
          Number(d),
          Number(hh),
          Number(mm),
          Number(ss)
        );
        return isNaN(parsed) ? null : parsed;
      }
      const parsed = new Date(str);
      return isNaN(parsed) ? null : parsed;
    }

    function formatDate(date){
      if(!(date instanceof Date) || isNaN(date)) return '‚Äî';
      try {
        return DATE_DISPLAY_FORMATTER.format(date);
      } catch {
        const d = date.getDate().toString().padStart(2, '0');
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
      }
    }

    function formatDisplayValue(dateValue, rawValue){
      if(dateValue instanceof Date && !isNaN(dateValue)){
        return formatDate(dateValue);
      }
      const text = String(rawValue ?? '').trim();
      return text ? text : '‚Äî';
    }

    function parseCsv(text){
      const rows = [];
      let current = [];
      let field = '';
      let inQuotes = false;
      for(let i = 0; i < text.length; i++){
        const char = text[i];
        if(inQuotes){
          if(char === '"'){
            if(text[i + 1] === '"'){
              field += '"';
              i++;
            }else{
              inQuotes = false;
            }
          }else{
            field += char;
          }
        }else{
          if(char === '"'){
            inQuotes = true;
          }else if(char === ','){
            current.push(field);
            field = '';
          }else if(char === '\r'){
            continue;
          }else if(char === '\n'){
            current.push(field);
            rows.push(current);
            current = [];
            field = '';
          }else{
            field += char;
          }
        }
      }
      if(field.length || current.length){
        current.push(field);
        rows.push(current);
      }
      if(!rows.length) return [];
      const headers = rows.shift().map((header, index) => {
        const clean = String(header ?? '').replace(/^\uFEFF/, '').trim();
        return clean || `Column ${index + 1}`;
      });
      return rows
        .filter(row => row.some(cell => String(cell ?? '').trim().length))
        .map(row => headers.reduce((acc, header, idx) => {
          acc[header] = row[idx] ?? '';
          return acc;
        }, {}));
    }

    function sanitizeSheetUrl(raw){
      if(!raw) return null;
      const text = String(raw).trim();
      if(!text) return null;
      const normalized = text.startsWith('//') ? `https:${text}` : text;
      try {
        const url = new URL(normalized, location.href);
        if(url.protocol === 'http:') url.protocol = 'https:';
        return url.toString();
      } catch {
        return null;
      }
    }

    function getSheetUrl(){
      const paramUrl = sanitizeSheetUrl(PARAMS.get('sheet'));
      if(paramUrl){
        if(PARAMS.has('gid')){
          try {
            const url = new URL(paramUrl);
            url.searchParams.set('gid', PARAMS.get('gid'));
            url.searchParams.set('output', 'csv');
            return url.toString();
          } catch {
            const sep = paramUrl.includes('?') ? '&' : '?';
            return `${paramUrl}${sep}gid=${encodeURIComponent(PARAMS.get('gid'))}&output=csv`;
          }
        }
        return paramUrl;
      }
      return DEFAULT_INSPECTIONS_SHEET_URL;
    }

    function buildTabUrl(base, tabName){
      if(!base) return null;
      if(/^https?:/i.test(base)){
        try {
          const url = new URL(base, location.href);
          if(tabName){
            url.searchParams.set('sheet', tabName);
            if(PARAMS.has('gid') && tabName === INSPECTIONS_SHEET_NAME){
              url.searchParams.set('gid', PARAMS.get('gid'));
            }else{
              url.searchParams.delete('gid');
            }
          }
          if(!url.searchParams.has('output')){
            url.searchParams.set('output', 'csv');
          }else{
            url.searchParams.set('output', 'csv');
          }
          return url.toString();
        } catch {
          return null;
        }
      }
      const sheetId = base.replace(/\s+/g, '');
      if(!sheetId) return null;
      const encoded = encodeURIComponent(tabName || INSPECTIONS_SHEET_NAME);
      return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encoded}`;
    }

    async function fetchSheetCSV(url){
      if(!ALLOW_NETWORK){
        throw new Error('Network disabled in this environment');
      }
      const response = await fetch(url, { cache: 'no-store' });
      if(!response.ok){
        throw new Error(`Unable to fetch sheet: ${response.status} ${response.statusText}`);
      }
      const text = await response.text();
      return parseCsv(text);
    }

    async function fetchTabByName(sheetUrlOrId, name){
      const base = sheetUrlOrId || DEFAULT_INSPECTIONS_SHEET_URL;
      const tabUrl = buildTabUrl(base, name);
      if(!tabUrl){
        return [];
      }
      try {
        return await fetchSheetCSV(tabUrl);
      } catch (error){
        console.warn('Failed to load tab', name, error);
        return [];
      }
    }

    function getSiteKeyFromName(name){
      const normalized = String(name ?? '').trim().toLowerCase();
      if(SITE_NAME_TO_KEY[normalized]) return SITE_NAME_TO_KEY[normalized];
      if(SITE_NAME_ALIASES[normalized]) return SITE_NAME_ALIASES[normalized];
      return 'all';
    }

    function normalizeWorkOrder(value){
      const text = String(value ?? '').trim();
      if(!text) return { label: '‚Äî', href: '' };
      if(/^https?:\/\//i.test(text)){
        return { label: text, href: text };
      }
      return { label: text, href: '' };
    }

    function buildSearchText(parts){
      return parts
        .filter(Boolean)
        .map(part => String(part).toLowerCase())
        .join(' ');
    }

    function computeStatus(row, lastDate, dueDate, frequencyMonths){
      const today = toStartOfDay(new Date());
      let displayStatus = String(row.Status ?? '').trim();
      let statusKey = '';
      let effectiveDue = dueDate instanceof Date && !isNaN(dueDate) ? new Date(dueDate) : null;

      if(!effectiveDue && lastDate instanceof Date && !isNaN(lastDate) && frequencyMonths){
        const derived = new Date(lastDate);
        derived.setMonth(derived.getMonth() + frequencyMonths);
        if(!isNaN(derived)){
          effectiveDue = derived;
        }
      }

      if(displayStatus){
        const normalized = displayStatus.toLowerCase();
        if(normalized.includes('overdue')){
          statusKey = 'overdue';
        }else if(normalized.includes('due')){
          statusKey = 'due';
        }else if(
          normalized.includes('track') ||
          normalized.includes('complete') ||
          normalized.includes('ok') ||
          normalized.includes('clear') ||
          normalized.includes('done') ||
          normalized.includes('finished') ||
          normalized.includes('closed') ||
          normalized.includes('resolved')
        ){
          statusKey = 'clear';
        }
      }

      let diffDays = null;
      if(effectiveDue && today){
        diffDays = Math.floor((toStartOfDay(effectiveDue).getTime() - today.getTime()) / 86400000);
      }

      const completedDateValid = lastDate instanceof Date && !isNaN(lastDate);
      const frequencyValid = typeof frequencyMonths === 'number' && Number.isFinite(frequencyMonths) && frequencyMonths > 0;

      if(!statusKey){
        if(diffDays != null){
          if(diffDays < 0){
            statusKey = 'overdue';
          }else if(diffDays <= DUE_SOON_DAYS){
            statusKey = 'due';
          }else{
            statusKey = 'clear';
          }
        }else{
          statusKey = 'due';
        }
      }

      if(statusKey === 'clear' && diffDays != null && diffDays < 0){
        let nextDue = null;
        if(completedDateValid){
          if(frequencyValid){
            const projected = new Date(lastDate);
            projected.setMonth(projected.getMonth() + frequencyMonths);
            if(!isNaN(projected) && (!effectiveDue || projected > effectiveDue)){
              nextDue = projected;
            }
          }
          if(!nextDue && effectiveDue && effectiveDue < lastDate){
            nextDue = new Date(lastDate);
          }
        }
        if(nextDue){
          effectiveDue = nextDue;
          diffDays = Math.floor((toStartOfDay(effectiveDue).getTime() - today.getTime()) / 86400000);
        }else{
          diffDays = null;
        }
      }

      if(!displayStatus){
        displayStatus = statusKey === 'overdue' ? 'Overdue' : statusKey === 'due' ? 'Due Soon' : 'On Track';
      }

      return { statusKey, displayStatus, effectiveDue, diffDays };
    }

    function pickField(raw, keys){
      if(!raw || !Array.isArray(keys)) return '';
      let lowerCaseMap = null;
      const getLowerCaseValue = (key) => {
        if(!lowerCaseMap){
          lowerCaseMap = new Map();
          for(const [rawKey, rawValue] of Object.entries(raw)){
            const lowerKey = String(rawKey).trim().toLowerCase();
            if(lowerCaseMap.has(lowerKey)) continue;
            const textValue = rawValue != null ? String(rawValue).trim() : '';
            if(textValue){
              lowerCaseMap.set(lowerKey, rawValue);
            }
          }
        }
        const lookup = lowerCaseMap.get(String(key).trim().toLowerCase());
        return lookup != null ? String(lookup).trim() : '';
      };
      for(const key of keys){
        if(!key) continue;
        if(Object.prototype.hasOwnProperty.call(raw, key)){
          const value = raw[key];
          if(value != null){
            const text = String(value).trim();
            if(text) return text;
          }
        }
        const fallback = getLowerCaseValue(key);
        if(fallback) return fallback;
      }
      return '';
    }

    function normalizeCategoryList(value){
      const raw = Array.isArray(value) ? value.map(item => String(item ?? '').trim()).filter(Boolean) : (() => {
        const text = String(value ?? '').trim();
        if(!text) return [];
        if(text.startsWith('[') && text.endsWith(']')){
          try {
            const parsed = JSON.parse(text);
            if(Array.isArray(parsed)){
              return parsed.map(item => String(item ?? '').trim()).filter(Boolean);
            }
          } catch (error) {
            /* ignore malformed JSON */
          }
        }
        const parts = text.split(/[,;\n]+/);
        if(parts.length <= 1) return [text];
        return parts.map(part => part.replace(/\s+/g, ' ').trim()).filter(Boolean);
      })();
      const seen = new Set();
      const list = [];
      raw.forEach(item => {
        const cleaned = item.replace(/\s+/g, ' ').trim();
        if(!cleaned) return;
        const canonical = resolveCategoryValue(cleaned) || cleaned;
        const key = canonical.toLowerCase();
        if(seen.has(key)) return;
        seen.add(key);
        list.push(canonical);
      });
      return list.sort((a, b) => STRING_COLLATOR.compare(a, b));
    }

    function parseFrequencyMonths(value){
      if(!value) return null;
      const str = String(value).trim();
      if(!str) return null;
      const direct = Number(str);
      if(!Number.isNaN(direct)) return direct;
      const match = str.match(/(-?\d+(?:\.\d+)?)/);
      return match ? Number(match[1]) : null;
    }

    function normalizeRow(raw, index){
      const site = pickField(raw, ['Site', 'Location']);
      const asset = pickField(raw, ['Asset', 'Asset Name', 'Asset Description', 'Asset ID', 'Column 12', 'Column L', 'Equipment', 'Title', 'Equipment Name', 'Name']);
      const title = pickField(raw, ['Title', 'Task', 'Summary', 'Asset', 'Equipment', 'Name']);
      let category = pickField(raw, ['Category', 'Inspection Type', 'Type', 'Discipline']);
      const categories = pickField(raw, ['Categories', 'Category', 'Discipline']);
      const completedRaw = pickField(raw, ['Completed on', 'Last Done', 'Last Completed', 'Last Inspection', 'Last Inspection Date', 'Previous Inspection']);
      const dueRaw = pickField(raw, ['Due date', 'Due Date', 'Next Due', 'Next Inspection', 'Next Inspection Date']);
      const createdRaw = pickField(raw, ['Created on', 'Creation Date', 'Date Created', 'Reported on', 'Opened on']);
      const plannedRaw = pickField(raw, ['Planned Start Date', 'Planned Start', 'Planned Start Date (Local)', 'Planned Start Time']);
      const updatedRaw = pickField(raw, ['Last updated', 'Updated', 'Last Modified', 'Modified']);
      const frequencyText = pickField(raw, ['Frequency (Months)', 'Frequency', 'Interval (Months)', 'Months']);
      const owner = pickField(raw, ['Owner/Team', 'Owner', 'Assigned to', 'Team', 'Owner Team', 'Responsible', 'Inspector']);
      const assignedTo = pickField(raw, ['Assigned to', 'Owner', 'Owner/Team', 'Responsible', 'Inspector']) || owner;
      const priority = pickField(raw, ['Priority', 'Risk', 'Criticality', 'Severity']);
      const notes = pickField(raw, ['Notes', 'Comments', 'Remarks', 'Summary', 'Details', 'Description']);
      const workOrderValue = pickField(raw, ['ID', 'WO/Link', 'WO', 'Work Order', 'Workorder', 'Link', 'URL', 'Document', 'Document Link', 'Attachment', 'Attachment URL', 'File Name', 'File', 'Document URL']);
      const completedDate = parseDate(completedRaw);
      const dueDate = parseDate(dueRaw);
      const createdDate = parseDate(createdRaw);
      const plannedDate = parseDate(plannedRaw);
      const updatedDate = parseDate(updatedRaw);
      const frequencyMonths = parseFrequencyMonths(frequencyText);
      const workOrder = normalizeWorkOrder(workOrderValue);
      const derivationTitle = [title, asset].filter(Boolean).join(' ');
      const canonicalCategory = resolveCategoryValue(category);
      const derivedCategory = deriveCategoryFromText(derivationTitle, categories);
      category = canonicalCategory || derivedCategory;
      const resolvedFrequency = (typeof frequencyMonths === 'number' && !Number.isNaN(frequencyMonths)) ? frequencyMonths : null;
      const fallbackFrequency = CATEGORY_FREQUENCY[category] || null;
      const statusFrequency = resolvedFrequency && resolvedFrequency > 0 ? resolvedFrequency : fallbackFrequency;
      const statusInfo = computeStatus(raw, completedDate, dueDate, statusFrequency);
      const dueDisplay = statusInfo.effectiveDue || dueDate;
      const id = `ins-${index + 1}`;
      const idLabel = workOrder.label || '‚Äî';
      const formattedCompleted = formatDisplayValue(completedDate, completedRaw);
      const formattedDue = formatDisplayValue(dueDisplay, dueRaw);
      const formattedCreated = formatDisplayValue(createdDate, createdRaw);
      const formattedPlanned = formatDisplayValue(plannedDate, plannedRaw);
      const formattedUpdated = formatDisplayValue(updatedDate, updatedRaw);
      const resolvedTitle = title || asset || workOrder.label || '‚Äî';
      const resolvedLocation = pickField(raw, ['Location', 'Site', 'Facility']) || site;
      const normalizedCategories = normalizeCategoryList(categories || category);
      const resolvedCategory = category || (normalizedCategories.length
        ? normalizedCategories[0]
        : (categories || ''));
      const resolvedCategoriesText = normalizedCategories.length
        ? normalizedCategories.join(', ')
        : (categories || resolvedCategory || '');
      const resolvedCategoryKey = resolveCategoryKey(resolvedCategory);

      return {
        __id: id,
        __source: raw,
        Site: site || resolvedLocation || '‚Äî',
        Location: resolvedLocation || site || '‚Äî',
        Asset: asset || resolvedTitle || '‚Äî',
        Title: resolvedTitle,
        Category: resolvedCategory || 'Uncategorised',
        Categories: resolvedCategoriesText || 'Uncategorised',
        __categoryList: normalizedCategories.length ? normalizedCategories : (resolvedCategory ? [resolvedCategory] : []),
        'Last Completed': formattedCompleted,
        'Completed on': formattedCompleted,
        'Next Due': formattedDue,
        'Due date': formattedDue,
        Status: statusInfo.displayStatus,
        Priority: priority || '‚Äî',
        'Assigned to': assignedTo || owner || '‚Äî',
        'Created on': formattedCreated,
        'Planned Start Date': formattedPlanned,
        'Last updated': formattedUpdated,
        'WO/Link': idLabel,
        ID: idLabel,
        Notes: notes || '‚Äî',
        Owner: owner,
        FrequencyMonths: resolvedFrequency != null ? resolvedFrequency : fallbackFrequency,
        __lastDate: completedDate,
        __dueDate: dueDate,
        __effectiveDue: dueDisplay,
        __statusKey: statusInfo.statusKey,
        __statusLabel: statusInfo.displayStatus,
        __countdownDays: statusInfo.diffDays,
        __workOrderHref: workOrder.href,
        __siteKey: getSiteKeyFromName(site || resolvedLocation),
        __categoryKey: resolvedCategoryKey || 'uncategorised',
        __createdDate: createdDate instanceof Date && !isNaN(createdDate) ? createdDate : null,
        __plannedStartDate: plannedDate instanceof Date && !isNaN(plannedDate) ? plannedDate : null,
        __lastUpdatedDate: updatedDate instanceof Date && !isNaN(updatedDate) ? updatedDate : null,
        __searchText: buildSearchText([
          site,
          resolvedLocation,
          asset,
          resolvedTitle,
          resolvedCategory,
          categories,
          owner,
          assignedTo,
          priority,
          notes,
          workOrder.label
        ])
      };
    }

    function getTimeValue(input){
      if(!(input instanceof Date)) return 0;
      const time = input.getTime();
      return Number.isNaN(time) ? 0 : time;
    }

    function getStringValue(input){
      return String(input ?? '').trim().toLowerCase();
    }

    function buildRowFingerprint(row){
      const title = getStringValue(row?.Title);
      const site = getStringValue(row?.Site || row?.Location);
      const due = getTimeValue(row?.__effectiveDue) || getTimeValue(row?.__dueDate);
      const completed = getTimeValue(row?.__lastDate);
      const status = getStringValue(row?.__statusKey || row?.Status);
      if(!title && !site && !due && !completed && !status){
        return '';
      }
      return [title, site, due, completed, status].join('|');
    }

    function rowFreshnessScore(row){
      const updated = getTimeValue(row?.__lastUpdatedDate);
      const created = getTimeValue(row?.__createdDate);
      const due = getTimeValue(row?.__effectiveDue) || getTimeValue(row?.__dueDate);
      return updated || created || due || 0;
    }

    function shouldReplaceDuplicate(existing, candidate){
      if(!existing) return true;
      const existingFreshness = rowFreshnessScore(existing);
      const candidateFreshness = rowFreshnessScore(candidate);
      if(candidateFreshness > existingFreshness) return true;
      if(candidateFreshness < existingFreshness) return false;
      const existingNotesLength = getStringValue(existing?.Notes).length;
      const candidateNotesLength = getStringValue(candidate?.Notes).length;
      if(candidateNotesLength > existingNotesLength) return true;
      if(candidateNotesLength < existingNotesLength) return false;
      const existingHasLink = Boolean(existing?.__workOrderHref);
      const candidateHasLink = Boolean(candidate?.__workOrderHref);
      if(candidateHasLink && !existingHasLink) return true;
      if(existingHasLink && !candidateHasLink) return false;
      return false;
    }

    function normalizeInspectionsRows(rows){
      const list = Array.isArray(rows) ? rows : [];
      const seen = new Map();
      const result = [];
      list.forEach((row, index) => {
        const normalized = normalizeRow(row, index);
        const fingerprint = buildRowFingerprint(normalized);
        if(!fingerprint){
          result.push(normalized);
          return;
        }
        const existing = seen.get(fingerprint);
        if(!existing){
          seen.set(fingerprint, normalized);
          result.push(normalized);
          return;
        }
        if(shouldReplaceDuplicate(existing, normalized)){
          const existingIndex = result.indexOf(existing);
          if(existingIndex !== -1){
            result[existingIndex] = normalized;
          }
          seen.set(fingerprint, normalized);
        }
      });
      return result;
    }

    function normalizeMaintainXToInspections(mxRows){
      const rows = Array.isArray(mxRows) ? mxRows : [];
      const mapped = rows.map((raw) => {
        const title = String(raw['Title'] ?? '').trim();
        const asset = pickField(raw, ['Asset', 'Asset Name', 'Asset Description', 'Asset ID', 'Column 12', 'Column L', 'Equipment']) || title;
        const location = String(raw['Location'] ?? '').trim();
        const categories = String(raw['Categories'] ?? '').trim();
        const rawCategory = String(raw['Category'] ?? '').trim();
        const titleForDerivation = [title, asset].filter(Boolean).join(' ');
        const derivedCategory = deriveCategoryFromText(titleForDerivation, categories);
        const category = resolveCategoryValue(rawCategory) || derivedCategory;
        const frequency = CATEGORY_FREQUENCY[category] || null;
        const assignedRaw = String(raw['Assigned to'] ?? '').trim();
        const owner = assignedRaw.includes(',') ? assignedRaw.split(',')[0].trim() : assignedRaw;
        const id = String(raw['ID'] ?? '').trim();
        const dueRaw = String(raw['Due date'] ?? raw['Due Date'] ?? '').trim();
        const completedRaw = String(raw['Completed on'] ?? raw['Last Done'] ?? '').trim();
        const createdRaw = String(raw['Created on'] ?? '').trim();
        const plannedRaw = String(raw['Planned Start Date'] ?? '').trim();
        const updatedRaw = String(raw['Last updated'] ?? '').trim();
        const statusRaw = String(raw['Status'] ?? '').trim();
        const priorityRaw = String(raw['Priority'] ?? '').trim();
        return {
          'Site': location,
          'Location': location,
          'Asset': asset,
          'Title': title || asset,
          'Category': category,
          'Categories': categories || category,
          'Last Done': completedRaw,
          'Last Completed': completedRaw,
          'Completed on': completedRaw,
          'Due Date': dueRaw,
          'Due date': dueRaw,
          'Frequency (Months)': frequency ? String(frequency) : '',
          'Owner/Team': owner,
          'Assigned to': owner,
          'Status': statusRaw,
          'Priority': priorityRaw,
          'ID': id,
          'WO/Link': id,
          'Created on': createdRaw,
          'Planned Start Date': plannedRaw,
          'Last updated': updatedRaw,
          'Notes': ''
        };
      });
      return normalizeInspectionsRows(mapped);
    }

    function computeCounts(rows){
      const summary = { total: 0, overdue: 0, due: 0, clear: 0, sites: {} };
      rows.forEach(row => {
        summary.total += 1;
        if(row.__statusKey === 'overdue') summary.overdue += 1;
        else if(row.__statusKey === 'due') summary.due += 1;
        else if(row.__statusKey === 'clear') summary.clear += 1;
        const siteName = row.Site;
        if(!summary.sites[siteName]){
          summary.sites[siteName] = { total: 0, overdue: 0, due: 0, clear: 0, siteKey: row.__siteKey };
        }
        const site = summary.sites[siteName];
        site.total += 1;
        if(row.__statusKey === 'overdue') site.overdue += 1;
        else if(row.__statusKey === 'due') site.due += 1;
        else if(row.__statusKey === 'clear') site.clear += 1;
      });
      return summary;
    }

    function rowMatchesFilters(row, { ignoreSite = false } = {}){
      if(HIDE_CATEGORY_UI && isCategoryHidden(row.__categoryKey || resolveCategoryKey(row.Category))){
        return false;
      }
      if(!ignoreSite && state.siteKey !== 'all' && row.__siteKey !== state.siteKey){
        return false;
      }
      if(state.excludeDone && isDoneStatus(row)){
        return false;
      }
      const activeCategory = state.categoryHot || 'all';
      if(activeCategory !== 'all'){
        const rowCategory = resolveCategoryValue(row.Category) || row.Category || '';
        if(rowCategory !== activeCategory) return false;
      }
      if(state.search){
        if(!row.__searchText.includes(state.search.toLowerCase())) return false;
      }
      return true;
    }

    function applyFilters(rows){
      const filtered = rows.filter(row => rowMatchesFilters(row));
      return sortRows(filtered, state.sortBy, state.sortDir);
    }

    function sortRows(rows, column, direction){
      const list = rows.slice();
      const dir = direction === 'desc' ? -1 : 1;
      const col = column || 'Due date';
      const compareString = (a, b) => dir * STRING_COLLATOR.compare(String(a ?? '').toLowerCase(), String(b ?? '').toLowerCase());
      const dateAccessor = (row) => {
        if(col === 'Due date' || col === 'Next Due') return row.__effectiveDue instanceof Date ? row.__effectiveDue.getTime() : 0;
        if(col === 'Completed on' || col === 'Last Completed') return row.__lastDate instanceof Date ? row.__lastDate.getTime() : 0;
        if(col === 'Created on') return row.__createdDate instanceof Date ? row.__createdDate.getTime() : 0;
        if(col === 'Planned Start Date') return row.__plannedStartDate instanceof Date ? row.__plannedStartDate.getTime() : 0;
        if(col === 'Last updated') return row.__lastUpdatedDate instanceof Date ? row.__lastUpdatedDate.getTime() : 0;
        return null;
      };
      list.sort((a, b) => {
        const dateA = dateAccessor(a);
        const dateB = dateAccessor(b);
        if(dateA != null || dateB != null){
          if(dateA !== dateB) return dir * ((dateA ?? 0) - (dateB ?? 0));
        }else{
          const va = a[col] ?? '';
          const vb = b[col] ?? '';
          if(va !== vb) return compareString(va, vb);
        }
        return compareString(a.Title, b.Title);
      });
      return list;
    }

    function isDoneStatus(row){
      const text = String(row?.Status ?? '').trim().toLowerCase();
      if(!text) return false;
      if(text.includes('done')) return true;
      if(text.includes('complete')) return true;
      if(text.includes('closed')) return true;
      return false;
    }

    function countdownChip(row){
      if(isDoneStatus(row)){
        return null;
      }
      const days = row.__countdownDays;
      if(typeof days !== 'number'){
        return { label: 'Due soon', className: 'countdown-chip is-unknown' };
      }
      if(days < 0){
        return { label: `${Math.abs(days)} days overdue`, className: 'countdown-chip is-urgent' };
      }
      if(days === 0){
        return { label: 'Due today', className: 'countdown-chip is-warning' };
      }
      if(days <= DUE_SOON_DAYS){
        return { label: `${days} day${days === 1 ? '' : 's'}`, className: 'countdown-chip is-warning' };
      }
      if(days <= DUE_SOON_DAYS * 2){
        return { label: `${days} days`, className: 'countdown-chip is-healthy' };
      }
      return { label: `${days} days`, className: 'countdown-chip is-excellent' };
    }

    function statusClass(key){
      if(key === 'overdue') return 'status-pill is-overdue';
      if(key === 'due') return 'status-pill is-due';
      if(key === 'clear') return 'status-pill is-clear';
      return 'status-pill is-unknown';
    }

    function updateSortIndicators(){
      const headers = document.querySelectorAll('thead th[data-col]');
      headers.forEach(th => {
        const col = th.getAttribute('data-col');
        if(col === state.sortBy){
          th.setAttribute('aria-sort', state.sortDir === 'asc' ? 'ascending' : 'descending');
          th.dataset.sort = state.sortDir;
        }else{
          th.setAttribute('aria-sort', 'none');
          delete th.dataset.sort;
        }
      });
      const sortSelects = document.querySelectorAll('[data-role="sort-select"], [data-role="mobile-sort-select"]');
      sortSelects.forEach(select => {
        if(select.value !== state.sortBy){
          select.value = state.sortBy;
        }
      });
      const sortButtons = document.querySelectorAll('[data-role="sort-direction"], [data-role="mobile-sort-direction"]');
      sortButtons.forEach(button => {
        button.dataset.direction = state.sortDir;
        button.textContent = state.sortDir === 'asc' ? 'Ascending' : 'Descending';
        button.setAttribute('aria-label', `Toggle sort direction (currently ${state.sortDir === 'asc' ? 'ascending' : 'descending'})`);
      });
    }

    function renderPostureAndRisk(rows){
      const signal = document.querySelector('[data-role="inspections-signal"]');
      const signalValue = document.querySelector('[data-role="inspections-signal-value"]');
      const signalNote = document.querySelector('[data-role="inspections-signal-note"]');
      const riskPanel = document.querySelector('[data-role="inspections-risk"]');
      const riskMsg = document.querySelector('[data-role="inspections-risk-message"]');
      const segmentOverdue = document.querySelector('[data-role="inspections-risk-overdue"]');
      const segmentDue = document.querySelector('[data-role="inspections-risk-due"]');
      const segmentClear = document.querySelector('[data-role="inspections-risk-clear"]');
      const labelOverdue = document.querySelector('[data-role="inspections-risk-label-overdue"]');
      const labelDue = document.querySelector('[data-role="inspections-risk-label-due"]');
      const labelClear = document.querySelector('[data-role="inspections-risk-label-clear"]');

      const counts = computeCounts(rows);
      const total = counts.total;

      if(total === 0){
        signal?.setAttribute('data-state', 'empty');
        if(signalValue) signalValue.textContent = '‚Äî';
        if(signalNote) signalNote.textContent = 'No inspections match the current filters.';
        riskPanel?.setAttribute('data-state', 'stable');
        if(riskMsg) riskMsg.textContent = 'No inspections to display.';
        [segmentOverdue, segmentDue, segmentClear].forEach(seg => { if(seg) seg.style.width = '0%'; });
        [segmentOverdue, segmentDue, segmentClear].forEach(seg => { if(seg) seg.style.left = '0%'; });
        if(labelOverdue) labelOverdue.textContent = '0 overdue';
        if(labelDue) labelDue.textContent = '0 due soon';
        if(labelClear) labelClear.textContent = '0 on track';
        return;
      }

      const overdue = counts.overdue;
      const due = counts.due;
      const clear = counts.clear;
      let posture = 'Good';
      let postureState = 'stable';
      let note = 'All inspections are on track.';
      if(overdue > 0){
        posture = 'Critical';
        postureState = 'critical';
        note = `${overdue} inspection${overdue === 1 ? '' : 's'} are overdue and need immediate action.`;
      }else if(due > 0){
        posture = 'Caution';
        postureState = 'warning';
        note = `${due} inspection${due === 1 ? '' : 's'} are due soon.`;
      }

      signal?.setAttribute('data-state', postureState);
      if(signalValue) signalValue.textContent = posture;
      if(signalNote) signalNote.textContent = note;

      riskPanel?.setAttribute('data-state', postureState);
      if(riskMsg){
        riskMsg.textContent = postureState === 'critical'
          ? 'Address overdue inspections immediately.'
          : postureState === 'warning'
            ? 'Upcoming inspections need scheduling attention.'
            : 'All scheduled inspections are currently on track.';
      }

      const toPercent = (value) => (total ? Math.max(0, Math.min(100, (value / total) * 100)) : 0);
      const pOverdue = toPercent(overdue);
      const pDue = toPercent(due);
      const pClear = Math.max(0, 100 - pOverdue - pDue);

      if(segmentOverdue){
        segmentOverdue.style.left = '0%';
        segmentOverdue.style.width = `${pOverdue}%`;
      }
      if(segmentDue){
        segmentDue.style.left = `${pOverdue}%`;
        segmentDue.style.width = `${pDue}%`;
      }
      if(segmentClear){
        segmentClear.style.left = `${pOverdue + pDue}%`;
        segmentClear.style.width = `${pClear}%`;
      }

      if(labelOverdue) labelOverdue.textContent = `${overdue} overdue`;
      if(labelDue) labelDue.textContent = `${due} due soon`;
      if(labelClear) labelClear.textContent = `${clear} on track`;
    }

    function renderSiteCards(allRows){
      const hint = document.querySelector('[data-role="inspections-site-hint"]');
      const list = document.querySelector('[data-role="inspections-site-breakdown"]');
      if(!list) return;

      const filteredForSiteCards = allRows.filter(row => rowMatchesFilters(row, { ignoreSite: true }));
      const countsBySite = computeCounts(filteredForSiteCards).sites;
      const order = ['Byron', 'Keith', 'Cathkin (East Kilbride)', 'Mugiemoss'];
      const items = order.map(name => {
        const metrics = countsBySite[name] || { total: 0, overdue: 0, due: 0, clear: 0, siteKey: getSiteKeyFromName(name) };
        return { name, metrics };
      });

      const siteHtml = items.map(({ name, metrics }) => {
        const siteKey = metrics.siteKey;
        const isActive = state.siteKey === siteKey;
        const badge = (label, value, className) => `
          <button type="button" class="pssr-site-breakdown__badge ${className}" data-role="inspections-site-kpi" data-site-key="${esc(siteKey)}" data-empty="${value === 0}" aria-pressed="${isActive ? 'true' : 'false'}">
            <span class="pssr-site-breakdown__count">${esc(value)}</span>
            <span class="pssr-site-breakdown__label">${esc(label)}</span>
          </button>`;
        return `
          <li class="pssr-site-breakdown__item" data-site="${esc(siteKey)}" data-selected="${isActive}">
            <div class="pssr-site-breakdown__header">
              <span class="pssr-site-breakdown__name">${esc(name)}</span>
            </div>
            <div class="pssr-site-breakdown__status">
              ${badge('total', metrics.total, 'is-total')}
              ${badge('overdue', metrics.overdue, 'is-alert')}
              ${badge('due soon', metrics.due, 'is-warning')}
              ${badge('on track', metrics.clear, 'is-ok')}
            </div>
          </li>`;
      }).join('');

      list.innerHTML = siteHtml;

      if(hint){
        hint.textContent = state.siteKey === 'all'
          ? 'Select a site to filter.'
          : `Filtering by ${SITE_KEY_TO_NAME[state.siteKey] || 'selected site'}.`;
      }
    }

    function computeCategoryCounts(allRows){
      const counts = new Map();
      const rows = (Array.isArray(allRows) ? allRows : []).filter(row => {
        if(isDoneStatus(row)) return false;
        if(HIDE_CATEGORY_UI && isCategoryHidden(row.__categoryKey || resolveCategoryKey(row?.Category))){
          return false;
        }
        return true;
      });
      rows.forEach(row => {
        const label = resolveCategoryValue(row?.Category) || 'Uncategorised';
        const key = label.toLowerCase();
        const entry = counts.get(key) || { key, label, count: 0 };
        entry.count += 1;
        entry.label = label;
        counts.set(key, entry);
      });
      CATEGORY_DEFS.forEach(def => {
        if(def.value === 'all') return;
        const key = def.value.toLowerCase();
        if(!counts.has(key)){
          counts.set(key, { key, label: def.value, count: 0 });
        }else{
          const entry = counts.get(key);
          entry.label = def.value;
          counts.set(key, entry);
        }
      });
      return { counts, total: rows.length };
    }

    function renderCategoryOptions(allRows, summary){
      const { counts, total } = summary || computeCategoryCounts(allRows);
      renderCategoryHotbar(counts, total);
    }

    function renderCategoryHotbar(counts, totalCount){
      const hotbar = document.querySelector('[data-role="category-hotbar"]');
      if(!hotbar) return;
      if(!hotbar.__wired){
        hotbar.addEventListener('click', event => {
          const button = event.target.closest('[data-category-value]');
          if(!button) return;
          const value = button.getAttribute('data-category-value') || 'all';
          const next = value === state.categoryHot && value !== 'all' ? 'all' : value;
          setActiveCategory(next);
        });
        hotbar.__wired = true;
      }
      const active = state.categoryHot || 'all';
      const definitions = HIDE_CATEGORY_UI
        ? CATEGORY_DEFS.filter(def => !isCategoryHidden(def.key))
        : CATEGORY_DEFS;
      const entries = definitions.map(def => {
        const value = def.value;
        const label = def.label || def.value;
        const key = def.key || slugify(value);
        const entry = counts?.get(value.toLowerCase());
        const count = value === 'all' ? totalCount : (entry?.count ?? 0);
        const isActive = active === value;
        const classes = ['category-hotbar__btn'];
        if(isActive) classes.push('category-hotbar__btn--active');
        const countLabel = `${count} inspection${count === 1 ? '' : 's'}`;
        const title = `${label} ‚Äì ${countLabel}`;
        return `<button type="button" class="${classes.join(' ')}" data-category-key="${esc(key)}" data-category-value="${esc(value)}" aria-pressed="${isActive ? 'true' : 'false'}" title="${esc(title)}"><span class="category-hotbar__label">${esc(label)}</span><span class="category-hotbar__count">${esc(countLabel)}</span></button>`;
      }).join('');
      hotbar.innerHTML = entries;
    }

    function setActiveCategory(value, { triggerRender = true } = {}){
      const normalized = value === 'all' ? 'all' : (resolveCategoryValue(value) || value || 'all');
      const next = normalized || 'all';
      let changed = false;
      if(state.categoryHot !== next){
        state.categoryHot = next;
        changed = true;
      }
      if(state.category !== next){
        state.category = next;
        changed = true;
      }
      if(changed && triggerRender && window.__INSPECTIONS_ALL__){
        renderAll(window.__INSPECTIONS_ALL__);
      }else if(triggerRender && !changed && window.__INSPECTIONS_ALL__ && next === 'all'){
        // No state change but ensure filters clear when toggling All again.
        renderAll(window.__INSPECTIONS_ALL__);
      }
    }

    function renderTable(rows){
      const tbody = document.querySelector('tbody');
      const scroll = document.querySelector('[data-role="scroll-region"]');
      if(!tbody) return;
      window.__INSPECTIONS_VIEW__ = rows.slice();
      const html = rows.length ? rows.map(row => {
        const chip = countdownChip(row);
        const isDone = isDoneStatus(row);
        const statusCls = isDone ? 'status-pill is-completed' : statusClass(row.__statusKey);
        const classes = [];
        if(row.__statusKey === 'overdue') classes.push('row-overdue');
        if(isDone) classes.push('row-done');
        if(row.__id === selectedRowId) classes.push('is-active');
        const classAttr = classes.length ? ` class="${esc(classes.join(' '))}"` : '';
        const dueDateValue = String(row['Due date'] ?? '').trim() || '‚Äî';
        const hasDueDate = dueDateValue && dueDateValue !== '‚Äî';
        const dueAttr = chip && hasDueDate
          ? ` title="${esc(dueDateValue)}" aria-label="${esc(`${chip.label} ‚Äì ${dueDateValue}`)}"`
          : (chip
            ? ` aria-label="${esc(chip.label)}"`
            : '');
        let dueCellAttr = '';
        if(!chip && isDone){
          const ariaNote = hasDueDate
            ? `Completed work order ‚Äì ${dueDateValue}`
            : 'Completed work order';
          dueCellAttr = ` aria-label="${esc(ariaNote)}"`;
        }
        const idCell = row.__workOrderHref
          ? `<a href="${esc(row.__workOrderHref)}" target="_blank" rel="noopener">${esc(row.ID)}</a>`
          : esc(row.ID);
        const categoriesSource = (row.__categoryList && row.__categoryList.length)
          ? row.__categoryList
          : row.Categories;
        const categoriesChips = buildCategoryChips(categoriesSource);
        const categoriesLabel = String(row.Categories ?? '').trim() || 'Uncategorised';
        const categoriesCell = categoriesChips
          ? `<div class="chip-stack">${categoriesChips}</div>`
          : esc(categoriesLabel);
        const dueContent = chip
          ? `<span class="${chip.className}"${dueAttr}>${esc(chip.label)}</span>`
          : '';
        return `
          <tr data-row-id="${esc(row.__id)}"${classAttr}>
            <td data-col="ID">${idCell}</td>
            <td data-col="Title">${esc(row.Title)}</td>
            <td data-col="Status"><span class="${statusCls}">${esc(row.Status)}</span></td>
            <td data-col="Priority">${esc(row.Priority)}</td>
            <td data-col="Assigned to">${esc(row['Assigned to'])}</td>
            <td data-col="Created on">${esc(row['Created on'])}</td>
            <td data-col="Planned Start Date">${esc(row['Planned Start Date'])}</td>
            <td data-col="Due date"${dueCellAttr}>${dueContent}</td>
            <td data-col="Completed on">${esc(row['Completed on'])}</td>
            <td data-col="Last updated">${esc(row['Last updated'])}</td>
            <td data-col="Location">${esc(row.Location)}</td>
            <td data-col="Asset">${esc(row.Asset)}</td>
            <td data-col="Categories">${categoriesCell}</td>
          </tr>`;
      }).join('') : '<tr><td colspan="13" class="empty-state">No inspections match the current filters.</td></tr>';
      tbody.innerHTML = html;
      scroll?.setAttribute('aria-busy', 'false');
      updateSortIndicators();
      highlightSelectedRow();
    }

    function renderMobileCards(rows){
      const container = document.querySelector('[data-role="mobile-cards"]');
      if(!container) return;
      container.innerHTML = rows.length ? rows.map(row => {
        const chip = countdownChip(row);
        const isDone = isDoneStatus(row);
        const statusCls = isDone ? 'status-pill is-completed' : statusClass(row.__statusKey);
        const isActive = row.__id === selectedRowId;
        const classes = [];
        if(row.__statusKey === 'overdue') classes.push('row-overdue');
        if(isDone) classes.push('row-done');
        if(isActive) classes.push('is-active');
        const classNames = classes.length ? ` ${classes.join(' ')}` : '';
        const notes = row.Notes && row.Notes !== '‚Äî' ? row.Notes : 'No additional notes.';
        const workOrder = row.__workOrderHref
          ? `<a class="mobile-card__action" href="${esc(row.__workOrderHref)}" target="_blank" rel="noopener">Open ID</a>`
          : (row.ID && row.ID !== '‚Äî' ? `<span class="mobile-card__action" role="text">${esc(row.ID)}</span>` : '');
        const categoriesSource = (row.__categoryList && row.__categoryList.length)
          ? row.__categoryList
          : row.Categories;
        const categoriesChips = buildCategoryChips(categoriesSource);
        const categoriesLabel = String(row.Categories ?? '').trim() || 'Uncategorised';
        const categoriesSubtitle = categoriesChips
          ? `<span class="chip-stack chip-stack--inline">${categoriesChips}</span>`
          : `<span>${esc(categoriesLabel)}</span>`;
        const chipBlock = chip
          ? `<div class="mobile-card__chip ${chip.className}">${esc(chip.label)}</div>`
          : '';
        return `
          <article class="mobile-card${classNames}" data-row-id="${esc(row.__id)}" role="listitem">
            <header class="mobile-card__header">
              <div class="mobile-card__heading">
                <div class="mobile-card__title">${esc(row.Title)}</div>
                <div class="mobile-card__subtitle"><span>${esc(row.Location)}</span>${categoriesSubtitle}</div>
              </div>
              <span class="${statusCls}">${esc(row.Status)}</span>
            </header>
            ${chipBlock}
            <dl class="mobile-card__details">
              <dt class="mobile-card__detail-label">Priority</dt>
              <dd class="mobile-card__detail-value">${esc(row.Priority)}</dd>
              <dt class="mobile-card__detail-label">Due</dt>
              <dd class="mobile-card__detail-value">${esc(row['Due date'])}</dd>
              <dt class="mobile-card__detail-label">Completed</dt>
              <dd class="mobile-card__detail-value">${esc(row['Completed on'])}</dd>
              <dt class="mobile-card__detail-label">Assigned</dt>
              <dd class="mobile-card__detail-value">${esc(row['Assigned to'] || row.Owner || '‚Äî')}</dd>
            </dl>
            <div class="mobile-card__note">
              <span class="mobile-card__note-label">Notes</span>
              <p class="mobile-card__note-text">${esc(notes)}</p>
            </div>
            ${workOrder ? `<div class="mobile-card__actions">${workOrder}</div>` : ''}
          </article>`;
      }).join('') : '<div class="mobile-card mobile-card--status" role="listitem">No inspections match the current filters.</div>';
    }

    function highlightSelectedRow(){
      const rows = document.querySelectorAll('tbody tr[data-row-id]');
      rows.forEach(tr => {
        const isActive = tr.getAttribute('data-row-id') === selectedRowId;
        tr.classList.toggle('is-active', isActive);
      });
      const cards = document.querySelectorAll('[data-role="mobile-cards"] [data-row-id]');
      cards.forEach(card => {
        const isActive = card.getAttribute('data-row-id') === selectedRowId;
        card.classList.toggle('is-active', isActive);
      });
    }

    function updateViewerContent(row){
      const viewer = document.getElementById('viewer');
      const toggle = document.querySelector('[data-role="viewer-toggle"]');
      const body = document.querySelector('[data-role="viewer-content"]');
      const heading = viewer?.querySelector('.document-viewer__title');
      if(!viewer || !toggle || !body) return;
      if(!row){
        body.innerHTML = '<div class="placeholder">Select an inspection to preview documentation.</div>';
        toggle.setAttribute('aria-expanded', 'false');
        body.hidden = true;
        viewer.setAttribute('data-viewer-collapsed', 'true');
        viewer.hidden = true;
        if(heading) heading.textContent = 'Inspection document preview';
        return;
      }
      const notes = row.Notes && row.Notes !== '‚Äî' ? row.Notes : 'No additional notes.';
      const assigned = row['Assigned to'] || row.Owner || '‚Äî';
      const idDisplay = row.__workOrderHref
        ? `<a href="${esc(row.__workOrderHref)}" target="_blank" rel="noopener">${esc(row.ID)}</a>`
        : esc(row.ID || '‚Äî');
      const categoriesSource = (row.__categoryList && row.__categoryList.length)
        ? row.__categoryList
        : row.Categories;
      const categoriesChips = buildCategoryChips(categoriesSource);
      const categoriesLabel = String(row.Categories ?? '').trim() || 'Uncategorised';
      const categoriesDetail = categoriesChips
        ? `<span class="chip-stack chip-stack--inline">${categoriesChips}</span>`
        : `<span>${esc(categoriesLabel)}</span>`;
      if(heading){
        heading.textContent = row.Title ? `${row.Title}` : 'Inspection details';
      }
      body.innerHTML = `
        <p><strong>ID:</strong> ${idDisplay}</p>
        <p><strong>Status:</strong> ${esc(row.Status)}</p>
        <p><strong>Priority:</strong> ${esc(row.Priority)}</p>
        <p><strong>Assigned to:</strong> ${esc(assigned)}</p>
        <p><strong>Due date:</strong> ${esc(row['Due date'])}</p>
        <p><strong>Completed on:</strong> ${esc(row['Completed on'])}</p>
        <p><strong>Last updated:</strong> ${esc(row['Last updated'])}</p>
        <p><strong>Location:</strong> ${esc(row.Location)}</p>
        <p><strong>Asset:</strong> ${esc(row.Asset)}</p>
        <p><strong>Categories:</strong> ${categoriesDetail}</p>
        <p><strong>Notes:</strong> ${esc(notes)}</p>`;
      viewer.hidden = false;
      toggle.setAttribute('aria-expanded', 'true');
      viewer.setAttribute('data-viewer-collapsed', 'false');
      body.hidden = false;
    }

    function selectRow(id){
      if(!id){
        selectedRowId = '';
        updateViewerContent(null);
        highlightSelectedRow();
        return;
      }
      const row = rowLookup.get(id);
      if(!row){
        selectedRowId = '';
        updateViewerContent(null);
        highlightSelectedRow();
        return;
      }
      selectedRowId = id;
      updateViewerContent(row);
      highlightSelectedRow();
    }

    let clicksWired = false;
    function wireRowClicks(){
      if(clicksWired) return;
      clicksWired = true;
      const tbody = document.querySelector('tbody');
      const cards = document.querySelector('[data-role="mobile-cards"]');
      tbody?.addEventListener('click', event => {
        const row = event.target.closest('tr[data-row-id]');
        if(!row) return;
        const id = row.getAttribute('data-row-id');
        selectRow(selectedRowId === id ? '' : id);
      });
      cards?.addEventListener('click', event => {
        const card = event.target.closest('[data-row-id]');
        if(!card) return;
        const id = card.getAttribute('data-row-id');
        selectRow(selectedRowId === id ? '' : id);
      });
    }

    function renderAll(rawRows){
      const summary = computeCategoryCounts(rawRows);
      if(state.categoryHot !== 'all'){
        const activeKey = state.categoryHot.toLowerCase();
        if(isCategoryHidden(activeKey)){
          state.categoryHot = 'all';
          state.category = 'all';
        }
        if(!summary.counts.has(activeKey)){
          state.categoryHot = 'all';
          state.category = 'all';
        }
      }
      const rows = applyFilters(rawRows);
      if(selectedRowId && !rows.some(row => row.__id === selectedRowId)){
        selectRow('');
      }
      renderPostureAndRisk(rows);
      renderSiteCards(rawRows);
      renderCategoryOptions(rawRows, summary);
      renderTable(rows);
      renderMobileCards(rows);
      wireRowClicks();
      updateSiteChips();
    }

    async function loadInspectionsRows(){
      const sheetUrl = getSheetUrl();
      const rows = await fetchTabByName(sheetUrl, INSPECTIONS_SHEET_NAME);
      if(rows.length){
        return normalizeInspectionsRows(rows);
      }
      const mxRows = await fetchTabByName(sheetUrl, 'MX_Raw');
      return normalizeMaintainXToInspections(mxRows);
    }

    function updateSearchInput(){
      const input = document.querySelector('[data-role="search-input"]');
      if(input && input.value !== state.search){
        input.value = state.search;
      }
    }

    function updateSiteChips(){
      const nav = document.querySelector('[data-role="site-nav"]');
      const label = document.querySelector('[data-role="site-filter-active"]');
      if(label){
        label.textContent = SITE_KEY_TO_NAME[state.siteKey] || 'All sites';
      }
      if(!nav) return;
      nav.querySelectorAll('[data-site-key]').forEach(btn => {
        const key = btn.getAttribute('data-site-key') || 'all';
        const active = key === state.siteKey;
        btn.classList.toggle('is-active', active);
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
    }

    function updateExcludeDoneToggle(){
      const toggle = document.querySelector('[data-role="exclude-done-toggle"]');
      if(!toggle) return;
      const status = toggle.querySelector('[data-role="exclude-done-status"]');
      toggle.setAttribute('aria-pressed', state.excludeDone ? 'true' : 'false');
      toggle.dataset.state = state.excludeDone ? 'on' : 'off';
      if(status){
        status.textContent = state.excludeDone ? 'On' : 'Off';
      }
      const label = state.excludeDone ? 'Show done inspections' : 'Exclude done inspections';
      toggle.setAttribute('aria-label', label);
      toggle.title = label;
    }

    function setSort(column, direction){
      state.sortBy = column;
      state.sortDir = direction;
      updateSortIndicators();
      if(window.__INSPECTIONS_ALL__){
        renderAll(window.__INSPECTIONS_ALL__);
      }
    }

    function updateStickyOffsets(){
      document.documentElement.style.setProperty('--sticky-controls-offset', '0px');
    }

    function needsMobileLayout(){
      return window.innerWidth <= 1248;
    }

    function getLayoutContainer(){
      return document.querySelector('[data-component="inspections-table"]');
    }

    const themeBtn = document.getElementById('dark-toggle');
    const themeBtnLabel = themeBtn?.querySelector('.switch-label') || themeBtn?.querySelector('.label');
    const layoutToggleBtn = document.getElementById('layout-toggle');
    const metaColorScheme = document.querySelector('meta[name="color-scheme"]');

    function currentForcedLayout(){
      if(document.body.classList.contains('force-mobile')) return 'mobile';
      if(document.body.classList.contains('force-desktop')) return 'desktop';
      return 'auto';
    }

    function syncLayoutToggle(){
      if(!layoutToggleBtn) return;
      const mode = currentForcedLayout();
      const labelEl = layoutToggleBtn.querySelector('.switch-label') || layoutToggleBtn.querySelector('.label');
      if(labelEl){
        if(mode === 'mobile') labelEl.textContent = 'Mobile view';
        else if(mode === 'desktop') labelEl.textContent = 'Desktop view';
        else {
          const autoMobile = document.body.getAttribute('data-table-mode') === 'mobile';
          labelEl.textContent = autoMobile ? 'Auto ¬∑ Mobile' : 'Auto ¬∑ Desktop';
        }
      }
      const nextAction = mode === 'mobile'
        ? 'Switch to desktop view'
        : mode === 'desktop'
          ? 'Return to automatic view'
          : 'Switch to mobile view';
      layoutToggleBtn.setAttribute('aria-checked', mode === 'mobile' ? 'true' : 'false');
      layoutToggleBtn.setAttribute('aria-label', nextAction);
      layoutToggleBtn.title = nextAction;
    }

    function applyLayoutMode(mode, { persist = true } = {}){
      const desired = mode === 'mobile' ? 'mobile' : mode === 'desktop' ? 'desktop' : 'auto';
      if(desired === 'mobile'){
        document.body.classList.add('force-mobile');
        document.body.classList.remove('force-desktop');
        document.body.setAttribute('data-table-mode', 'mobile');
        if(persist) localStorage.setItem(LAYOUT_MODE_STORAGE_KEY, 'mobile');
      }else if(desired === 'desktop'){
        document.body.classList.add('force-desktop');
        document.body.classList.remove('force-mobile');
        document.body.removeAttribute('data-table-mode');
        if(persist) localStorage.setItem(LAYOUT_MODE_STORAGE_KEY, 'desktop');
      }else{
        document.body.classList.remove('force-mobile', 'force-desktop');
        document.body.removeAttribute('data-table-mode');
        if(persist) localStorage.removeItem(LAYOUT_MODE_STORAGE_KEY);
      }
      updateResponsiveState();
      updateStickyOffsets();
    }

    function cycleLayoutMode(){
      const mode = currentForcedLayout();
      const next = mode === 'mobile' ? 'desktop' : mode === 'desktop' ? 'auto' : 'mobile';
      applyLayoutMode(next);
    }

    function restoreStoredLayoutMode(){
      const stored = localStorage.getItem(LAYOUT_MODE_STORAGE_KEY);
      if(stored === 'mobile' || stored === 'desktop'){
        applyLayoutMode(stored, { persist: false });
      }else{
        applyLayoutMode('auto', { persist: false });
      }
    }

    function updateResponsiveState(){
      if(document.body.classList.contains('force-mobile')){
        document.body.setAttribute('data-table-mode', 'mobile');
      }else if(document.body.classList.contains('force-desktop')){
        document.body.removeAttribute('data-table-mode');
      }else{
        if(needsMobileLayout()){
          document.body.setAttribute('data-table-mode', 'mobile');
        }else{
          document.body.removeAttribute('data-table-mode');
        }
      }
      syncLayoutToggle();
    }

    function setThemeButtonLabel(text){
      if(!themeBtn) return;
      if(themeBtnLabel){
        themeBtnLabel.textContent = text;
      }else{
        themeBtn.textContent = text;
      }
    }

    function applyTheme(theme){
      const normalized = theme === 'dark' ? 'dark' : 'light';
      const isDark = normalized === 'dark';
      document.body.classList.toggle('dark', isDark);
      document.body.classList.toggle('light', !isDark);
      document.body.classList.toggle('theme-dark', isDark);
      document.documentElement.setAttribute('color-scheme', normalized);
      metaColorScheme?.setAttribute('content', normalized);
      setThemeButtonLabel(isDark ? 'Light' : 'Dark');
      const label = isDark ? 'Switch to light mode' : 'Switch to dark mode';
      themeBtn?.setAttribute('aria-checked', isDark ? 'true' : 'false');
      themeBtn?.setAttribute('aria-label', label);
      themeBtn?.setAttribute('title', label);
    }

    function initTheme(){
      const stored = localStorage.getItem(THEME_STORAGE_KEY);
      const colorSchemeQuery = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
      const prefersDark = colorSchemeQuery ? colorSchemeQuery.matches : false;
      let hasStoredTheme = stored === 'dark' || stored === 'light';
      let activeTheme = hasStoredTheme ? stored : (prefersDark ? 'dark' : 'light');
      applyTheme(activeTheme);

      if(colorSchemeQuery){
        const handler = (event) => {
          if(hasStoredTheme) return;
          activeTheme = event.matches ? 'dark' : 'light';
          applyTheme(activeTheme);
        };
        if(typeof colorSchemeQuery.addEventListener === 'function'){
          colorSchemeQuery.addEventListener('change', handler);
        }else if(typeof colorSchemeQuery.addListener === 'function'){
          colorSchemeQuery.addListener(handler);
        }
      }

      themeBtn?.addEventListener('click', () => {
        activeTheme = document.body.classList.contains('theme-dark') ? 'light' : 'dark';
        applyTheme(activeTheme);
        localStorage.setItem(THEME_STORAGE_KEY, activeTheme);
        hasStoredTheme = true;
      });
    }

    function initLayout(){
      restoreStoredLayoutMode();
      updateResponsiveState();
      layoutToggleBtn?.addEventListener('click', cycleLayoutMode);
      window.addEventListener('resize', () => {
        updateResponsiveState();
        updateStickyOffsets();
      });
      updateStickyOffsets();
    }

    function initControls(){
      const siteNav = document.querySelector('[data-role="site-nav"]');
      siteNav?.addEventListener('click', event => {
        const btn = event.target.closest('[data-site-key]');
        if(!btn) return;
        const key = btn.getAttribute('data-site-key') || 'all';
        state.siteKey = state.siteKey === key ? 'all' : key;
        updateSiteChips();
        if(window.__INSPECTIONS_ALL__){
          renderAll(window.__INSPECTIONS_ALL__);
        }
      });

      const siteBreakdown = document.querySelector('[data-role="inspections-site-breakdown"]');
      siteBreakdown?.addEventListener('click', event => {
        const button = event.target.closest('[data-role="inspections-site-kpi"]');
        if(!button) return;
        const key = button.getAttribute('data-site-key') || 'all';
        state.siteKey = state.siteKey === key ? 'all' : key;
        updateSiteChips();
        if(window.__INSPECTIONS_ALL__){
          renderAll(window.__INSPECTIONS_ALL__);
        }
      });

      const thead = document.querySelector('thead');
      thead?.addEventListener('click', event => {
        const th = event.target.closest('th[data-col]');
        if(!th) return;
        const column = th.getAttribute('data-col');
        const next = state.sortBy === column && state.sortDir === 'asc' ? 'desc' : 'asc';
        setSort(column, next);
      });

      const searchInput = document.querySelector('[data-role="search-input"]');
      const applySearch = () => {
        state.search = searchInput.value.trim();
        if(window.__INSPECTIONS_ALL__){
          renderAll(window.__INSPECTIONS_ALL__);
        }
      };
      searchInput?.addEventListener('input', applySearch);
      searchInput?.addEventListener('search', applySearch);

      document.querySelector('[data-role="sort-select"]')?.addEventListener('change', event => {
        setSort(event.target.value, state.sortDir);
      });
      document.querySelector('[data-role="mobile-sort-select"]')?.addEventListener('change', event => {
        setSort(event.target.value, state.sortDir);
      });
      const toggleSortDir = () => {
        const next = state.sortDir === 'asc' ? 'desc' : 'asc';
        setSort(state.sortBy, next);
      };
      document.querySelector('[data-role="sort-direction"]')?.addEventListener('click', toggleSortDir);
      document.querySelector('[data-role="mobile-sort-direction"]')?.addEventListener('click', toggleSortDir);

      const excludeToggle = document.querySelector('[data-role="exclude-done-toggle"]');
      excludeToggle?.addEventListener('click', () => {
        state.excludeDone = !state.excludeDone;
        updateExcludeDoneToggle();
        if(window.__INSPECTIONS_ALL__){
          renderAll(window.__INSPECTIONS_ALL__);
        }
      });
      updateExcludeDoneToggle();

      const viewerToggle = document.querySelector('[data-role="viewer-toggle"]');
      const viewerContent = document.querySelector('[data-role="viewer-content"]');
      const viewer = document.getElementById('viewer');
      viewerToggle?.addEventListener('click', () => {
        const expanded = viewerToggle.getAttribute('aria-expanded') === 'true';
        const next = !expanded;
        viewerToggle.setAttribute('aria-expanded', next ? 'true' : 'false');
        viewerContent.hidden = !next;
        if(viewer){
          viewer.setAttribute('data-viewer-collapsed', next ? 'false' : 'true');
        }
      });
    }

    async function initInspections(){
      const scrollRegion = document.querySelector('[data-role="scroll-region"]');
      scrollRegion?.setAttribute('data-loading', 'true');
      try {
        const rows = ALLOW_NETWORK ? await loadInspectionsRows() : normalizeInspectionsRows(OFFLINE_SAMPLE);
        rowLookup = new Map(rows.map(row => [row.__id, row]));
        window.__INSPECTIONS_ALL__ = rows;
        selectedRowId = '';
        updateViewerContent(null);
        renderAll(rows);
      } catch (error){
        console.error(error);
      } finally {
        scrollRegion?.removeAttribute('data-loading');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initTheme();
      initLayout();
      initControls();
      updateSiteChips();
      updateSearchInput();
      updateSortIndicators();
      initInspections();
    });

    document.querySelector('[data-action="refresh"]')?.addEventListener('click', initInspections);
  </script>

</body>
</html>
